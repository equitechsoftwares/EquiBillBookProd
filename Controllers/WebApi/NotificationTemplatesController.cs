using EquiBillBook.Filters;
using EquiBillBook.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net;
using System.Net.Http;
using System.Threading.Tasks;
using System.Transactions;
using System.Web.Configuration;
using System.Web.Http;

namespace EquiBillBook.Controllers.WebApi
{
    [ExceptionHandler]
    [IdentityBasicAuthentication]
    public class NotificationTemplatesController : ApiController
    {
        CommonController oCommonController = new CommonController();
        ConnectionContext oConnectionContext = new ConnectionContext();
        dynamic data = null;
        public string webUrl = WebConfigurationManager.AppSettings["webUrl"];

        public async Task<IHttpActionResult> UpdateNotificationTemplate(ClsNotificationModulesSettingsVm obj)
        {
            var CurrentDate = oCommonController.CurrentDate(obj.CompanyId);
            using (TransactionScope dbContextTransaction = new TransactionScope())
            {
                long NotificationModulesSettingsId = oConnectionContext.DbClsNotificationModulesSettings.
                    Where(a => a.NotificationModulesId == obj.NotificationModulesId
                    && a.NotificationModulesDetailsId == obj.NotificationModulesDetailsId
                    && a.NotificationTemplatesId == obj.NotificationTemplatesId
                    && a.CompanyId == obj.CompanyId)
                    .Select(a => a.NotificationModulesSettingsId).FirstOrDefault();

                if (NotificationModulesSettingsId == 0)
                {
                    ClsNotificationModulesSettings oClsNotificationModulesSettings = new ClsNotificationModulesSettings()
                    {
                        AddedBy = obj.AddedBy,
                        AddedOn = CurrentDate,
                        IsActive = true,
                        IsDeleted = false,
                        CompanyId = obj.CompanyId,
                        NotificationModulesId = obj.NotificationModulesId,
                        NotificationModulesDetailsId = obj.NotificationModulesDetailsId,
                        NotificationTemplatesId = obj.NotificationTemplatesId,
                        AutoSendEmail = obj.AutoSendEmail,
                        AutoSendSms = obj.AutoSendSms,
                        AutoSendWhatsapp = obj.AutoSendWhatsapp,
                        BCC = obj.BCC,
                        CC = obj.CC,
                        EmailBody = obj.EmailBody,
                        EmailSubject = obj.EmailSubject,
                        SmsBody = obj.SmsBody,
                        WhatsappBody = obj.WhatsappBody
                    };
                    oConnectionContext.DbClsNotificationModulesSettings.Add(oClsNotificationModulesSettings);
                    oConnectionContext.SaveChanges();
                }
                else
                {
                    ClsNotificationModulesSettings oClsNotificationModulesSettings = new ClsNotificationModulesSettings()
                    {
                        NotificationModulesSettingsId = NotificationModulesSettingsId,
                        ModifiedBy = obj.AddedBy,
                        ModifiedOn = CurrentDate,
                        NotificationModulesId = obj.NotificationModulesId,
                        NotificationModulesDetailsId = obj.NotificationModulesDetailsId,
                        NotificationTemplatesId = obj.NotificationTemplatesId,
                        AutoSendEmail = obj.AutoSendEmail,
                        AutoSendSms = obj.AutoSendSms,
                        AutoSendWhatsapp = obj.AutoSendWhatsapp,
                        BCC = obj.BCC,
                        CC = obj.CC,
                        EmailBody = obj.EmailBody,
                        EmailSubject = obj.EmailSubject,
                        SmsBody = obj.SmsBody,
                        WhatsappBody = obj.WhatsappBody
                    };

                    oConnectionContext.DbClsNotificationModulesSettings.Attach(oClsNotificationModulesSettings);
                    oConnectionContext.Entry(oClsNotificationModulesSettings).Property(x => x.ModifiedBy).IsModified = true;
                    oConnectionContext.Entry(oClsNotificationModulesSettings).Property(x => x.ModifiedOn).IsModified = true;
                    oConnectionContext.Entry(oClsNotificationModulesSettings).Property(x => x.NotificationModulesId).IsModified = true;
                    oConnectionContext.Entry(oClsNotificationModulesSettings).Property(x => x.NotificationModulesDetailsId).IsModified = true;
                    oConnectionContext.Entry(oClsNotificationModulesSettings).Property(x => x.NotificationTemplatesId).IsModified = true;
                    oConnectionContext.Entry(oClsNotificationModulesSettings).Property(x => x.AutoSendEmail).IsModified = true;
                    oConnectionContext.Entry(oClsNotificationModulesSettings).Property(x => x.AutoSendSms).IsModified = true;
                    oConnectionContext.Entry(oClsNotificationModulesSettings).Property(x => x.AutoSendWhatsapp).IsModified = true;
                    oConnectionContext.Entry(oClsNotificationModulesSettings).Property(x => x.BCC).IsModified = true;
                    oConnectionContext.Entry(oClsNotificationModulesSettings).Property(x => x.CC).IsModified = true;
                    oConnectionContext.Entry(oClsNotificationModulesSettings).Property(x => x.EmailBody).IsModified = true;
                    oConnectionContext.Entry(oClsNotificationModulesSettings).Property(x => x.EmailSubject).IsModified = true;
                    oConnectionContext.Entry(oClsNotificationModulesSettings).Property(x => x.SmsBody).IsModified = true;
                    oConnectionContext.Entry(oClsNotificationModulesSettings).Property(x => x.WhatsappBody).IsModified = true;
                    oConnectionContext.SaveChanges();

                    //ClsNotificationTemplates oClsNotificationModulesSettings = new ClsNotificationTemplates()
                    //{
                    //    ModifiedBy = obj.AddedBy,
                    //    ModifiedOn = CurrentDate,
                    //    NotificationModulesId = obj.NotificationModulesId,
                    //    NotificationModulesDetailsId = obj.NotificationModulesDetailsId,
                    //    NotificationTemplatesId = obj.NotificationTemplatesId,
                    //    EmailBody = obj.EmailBody,
                    //    EmailSubject = obj.EmailSubject,
                    //    SmsBody = obj.SmsBody,
                    //    WhatsappBody = obj.WhatsappBody
                    //};

                    //oConnectionContext.DbClsNotificationTemplates.Attach(oClsNotificationModulesSettings);
                    //oConnectionContext.Entry(oClsNotificationModulesSettings).Property(x => x.ModifiedBy).IsModified = true;
                    //oConnectionContext.Entry(oClsNotificationModulesSettings).Property(x => x.ModifiedOn).IsModified = true;
                    //oConnectionContext.Entry(oClsNotificationModulesSettings).Property(x => x.NotificationModulesId).IsModified = true;
                    //oConnectionContext.Entry(oClsNotificationModulesSettings).Property(x => x.NotificationModulesDetailsId).IsModified = true;
                    //oConnectionContext.Entry(oClsNotificationModulesSettings).Property(x => x.NotificationTemplatesId).IsModified = true;
                    //oConnectionContext.Entry(oClsNotificationModulesSettings).Property(x => x.EmailBody).IsModified = true;
                    //oConnectionContext.Entry(oClsNotificationModulesSettings).Property(x => x.EmailSubject).IsModified = true;
                    //oConnectionContext.Entry(oClsNotificationModulesSettings).Property(x => x.SmsBody).IsModified = true;
                    //oConnectionContext.Entry(oClsNotificationModulesSettings).Property(x => x.WhatsappBody).IsModified = true;
                    //oConnectionContext.SaveChanges();
                }

                //ClsNotificationTemplates oClsNotificationTemplates = new ClsNotificationTemplates()
                //{
                //    NotificationTemplatesId = obj.NotificationTemplatesId,
                //    EmailBody = obj.EmailBody,
                //    EmailSubject = obj.EmailSubject,
                //    SmsBody = obj.SmsBody,
                //    WhatsappBody = obj.WhatsappBody
                //};

                //oConnectionContext.DbClsNotificationTemplates.Attach(oClsNotificationTemplates);
                //oConnectionContext.Entry(oClsNotificationTemplates).Property(x => x.EmailBody).IsModified = true;
                //oConnectionContext.Entry(oClsNotificationTemplates).Property(x => x.EmailSubject).IsModified = true;
                //oConnectionContext.Entry(oClsNotificationTemplates).Property(x => x.SmsBody).IsModified = true;
                //oConnectionContext.Entry(oClsNotificationTemplates).Property(x => x.WhatsappBody).IsModified = true;
                //oConnectionContext.SaveChanges();

                ClsActivityLogVm oClsActivityLogVm = new ClsActivityLogVm()
                {
                    AddedBy = obj.AddedBy,
                    Browser = obj.Browser,
                    Category = "Notification Templates",
                    CompanyId = obj.CompanyId,
                    Description = "Notification Templates updated",
                    Id = 0,
                    IpAddress = obj.IpAddress,
                    Platform = obj.Platform,
                    Type = "Update"
                };
                oCommonController.InsertActivityLog(oClsActivityLogVm, CurrentDate);

                dbContextTransaction.Complete();
                data = new
                {
                    Status = 1,
                    Message = "Notification Templates updated successfully.",
                    Data = new
                    {

                    }
                };
                return await Task.FromResult(Ok(data));
            }
        }

        #region Sales

        public dynamic SendNotifications(string Type, long CompanyId, long Id, long SmsSettingsId, long EmailSettingsId, long WhatsappSettingsId, long AddedBy, DateTime CurrentDate, string Domain)
        {
            string Status = oCommonController.fetchStatus(CompanyId, Type, Id);

            ClsNotificationModulesSettingsVm NotificationModulesSetting = (from a in oConnectionContext.DbClsNotificationModulesDetails
                                                                           join c in oConnectionContext.DbClsNotificationTemplates
                                                                           on a.NotificationModulesDetailsId equals c.NotificationModulesDetailsId
                                                                           join b in oConnectionContext.DbClsNotificationModulesSettings
                                                     on c.NotificationTemplatesId equals b.NotificationTemplatesId
                                                                           where b.CompanyId == CompanyId && a.Name == Type && c.Name == Status
                                                                           select new ClsNotificationModulesSettingsVm
                                                                           {
                                                                               AutoSendEmail = b.AutoSendEmail,
                                                                               AutoSendSms = b.AutoSendSms,
                                                                               AutoSendWhatsapp = b.AutoSendWhatsapp,
                                                                               EmailSubject = b.EmailSubject,
                                                                               CC = b.CC,
                                                                               BCC = b.BCC,
                                                                               EmailBody = b.EmailBody == null ? "" : b.EmailBody,
                                                                               SmsBody = b.SmsBody == null ? "" : b.SmsBody,
                                                                               WhatsappBody = b.WhatsappBody == null ? "" : b.WhatsappBody,
                                                                           }).FirstOrDefault();
            if (NotificationModulesSetting != null)
            {
                if (NotificationModulesSetting.AutoSendSms == true || NotificationModulesSetting.AutoSendEmail == true ||
                NotificationModulesSetting.AutoSendWhatsapp == true)
                {
                    SmsSettingsId = oConnectionContext.DbClsSmsSettings.Where(a => a.CompanyId == CompanyId && a.IsDefault == true && a.IsDeleted == false && a.IsActive == true).Select(a => a.SmsSettingsId).FirstOrDefault();
                    EmailSettingsId = oConnectionContext.DbClsEmailSettings.Where(a => a.CompanyId == CompanyId && a.IsDefault == true && a.IsDeleted == false && a.IsActive == true).Select(a => a.EmailSettingsId).FirstOrDefault();
                    WhatsappSettingsId = oConnectionContext.DbClsWhatsappSettings.Where(a => a.CompanyId == CompanyId && a.IsDefault == true && a.IsDeleted == false && a.IsActive == true).Select(a => a.WhatsappSettingsId).FirstOrDefault();

                    if (Type == "Sales Quotation")
                    {
                        return SalesQuotation(NotificationModulesSetting, CompanyId, Id, NotificationModulesSetting.CC, NotificationModulesSetting.BCC, SmsSettingsId, EmailSettingsId, WhatsappSettingsId, Type, AddedBy, CurrentDate, Domain);
                    }
                    else if (Type == "Sales Order")
                    {
                        return SalesOrder(NotificationModulesSetting, CompanyId, Id, NotificationModulesSetting.CC, NotificationModulesSetting.BCC, SmsSettingsId, EmailSettingsId, WhatsappSettingsId, Type, AddedBy, CurrentDate, Domain);
                    }
                    else if (Type == "Sales Proforma")
                    {
                        return SalesProforma(NotificationModulesSetting, CompanyId, Id, NotificationModulesSetting.CC, NotificationModulesSetting.BCC, SmsSettingsId, EmailSettingsId, WhatsappSettingsId, Type, AddedBy, CurrentDate, Domain);
                    }
                    else if (Type == "Delivery Challan")
                    {
                        return DeliveryChallan(NotificationModulesSetting, CompanyId, Id, NotificationModulesSetting.CC, NotificationModulesSetting.BCC, SmsSettingsId, EmailSettingsId, WhatsappSettingsId, Type, AddedBy, CurrentDate, Domain);
                    }
                    else if (Type == "Sales Invoice")
                    {
                        return SalesInvoice(NotificationModulesSetting, CompanyId, Id, NotificationModulesSetting.CC, NotificationModulesSetting.BCC, SmsSettingsId, EmailSettingsId, WhatsappSettingsId, Type, AddedBy, CurrentDate, Domain);
                    }
                    else if (Type == "Sales Debit Note")
                    {
                        return SalesDebitNote(NotificationModulesSetting, CompanyId, Id, NotificationModulesSetting.CC, NotificationModulesSetting.BCC, SmsSettingsId, EmailSettingsId, WhatsappSettingsId, Type, AddedBy, CurrentDate, Domain);
                    }
                    else if (Type == "Bill Of Supply")
                    {
                        return BillOfSupply(NotificationModulesSetting, CompanyId, Id, NotificationModulesSetting.CC, NotificationModulesSetting.BCC, SmsSettingsId, EmailSettingsId, WhatsappSettingsId, Type, AddedBy, CurrentDate, Domain);
                    }
                    else if (Type == "Pos")
                    {
                        return Pos(NotificationModulesSetting, CompanyId, Id, NotificationModulesSetting.CC, NotificationModulesSetting.BCC, SmsSettingsId, EmailSettingsId, WhatsappSettingsId, Type, AddedBy, CurrentDate, Domain);
                    }
                    else if (Type == "Sales Credit Note")
                    {
                        return SalesCreditNote(NotificationModulesSetting, CompanyId, Id, NotificationModulesSetting.CC, NotificationModulesSetting.BCC, SmsSettingsId, EmailSettingsId, WhatsappSettingsId, Type, AddedBy, CurrentDate, Domain);
                    }
                    else if (Type == "Payment Link")
                    {
                        return PaymentLink(NotificationModulesSetting, CompanyId, Id, NotificationModulesSetting.CC, NotificationModulesSetting.BCC, SmsSettingsId, EmailSettingsId, WhatsappSettingsId, Type, AddedBy, CurrentDate, Domain);
                    }
                    else if (Type == "Sales Invoice Payment")
                    {
                        return SalesInvoicePayment(NotificationModulesSetting, CompanyId, Id, NotificationModulesSetting.CC, NotificationModulesSetting.BCC, SmsSettingsId, EmailSettingsId, WhatsappSettingsId, Type, AddedBy, CurrentDate, Domain);
                    }
                    else if (Type == "Customer Advance Payment")
                    {
                        return CustomerAdvancePayment(NotificationModulesSetting, CompanyId, Id, NotificationModulesSetting.CC, NotificationModulesSetting.BCC, SmsSettingsId, EmailSettingsId, WhatsappSettingsId, Type, AddedBy, CurrentDate, Domain);
                    }
                    else if (Type == "Refund From Credit Note")
                    {
                        return RefundFromCreditNote(NotificationModulesSetting, CompanyId, Id, NotificationModulesSetting.CC, NotificationModulesSetting.BCC, SmsSettingsId, EmailSettingsId, WhatsappSettingsId, Type, AddedBy, CurrentDate, Domain);
                    }
                    else if (Type == "Refund From Customer Advance Payment")
                    {
                        return RefundFromCustomerAdvancePayment(NotificationModulesSetting, CompanyId, Id, NotificationModulesSetting.CC, NotificationModulesSetting.BCC, SmsSettingsId, EmailSettingsId, WhatsappSettingsId, Type, AddedBy, CurrentDate, Domain);
                    }
                    else if (Type == "Credits Applied From Credit Note")
                    {
                        return CreditsAppliedFromCreditNote(NotificationModulesSetting, CompanyId, Id, NotificationModulesSetting.CC, NotificationModulesSetting.BCC, SmsSettingsId, EmailSettingsId, WhatsappSettingsId, Type, AddedBy, CurrentDate, Domain);
                    }
                    else if (Type == "Credits Applied From Customer Advance Payment")
                    {
                        return CreditsAppliedFromCustomerAdvancePayment(NotificationModulesSetting, CompanyId, Id, NotificationModulesSetting.CC, NotificationModulesSetting.BCC, SmsSettingsId, EmailSettingsId, WhatsappSettingsId, Type, AddedBy, CurrentDate, Domain);
                    }
                    else if (Type == "Purchase Quotation")
                    {
                        return PurchaseQuotation(NotificationModulesSetting, CompanyId, Id, NotificationModulesSetting.CC, NotificationModulesSetting.BCC, SmsSettingsId, EmailSettingsId, WhatsappSettingsId, Type, AddedBy, CurrentDate, Domain);
                    }
                    else if (Type == "Purchase Order")
                    {
                        return PurchaseOrder(NotificationModulesSetting, CompanyId, Id, NotificationModulesSetting.CC, NotificationModulesSetting.BCC, SmsSettingsId, EmailSettingsId, WhatsappSettingsId, Type, AddedBy, CurrentDate, Domain);
                    }
                    else if (Type == "Purchase Bill")
                    {
                        return PurchaseBill(NotificationModulesSetting, CompanyId, Id, NotificationModulesSetting.CC, NotificationModulesSetting.BCC, SmsSettingsId, EmailSettingsId, WhatsappSettingsId, Type, AddedBy, CurrentDate, Domain);
                    }
                    else if (Type == "Purchase Debit Note")
                    {
                        return PurchaseDebitNote(NotificationModulesSetting, CompanyId, Id, NotificationModulesSetting.CC, NotificationModulesSetting.BCC, SmsSettingsId, EmailSettingsId, WhatsappSettingsId, Type, AddedBy, CurrentDate, Domain);
                    }
                    else if (Type == "Purchase Bill Payment")
                    {
                        return PurchaseBillPayment(NotificationModulesSetting, CompanyId, Id, NotificationModulesSetting.CC, NotificationModulesSetting.BCC, SmsSettingsId, EmailSettingsId, WhatsappSettingsId, Type, AddedBy, CurrentDate, Domain);
                    }
                    else if (Type == "Supplier Advance Payment")
                    {
                        return SupplierAdvancePayment(NotificationModulesSetting, CompanyId, Id, NotificationModulesSetting.CC, NotificationModulesSetting.BCC, SmsSettingsId, EmailSettingsId, WhatsappSettingsId, Type, AddedBy, CurrentDate, Domain);
                    }
                    else if (Type == "Refund From Debit Note")
                    {
                        return RefundFromDebitNote(NotificationModulesSetting, CompanyId, Id, NotificationModulesSetting.CC, NotificationModulesSetting.BCC, SmsSettingsId, EmailSettingsId, WhatsappSettingsId, Type, AddedBy, CurrentDate, Domain);
                    }
                    else if (Type == "Refund From Supplier Advance Payment")
                    {
                        return RefundFromSupplierAdvancePayment(NotificationModulesSetting, CompanyId, Id, NotificationModulesSetting.CC, NotificationModulesSetting.BCC, SmsSettingsId, EmailSettingsId, WhatsappSettingsId, Type, AddedBy, CurrentDate, Domain);
                    }
                    else if (Type == "Credits Applied From Debit Note")
                    {
                        return CreditsAppliedFromDebitNote(NotificationModulesSetting, CompanyId, Id, NotificationModulesSetting.CC, NotificationModulesSetting.BCC, SmsSettingsId, EmailSettingsId, WhatsappSettingsId, Type, AddedBy, CurrentDate, Domain);
                    }
                    else if (Type == "Credits Applied From Supplier Advance Payment")
                    {
                        return CreditsAppliedFromSupplierAdvancePayment(NotificationModulesSetting, CompanyId, Id, NotificationModulesSetting.CC, NotificationModulesSetting.BCC, SmsSettingsId, EmailSettingsId, WhatsappSettingsId, Type, AddedBy, CurrentDate, Domain);
                    }
                }
            }

            string[] arr = { "1", "", "" };
            return arr;
        }

        public dynamic SalesQuotation(ClsNotificationModulesSettingsVm NotificationModulesSetting, long CompanyId, long Id, string CC, string Bcc, long SmsSettingsId, long EmailSettingsId, long WhatsappSettingsId, string Type, long AddedBy, DateTime CurrentDate, string Domain)
        {
            var Sale = oConnectionContext.DbClsSalesQuotation.Where(a => a.SalesQuotationId == Id).Select(a => new
            {
                a.BranchId,
                a.InvoiceNo,
                InvoiceUrl = Domain + "/salesquotation/invoice?InvoiceId=" + a.InvoiceId,
                CustomerName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.Name).FirstOrDefault(),
                CustomerMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.MobileNo).FirstOrDefault(),
                CustomerEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.EmailId).FirstOrDefault(),
                PlaceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.PlaceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                a.SalesQuotationDate,
                SellingPriceGroup = oConnectionContext.DbClsSellingPriceGroup.Where(b => b.SellingPriceGroupId == a.SellingPriceGroupId).
                Select(b => b.SellingPriceGroup).FirstOrDefault(),
                a.Notes,
                a.Subtotal,
                a.TotalDiscount,
                a.TotalTaxAmount,
                a.NetAmount,
                a.RoundOff,
                a.SpecialDiscount,
                a.GrandTotal
            }).FirstOrDefault();

            var Branch = oConnectionContext.DbClsBranch.Where(a => a.BranchId == Sale.BranchId).Select(a => new
            {
                BusinessName = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessName).FirstOrDefault(),
                BusinessLogo = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessLogo).FirstOrDefault(),
                a.Branch,
                a.BranchCode,
                a.Address,
                a.Zipcode,
                Country = oConnectionContext.DbClsCountry.Where(b => b.CountryId == a.CountryId).Select(b => b.Country).FirstOrDefault(),
                State = oConnectionContext.DbClsState.Where(b => b.StateId == a.StateId).Select(b => b.State).FirstOrDefault(),
                City = oConnectionContext.DbClsCity.Where(b => b.CityId == a.CityId).Select(b => b.City).FirstOrDefault(),
                //ContactPersonName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.Name).FirstOrDefault(),
                //ContactPersonMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.MobileNo).FirstOrDefault(),
                a.Mobile,
                a.AltMobileNo,
                a.Email,
                BusinessRegistrationNo = oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNo).FirstOrDefault(),
                BusinessRegistrationName = oConnectionContext.DbClsBusinessRegistrationName.Where(c => c.BusinessRegistrationNameId ==
                oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNameId).FirstOrDefault()).Select(c => c.Name).FirstOrDefault()
            }).FirstOrDefault();

            if (SmsSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.SmsBody;
                string[] array = NotificationModulesSetting.SmsBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Quotation No")
                    {
                        formattedBody = formattedBody.Replace("{Quotation No}", Sale.InvoiceNo);
                    }
                    else if (item == "Quotation Url")
                    {
                        formattedBody = formattedBody.Replace("{Quotation Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", Sale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", Sale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", Sale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Quotation Date")
                    {
                        formattedBody = formattedBody.Replace("{Quotation Date}", Sale.SalesQuotationDate.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }

                SmsController oSmsController = new SmsController();
                oSmsController.SmsFunction(CompanyId, Sale.CustomerMobileNo, formattedBody, AddedBy, CurrentDate, Id, Type, Domain, 0);
            }
            if (EmailSettingsId != 0)
            {
                #region Email Subject
                string formattedSubject = "";

                formattedSubject = NotificationModulesSetting.EmailSubject;
                string[] arr1 = NotificationModulesSetting.EmailSubject.Split('{');
                List<string> list1 = new List<string>();

                foreach (var item in arr1)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list1.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list1)
                {
                    if (item == "Business Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Quotation No")
                    {
                        formattedSubject = formattedSubject.Replace("{Quotation No}", Sale.InvoiceNo);
                    }
                    else if (item == "Quotation Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Quotation Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Name}", Sale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Mobile No}", Sale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Email}", Sale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Quotation Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Quotation Date}", Sale.SalesQuotationDate.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedSubject = formattedSubject.Replace("{Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedSubject = formattedSubject.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedSubject = formattedSubject.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }
                #endregion

                #region EmailBody
                string formattedBody = NotificationModulesSetting.EmailBody;
                string[] array = NotificationModulesSetting.EmailBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Logo")
                    {
                        formattedBody = formattedBody.Replace("{Business Logo}", "<img src='" + webUrl + Branch.BusinessLogo + "' />");
                    }
                    else if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Quotation No")
                    {
                        formattedBody = formattedBody.Replace("{Quotation No}", Sale.InvoiceNo);
                    }
                    else if (item == "Quotation Url")
                    {
                        formattedBody = formattedBody.Replace("{Quotation Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", Sale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", Sale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", Sale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Quotation Date")
                    {
                        formattedBody = formattedBody.Replace("{Quotation Date}", Sale.SalesQuotationDate.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }
                #endregion

                EmailController oEmailController = new EmailController();
                oEmailController.NotificationTemplate(CompanyId, Sale.CustomerEmailId, formattedSubject, formattedBody, CC, Bcc, AddedBy, CurrentDate, Id, Type, Domain);
            }
            if (WhatsappSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.WhatsappBody;
                string[] array = NotificationModulesSetting.WhatsappBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Quotation No")
                    {
                        formattedBody = formattedBody.Replace("{Quotation No}", Sale.InvoiceNo);
                    }
                    else if (item == "Quotation Url")
                    {
                        formattedBody = formattedBody.Replace("{Quotation Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", Sale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", Sale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", Sale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Quotation Date")
                    {
                        formattedBody = formattedBody.Replace("{Quotation Date}", Sale.SalesQuotationDate.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }

                WhatsappController oWhatsappController = new WhatsappController();
                return oWhatsappController.WhatsappFunction(CompanyId, Sale.CustomerMobileNo, formattedBody, 0);
            }
            string[] arr = { "1", "", "" };
            return arr;
        }

        public dynamic SalesOrder(ClsNotificationModulesSettingsVm NotificationModulesSetting, long CompanyId, long Id, string CC, string Bcc, long SmsSettingsId, long EmailSettingsId, long WhatsappSettingsId, string Type, long AddedBy, DateTime CurrentDate, string Domain)
        {
            var Sale = oConnectionContext.DbClsSalesOrder.Where(a => a.SalesOrderId == Id).Select(a => new
            {
                a.BranchId,
                a.InvoiceNo,
                InvoiceUrl = Domain + "/salesorder/invoice?InvoiceId=" + a.InvoiceId,
                CustomerName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.Name).FirstOrDefault(),
                CustomerMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.MobileNo).FirstOrDefault(),
                CustomerEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.EmailId).FirstOrDefault(),
                PlaceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.PlaceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                a.SalesOrderDate,
                SellingPriceGroup = oConnectionContext.DbClsSellingPriceGroup.Where(b => b.SellingPriceGroupId == a.SellingPriceGroupId).
                Select(b => b.SellingPriceGroup).FirstOrDefault(),
                a.Notes,
                a.Subtotal,
                a.TotalDiscount,
                a.TotalTaxAmount,
                a.NetAmount,
                a.RoundOff,
                a.SpecialDiscount,
                a.GrandTotal
            }).FirstOrDefault();

            var Branch = oConnectionContext.DbClsBranch.Where(a => a.BranchId == Sale.BranchId).Select(a => new
            {
                BusinessName = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessName).FirstOrDefault(),
                BusinessLogo = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessLogo).FirstOrDefault(),
                a.Branch,
                a.BranchCode,
                a.Address,
                a.Zipcode,
                Country = oConnectionContext.DbClsCountry.Where(b => b.CountryId == a.CountryId).Select(b => b.Country).FirstOrDefault(),
                State = oConnectionContext.DbClsState.Where(b => b.StateId == a.StateId).Select(b => b.State).FirstOrDefault(),
                City = oConnectionContext.DbClsCity.Where(b => b.CityId == a.CityId).Select(b => b.City).FirstOrDefault(),
                //ContactPersonName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.Name).FirstOrDefault(),
                //ContactPersonMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.MobileNo).FirstOrDefault(),
                a.Mobile,
                a.AltMobileNo,
                a.Email,
                BusinessRegistrationNo = oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNo).FirstOrDefault(),
                BusinessRegistrationName = oConnectionContext.DbClsBusinessRegistrationName.Where(c => c.BusinessRegistrationNameId ==
                oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNameId).FirstOrDefault()).Select(c => c.Name).FirstOrDefault()
            }).FirstOrDefault();

            if (SmsSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.SmsBody;
                string[] array = NotificationModulesSetting.SmsBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Order No")
                    {
                        formattedBody = formattedBody.Replace("{Order No}", Sale.InvoiceNo);
                    }
                    else if (item == "Order Url")
                    {
                        formattedBody = formattedBody.Replace("{Order Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", Sale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", Sale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", Sale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Order Date")
                    {
                        formattedBody = formattedBody.Replace("{Order Date}", Sale.SalesOrderDate.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }

                SmsController oSmsController = new SmsController();
                oSmsController.SmsFunction(CompanyId, Sale.CustomerMobileNo, formattedBody, AddedBy, CurrentDate, Id, Type, Domain, 0);
            }
            if (EmailSettingsId != 0)
            {
                #region Email Subject
                string formattedSubject = "";

                formattedSubject = NotificationModulesSetting.EmailSubject;
                string[] arr1 = NotificationModulesSetting.EmailSubject.Split('{');
                List<string> list1 = new List<string>();

                foreach (var item in arr1)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list1.Add(item.Split('}')[0]);
                    }
                }


                foreach (var item in list1)
                {
                    if (item == "Business Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Order No")
                    {
                        formattedSubject = formattedSubject.Replace("{Order No}", Sale.InvoiceNo);
                    }
                    else if (item == "Order Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Order Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Name}", Sale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Mobile No}", Sale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Email}", Sale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Order Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Order Date}", Sale.SalesOrderDate.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedSubject = formattedSubject.Replace("{Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedSubject = formattedSubject.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedSubject = formattedSubject.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }
                #endregion

                #region EmailBody
                string formattedBody = NotificationModulesSetting.EmailBody;
                string[] array = NotificationModulesSetting.EmailBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Logo")
                    {
                        formattedBody = formattedBody.Replace("{Business Logo}", "<img src='" + webUrl + Branch.BusinessLogo + "' />");
                    }
                    else if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Order No")
                    {
                        formattedBody = formattedBody.Replace("{Order No}", Sale.InvoiceNo);
                    }
                    else if (item == "Order Url")
                    {
                        formattedBody = formattedBody.Replace("{Order Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", Sale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", Sale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", Sale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Order Date")
                    {
                        formattedBody = formattedBody.Replace("{Order Date}", Sale.SalesOrderDate.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }
                #endregion

                EmailController oEmailController = new EmailController();
                oEmailController.NotificationTemplate(CompanyId, Sale.CustomerEmailId, formattedSubject, formattedBody, CC, Bcc, AddedBy, CurrentDate, Id, Type, Domain);
            }
            if (WhatsappSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.WhatsappBody;
                string[] array = NotificationModulesSetting.WhatsappBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Order No")
                    {
                        formattedBody = formattedBody.Replace("{Order No}", Sale.InvoiceNo);
                    }
                    else if (item == "Order Url")
                    {
                        formattedBody = formattedBody.Replace("{Order Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", Sale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", Sale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", Sale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Order Date")
                    {
                        formattedBody = formattedBody.Replace("{Order Date}", Sale.SalesOrderDate.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }

                WhatsappController oWhatsappController = new WhatsappController();
                return oWhatsappController.WhatsappFunction(CompanyId, Sale.CustomerMobileNo, formattedBody, 0);
            }
            string[] arr = { "1", "", "" };
            return arr;
        }

        public dynamic SalesProforma(ClsNotificationModulesSettingsVm NotificationModulesSetting, long CompanyId, long Id, string CC, string Bcc, long SmsSettingsId, long EmailSettingsId, long WhatsappSettingsId, string Type, long AddedBy, DateTime CurrentDate, string Domain)
        {
            var Sale = oConnectionContext.DbClsSalesProforma.Where(a => a.SalesProformaId == Id).Select(a => new
            {
                a.BranchId,
                a.InvoiceNo,
                InvoiceUrl = Domain + "/salesproforma/invoice?InvoiceId=" + a.InvoiceId,
                CustomerName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.Name).FirstOrDefault(),
                CustomerMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.MobileNo).FirstOrDefault(),
                CustomerEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.EmailId).FirstOrDefault(),
                PlaceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.PlaceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                a.SalesProformaDate,
                SellingPriceGroup = oConnectionContext.DbClsSellingPriceGroup.Where(b => b.SellingPriceGroupId == a.SellingPriceGroupId).
                Select(b => b.SellingPriceGroup).FirstOrDefault(),
                a.Notes,
                a.Subtotal,
                a.TotalDiscount,
                a.TotalTaxAmount,
                a.NetAmount,
                a.RoundOff,
                a.SpecialDiscount,
                a.GrandTotal
            }).FirstOrDefault();

            var Branch = oConnectionContext.DbClsBranch.Where(a => a.BranchId == Sale.BranchId).Select(a => new
            {
                BusinessName = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessName).FirstOrDefault(),
                BusinessLogo = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessLogo).FirstOrDefault(),
                a.Branch,
                a.BranchCode,
                a.Address,
                a.Zipcode,
                Country = oConnectionContext.DbClsCountry.Where(b => b.CountryId == a.CountryId).Select(b => b.Country).FirstOrDefault(),
                State = oConnectionContext.DbClsState.Where(b => b.StateId == a.StateId).Select(b => b.State).FirstOrDefault(),
                City = oConnectionContext.DbClsCity.Where(b => b.CityId == a.CityId).Select(b => b.City).FirstOrDefault(),
                //ContactPersonName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.Name).FirstOrDefault(),
                //ContactPersonMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.MobileNo).FirstOrDefault(),
                a.Mobile,
                a.AltMobileNo,
                a.Email,
                BusinessRegistrationNo = oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNo).FirstOrDefault(),
                BusinessRegistrationName = oConnectionContext.DbClsBusinessRegistrationName.Where(c => c.BusinessRegistrationNameId ==
                oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNameId).FirstOrDefault()).Select(c => c.Name).FirstOrDefault()
            }).FirstOrDefault();

            if (SmsSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.SmsBody;
                string[] array = NotificationModulesSetting.SmsBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Proforma No")
                    {
                        formattedBody = formattedBody.Replace("{Proforma No}", Sale.InvoiceNo);
                    }
                    else if (item == "Proforma Url")
                    {
                        formattedBody = formattedBody.Replace("{Proforma Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", Sale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", Sale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", Sale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Proforma Date")
                    {
                        formattedBody = formattedBody.Replace("{Proforma Date}", Sale.SalesProformaDate.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }

                SmsController oSmsController = new SmsController();
                oSmsController.SmsFunction(CompanyId, Sale.CustomerMobileNo, formattedBody, AddedBy, CurrentDate, Id, Type, Domain, 0);
            }
            if (EmailSettingsId != 0)
            {
                #region Email Subject
                string formattedSubject = "";

                formattedSubject = NotificationModulesSetting.EmailSubject;
                string[] arr1 = NotificationModulesSetting.EmailSubject.Split('{');
                List<string> list1 = new List<string>();

                foreach (var item in arr1)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list1.Add(item.Split('}')[0]);
                    }
                }


                foreach (var item in list1)
                {
                    if (item == "Business Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Proforma No")
                    {
                        formattedSubject = formattedSubject.Replace("{Proforma No}", Sale.InvoiceNo);
                    }
                    else if (item == "Proforma Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Proforma Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Name}", Sale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Mobile No}", Sale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Email}", Sale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Proforma Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Proforma Date}", Sale.SalesProformaDate.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedSubject = formattedSubject.Replace("{Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedSubject = formattedSubject.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedSubject = formattedSubject.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }
                #endregion

                #region EmailBody
                string formattedBody = NotificationModulesSetting.EmailBody;
                string[] array = NotificationModulesSetting.EmailBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Logo")
                    {
                        formattedBody = formattedBody.Replace("{Business Logo}", "<img src='" + webUrl + Branch.BusinessLogo + "' />");
                    }
                    else if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Proforma No")
                    {
                        formattedBody = formattedBody.Replace("{Proforma No}", Sale.InvoiceNo);
                    }
                    else if (item == "Proforma Url")
                    {
                        formattedBody = formattedBody.Replace("{Proforma Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", Sale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", Sale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", Sale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Proforma Date")
                    {
                        formattedBody = formattedBody.Replace("{Proforma Date}", Sale.SalesProformaDate.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }
                #endregion

                EmailController oEmailController = new EmailController();
                oEmailController.NotificationTemplate(CompanyId, Sale.CustomerEmailId, formattedSubject, formattedBody, CC, Bcc, AddedBy, CurrentDate, Id, Type, Domain);
            }
            if (WhatsappSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.WhatsappBody;
                string[] array = NotificationModulesSetting.WhatsappBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Proforma No")
                    {
                        formattedBody = formattedBody.Replace("{Proforma No}", Sale.InvoiceNo);
                    }
                    else if (item == "Proforma Url")
                    {
                        formattedBody = formattedBody.Replace("{Proforma Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", Sale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", Sale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", Sale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Proforma Date")
                    {
                        formattedBody = formattedBody.Replace("{Proforma Date}", Sale.SalesProformaDate.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }

                WhatsappController oWhatsappController = new WhatsappController();
                return oWhatsappController.WhatsappFunction(CompanyId, Sale.CustomerMobileNo, formattedBody, 0);
            }
            string[] arr = { "1", "", "" };
            return arr;
        }

        public dynamic DeliveryChallan(ClsNotificationModulesSettingsVm NotificationModulesSetting, long CompanyId, long Id, string CC, string Bcc, long SmsSettingsId, long EmailSettingsId, long WhatsappSettingsId, string Type, long AddedBy, DateTime CurrentDate, string Domain)
        {
            var Sale = oConnectionContext.DbClsDeliveryChallan.Where(a => a.DeliveryChallanId == Id).Select(a => new
            {
                a.BranchId,
                a.InvoiceNo,
                InvoiceUrl = Domain + "/deliverychallan/invoice?InvoiceId=" + a.InvoiceId,
                CustomerName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.Name).FirstOrDefault(),
                CustomerMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.MobileNo).FirstOrDefault(),
                CustomerEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.EmailId).FirstOrDefault(),
                PlaceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.PlaceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                a.DeliveryChallanDate,
                a.DeliveryChallanType,
                SellingPriceGroup = oConnectionContext.DbClsSellingPriceGroup.Where(b => b.SellingPriceGroupId == a.SellingPriceGroupId).
                Select(b => b.SellingPriceGroup).FirstOrDefault(),
                a.Notes,
                a.Subtotal,
                a.TotalDiscount,
                a.TotalTaxAmount,
                a.NetAmount,
                a.RoundOff,
                a.SpecialDiscount,
                a.GrandTotal
            }).FirstOrDefault();

            var Branch = oConnectionContext.DbClsBranch.Where(a => a.BranchId == Sale.BranchId).Select(a => new
            {
                BusinessName = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessName).FirstOrDefault(),
                BusinessLogo = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessLogo).FirstOrDefault(),
                a.Branch,
                a.BranchCode,
                a.Address,
                a.Zipcode,
                Country = oConnectionContext.DbClsCountry.Where(b => b.CountryId == a.CountryId).Select(b => b.Country).FirstOrDefault(),
                State = oConnectionContext.DbClsState.Where(b => b.StateId == a.StateId).Select(b => b.State).FirstOrDefault(),
                City = oConnectionContext.DbClsCity.Where(b => b.CityId == a.CityId).Select(b => b.City).FirstOrDefault(),
                //ContactPersonName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.Name).FirstOrDefault(),
                //ContactPersonMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.MobileNo).FirstOrDefault(),
                a.Mobile,
                a.AltMobileNo,
                a.Email,
                BusinessRegistrationNo = oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNo).FirstOrDefault(),
                BusinessRegistrationName = oConnectionContext.DbClsBusinessRegistrationName.Where(c => c.BusinessRegistrationNameId ==
                oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNameId).FirstOrDefault()).Select(c => c.Name).FirstOrDefault()
            }).FirstOrDefault();

            if (SmsSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.SmsBody;
                string[] array = NotificationModulesSetting.SmsBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Challan No")
                    {
                        formattedBody = formattedBody.Replace("{Challan No}", Sale.InvoiceNo);
                    }
                    else if (item == "Challan Url")
                    {
                        formattedBody = formattedBody.Replace("{Challan Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", Sale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", Sale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", Sale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Challan Date")
                    {
                        formattedBody = formattedBody.Replace("{Challan Date}", Sale.DeliveryChallanDate.ToString());
                    }
                    else if (item == "Challan Type")
                    {
                        formattedBody = formattedBody.Replace("{Challan Type}", Sale.DeliveryChallanType.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }

                SmsController oSmsController = new SmsController();
                oSmsController.SmsFunction(CompanyId, Sale.CustomerMobileNo, formattedBody, AddedBy, CurrentDate, Id, Type, Domain, 0);
            }
            if (EmailSettingsId != 0)
            {
                #region Email Subject
                string formattedSubject = "";

                formattedSubject = NotificationModulesSetting.EmailSubject;
                string[] arr1 = NotificationModulesSetting.EmailSubject.Split('{');
                List<string> list1 = new List<string>();

                foreach (var item in arr1)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list1.Add(item.Split('}')[0]);
                    }
                }


                foreach (var item in list1)
                {
                    if (item == "Business Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Challan No")
                    {
                        formattedSubject = formattedSubject.Replace("{Challan No}", Sale.InvoiceNo);
                    }
                    else if (item == "Challan Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Challan Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Name}", Sale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Mobile No}", Sale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Email}", Sale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Challan Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Challan Date}", Sale.DeliveryChallanDate.ToString());
                    }
                    else if (item == "Challan Type")
                    {
                        formattedSubject = formattedSubject.Replace("{Challan Type}", Sale.DeliveryChallanType.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedSubject = formattedSubject.Replace("{Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedSubject = formattedSubject.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedSubject = formattedSubject.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }
                #endregion

                #region EmailBody
                string formattedBody = NotificationModulesSetting.EmailBody;
                string[] array = NotificationModulesSetting.EmailBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Logo")
                    {
                        formattedBody = formattedBody.Replace("{Business Logo}", "<img src='" + webUrl + Branch.BusinessLogo + "' />");
                    }
                    else if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Challan No")
                    {
                        formattedBody = formattedBody.Replace("{Challan No}", Sale.InvoiceNo);
                    }
                    else if (item == "Challan Url")
                    {
                        formattedBody = formattedBody.Replace("{Challan Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", Sale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", Sale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", Sale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Challan Date")
                    {
                        formattedBody = formattedBody.Replace("{Challan Date}", Sale.DeliveryChallanDate.ToString());
                    }
                    else if (item == "Challan Type")
                    {
                        formattedBody = formattedBody.Replace("{Challan Type}", Sale.DeliveryChallanType.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }
                #endregion

                EmailController oEmailController = new EmailController();
                oEmailController.NotificationTemplate(CompanyId, Sale.CustomerEmailId, formattedSubject, formattedBody, CC, Bcc, AddedBy, CurrentDate, Id, Type, Domain);
            }
            if (WhatsappSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.WhatsappBody;
                string[] array = NotificationModulesSetting.WhatsappBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Challan No")
                    {
                        formattedBody = formattedBody.Replace("{Challan No}", Sale.InvoiceNo);
                    }
                    else if (item == "Challan Url")
                    {
                        formattedBody = formattedBody.Replace("{Challan Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", Sale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", Sale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", Sale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Challan Date")
                    {
                        formattedBody = formattedBody.Replace("{Challan Date}", Sale.DeliveryChallanDate.ToString());
                    }
                    else if (item == "Challan Type")
                    {
                        formattedBody = formattedBody.Replace("{Challan Type}", Sale.DeliveryChallanType.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }

                WhatsappController oWhatsappController = new WhatsappController();
                return oWhatsappController.WhatsappFunction(CompanyId, Sale.CustomerMobileNo, formattedBody, 0);
            }
            string[] arr = { "1", "", "" };
            return arr;
        }

        public dynamic SalesInvoice(ClsNotificationModulesSettingsVm NotificationModulesSetting, long CompanyId, long Id, string CC, string Bcc, long SmsSettingsId, long EmailSettingsId, long WhatsappSettingsId, string Type, long AddedBy, DateTime CurrentDate, string Domain)
        {
            var Sale = oConnectionContext.DbClsSales.Where(a => a.SalesId == Id).Select(a => new
            {
                a.BranchId,
                a.InvoiceNo,
                InvoiceUrl = Domain + (a.SalesType.ToLower() == "pos" ? "/sales/receipt?InvoiceId=" + a.InvoiceId : "/sales/invoice?InvoiceId=" + a.InvoiceId),
                CustomerName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.Name).FirstOrDefault(),
                CustomerMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.MobileNo).FirstOrDefault(),
                CustomerEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.EmailId).FirstOrDefault(),
                PlaceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.PlaceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                a.SalesDate,
                PaymentTerm = oConnectionContext.DbClsPaymentTerm.Where(b => b.PaymentTermId == a.PaymentTermId).Select(b => b.PaymentTerm).FirstOrDefault(),
                a.DueDate,
                SellingPriceGroup = oConnectionContext.DbClsSellingPriceGroup.Where(b => b.SellingPriceGroupId == a.SellingPriceGroupId).
                Select(b => b.SellingPriceGroup).FirstOrDefault(),
                a.Notes,
                a.Subtotal,
                a.TotalDiscount,
                a.TotalTaxAmount,
                a.NetAmount,
                a.RoundOff,
                a.SpecialDiscount,
                a.GrandTotal
            }).FirstOrDefault();

            var Branch = oConnectionContext.DbClsBranch.Where(a => a.BranchId == Sale.BranchId).Select(a => new
            {
                BusinessName = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessName).FirstOrDefault(),
                BusinessLogo = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessLogo).FirstOrDefault(),
                a.Branch,
                a.BranchCode,
                a.Address,
                a.Zipcode,
                Country = oConnectionContext.DbClsCountry.Where(b => b.CountryId == a.CountryId).Select(b => b.Country).FirstOrDefault(),
                State = oConnectionContext.DbClsState.Where(b => b.StateId == a.StateId).Select(b => b.State).FirstOrDefault(),
                City = oConnectionContext.DbClsCity.Where(b => b.CityId == a.CityId).Select(b => b.City).FirstOrDefault(),
                //ContactPersonName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.Name).FirstOrDefault(),
                //ContactPersonMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.MobileNo).FirstOrDefault(),
                a.Mobile,
                a.AltMobileNo,
                a.Email,
                BusinessRegistrationNo = oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNo).FirstOrDefault(),
                BusinessRegistrationName = oConnectionContext.DbClsBusinessRegistrationName.Where(c => c.BusinessRegistrationNameId ==
                oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNameId).FirstOrDefault()).Select(c => c.Name).FirstOrDefault()
            }).FirstOrDefault();

            if (SmsSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.SmsBody;
                string[] array = NotificationModulesSetting.SmsBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Invoice No}", Sale.InvoiceNo);
                    }
                    else if (item == "Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Invoice Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", Sale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", Sale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", Sale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Invoice Date")
                    {
                        formattedBody = formattedBody.Replace("{Invoice Date}", Sale.SalesDate.ToString());
                    }
                    else if (item == "Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Payment Term}", Sale.PaymentTerm);
                    }
                    else if (item == "Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Due Date}", Sale.DueDate.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }

                SmsController oSmsController = new SmsController();
                oSmsController.SmsFunction(CompanyId, Sale.CustomerMobileNo, formattedBody, AddedBy, CurrentDate, Id, Type, Domain, 0);
            }
            if (EmailSettingsId != 0)
            {
                #region Email Subject
                string formattedSubject = "";

                formattedSubject = NotificationModulesSetting.EmailSubject;
                string[] arr1 = NotificationModulesSetting.EmailSubject.Split('{');
                List<string> list1 = new List<string>();

                foreach (var item in arr1)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list1.Add(item.Split('}')[0]);
                    }
                }


                foreach (var item in list1)
                {
                    if (item == "Business Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Invoice No")
                    {
                        formattedSubject = formattedSubject.Replace("{Invoice No}", Sale.InvoiceNo);
                    }
                    else if (item == "Invoice Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Invoice Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Name}", Sale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Mobile No}", Sale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Email}", Sale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Invoice Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Invoice Date}", Sale.SalesDate.ToString());
                    }
                    else if (item == "Payment Term")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Term}", Sale.PaymentTerm);
                    }
                    else if (item == "Due Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Due Date}", Sale.DueDate.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedSubject = formattedSubject.Replace("{Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedSubject = formattedSubject.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedSubject = formattedSubject.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }
                #endregion

                #region EmailBody
                string formattedBody = NotificationModulesSetting.EmailBody;
                string[] array = NotificationModulesSetting.EmailBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Logo")
                    {
                        formattedBody = formattedBody.Replace("{Business Logo}", "<img src='" + webUrl + Branch.BusinessLogo + "' />");
                    }
                    else if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Invoice No}", Sale.InvoiceNo);
                    }
                    else if (item == "Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Invoice Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", Sale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", Sale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", Sale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Invoice Date")
                    {
                        formattedBody = formattedBody.Replace("{Invoice Date}", Sale.SalesDate.ToString());
                    }
                    else if (item == "Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Payment Term}", Sale.PaymentTerm);
                    }
                    else if (item == "Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Due Date}", Sale.DueDate.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }
                #endregion

                EmailController oEmailController = new EmailController();
                oEmailController.NotificationTemplate(CompanyId, Sale.CustomerEmailId, formattedSubject, formattedBody, CC, Bcc, AddedBy, CurrentDate, Id, Type, Domain);
            }
            if (WhatsappSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.WhatsappBody;
                string[] array = NotificationModulesSetting.WhatsappBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Invoice No}", Sale.InvoiceNo);
                    }
                    else if (item == "Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Invoice Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", Sale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", Sale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", Sale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Invoice Date")
                    {
                        formattedBody = formattedBody.Replace("{Invoice Date}", Sale.SalesDate.ToString());
                    }
                    else if (item == "Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Payment Term}", Sale.PaymentTerm);
                    }
                    else if (item == "Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Due Date}", Sale.DueDate.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }

                WhatsappController oWhatsappController = new WhatsappController();
                return oWhatsappController.WhatsappFunction(CompanyId, Sale.CustomerMobileNo, formattedBody, 0);
            }
            string[] arr = { "1", "", "" };
            return arr;
        }

        public dynamic SalesDebitNote(ClsNotificationModulesSettingsVm NotificationModulesSetting, long CompanyId, long Id, string CC, string Bcc, long SmsSettingsId, long EmailSettingsId, long WhatsappSettingsId, string Type, long AddedBy, DateTime CurrentDate, string Domain)
        {
            long ParentSalesId = oConnectionContext.DbClsSales.Where(a => a.SalesId == Id).Select(a => a.ParentId).FirstOrDefault();

            var ParentSale = oConnectionContext.DbClsSales.Where(a => a.SalesId == ParentSalesId).Select(a => new
            {
                a.BranchId,
                CustomerName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.Name).FirstOrDefault(),
                CustomerMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.MobileNo).FirstOrDefault(),
                CustomerEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.EmailId).FirstOrDefault(),
                InvoiceNo = a.InvoiceNo,
                InvoiceUrl = Domain + (a.SalesType.ToLower() == "pos" ? "/sales/receipt?InvoiceId=" + a.InvoiceId : "/sales/invoice?InvoiceId=" + a.InvoiceId),
                PlaceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.PlaceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                InvoiceDate = a.SalesDate,
                PaymentTerm = oConnectionContext.DbClsPaymentTerm.Where(b => b.PaymentTermId == a.PaymentTermId).Select(b => b.PaymentTerm).FirstOrDefault(),
                DueDate = a.DueDate,
                SellingPriceGroup = oConnectionContext.DbClsSellingPriceGroup.Where(b => b.SellingPriceGroupId == a.SellingPriceGroupId).
                Select(b => b.SellingPriceGroup).FirstOrDefault(),
                InvoiceNotes = a.Notes,
                Subtotal = a.Subtotal,
                TotalDiscount = a.TotalDiscount,
                TotalTaxAmount = a.TotalTaxAmount,
                NetAmount = a.NetAmount,
                RoundOff = a.RoundOff,
                SpecialDiscount = a.SpecialDiscount,
                GrandTotal = a.GrandTotal,
            }).FirstOrDefault();

            var Sale = oConnectionContext.DbClsSales.Where(a => a.SalesId == Id).Select(a => new
            {
                a.BranchId,
                PlaceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.PlaceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                Reason = oConnectionContext.DbClsSalesDebitNoteReason.Where(b => b.SalesDebitNoteReasonId == a.SalesDebitNoteReasonId).Select(b => b.SalesDebitNoteReason).FirstOrDefault(),
                Date = a.SalesDate,
                InvoiceNo = a.InvoiceNo,
                InvoiceUrl = Domain + (a.SalesType.ToLower() == "pos" ? "/sales/receipt?InvoiceId=" + a.InvoiceId : "/sales/invoice?InvoiceId=" + a.InvoiceId),
                PaymentTerm = oConnectionContext.DbClsPaymentTerm.Where(b => b.PaymentTermId == a.PaymentTermId).Select(b => b.PaymentTerm).FirstOrDefault(),
                DueDate = a.DueDate,
                SellingPriceGroup = oConnectionContext.DbClsSellingPriceGroup.Where(b => b.SellingPriceGroupId == a.SellingPriceGroupId).
                Select(b => b.SellingPriceGroup).FirstOrDefault(),
                InvoiceNotes = a.Notes,
                Subtotal = a.Subtotal,
                TotalDiscount = a.TotalDiscount,
                TotalTaxAmount = a.TotalTaxAmount,
                NetAmount = a.NetAmount,
                RoundOff = a.RoundOff,
                SpecialDiscount = a.SpecialDiscount,
                GrandTotal = a.GrandTotal
            }).FirstOrDefault();

            var Branch = oConnectionContext.DbClsBranch.Where(a => a.BranchId == Sale.BranchId).Select(a => new
            {
                BusinessName = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessName).FirstOrDefault(),
                BusinessLogo = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessLogo).FirstOrDefault(),
                a.Branch,
                a.BranchCode,
                a.Address,
                a.Zipcode,
                Country = oConnectionContext.DbClsCountry.Where(b => b.CountryId == a.CountryId).Select(b => b.Country).FirstOrDefault(),
                State = oConnectionContext.DbClsState.Where(b => b.StateId == a.StateId).Select(b => b.State).FirstOrDefault(),
                City = oConnectionContext.DbClsCity.Where(b => b.CityId == a.CityId).Select(b => b.City).FirstOrDefault(),
                //ContactPersonName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.Name).FirstOrDefault(),
                //ContactPersonMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.MobileNo).FirstOrDefault(),
                a.Mobile,
                a.AltMobileNo,
                a.Email,
                BusinessRegistrationNo = oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNo).FirstOrDefault(),
                BusinessRegistrationName = oConnectionContext.DbClsBusinessRegistrationName.Where(c => c.BusinessRegistrationNameId ==
                oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNameId).FirstOrDefault()).Select(c => c.Name).FirstOrDefault()
            }).FirstOrDefault();

            if (SmsSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.SmsBody;
                string[] array = NotificationModulesSetting.SmsBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", ParentSale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", ParentSale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", ParentSale.CustomerEmailId);
                    }
                    else if (item == "Parent Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice No}", ParentSale.InvoiceNo);
                    }
                    else if (item == "Parent Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Parent Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Parent Place Of Supply}", ParentSale.PlaceOfSupply);
                    }
                    else if (item == "Parent Invoice Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Date}", ParentSale.InvoiceDate.ToString());
                    }
                    else if (item == "Parent Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Parent Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Parent Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Parent Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Parent Selling Price Group}", ParentSale.SellingPriceGroup);
                    }
                    else if (item == "Parent Invoice Notes")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Notes}", ParentSale.InvoiceNotes);
                    }
                    else if (item == "Parent Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Parent Discount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Parent Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Parent Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Parent Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Parent Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Parent Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Debit Note Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Debit Note Reason")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Reason}", Sale.Reason);
                    }
                    else if (item == "Debit Note Date")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Date}", Sale.Date.ToString());
                    }
                    else if (item == "Debit Note Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Invoice No}", Sale.InvoiceNo);
                    }
                    else if (item == "Debit Note Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Invoice Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Debit Note Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Payment Term}", Sale.PaymentTerm);
                    }
                    else if (item == "Debit Note Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Due Date}", Sale.DueDate.ToString());
                    }
                    else if (item == "Debit Note Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Debit Note Notes")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Notes}", Sale.InvoiceNotes);
                    }
                    else if (item == "Debit Note Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Debit Note Discount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Debit Note Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Debit Note Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Debit Note Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Debit Note Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Total Amount}", Sale.GrandTotal.ToString());
                    }
                }

                SmsController oSmsController = new SmsController();
                oSmsController.SmsFunction(CompanyId, ParentSale.CustomerMobileNo, formattedBody, AddedBy, CurrentDate, Id, Type, Domain, 0);
            }
            if (EmailSettingsId != 0)
            {
                #region Email Subject
                string formattedSubject = "";

                formattedSubject = NotificationModulesSetting.EmailSubject;
                string[] arr1 = NotificationModulesSetting.EmailSubject.Split('{');
                List<string> list1 = new List<string>();

                foreach (var item in arr1)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list1.Add(item.Split('}')[0]);
                    }
                }


                foreach (var item in list1)
                {
                    if (item == "Business Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Name}", ParentSale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Mobile No}", ParentSale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Email}", ParentSale.CustomerEmailId);
                    }
                    else if (item == "Parent Invoice No")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Invoice No}", ParentSale.InvoiceNo);
                    }
                    else if (item == "Parent Invoice Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Invoice Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Parent Place Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Place Of Supply}", ParentSale.PlaceOfSupply);
                    }
                    else if (item == "Parent Invoice Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Invoice Date}", ParentSale.InvoiceDate.ToString());
                    }
                    else if (item == "Parent Payment Term")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Parent Due Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Parent Selling Price Group")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Selling Price Group}", ParentSale.SellingPriceGroup);
                    }
                    else if (item == "Parent Invoice Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Invoice Notes}", ParentSale.InvoiceNotes);
                    }
                    else if (item == "Parent Gross Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Parent Discount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Parent Tax Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Parent Net Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Parent Round Off")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Parent Total Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Debit Note Place Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Debit Note Reason")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Reason}", Sale.Reason);
                    }
                    else if (item == "Debit Note Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Date}", Sale.Date.ToString());
                    }
                    else if (item == "Debit Note Invoice No")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Invoice No}", Sale.InvoiceNo);
                    }
                    else if (item == "Debit Note Invoice Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Invoice Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Debit Note Payment Term")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Payment Term}", Sale.PaymentTerm);
                    }
                    else if (item == "Debit Note Due Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Due Date}", Sale.DueDate.ToString());
                    }
                    else if (item == "Debit Note Selling Price Group")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Debit Note Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Notes}", Sale.InvoiceNotes);
                    }
                    else if (item == "Debit Note Gross Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Debit Note Discount")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Debit Note Tax Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Debit Note Net Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Debit Note Round Off")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Debit Note Total Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Total Amount}", Sale.GrandTotal.ToString());
                    }
                }
                #endregion

                #region EmailBody
                string formattedBody = NotificationModulesSetting.EmailBody;
                string[] array = NotificationModulesSetting.EmailBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Logo")
                    {
                        formattedBody = formattedBody.Replace("{Business Logo}", "<img src='" + webUrl + Branch.BusinessLogo + "' />");
                    }
                    else if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", ParentSale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", ParentSale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", ParentSale.CustomerEmailId);
                    }
                    else if (item == "Parent Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice No}", ParentSale.InvoiceNo);
                    }
                    else if (item == "Parent Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Parent Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Parent Place Of Supply}", ParentSale.PlaceOfSupply);
                    }
                    else if (item == "Parent Invoice Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Date}", ParentSale.InvoiceDate.ToString());
                    }
                    else if (item == "Parent Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Parent Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Parent Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Parent Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Parent Selling Price Group}", ParentSale.SellingPriceGroup);
                    }
                    else if (item == "Parent Invoice Notes")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Notes}", ParentSale.InvoiceNotes);
                    }
                    else if (item == "Parent Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Parent Discount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Parent Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Parent Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Parent Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Parent Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Parent Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Debit Note Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Debit Note Reason")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Reason}", Sale.Reason);
                    }
                    else if (item == "Debit Note Date")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Date}", Sale.Date.ToString());
                    }
                    else if (item == "Debit Note Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Invoice No}", Sale.InvoiceNo);
                    }
                    else if (item == "Debit Note Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Invoice Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Debit Note Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Payment Term}", Sale.PaymentTerm);
                    }
                    else if (item == "Debit Note Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Due Date}", Sale.DueDate.ToString());
                    }
                    else if (item == "Debit Note Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Debit Note Notes")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Notes}", Sale.InvoiceNotes);
                    }
                    else if (item == "Debit Note Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Debit Note Discount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Debit Note Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Debit Note Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Debit Note Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Debit Note Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Total Amount}", Sale.GrandTotal.ToString());
                    }
                }
                #endregion

                EmailController oEmailController = new EmailController();
                oEmailController.NotificationTemplate(CompanyId, ParentSale.CustomerEmailId, formattedSubject, formattedBody, CC, Bcc, AddedBy, CurrentDate, Id, Type, Domain);
            }
            if (WhatsappSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.WhatsappBody;
                string[] array = NotificationModulesSetting.WhatsappBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", ParentSale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", ParentSale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", ParentSale.CustomerEmailId);
                    }
                    else if (item == "Parent Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice No}", ParentSale.InvoiceNo);
                    }
                    else if (item == "Parent Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Parent Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Parent Place Of Supply}", ParentSale.PlaceOfSupply);
                    }
                    else if (item == "Parent Invoice Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Date}", ParentSale.InvoiceDate.ToString());
                    }
                    else if (item == "Parent Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Parent Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Parent Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Parent Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Parent Selling Price Group}", ParentSale.SellingPriceGroup);
                    }
                    else if (item == "Parent Invoice Notes")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Notes}", ParentSale.InvoiceNotes);
                    }
                    else if (item == "Parent Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Parent Discount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Parent Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Parent Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Parent Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Parent Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Parent Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Debit Note Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Debit Note Reason")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Reason}", Sale.Reason);
                    }
                    else if (item == "Debit Note Date")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Date}", Sale.Date.ToString());
                    }
                    else if (item == "Debit Note Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Invoice No}", Sale.InvoiceNo);
                    }
                    else if (item == "Debit Note Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Invoice Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Debit Note Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Payment Term}", Sale.PaymentTerm);
                    }
                    else if (item == "Debit Note Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Due Date}", Sale.DueDate.ToString());
                    }
                    else if (item == "Debit Note Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Debit Note Notes")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Notes}", Sale.InvoiceNotes);
                    }
                    else if (item == "Debit Note Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Debit Note Discount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Debit Note Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Debit Note Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Debit Note Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Debit Note Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Total Amount}", Sale.GrandTotal.ToString());
                    }
                }

                WhatsappController oWhatsappController = new WhatsappController();
                return oWhatsappController.WhatsappFunction(CompanyId, ParentSale.CustomerMobileNo, formattedBody, 0);
            }
            string[] arr = { "1", "", "" };
            return arr;
        }

        public dynamic BillOfSupply(ClsNotificationModulesSettingsVm NotificationModulesSetting, long CompanyId, long Id, string CC, string Bcc, long SmsSettingsId, long EmailSettingsId, long WhatsappSettingsId, string Type, long AddedBy, DateTime CurrentDate, string Domain)
        {
            var Sale = oConnectionContext.DbClsSales.Where(a => a.SalesId == Id).Select(a => new
            {
                a.BranchId,
                a.InvoiceNo,
                InvoiceUrl = Domain + (a.SalesType.ToLower() == "pos" ? "/sales/receipt?InvoiceId=" + a.InvoiceId : "/sales/invoice?InvoiceId=" + a.InvoiceId),
                CustomerName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.Name).FirstOrDefault(),
                CustomerMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.MobileNo).FirstOrDefault(),
                CustomerEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.EmailId).FirstOrDefault(),
                PlaceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.PlaceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                a.SalesDate,
                PaymentTerm = oConnectionContext.DbClsPaymentTerm.Where(b => b.PaymentTermId == a.PaymentTermId).Select(b => b.PaymentTerm).FirstOrDefault(),
                a.DueDate,
                SellingPriceGroup = oConnectionContext.DbClsSellingPriceGroup.Where(b => b.SellingPriceGroupId == a.SellingPriceGroupId).
                Select(b => b.SellingPriceGroup).FirstOrDefault(),
                a.Notes,
                a.Subtotal,
                a.TotalDiscount,
                a.TotalTaxAmount,
                a.NetAmount,
                a.RoundOff,
                SpecialDiscount = a.SpecialDiscount,
                a.GrandTotal
            }).FirstOrDefault();

            var Branch = oConnectionContext.DbClsBranch.Where(a => a.BranchId == Sale.BranchId).Select(a => new
            {
                BusinessName = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessName).FirstOrDefault(),
                BusinessLogo = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessLogo).FirstOrDefault(),
                a.Branch,
                a.BranchCode,
                a.Address,
                a.Zipcode,
                Country = oConnectionContext.DbClsCountry.Where(b => b.CountryId == a.CountryId).Select(b => b.Country).FirstOrDefault(),
                State = oConnectionContext.DbClsState.Where(b => b.StateId == a.StateId).Select(b => b.State).FirstOrDefault(),
                City = oConnectionContext.DbClsCity.Where(b => b.CityId == a.CityId).Select(b => b.City).FirstOrDefault(),
                //ContactPersonName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.Name).FirstOrDefault(),
                //ContactPersonMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.MobileNo).FirstOrDefault(),
                a.Mobile,
                a.AltMobileNo,
                a.Email,
                BusinessRegistrationNo = oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNo).FirstOrDefault(),
                BusinessRegistrationName = oConnectionContext.DbClsBusinessRegistrationName.Where(c => c.BusinessRegistrationNameId ==
                oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNameId).FirstOrDefault()).Select(c => c.Name).FirstOrDefault()
            }).FirstOrDefault();

            if (SmsSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.SmsBody;
                string[] array = NotificationModulesSetting.SmsBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Invoice No}", Sale.InvoiceNo);
                    }
                    else if (item == "Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Invoice Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", Sale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", Sale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", Sale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Invoice Date")
                    {
                        formattedBody = formattedBody.Replace("{Invoice Date}", Sale.SalesDate.ToString());
                    }
                    else if (item == "Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Payment Term}", Sale.PaymentTerm);
                    }
                    else if (item == "Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Due Date}", Sale.DueDate.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }

                SmsController oSmsController = new SmsController();
                oSmsController.SmsFunction(CompanyId, Sale.CustomerMobileNo, formattedBody, AddedBy, CurrentDate, Id, Type, Domain, 0);
            }
            if (EmailSettingsId != 0)
            {
                #region Email Subject
                string formattedSubject = "";

                formattedSubject = NotificationModulesSetting.EmailSubject;
                string[] arr1 = NotificationModulesSetting.EmailSubject.Split('{');
                List<string> list1 = new List<string>();

                foreach (var item in arr1)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list1.Add(item.Split('}')[0]);
                    }
                }


                foreach (var item in list1)
                {
                    if (item == "Business Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Invoice No")
                    {
                        formattedSubject = formattedSubject.Replace("{Invoice No}", Sale.InvoiceNo);
                    }
                    else if (item == "Invoice Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Invoice Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Name}", Sale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Mobile No}", Sale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Email}", Sale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Invoice Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Invoice Date}", Sale.SalesDate.ToString());
                    }
                    else if (item == "Payment Term")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Term}", Sale.PaymentTerm);
                    }
                    else if (item == "Due Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Due Date}", Sale.DueDate.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedSubject = formattedSubject.Replace("{Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedSubject = formattedSubject.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedSubject = formattedSubject.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }
                #endregion

                #region EmailBody
                string formattedBody = NotificationModulesSetting.EmailBody;
                string[] array = NotificationModulesSetting.EmailBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Logo")
                    {
                        formattedBody = formattedBody.Replace("{Business Logo}", "<img src='" + webUrl + Branch.BusinessLogo + "' />");
                    }
                    else if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Invoice No}", Sale.InvoiceNo);
                    }
                    else if (item == "Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Invoice Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", Sale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", Sale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", Sale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Invoice Date")
                    {
                        formattedBody = formattedBody.Replace("{Invoice Date}", Sale.SalesDate.ToString());
                    }
                    else if (item == "Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Payment Term}", Sale.PaymentTerm);
                    }
                    else if (item == "Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Due Date}", Sale.DueDate.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }
                #endregion

                EmailController oEmailController = new EmailController();
                oEmailController.NotificationTemplate(CompanyId, Sale.CustomerEmailId, formattedSubject, formattedBody, CC, Bcc, AddedBy, CurrentDate, Id, Type, Domain);
            }
            if (WhatsappSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.WhatsappBody;
                string[] array = NotificationModulesSetting.WhatsappBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Invoice No}", Sale.InvoiceNo);
                    }
                    else if (item == "Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Invoice Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", Sale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", Sale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", Sale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Invoice Date")
                    {
                        formattedBody = formattedBody.Replace("{Invoice Date}", Sale.SalesDate.ToString());
                    }
                    else if (item == "Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Payment Term}", Sale.PaymentTerm);
                    }
                    else if (item == "Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Due Date}", Sale.DueDate.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }

                WhatsappController oWhatsappController = new WhatsappController();
                return oWhatsappController.WhatsappFunction(CompanyId, Sale.CustomerMobileNo, formattedBody, 0);
            }
            string[] arr = { "1", "", "" };
            return arr;
        }

        public dynamic Pos(ClsNotificationModulesSettingsVm NotificationModulesSetting, long CompanyId, long Id, string CC, string Bcc, long SmsSettingsId, long EmailSettingsId, long WhatsappSettingsId, string Type, long AddedBy, DateTime CurrentDate, string Domain)
        {
            var Sale = oConnectionContext.DbClsSales.Where(a => a.SalesId == Id).Select(a => new
            {
                a.BranchId,
                a.InvoiceNo,
                InvoiceUrl = Domain + (a.SalesType.ToLower() == "pos" ? "/sales/receipt?InvoiceId=" + a.InvoiceId : "/sales/invoice?InvoiceId=" + a.InvoiceId),
                CustomerName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.Name).FirstOrDefault(),
                CustomerMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.MobileNo).FirstOrDefault(),
                CustomerEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.EmailId).FirstOrDefault(),
                PlaceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.PlaceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                a.SalesDate,
                PaymentTerm = oConnectionContext.DbClsPaymentTerm.Where(b => b.PaymentTermId == a.PaymentTermId).Select(b => b.PaymentTerm).FirstOrDefault(),
                a.DueDate,
                SellingPriceGroup = oConnectionContext.DbClsSellingPriceGroup.Where(b => b.SellingPriceGroupId == a.SellingPriceGroupId).
                Select(b => b.SellingPriceGroup).FirstOrDefault(),
                a.Notes,
                a.Subtotal,
                a.TotalDiscount,
                a.TotalTaxAmount,
                a.NetAmount,
                a.RoundOff,
                SpecialDiscount = a.SpecialDiscount,
                a.GrandTotal
            }).FirstOrDefault();

            var Branch = oConnectionContext.DbClsBranch.Where(a => a.BranchId == Sale.BranchId).Select(a => new
            {
                BusinessName = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessName).FirstOrDefault(),
                BusinessLogo = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessLogo).FirstOrDefault(),
                a.Branch,
                a.BranchCode,
                a.Address,
                a.Zipcode,
                Country = oConnectionContext.DbClsCountry.Where(b => b.CountryId == a.CountryId).Select(b => b.Country).FirstOrDefault(),
                State = oConnectionContext.DbClsState.Where(b => b.StateId == a.StateId).Select(b => b.State).FirstOrDefault(),
                City = oConnectionContext.DbClsCity.Where(b => b.CityId == a.CityId).Select(b => b.City).FirstOrDefault(),
                //ContactPersonName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.Name).FirstOrDefault(),
                //ContactPersonMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.MobileNo).FirstOrDefault(),
                a.Mobile,
                a.AltMobileNo,
                a.Email,
                BusinessRegistrationNo = oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNo).FirstOrDefault(),
                BusinessRegistrationName = oConnectionContext.DbClsBusinessRegistrationName.Where(c => c.BusinessRegistrationNameId ==
                oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNameId).FirstOrDefault()).Select(c => c.Name).FirstOrDefault()
            }).FirstOrDefault();

            if (SmsSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.SmsBody;
                string[] array = NotificationModulesSetting.SmsBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Invoice No}", Sale.InvoiceNo);
                    }
                    else if (item == "Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Invoice Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", Sale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", Sale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", Sale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Invoice Date")
                    {
                        formattedBody = formattedBody.Replace("{Invoice Date}", Sale.SalesDate.ToString());
                    }
                    else if (item == "Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Payment Term}", Sale.PaymentTerm);
                    }
                    else if (item == "Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Due Date}", Sale.DueDate.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }

                SmsController oSmsController = new SmsController();
                oSmsController.SmsFunction(CompanyId, Sale.CustomerMobileNo, formattedBody, AddedBy, CurrentDate, Id, Type, Domain, 0);
            }
            if (EmailSettingsId != 0)
            {
                #region Email Subject
                string formattedSubject = "";

                formattedSubject = NotificationModulesSetting.EmailSubject;
                string[] arr1 = NotificationModulesSetting.EmailSubject.Split('{');
                List<string> list1 = new List<string>();

                foreach (var item in arr1)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list1.Add(item.Split('}')[0]);
                    }
                }


                foreach (var item in list1)
                {
                    if (item == "Business Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Invoice No")
                    {
                        formattedSubject = formattedSubject.Replace("{Invoice No}", Sale.InvoiceNo);
                    }
                    else if (item == "Invoice Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Invoice Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Name}", Sale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Mobile No}", Sale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Email}", Sale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Invoice Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Invoice Date}", Sale.SalesDate.ToString());
                    }
                    else if (item == "Payment Term")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Term}", Sale.PaymentTerm);
                    }
                    else if (item == "Due Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Due Date}", Sale.DueDate.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedSubject = formattedSubject.Replace("{Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedSubject = formattedSubject.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedSubject = formattedSubject.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }
                #endregion

                #region EmailBody
                string formattedBody = NotificationModulesSetting.EmailBody;
                string[] array = NotificationModulesSetting.EmailBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Logo")
                    {
                        formattedBody = formattedBody.Replace("{Business Logo}", "<img src='" + webUrl + Branch.BusinessLogo + "' />");
                    }
                    else if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Invoice No}", Sale.InvoiceNo);
                    }
                    else if (item == "Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Invoice Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", Sale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", Sale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", Sale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Invoice Date")
                    {
                        formattedBody = formattedBody.Replace("{Invoice Date}", Sale.SalesDate.ToString());
                    }
                    else if (item == "Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Payment Term}", Sale.PaymentTerm);
                    }
                    else if (item == "Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Due Date}", Sale.DueDate.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }
                #endregion

                EmailController oEmailController = new EmailController();
                oEmailController.NotificationTemplate(CompanyId, Sale.CustomerEmailId, formattedSubject, formattedBody, CC, Bcc, AddedBy, CurrentDate, Id, Type, Domain);
            }
            if (WhatsappSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.WhatsappBody;
                string[] array = NotificationModulesSetting.WhatsappBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Invoice No}", Sale.InvoiceNo);
                    }
                    else if (item == "Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Invoice Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", Sale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", Sale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", Sale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Invoice Date")
                    {
                        formattedBody = formattedBody.Replace("{Invoice Date}", Sale.SalesDate.ToString());
                    }
                    else if (item == "Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Payment Term}", Sale.PaymentTerm);
                    }
                    else if (item == "Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Due Date}", Sale.DueDate.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Selling Price Group}", Sale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }

                WhatsappController oWhatsappController = new WhatsappController();
                return oWhatsappController.WhatsappFunction(CompanyId, Sale.CustomerMobileNo, formattedBody, 0);
            }
            string[] arr = { "1", "", "" };
            return arr;
        }

        public dynamic SalesCreditNote(ClsNotificationModulesSettingsVm NotificationModulesSetting, long CompanyId, long Id, string CC, string Bcc, long SmsSettingsId, long EmailSettingsId, long WhatsappSettingsId, string Type, long AddedBy, DateTime CurrentDate, string Domain)
        {
            long ParentSalesId = oConnectionContext.DbClsSalesReturn.Where(a => a.SalesReturnId == Id).Select(a => a.SalesId).FirstOrDefault();

            var ParentSale = oConnectionContext.DbClsSales.Where(a => a.SalesId == ParentSalesId).Select(a => new
            {
                a.BranchId,
                CustomerName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.Name).FirstOrDefault(),
                CustomerMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.MobileNo).FirstOrDefault(),
                CustomerEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.EmailId).FirstOrDefault(),
                InvoiceNo = a.InvoiceNo,
                InvoiceUrl = Domain + (a.SalesType.ToLower() == "pos" ? "/sales/receipt?InvoiceId=" + a.InvoiceId : "/sales/invoice?InvoiceId=" + a.InvoiceId),
                PlaceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.PlaceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                InvoiceDate = a.SalesDate,
                PaymentTerm = oConnectionContext.DbClsPaymentTerm.Where(b => b.PaymentTermId == a.PaymentTermId).Select(b => b.PaymentTerm).FirstOrDefault(),
                DueDate = a.DueDate,
                SellingPriceGroup = oConnectionContext.DbClsSellingPriceGroup.Where(b => b.SellingPriceGroupId == a.SellingPriceGroupId).
                Select(b => b.SellingPriceGroup).FirstOrDefault(),
                InvoiceNotes = a.Notes,
                Subtotal = a.Subtotal,
                TotalDiscount = a.TotalDiscount,
                TotalTaxAmount = a.TotalTaxAmount,
                NetAmount = a.NetAmount,
                RoundOff = a.RoundOff,
                SpecialDiscount = a.SpecialDiscount,
                GrandTotal = a.GrandTotal,
                a.SalesType
            }).FirstOrDefault();

            var Sale = oConnectionContext.DbClsSalesReturn.Where(a => a.SalesReturnId == Id).Select(a => new
            {
                a.BranchId,
                PlaceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.PlaceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                Reason = oConnectionContext.DbClsSalesCreditNoteReason.Where(b => b.SalesCreditNoteReasonId == a.SalesCreditNoteReasonId).Select(b => b.SalesCreditNoteReason).FirstOrDefault(),
                Date = a.Date,
                InvoiceNo = a.InvoiceNo,
                InvoiceUrl = Domain + (ParentSale.SalesType.ToLower() == "pos" ? "/sales/salesreturnreceipt?InvoiceId=" + a.InvoiceId : "/sales/salesreturninvoice?InvoiceId=" + a.InvoiceId),
                InvoiceNotes = a.Notes,
                Subtotal = a.Subtotal,
                TotalDiscount = a.TotalDiscount,
                TotalTaxAmount = a.TotalTaxAmount,
                NetAmount = a.NetAmount,
                RoundOff = a.RoundOff,
                SpecialDiscount = a.SpecialDiscount,
                GrandTotal = a.GrandTotal
            }).FirstOrDefault();

            var Branch = oConnectionContext.DbClsBranch.Where(a => a.BranchId == Sale.BranchId).Select(a => new
            {
                BusinessName = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessName).FirstOrDefault(),
                BusinessLogo = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessLogo).FirstOrDefault(),
                a.Branch,
                a.BranchCode,
                a.Address,
                a.Zipcode,
                Country = oConnectionContext.DbClsCountry.Where(b => b.CountryId == a.CountryId).Select(b => b.Country).FirstOrDefault(),
                State = oConnectionContext.DbClsState.Where(b => b.StateId == a.StateId).Select(b => b.State).FirstOrDefault(),
                City = oConnectionContext.DbClsCity.Where(b => b.CityId == a.CityId).Select(b => b.City).FirstOrDefault(),
                //ContactPersonName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.Name).FirstOrDefault(),
                //ContactPersonMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.MobileNo).FirstOrDefault(),
                a.Mobile,
                a.AltMobileNo,
                a.Email,
                BusinessRegistrationNo = oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNo).FirstOrDefault(),
                BusinessRegistrationName = oConnectionContext.DbClsBusinessRegistrationName.Where(c => c.BusinessRegistrationNameId ==
                oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNameId).FirstOrDefault()).Select(c => c.Name).FirstOrDefault()
            }).FirstOrDefault();

            if (SmsSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.SmsBody;
                string[] array = NotificationModulesSetting.SmsBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", ParentSale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", ParentSale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", ParentSale.CustomerEmailId);
                    }
                    else if (item == "Parent Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice No}", ParentSale.InvoiceNo);
                    }
                    else if (item == "Parent Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Parent Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Parent Place Of Supply}", ParentSale.PlaceOfSupply);
                    }
                    else if (item == "Parent Invoice Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Date}", ParentSale.InvoiceDate.ToString());
                    }
                    else if (item == "Parent Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Parent Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Parent Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Parent Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Parent Selling Price Group}", ParentSale.SellingPriceGroup);
                    }
                    else if (item == "Parent Invoice Notes")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Notes}", ParentSale.InvoiceNotes);
                    }
                    else if (item == "Parent Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Parent Discount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Parent Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Parent Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Parent Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Parent Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Parent Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Credit Note Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Credit Note Reason")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Reason}", Sale.Reason);
                    }
                    else if (item == "Credit Note Date")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Date}", Sale.Date.ToString());
                    }
                    else if (item == "Credit Note Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Invoice No}", Sale.InvoiceNo);
                    }
                    else if (item == "Credit Note Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Invoice Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Credit Note Notes")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Notes}", Sale.InvoiceNotes);
                    }
                    else if (item == "Credit Note Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Credit Note Discount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Credit Note Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Credit Note Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Credit Note Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Credit Note Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Total Amount}", Sale.GrandTotal.ToString());
                    }
                }

                SmsController oSmsController = new SmsController();
                oSmsController.SmsFunction(CompanyId, ParentSale.CustomerMobileNo, formattedBody, AddedBy, CurrentDate, Id, Type, Domain, 0);
            }
            if (EmailSettingsId != 0)
            {
                #region Email Subject
                string formattedSubject = "";

                formattedSubject = NotificationModulesSetting.EmailSubject;
                string[] arr1 = NotificationModulesSetting.EmailSubject.Split('{');
                List<string> list1 = new List<string>();

                foreach (var item in arr1)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list1.Add(item.Split('}')[0]);
                    }
                }


                foreach (var item in list1)
                {
                    if (item == "Business Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Name}", ParentSale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Mobile No}", ParentSale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Email}", ParentSale.CustomerEmailId);
                    }
                    else if (item == "Parent Invoice No")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Invoice No}", ParentSale.InvoiceNo);
                    }
                    else if (item == "Parent Invoice Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Invoice Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Parent Place Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Place Of Supply}", ParentSale.PlaceOfSupply);
                    }
                    else if (item == "Parent Invoice Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Invoice Date}", ParentSale.InvoiceDate.ToString());
                    }
                    else if (item == "Parent Payment Term")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Parent Due Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Parent Selling Price Group")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Selling Price Group}", ParentSale.SellingPriceGroup);
                    }
                    else if (item == "Parent Invoice Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Invoice Notes}", ParentSale.InvoiceNotes);
                    }
                    else if (item == "Parent Gross Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Parent Discount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Parent Tax Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Parent Net Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Parent Round Off")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Parent Total Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Credit Note Place Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Credit Note Reason")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Reason}", Sale.Reason);
                    }
                    else if (item == "Credit Note Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Date}", Sale.Date.ToString());
                    }
                    else if (item == "Credit Note Invoice No")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Invoice No}", Sale.InvoiceNo);
                    }
                    else if (item == "Credit Note Invoice Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Invoice Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Credit Note Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Notes}", Sale.InvoiceNotes);
                    }
                    else if (item == "Credit Note Gross Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Credit Note Discount")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Credit Note Tax Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Credit Note Net Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Credit Note Round Off")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Credit Note Total Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Total Amount}", Sale.GrandTotal.ToString());
                    }
                }
                #endregion


                #region EmailBody
                string formattedBody = NotificationModulesSetting.EmailBody;
                string[] array = NotificationModulesSetting.EmailBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Logo")
                    {
                        formattedBody = formattedBody.Replace("{Business Logo}", "<img src='" + webUrl + Branch.BusinessLogo + "' />");
                    }
                    else if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", ParentSale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", ParentSale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", ParentSale.CustomerEmailId);
                    }
                    else if (item == "Parent Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice No}", ParentSale.InvoiceNo);
                    }
                    else if (item == "Parent Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Parent Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Parent Place Of Supply}", ParentSale.PlaceOfSupply);
                    }
                    else if (item == "Parent Invoice Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Date}", ParentSale.InvoiceDate.ToString());
                    }
                    else if (item == "Parent Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Parent Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Parent Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Parent Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Parent Selling Price Group}", ParentSale.SellingPriceGroup);
                    }
                    else if (item == "Parent Invoice Notes")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Notes}", ParentSale.InvoiceNotes);
                    }
                    else if (item == "Parent Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Parent Discount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Parent Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Parent Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Parent Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Parent Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Parent Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Credit Note Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Credit Note Reason")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Reason}", Sale.Reason);
                    }
                    else if (item == "Credit Note Date")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Date}", Sale.Date.ToString());
                    }
                    else if (item == "Credit Note Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Invoice No}", Sale.InvoiceNo);
                    }
                    else if (item == "Credit Note Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Invoice Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Credit Note Notes")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Notes}", Sale.InvoiceNotes);
                    }
                    else if (item == "Credit Note Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Credit Note Discount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Credit Note Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Credit Note Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Credit Note Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Credit Note Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Total Amount}", Sale.GrandTotal.ToString());
                    }
                }
                #endregion


                EmailController oEmailController = new EmailController();
                oEmailController.NotificationTemplate(CompanyId, ParentSale.CustomerEmailId, formattedSubject, formattedBody, CC, Bcc, AddedBy, CurrentDate, Id, Type, Domain);
            }
            if (WhatsappSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.WhatsappBody;
                string[] array = NotificationModulesSetting.WhatsappBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", ParentSale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", ParentSale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", ParentSale.CustomerEmailId);
                    }
                    else if (item == "Parent Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice No}", ParentSale.InvoiceNo);
                    }
                    else if (item == "Parent Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Parent Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Parent Place Of Supply}", ParentSale.PlaceOfSupply);
                    }
                    else if (item == "Parent Invoice Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Date}", ParentSale.InvoiceDate.ToString());
                    }
                    else if (item == "Parent Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Parent Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Parent Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Parent Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Parent Selling Price Group}", ParentSale.SellingPriceGroup);
                    }
                    else if (item == "Parent Invoice Notes")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Notes}", ParentSale.InvoiceNotes);
                    }
                    else if (item == "Parent Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Parent Discount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Parent Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Parent Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Parent Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Parent Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Parent Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Credit Note Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Credit Note Reason")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Reason}", Sale.Reason);
                    }
                    else if (item == "Credit Note Date")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Date}", Sale.Date.ToString());
                    }
                    else if (item == "Credit Note Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Invoice No}", Sale.InvoiceNo);
                    }
                    else if (item == "Credit Note Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Invoice Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Credit Note Notes")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Notes}", Sale.InvoiceNotes);
                    }
                    else if (item == "Credit Note Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Credit Note Discount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Credit Note Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Credit Note Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Credit Note Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Credit Note Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Total Amount}", Sale.GrandTotal.ToString());
                    }
                }

                WhatsappController oWhatsappController = new WhatsappController();
                return oWhatsappController.WhatsappFunction(CompanyId, ParentSale.CustomerMobileNo, formattedBody, 0);
            }
            string[] arr = { "1", "", "" };
            return arr;
        }

        public dynamic PaymentLink(ClsNotificationModulesSettingsVm NotificationModulesSetting, long CompanyId, long Id, string CC, string Bcc, long SmsSettingsId, long EmailSettingsId, long WhatsappSettingsId, string Type, long AddedBy, DateTime CurrentDate, string Domain)
        {
            var Payment = oConnectionContext.DbClsPaymentLink.Where(a => a.PaymentLinkId == Id).Select(a => new
            {
                a.BranchId,
                CustomerName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.Name).FirstOrDefault(),
                CustomerEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.EmailId).FirstOrDefault(),
                CustomerMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.MobileNo).FirstOrDefault(),
                a.ReferenceNo,
                PlaceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.PlaceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                Tax = oConnectionContext.DbClsTax.Where(b => b.TaxId == a.TaxId).Select(b => b.Tax).FirstOrDefault(),
                a.AddedOn,
                a.Amount,
                a.LinkExpirationDate,
                a.Notes,
                InvoiceUrl = Domain + "/paymentlink/securepay?ReferenceId=" + a.ReferenceId,
                PaymentType = oConnectionContext.DbClsPaymentType.Where(b => b.PaymentTypeId == Id).Select(b => b.PaymentType).FirstOrDefault(),
            }).FirstOrDefault();

            var Branch = oConnectionContext.DbClsBranch.Where(a => a.BranchId == Payment.BranchId).Select(a => new
            {
                BusinessName = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessName).FirstOrDefault(),
                BusinessLogo = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessLogo).FirstOrDefault(),
                a.Branch,
                a.BranchCode,
                a.Address,
                a.Zipcode,
                Country = oConnectionContext.DbClsCountry.Where(b => b.CountryId == a.CountryId).Select(b => b.Country).FirstOrDefault(),
                State = oConnectionContext.DbClsState.Where(b => b.StateId == a.StateId).Select(b => b.State).FirstOrDefault(),
                City = oConnectionContext.DbClsCity.Where(b => b.CityId == a.CityId).Select(b => b.City).FirstOrDefault(),
                //ContactPersonName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.Name).FirstOrDefault(),
                //ContactPersonMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.MobileNo).FirstOrDefault(),
                a.Mobile,
                a.AltMobileNo,
                a.Email,
                BusinessRegistrationNo = oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNo).FirstOrDefault(),
                BusinessRegistrationName = oConnectionContext.DbClsBusinessRegistrationName.Where(c => c.BusinessRegistrationNameId ==
                oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNameId).FirstOrDefault()).Select(c => c.Name).FirstOrDefault()
            }).FirstOrDefault();

            if (SmsSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.SmsBody;
                string[] array = NotificationModulesSetting.SmsBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", Payment.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", Payment.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", Payment.CustomerEmailId);
                    }
                    else if (item == "Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Place Of Supply}", Payment.PlaceOfSupply);
                    }
                    else if (item == "Tax")
                    {
                        formattedBody = formattedBody.Replace("{Tax}", Payment.Tax);
                    }
                    else if (item == "Payment Link Date")
                    {
                        formattedBody = formattedBody.Replace("{Payment Link Date}", Payment.AddedOn.ToString());
                    }
                    else if (item == "Amount")
                    {
                        formattedBody = formattedBody.Replace("{Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Expiration Date")
                    {
                        formattedBody = formattedBody.Replace("{Expiration Date}", Payment.LinkExpirationDate.ToString());
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Payment.Notes.ToString());
                    }
                    else if (item == "Payment Link Url")
                    {
                        formattedBody = formattedBody.Replace("{Payment Link Url}", Payment.InvoiceUrl.ToString());
                    }
                }

                SmsController oSmsController = new SmsController();
                oSmsController.SmsFunction(CompanyId, Payment.CustomerMobileNo, formattedBody, AddedBy, CurrentDate, Id, Type, Domain, 0);
            }
            if (EmailSettingsId != 0)
            {
                #region Email Subject
                string formattedSubject = "";

                formattedSubject = NotificationModulesSetting.EmailSubject;
                string[] arr1 = NotificationModulesSetting.EmailSubject.Split('{');
                List<string> list1 = new List<string>();

                foreach (var item in arr1)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list1.Add(item.Split('}')[0]);
                    }
                }


                foreach (var item in list1)
                {
                    if (item == "Business Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Name}", Payment.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Mobile No}", Payment.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Email}", Payment.CustomerEmailId);
                    }
                    else if (item == "Reference No")
                    {
                        formattedSubject = formattedSubject.Replace("{Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Place Of Supply}", Payment.PlaceOfSupply);
                    }
                    else if (item == "Tax")
                    {
                        formattedSubject = formattedSubject.Replace("{Tax}", Payment.Tax);
                    }
                    else if (item == "Payment Link Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Link Date}", Payment.AddedOn.ToString());
                    }
                    else if (item == "Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Expiration Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Expiration Date}", Payment.LinkExpirationDate.ToString());
                    }
                    else if (item == "Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Notes}", Payment.Notes.ToString());
                    }
                    else if (item == "Payment Link Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Link Url}", Payment.InvoiceUrl.ToString());
                    }
                }
                #endregion


                #region EmailBody
                string formattedBody = NotificationModulesSetting.EmailBody;
                string[] array = NotificationModulesSetting.EmailBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", Payment.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", Payment.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", Payment.CustomerEmailId);
                    }
                    else if (item == "Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Place Of Supply}", Payment.PlaceOfSupply);
                    }
                    else if (item == "Tax")
                    {
                        formattedBody = formattedBody.Replace("{Tax}", Payment.Tax);
                    }
                    else if (item == "Payment Link Date")
                    {
                        formattedBody = formattedBody.Replace("{Payment Link Date}", Payment.AddedOn.ToString());
                    }
                    else if (item == "Amount")
                    {
                        formattedBody = formattedBody.Replace("{Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Expiration Date")
                    {
                        formattedBody = formattedBody.Replace("{Expiration Date}", Payment.LinkExpirationDate.ToString());
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Payment.Notes.ToString());
                    }
                    else if (item == "Payment Link Url")
                    {
                        formattedBody = formattedBody.Replace("{Payment Link Url}", Payment.InvoiceUrl.ToString());
                    }
                }
                #endregion


                EmailController oEmailController = new EmailController();
                oEmailController.NotificationTemplate(CompanyId, Payment.CustomerEmailId, formattedSubject, formattedBody, CC, Bcc, AddedBy, CurrentDate, Id, Type, Domain);
            }
            if (WhatsappSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.WhatsappBody;
                string[] array = NotificationModulesSetting.WhatsappBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", Payment.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", Payment.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", Payment.CustomerEmailId);
                    }
                    else if (item == "Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Place Of Supply}", Payment.PlaceOfSupply);
                    }
                    else if (item == "Tax")
                    {
                        formattedBody = formattedBody.Replace("{Tax}", Payment.Tax);
                    }
                    else if (item == "Payment Link Date")
                    {
                        formattedBody = formattedBody.Replace("{Payment Link Date}", Payment.AddedOn.ToString());
                    }
                    else if (item == "Amount")
                    {
                        formattedBody = formattedBody.Replace("{Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Expiration Date")
                    {
                        formattedBody = formattedBody.Replace("{Expiration Date}", Payment.LinkExpirationDate.ToString());
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Payment.Notes.ToString());
                    }
                    else if (item == "Payment Link Url")
                    {
                        formattedBody = formattedBody.Replace("{Payment Link Url}", Payment.InvoiceUrl.ToString());
                    }
                }

                WhatsappController oWhatsappController = new WhatsappController();
                return oWhatsappController.WhatsappFunction(CompanyId, Payment.CustomerMobileNo, formattedBody, 0);
            }
            string[] arr = { "1", "", "" };
            return arr;
        }

        public dynamic SalesInvoicePayment(ClsNotificationModulesSettingsVm NotificationModulesSetting, long CompanyId, long Id, string CC, string Bcc, long SmsSettingsId, long EmailSettingsId, long WhatsappSettingsId, string Type, long AddedBy, DateTime CurrentDate, string Domain)
        {
            var Payment = oConnectionContext.DbClsCustomerPayment.Where(a => a.CustomerPaymentId == Id).Select(a => new
            {
                CustomerName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.Name).FirstOrDefault(),
                CustomerMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.MobileNo).FirstOrDefault(),
                CustomerEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.EmailId).FirstOrDefault(),
                a.Amount,
                a.PaymentDate,
                PaymentType = oConnectionContext.DbClsPaymentType.Where(b => b.PaymentTypeId == Id).Select(b => b.PaymentType).FirstOrDefault(),
                a.ReferenceNo,
                a.Notes,
                InvoiceUrl = Domain + "/sales/PaymentReceipt?ReferenceId=" + a.ReferenceId,
                a.SalesId,
                a.BranchId,
                CustomerPaymentIds = oConnectionContext.DbClsCustomerPayment.Where(c => c.ParentId == a.CustomerPaymentId && c.IsDeleted == false
                && c.IsCancelled == false).Select(c => new
                {
                    BranchId = oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.BranchId).FirstOrDefault(),
                    InvoiceNo = oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.InvoiceNo).FirstOrDefault(),
                    InvoiceUrl = Domain + (
    oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.SalesType).FirstOrDefault().ToLower() == "pos"
    ? "/sales/receipt?InvoiceId=" + c.SalesId
    : "/sales/invoice?InvoiceId=" + c.SalesId
),
                    //                    CustomerName = oConnectionContext.DbClsUser.Where(b => b.UserId ==
                    //                        oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.CustomerId).FirstOrDefault()
                    //).Select(b => b.Name).FirstOrDefault(),
                    //                    CustomerMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId ==
                    //                        oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.CustomerId).FirstOrDefault()
                    //).Select(b => b.MobileNo).FirstOrDefault(),
                    //                    CustomerEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId ==
                    //                        oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.CustomerId).FirstOrDefault()
                    //).Select(b => b.EmailId).FirstOrDefault(),
                    PlaceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId ==
                        oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.PlaceOfSupplyId).FirstOrDefault()
).Select(b => b.State).FirstOrDefault(),
                    InvoiceDate = oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.SalesDate).FirstOrDefault(),
                    PaymentTerm = oConnectionContext.DbClsPaymentTerm.Where(b => b.PaymentTermId ==
                        oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.PaymentTermId).FirstOrDefault()
).Select(b => b.PaymentTerm).FirstOrDefault(),
                    DueDate = oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.DueDate).FirstOrDefault(),
                    SellingPriceGroup = oConnectionContext.DbClsSellingPriceGroup.Where(b => b.SellingPriceGroupId ==
                        oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.SellingPriceGroupId).FirstOrDefault()
).Select(b => b.SellingPriceGroup).FirstOrDefault(),
                    InvoiceNotes = oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.Notes).FirstOrDefault(),
                    Subtotal = oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.Subtotal).FirstOrDefault(),
                    TotalDiscount = oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.TotalDiscount).FirstOrDefault(),
                    TotalTaxAmount = oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.TotalTaxAmount).FirstOrDefault(),
                    NetAmount = oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.NetAmount).FirstOrDefault(),
                    RoundOff = oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.RoundOff).FirstOrDefault(),
                    GrandTotal = oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.GrandTotal).FirstOrDefault(),
                    SalesType = oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.SalesType).FirstOrDefault(),
                    Paid = oConnectionContext.DbClsCustomerPayment.Where(b =>
                        b.Type.ToLower() == "sales payment" && b.IsDeleted == false && b.IsCancelled == false && b.SalesId == c.SalesId
).Select(b => b.Amount).DefaultIfEmpty().Sum(),
                    Due = (
    (oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.GrandTotal).FirstOrDefault()
    - oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.WriteOffAmount).FirstOrDefault())
    -
    (oConnectionContext.DbClsCustomerPayment.Where(b =>
        b.Type.ToLower() == "sales payment" && b.IsDeleted == false && b.IsCancelled == false && b.SalesId == c.SalesId
    ).Select(b => b.Amount).DefaultIfEmpty().Sum()
    -
    oConnectionContext.DbClsCustomerPayment.Where(b =>
        b.Type == "Change Return" && b.IsDeleted == false && b.IsCancelled == false && b.SalesId == c.SalesId
    ).Select(b => b.Amount).DefaultIfEmpty().Sum())
)
                }).Union(
                    oConnectionContext.DbClsCustomerPayment.Where(c => c.CustomerPaymentId == a.CustomerPaymentId && c.IsDirectPayment == true).Select(c => new
                    {
                        BranchId = oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.BranchId).FirstOrDefault(),
                        InvoiceNo = oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.InvoiceNo).FirstOrDefault(),
                        InvoiceUrl = Domain + (
    oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.SalesType).FirstOrDefault().ToLower() == "pos"
    ? "/sales/receipt?InvoiceId=" + c.SalesId
    : "/sales/invoice?InvoiceId=" + c.SalesId
),
                        //                        CustomerName = oConnectionContext.DbClsUser.Where(b => b.UserId ==
                        //                            oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.CustomerId).FirstOrDefault()
                        //).Select(b => b.Name).FirstOrDefault(),
                        //                        CustomerMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId ==
                        //                            oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.CustomerId).FirstOrDefault()
                        //).Select(b => b.MobileNo).FirstOrDefault(),
                        //                        CustomerEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId ==
                        //                            oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.CustomerId).FirstOrDefault()
                        //).Select(b => b.EmailId).FirstOrDefault(),
                        PlaceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId ==
                            oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.PlaceOfSupplyId).FirstOrDefault()
).Select(b => b.State).FirstOrDefault(),
                        InvoiceDate = oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.SalesDate).FirstOrDefault(),
                        PaymentTerm = oConnectionContext.DbClsPaymentTerm.Where(b => b.PaymentTermId ==
                            oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.PaymentTermId).FirstOrDefault()
).Select(b => b.PaymentTerm).FirstOrDefault(),
                        DueDate = oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.DueDate).FirstOrDefault(),
                        SellingPriceGroup = oConnectionContext.DbClsSellingPriceGroup.Where(b => b.SellingPriceGroupId ==
                            oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.SellingPriceGroupId).FirstOrDefault()
).Select(b => b.SellingPriceGroup).FirstOrDefault(),
                        InvoiceNotes = oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.Notes).FirstOrDefault(),
                        Subtotal = oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.Subtotal).FirstOrDefault(),
                        TotalDiscount = oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.TotalDiscount).FirstOrDefault(),
                        TotalTaxAmount = oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.TotalTaxAmount).FirstOrDefault(),
                        NetAmount = oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.NetAmount).FirstOrDefault(),
                        RoundOff = oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.RoundOff).FirstOrDefault(),
                        GrandTotal = oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.GrandTotal).FirstOrDefault(),
                        SalesType = oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.SalesType).FirstOrDefault(),
                        Paid = oConnectionContext.DbClsCustomerPayment.Where(b =>
                            b.Type.ToLower() == "sales payment" && b.IsDeleted == false && b.IsCancelled == false && b.SalesId == c.SalesId
).Select(b => b.Amount).DefaultIfEmpty().Sum(),
                        Due = (
    (oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.GrandTotal).FirstOrDefault()
    - oConnectionContext.DbClsSales.Where(d => d.SalesId == c.SalesId).Select(d => d.WriteOffAmount).FirstOrDefault())
    -
    (oConnectionContext.DbClsCustomerPayment.Where(b =>
        b.Type.ToLower() == "sales payment" && b.IsDeleted == false && b.IsCancelled == false && b.SalesId == c.SalesId
    ).Select(b => b.Amount).DefaultIfEmpty().Sum()
    -
    oConnectionContext.DbClsCustomerPayment.Where(b =>
        b.Type == "Change Return" && b.IsDeleted == false && b.IsCancelled == false && b.SalesId == c.SalesId
    ).Select(b => b.Amount).DefaultIfEmpty().Sum())
),

                    }))
            }).FirstOrDefault();

            var ParentSale = new
            {
                BranchId = Payment.CustomerPaymentIds.AsEnumerable().Select(a => a.BranchId).FirstOrDefault(),
                InvoiceNo = string.Join(",", Payment.CustomerPaymentIds.AsEnumerable().Select(a => a.InvoiceNo)),
                InvoiceUrl = string.Join(",", Payment.CustomerPaymentIds.AsEnumerable().Select(a => a.InvoiceUrl)),
                CustomerName = Payment.CustomerName,
                CustomerMobileNo = Payment.CustomerMobileNo,
                CustomerEmailId = Payment.CustomerEmailId,
                PlaceOfSupply = Payment.CustomerPaymentIds.AsEnumerable().Select(a => a.PlaceOfSupply).FirstOrDefault(),
                InvoiceDate = string.Join(",", Payment.CustomerPaymentIds.AsEnumerable().Select(a => a.InvoiceDate)),
                PaymentTerm = string.Join(",", Payment.CustomerPaymentIds.AsEnumerable().Select(a => a.PaymentTerm)),
                DueDate = string.Join(",", Payment.CustomerPaymentIds.AsEnumerable().Select(a => a.DueDate)),
                SellingPriceGroup = string.Join(",", Payment.CustomerPaymentIds.AsEnumerable().Select(a => a.SellingPriceGroup)),
                InvoiceNotes = string.Join(",", Payment.CustomerPaymentIds.AsEnumerable().Select(a => a.InvoiceNotes)),
                Subtotal = string.Join(",", Payment.CustomerPaymentIds.AsEnumerable().Select(a => a.Subtotal)),
                TotalDiscount = string.Join(",", Payment.CustomerPaymentIds.AsEnumerable().Select(a => a.TotalDiscount)),
                TotalTaxAmount = string.Join(",", Payment.CustomerPaymentIds.AsEnumerable().Select(a => a.TotalTaxAmount)),
                NetAmount = string.Join(",", Payment.CustomerPaymentIds.AsEnumerable().Select(a => a.NetAmount)),
                RoundOff = string.Join(",", Payment.CustomerPaymentIds.AsEnumerable().Select(a => a.RoundOff)),
                GrandTotal = string.Join(",", Payment.CustomerPaymentIds.AsEnumerable().Select(a => a.GrandTotal)),
                SalesType = string.Join(",", Payment.CustomerPaymentIds.AsEnumerable().Select(a => a.SalesType)),
                Paid = string.Join(",", Payment.CustomerPaymentIds.AsEnumerable().Select(a => a.Paid)),
                Due = string.Join(",", Payment.CustomerPaymentIds.AsEnumerable().Select(a => a.Due)),
            };

            var Branch = oConnectionContext.DbClsBranch.Where(a => a.BranchId == Payment.BranchId).Select(a => new
            {
                BusinessName = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessName).FirstOrDefault(),
                BusinessLogo = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessLogo).FirstOrDefault(),
                a.Branch,
                a.BranchCode,
                a.Address,
                a.Zipcode,
                Country = oConnectionContext.DbClsCountry.Where(b => b.CountryId == a.CountryId).Select(b => b.Country).FirstOrDefault(),
                State = oConnectionContext.DbClsState.Where(b => b.StateId == a.StateId).Select(b => b.State).FirstOrDefault(),
                City = oConnectionContext.DbClsCity.Where(b => b.CityId == a.CityId).Select(b => b.City).FirstOrDefault(),
                //ContactPersonName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.Name).FirstOrDefault(),
                //ContactPersonMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.MobileNo).FirstOrDefault(),
                a.Mobile,
                a.AltMobileNo,
                a.Email,
                BusinessRegistrationNo = oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNo).FirstOrDefault(),
                BusinessRegistrationName = oConnectionContext.DbClsBusinessRegistrationName.Where(c => c.BusinessRegistrationNameId ==
                oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNameId).FirstOrDefault()).Select(c => c.Name).FirstOrDefault()
            }).FirstOrDefault();

            if (SmsSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.SmsBody;
                string[] array = NotificationModulesSetting.SmsBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Invoice No}", ParentSale.InvoiceNo);
                    }
                    else if (item == "Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Invoice Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", ParentSale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", ParentSale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", ParentSale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Place Of Supply}", ParentSale.PlaceOfSupply);
                    }
                    else if (item == "Invoice Date")
                    {
                        formattedBody = formattedBody.Replace("{Invoice Date}", ParentSale.InvoiceDate.ToString());
                    }
                    else if (item == "Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Selling Price Group}", ParentSale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", ParentSale.InvoiceNotes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Payment Amount")
                    {
                        formattedBody = formattedBody.Replace("{Payment Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Payment Date")
                    {
                        formattedBody = formattedBody.Replace("{Payment Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Payment Method")
                    {
                        formattedBody = formattedBody.Replace("{Payment Method}", Payment.PaymentType);
                    }
                    else if (item == "Payment Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Payment Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Payment Notes")
                    {
                        formattedBody = formattedBody.Replace("{Payment Notes}", Payment.Notes);
                    }
                    else if (item == "Payment Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Payment Receipt Url}", Payment.InvoiceUrl);
                    }
                    else if (item == "Paid Amount")
                    {
                        formattedBody = formattedBody.Replace("{Paid Amount}", ParentSale.Paid.ToString());
                    }
                    else if (item == "Due Amount")
                    {
                        formattedBody = formattedBody.Replace("{Due Amount}", ParentSale.Due.ToString());
                    }
                }

                SmsController oSmsController = new SmsController();
                oSmsController.SmsFunction(CompanyId, ParentSale.CustomerMobileNo, formattedBody, AddedBy, CurrentDate, Id, Type, Domain, 0);
            }
            if (EmailSettingsId != 0)
            {
                #region Email Subject
                string formattedSubject = "";

                formattedSubject = NotificationModulesSetting.EmailSubject;
                string[] arr1 = NotificationModulesSetting.EmailSubject.Split('{');
                List<string> list1 = new List<string>();

                foreach (var item in arr1)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list1.Add(item.Split('}')[0]);
                    }
                }


                foreach (var item in list1)
                {
                    if (item == "Business Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Invoice No")
                    {
                        formattedSubject = formattedSubject.Replace("{Invoice No}", ParentSale.InvoiceNo);
                    }
                    else if (item == "Invoice Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Invoice Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Name}", ParentSale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Mobile No}", ParentSale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Email}", ParentSale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Place Of Supply}", ParentSale.PlaceOfSupply);
                    }
                    else if (item == "Invoice Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Invoice Date}", ParentSale.InvoiceDate.ToString());
                    }
                    else if (item == "Payment Term")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Due Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedSubject = formattedSubject.Replace("{Selling Price Group}", ParentSale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Notes}", ParentSale.InvoiceNotes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedSubject = formattedSubject.Replace("{Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedSubject = formattedSubject.Replace("{Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Payment Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Payment Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Payment Method")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Method}", Payment.PaymentType);
                    }
                    else if (item == "Payment Reference No")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Payment Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Notes}", Payment.Notes);
                    }
                    else if (item == "Payment Receipt Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Receipt Url}", Payment.InvoiceUrl);
                    }
                    else if (item == "Paid Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Paid Amount}", ParentSale.Paid.ToString());
                    }
                    else if (item == "Due Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Due Amount}", ParentSale.Due.ToString());
                    }
                }
                #endregion


                #region EmailBody
                string formattedBody = NotificationModulesSetting.EmailBody;
                string[] array = NotificationModulesSetting.EmailBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Logo")
                    {
                        formattedBody = formattedBody.Replace("{Business Logo}", "<img src='" + webUrl + Branch.BusinessLogo + "' />");
                    }
                    else if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Invoice No}", ParentSale.InvoiceNo);
                    }
                    else if (item == "Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Invoice Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", ParentSale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", ParentSale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", ParentSale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Place Of Supply}", ParentSale.PlaceOfSupply);
                    }
                    else if (item == "Invoice Date")
                    {
                        formattedBody = formattedBody.Replace("{Invoice Date}", ParentSale.InvoiceDate.ToString());
                    }
                    else if (item == "Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Selling Price Group}", ParentSale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", ParentSale.InvoiceNotes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Payment Amount")
                    {
                        formattedBody = formattedBody.Replace("{Payment Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Payment Date")
                    {
                        formattedBody = formattedBody.Replace("{Payment Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Payment Method")
                    {
                        formattedBody = formattedBody.Replace("{Payment Method}", Payment.PaymentType);
                    }
                    else if (item == "Payment Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Payment Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Payment Notes")
                    {
                        formattedBody = formattedBody.Replace("{Payment Notes}", Payment.Notes);
                    }
                    else if (item == "Payment Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Payment Receipt Url}", Payment.InvoiceUrl);
                    }
                    else if (item == "Paid Amount")
                    {
                        formattedBody = formattedBody.Replace("{Paid Amount}", ParentSale.Paid.ToString());
                    }
                    else if (item == "Due Amount")
                    {
                        formattedBody = formattedBody.Replace("{Due Amount}", ParentSale.Due.ToString());
                    }
                }
                #endregion


                EmailController oEmailController = new EmailController();
                oEmailController.NotificationTemplate(CompanyId, ParentSale.CustomerEmailId, formattedSubject, formattedBody, CC, Bcc, AddedBy, CurrentDate, Id, Type, Domain);
            }
            if (WhatsappSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.WhatsappBody;
                string[] array = NotificationModulesSetting.WhatsappBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Invoice No}", ParentSale.InvoiceNo);
                    }
                    else if (item == "Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Invoice Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", ParentSale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", ParentSale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", ParentSale.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Place Of Supply}", ParentSale.PlaceOfSupply);
                    }
                    else if (item == "Invoice Date")
                    {
                        formattedBody = formattedBody.Replace("{Invoice Date}", ParentSale.InvoiceDate.ToString());
                    }
                    else if (item == "Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Selling Price Group}", ParentSale.SellingPriceGroup);
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", ParentSale.InvoiceNotes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Payment Amount")
                    {
                        formattedBody = formattedBody.Replace("{Payment Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Payment Date")
                    {
                        formattedBody = formattedBody.Replace("{Payment Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Payment Method")
                    {
                        formattedBody = formattedBody.Replace("{Payment Method}", Payment.PaymentType);
                    }
                    else if (item == "Payment Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Payment Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Payment Notes")
                    {
                        formattedBody = formattedBody.Replace("{Payment Notes}", Payment.Notes);
                    }
                    else if (item == "Payment Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Payment Receipt Url}", Payment.InvoiceUrl);
                    }
                    else if (item == "Paid Amount")
                    {
                        formattedBody = formattedBody.Replace("{Paid Amount}", ParentSale.Paid.ToString());
                    }
                    else if (item == "Due Amount")
                    {
                        formattedBody = formattedBody.Replace("{Due Amount}", ParentSale.Due.ToString());
                    }
                }

                WhatsappController oWhatsappController = new WhatsappController();
                return oWhatsappController.WhatsappFunction(CompanyId, ParentSale.CustomerMobileNo, formattedBody, 0);
            }
            string[] arr = { "1", "", "" };
            return arr;
        }

        public dynamic CustomerAdvancePayment(ClsNotificationModulesSettingsVm NotificationModulesSetting, long CompanyId, long Id, string CC, string Bcc, long SmsSettingsId, long EmailSettingsId, long WhatsappSettingsId, string Type, long AddedBy, DateTime CurrentDate, string Domain)
        {
            var Payment = oConnectionContext.DbClsCustomerPayment.Where(a => a.CustomerPaymentId == Id).Select(a => new
            {
                CustomerName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.Name).FirstOrDefault(),
                CustomerEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.EmailId).FirstOrDefault(),
                CustomerMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.MobileNo).FirstOrDefault(),
                PlaceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.PlaceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                Tax = oConnectionContext.DbClsTax.Where(b => b.TaxId == a.TaxId).Select(b => b.Tax).FirstOrDefault(),
                a.Amount,
                a.PaymentDate,
                PaymentType = oConnectionContext.DbClsPaymentType.Where(b => b.PaymentTypeId == Id).Select(b => b.PaymentType).FirstOrDefault(),
                a.ReferenceNo,
                InvoiceUrl = Domain + "/sales/PaymentReceipt?ReferenceId=" + a.ReferenceId,
                a.Notes,
                a.BranchId,
                a.CustomerId,
            }).FirstOrDefault();

            var Branch = oConnectionContext.DbClsBranch.Where(a => a.BranchId == Payment.BranchId).Select(a => new
            {
                BusinessName = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessName).FirstOrDefault(),
                BusinessLogo = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessLogo).FirstOrDefault(),
                a.Branch,
                a.BranchCode,
                a.Address,
                a.Zipcode,
                Country = oConnectionContext.DbClsCountry.Where(b => b.CountryId == a.CountryId).Select(b => b.Country).FirstOrDefault(),
                State = oConnectionContext.DbClsState.Where(b => b.StateId == a.StateId).Select(b => b.State).FirstOrDefault(),
                City = oConnectionContext.DbClsCity.Where(b => b.CityId == a.CityId).Select(b => b.City).FirstOrDefault(),
                //ContactPersonName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.Name).FirstOrDefault(),
                //ContactPersonMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.MobileNo).FirstOrDefault(),
                a.Mobile,
                a.AltMobileNo,
                a.Email,
                BusinessRegistrationNo = oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNo).FirstOrDefault(),
                BusinessRegistrationName = oConnectionContext.DbClsBusinessRegistrationName.Where(c => c.BusinessRegistrationNameId ==
                oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNameId).FirstOrDefault()).Select(c => c.Name).FirstOrDefault()
            }).FirstOrDefault();

            if (SmsSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.SmsBody;
                string[] array = NotificationModulesSetting.SmsBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", Payment.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", Payment.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", Payment.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Place Of Supply}", Payment.PlaceOfSupply);
                    }
                    else if (item == "Tax")
                    {
                        formattedBody = formattedBody.Replace("{Tax}", Payment.Tax);
                    }
                    else if (item == "Payment Amount")
                    {
                        formattedBody = formattedBody.Replace("{Payment Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Payment Date")
                    {
                        formattedBody = formattedBody.Replace("{Payment Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Payment Method")
                    {
                        formattedBody = formattedBody.Replace("{Payment Method}", Payment.PaymentType);
                    }
                    else if (item == "Payment Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Payment Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Payment Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Payment Receipt Url}", Payment.InvoiceUrl);
                    }
                    else if (item == "Payment Notes")
                    {
                        formattedBody = formattedBody.Replace("{Payment Notes}", Payment.Notes);
                    }
                }

                SmsController oSmsController = new SmsController();
                oSmsController.SmsFunction(CompanyId, Payment.CustomerMobileNo, formattedBody, AddedBy, CurrentDate, Id, Type, Domain, 0);
            }
            if (EmailSettingsId != 0)
            {
                #region Email Subject
                string formattedSubject = "";

                formattedSubject = NotificationModulesSetting.EmailSubject;
                string[] arr1 = NotificationModulesSetting.EmailSubject.Split('{');
                List<string> list1 = new List<string>();

                foreach (var item in arr1)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list1.Add(item.Split('}')[0]);
                    }
                }


                foreach (var item in list1)
                {
                    if (item == "Business Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Name}", Payment.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Mobile No}", Payment.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Email}", Payment.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Place Of Supply}", Payment.PlaceOfSupply);
                    }
                    else if (item == "Tax")
                    {
                        formattedSubject = formattedSubject.Replace("{Tax}", Payment.Tax);
                    }
                    else if (item == "Payment Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Payment Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Payment Method")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Method}", Payment.PaymentType);
                    }
                    else if (item == "Payment Reference No")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Payment Receipt Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Receipt Url}", Payment.InvoiceUrl);
                    }
                    else if (item == "Payment Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Notes}", Payment.Notes);
                    }
                }
                #endregion


                #region EmailBody
                string formattedBody = NotificationModulesSetting.EmailBody;
                string[] array = NotificationModulesSetting.EmailBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Logo")
                    {
                        formattedBody = formattedBody.Replace("{Business Logo}", "<img src='" + webUrl + Branch.BusinessLogo + "' />");
                    }
                    else if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", Payment.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", Payment.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", Payment.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Place Of Supply}", Payment.PlaceOfSupply);
                    }
                    else if (item == "Tax")
                    {
                        formattedBody = formattedBody.Replace("{Tax}", Payment.Tax);
                    }
                    else if (item == "Payment Amount")
                    {
                        formattedBody = formattedBody.Replace("{Payment Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Payment Date")
                    {
                        formattedBody = formattedBody.Replace("{Payment Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Payment Method")
                    {
                        formattedBody = formattedBody.Replace("{Payment Method}", Payment.PaymentType);
                    }
                    else if (item == "Payment Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Payment Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Payment Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Payment Receipt Url}", Payment.InvoiceUrl);
                    }
                    else if (item == "Payment Notes")
                    {
                        formattedBody = formattedBody.Replace("{Payment Notes}", Payment.Notes);
                    }
                }
                #endregion


                EmailController oEmailController = new EmailController();
                oEmailController.NotificationTemplate(CompanyId, Payment.CustomerEmailId, formattedSubject, formattedBody, CC, Bcc, AddedBy, CurrentDate, Id, Type, Domain);
            }
            if (WhatsappSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.WhatsappBody;
                string[] array = NotificationModulesSetting.WhatsappBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", Payment.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", Payment.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", Payment.CustomerEmailId);
                    }
                    else if (item == "Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Place Of Supply}", Payment.PlaceOfSupply);
                    }
                    else if (item == "Tax")
                    {
                        formattedBody = formattedBody.Replace("{Tax}", Payment.Tax);
                    }
                    else if (item == "Payment Amount")
                    {
                        formattedBody = formattedBody.Replace("{Payment Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Payment Date")
                    {
                        formattedBody = formattedBody.Replace("{Payment Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Payment Method")
                    {
                        formattedBody = formattedBody.Replace("{Payment Method}", Payment.PaymentType);
                    }
                    else if (item == "Payment Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Payment Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Payment Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Payment Receipt Url}", Payment.InvoiceUrl);
                    }
                    else if (item == "Payment Notes")
                    {
                        formattedBody = formattedBody.Replace("{Payment Notes}", Payment.Notes);
                    }
                }

                WhatsappController oWhatsappController = new WhatsappController();
                return oWhatsappController.WhatsappFunction(CompanyId, Payment.CustomerMobileNo, formattedBody, 0);
            }
            string[] arr = { "1", "", "" };
            return arr;
        }

        public dynamic RefundFromCreditNote(ClsNotificationModulesSettingsVm NotificationModulesSetting, long CompanyId, long Id, string CC, string Bcc, long SmsSettingsId, long EmailSettingsId, long WhatsappSettingsId, string Type, long AddedBy, DateTime CurrentDate, string Domain)
        {
            var Payment = oConnectionContext.DbClsCustomerPayment.Where(a => a.CustomerPaymentId == Id).Select(a => new
            {
                a.BranchId,
                a.ParentId,
                SalesId = oConnectionContext.DbClsCustomerPayment.Where(b => b.CustomerPaymentId == a.ParentId
                && b.IsDeleted == false && b.IsCancelled == false && b.IsActive == true).Select(b => b.SalesId).FirstOrDefault(),
                SalesReturnId = oConnectionContext.DbClsCustomerPayment.Where(b => b.CustomerPaymentId == a.ParentId
                && b.IsDeleted == false && b.IsCancelled == false && b.IsActive == true).Select(b => b.SalesReturnId).FirstOrDefault(),
                InvoiceUrl = Domain + "/sales/ReturnPaymentReceipt?ReferenceId=" + a.ReferenceId,
                a.ReferenceNo,
                a.Notes,
                a.Amount,
                a.PaymentDate,
                a.PaymentTypeId,
                PaymentType = oConnectionContext.DbClsPaymentType.Where(b => b.PaymentTypeId == Id).Select(b => b.PaymentType).FirstOrDefault(),
                AmountRemaining = oConnectionContext.DbClsCustomerPayment.Where(b => b.CustomerPaymentId == a.ParentId
                && b.IsDeleted == false && b.IsCancelled == false && b.IsActive == true).Select(b => b.AmountRemaining).FirstOrDefault(),
            }).FirstOrDefault();

            var ParentSale = oConnectionContext.DbClsSales.Where(a => a.SalesId == Payment.SalesId).Select(a => new
            {
                a.BranchId,
                CustomerName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.Name).FirstOrDefault(),
                CustomerMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.MobileNo).FirstOrDefault(),
                CustomerEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.EmailId).FirstOrDefault(),
                InvoiceNo = a.InvoiceNo,
                InvoiceUrl = Domain + (a.SalesType.ToLower() == "pos" ? "/sales/receipt?InvoiceId=" + a.InvoiceId : "/sales/invoice?InvoiceId=" + a.InvoiceId),
                PlaceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.PlaceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                InvoiceDate = a.SalesDate,
                PaymentTerm = oConnectionContext.DbClsPaymentTerm.Where(b => b.PaymentTermId == a.PaymentTermId).Select(b => b.PaymentTerm).FirstOrDefault(),
                DueDate = a.DueDate,
                SellingPriceGroup = oConnectionContext.DbClsSellingPriceGroup.Where(b => b.SellingPriceGroupId == a.SellingPriceGroupId).
                Select(b => b.SellingPriceGroup).FirstOrDefault(),
                InvoiceNotes = a.Notes,
                Subtotal = a.Subtotal,
                TotalDiscount = a.TotalDiscount,
                TotalTaxAmount = a.TotalTaxAmount,
                NetAmount = a.NetAmount,
                RoundOff = a.RoundOff,
                SpecialDiscount = a.SpecialDiscount,
                GrandTotal = a.GrandTotal,
                a.SalesType
            }).FirstOrDefault();

            var Sale = oConnectionContext.DbClsSalesReturn.Where(a => a.SalesReturnId == Payment.SalesReturnId).Select(a => new
            {
                a.BranchId,
                PlaceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.PlaceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                Reason = oConnectionContext.DbClsSalesCreditNoteReason.Where(b => b.SalesCreditNoteReasonId == a.SalesCreditNoteReasonId).Select(b => b.SalesCreditNoteReason).FirstOrDefault(),
                Date = a.Date,
                InvoiceNo = a.InvoiceNo,
                InvoiceUrl = Domain + (ParentSale.SalesType.ToLower() == "pos" ? "/sales/salesreturnreceipt?InvoiceId=" + a.InvoiceId : "/sales/salesreturninvoice?InvoiceId=" + a.InvoiceId),
                InvoiceNotes = a.Notes,
                Subtotal = a.Subtotal,
                TotalDiscount = a.TotalDiscount,
                TotalTaxAmount = a.TotalTaxAmount,
                NetAmount = a.NetAmount,
                RoundOff = a.RoundOff,
                SpecialDiscount = a.SpecialDiscount,
                GrandTotal = a.GrandTotal
            }).FirstOrDefault();

            var Branch = oConnectionContext.DbClsBranch.Where(a => a.BranchId == Payment.BranchId).Select(a => new
            {
                BusinessName = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessName).FirstOrDefault(),
                BusinessLogo = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessLogo).FirstOrDefault(),
                a.Branch,
                a.BranchCode,
                a.Address,
                a.Zipcode,
                Country = oConnectionContext.DbClsCountry.Where(b => b.CountryId == a.CountryId).Select(b => b.Country).FirstOrDefault(),
                State = oConnectionContext.DbClsState.Where(b => b.StateId == a.StateId).Select(b => b.State).FirstOrDefault(),
                City = oConnectionContext.DbClsCity.Where(b => b.CityId == a.CityId).Select(b => b.City).FirstOrDefault(),
                //ContactPersonName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.Name).FirstOrDefault(),
                //ContactPersonMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.MobileNo).FirstOrDefault(),
                a.Mobile,
                a.AltMobileNo,
                a.Email,
                BusinessRegistrationNo = oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNo).FirstOrDefault(),
                BusinessRegistrationName = oConnectionContext.DbClsBusinessRegistrationName.Where(c => c.BusinessRegistrationNameId ==
                oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNameId).FirstOrDefault()).Select(c => c.Name).FirstOrDefault()
            }).FirstOrDefault();

            if (SmsSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.SmsBody;
                string[] array = NotificationModulesSetting.SmsBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", ParentSale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", ParentSale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", ParentSale.CustomerEmailId);
                    }
                    else if (item == "Parent Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice No}", ParentSale.InvoiceNo);
                    }
                    else if (item == "Parent Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Parent Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Parent Place Of Supply}", ParentSale.PlaceOfSupply);
                    }
                    else if (item == "Parent Invoice Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Date}", ParentSale.InvoiceDate.ToString());
                    }
                    else if (item == "Parent Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Parent Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Parent Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Parent Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Parent Selling Price Group}", ParentSale.SellingPriceGroup);
                    }
                    else if (item == "Parent Invoice Notes")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Notes}", ParentSale.InvoiceNotes);
                    }
                    else if (item == "Parent Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Parent Discount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Parent Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Parent Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Parent Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Parent Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Parent Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Credit Note Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Credit Note Reason")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Reason}", Sale.Reason);
                    }
                    else if (item == "Credit Note Date")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Date}", Sale.Date.ToString());
                    }
                    else if (item == "Credit Note Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Invoice No}", Sale.InvoiceNo);
                    }
                    else if (item == "Credit Note Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Invoice Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Credit Note Notes")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Notes}", Sale.InvoiceNotes);
                    }
                    else if (item == "Credit Note Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Credit Note Discount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Credit Note Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Credit Note Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Credit Note Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Credit Note Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Total Amount}", Sale.GrandTotal.ToString());
                    }
                    else if (item == "Refund Amount")
                    {
                        formattedBody = formattedBody.Replace("{Refund Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Refund Date")
                    {
                        formattedBody = formattedBody.Replace("{Refund Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Refund Method")
                    {
                        formattedBody = formattedBody.Replace("{Refund Method}", Payment.PaymentType);
                    }
                    else if (item == "Refund Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Refund Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Refund Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Refund Receipt Url}", Payment.InvoiceUrl);
                    }
                    else if (item == "Refund Notes")
                    {
                        formattedBody = formattedBody.Replace("{Refund Notes}", Payment.Notes);
                    }
                    else if (item == "Balance")
                    {
                        formattedBody = formattedBody.Replace("{Balance}", Payment.AmountRemaining.ToString());
                    }
                }

                SmsController oSmsController = new SmsController();
                oSmsController.SmsFunction(CompanyId, ParentSale.CustomerMobileNo, formattedBody, AddedBy, CurrentDate, Id, Type, Domain, 0);
            }
            if (EmailSettingsId != 0)
            {
                #region Email Subject
                string formattedSubject = "";

                formattedSubject = NotificationModulesSetting.EmailSubject;
                string[] arr1 = NotificationModulesSetting.EmailSubject.Split('{');
                List<string> list1 = new List<string>();

                foreach (var item in arr1)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list1.Add(item.Split('}')[0]);
                    }
                }


                foreach (var item in list1)
                {
                    if (item == "Business Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Name}", ParentSale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Mobile No}", ParentSale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Email}", ParentSale.CustomerEmailId);
                    }
                    else if (item == "Parent Invoice No")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Invoice No}", ParentSale.InvoiceNo);
                    }
                    else if (item == "Parent Invoice Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Invoice Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Parent Place Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Place Of Supply}", ParentSale.PlaceOfSupply);
                    }
                    else if (item == "Parent Invoice Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Invoice Date}", ParentSale.InvoiceDate.ToString());
                    }
                    else if (item == "Parent Payment Term")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Parent Due Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Parent Selling Price Group")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Selling Price Group}", ParentSale.SellingPriceGroup);
                    }
                    else if (item == "Parent Invoice Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Invoice Notes}", ParentSale.InvoiceNotes);
                    }
                    else if (item == "Parent Gross Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Parent Discount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Parent Tax Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Parent Net Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Parent Round Off")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Parent Total Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Credit Note Place Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Credit Note Reason")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Reason}", Sale.Reason);
                    }
                    else if (item == "Credit Note Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Date}", Sale.Date.ToString());
                    }
                    else if (item == "Credit Note Invoice No")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Invoice No}", Sale.InvoiceNo);
                    }
                    else if (item == "Credit Note Invoice Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Invoice Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Credit Note Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Notes}", Sale.InvoiceNotes);
                    }
                    else if (item == "Credit Note Gross Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Credit Note Discount")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Credit Note Tax Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Credit Note Net Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Credit Note Round Off")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Credit Note Total Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Total Amount}", Sale.GrandTotal.ToString());
                    }
                    else if (item == "Refund Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Refund Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Refund Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Refund Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Refund Method")
                    {
                        formattedSubject = formattedSubject.Replace("{Refund Method}", Payment.PaymentType);
                    }
                    else if (item == "Refund Reference No")
                    {
                        formattedSubject = formattedSubject.Replace("{Refund Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Refund Receipt Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Refund Receipt Url}", Payment.InvoiceUrl);
                    }
                    else if (item == "Refund Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Refund Notes}", Payment.Notes);
                    }
                    else if (item == "Balance")
                    {
                        formattedSubject = formattedSubject.Replace("{Balance}", Payment.AmountRemaining.ToString());
                    }
                }
                #endregion


                #region EmailBody
                string formattedBody = NotificationModulesSetting.EmailBody;
                string[] array = NotificationModulesSetting.EmailBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Logo")
                    {
                        formattedBody = formattedBody.Replace("{Business Logo}", "<img src='" + webUrl + Branch.BusinessLogo + "' />");
                    }
                    else if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", ParentSale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", ParentSale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", ParentSale.CustomerEmailId);
                    }
                    else if (item == "Parent Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice No}", ParentSale.InvoiceNo);
                    }
                    else if (item == "Parent Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Parent Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Parent Place Of Supply}", ParentSale.PlaceOfSupply);
                    }
                    else if (item == "Parent Invoice Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Date}", ParentSale.InvoiceDate.ToString());
                    }
                    else if (item == "Parent Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Parent Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Parent Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Parent Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Parent Selling Price Group}", ParentSale.SellingPriceGroup);
                    }
                    else if (item == "Parent Invoice Notes")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Notes}", ParentSale.InvoiceNotes);
                    }
                    else if (item == "Parent Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Parent Discount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Parent Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Parent Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Parent Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Parent Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Parent Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Credit Note Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Credit Note Reason")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Reason}", Sale.Reason);
                    }
                    else if (item == "Credit Note Date")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Date}", Sale.Date.ToString());
                    }
                    else if (item == "Credit Note Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Invoice No}", Sale.InvoiceNo);
                    }
                    else if (item == "Credit Note Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Invoice Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Credit Note Notes")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Notes}", Sale.InvoiceNotes);
                    }
                    else if (item == "Credit Note Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Credit Note Discount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Credit Note Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Credit Note Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Credit Note Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Credit Note Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Total Amount}", Sale.GrandTotal.ToString());
                    }
                    else if (item == "Refund Amount")
                    {
                        formattedBody = formattedBody.Replace("{Refund Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Refund Date")
                    {
                        formattedBody = formattedBody.Replace("{Refund Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Refund Method")
                    {
                        formattedBody = formattedBody.Replace("{Refund Method}", Payment.PaymentType);
                    }
                    else if (item == "Refund Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Refund Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Refund Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Refund Receipt Url}", Payment.InvoiceUrl);
                    }
                    else if (item == "Refund Notes")
                    {
                        formattedBody = formattedBody.Replace("{Refund Notes}", Payment.Notes);
                    }
                    else if (item == "Balance")
                    {
                        formattedBody = formattedBody.Replace("{Balance}", Payment.AmountRemaining.ToString());
                    }
                }
                #endregion


                EmailController oEmailController = new EmailController();
                oEmailController.NotificationTemplate(CompanyId, ParentSale.CustomerEmailId, formattedSubject, formattedBody, CC, Bcc, AddedBy, CurrentDate, Id, Type, Domain);
            }
            if (WhatsappSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.WhatsappBody;
                string[] array = NotificationModulesSetting.WhatsappBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", ParentSale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", ParentSale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", ParentSale.CustomerEmailId);
                    }
                    else if (item == "Parent Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice No}", ParentSale.InvoiceNo);
                    }
                    else if (item == "Parent Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Parent Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Parent Place Of Supply}", ParentSale.PlaceOfSupply);
                    }
                    else if (item == "Parent Invoice Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Date}", ParentSale.InvoiceDate.ToString());
                    }
                    else if (item == "Parent Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Parent Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Parent Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Parent Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Parent Selling Price Group}", ParentSale.SellingPriceGroup);
                    }
                    else if (item == "Parent Invoice Notes")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Notes}", ParentSale.InvoiceNotes);
                    }
                    else if (item == "Parent Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Parent Discount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Parent Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Parent Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Parent Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Parent Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Parent Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Credit Note Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Place Of Supply}", Sale.PlaceOfSupply);
                    }
                    else if (item == "Credit Note Reason")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Reason}", Sale.Reason);
                    }
                    else if (item == "Credit Note Date")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Date}", Sale.Date.ToString());
                    }
                    else if (item == "Credit Note Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Invoice No}", Sale.InvoiceNo);
                    }
                    else if (item == "Credit Note Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Invoice Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Credit Note Notes")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Notes}", Sale.InvoiceNotes);
                    }
                    else if (item == "Credit Note Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Credit Note Discount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Credit Note Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Credit Note Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Credit Note Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Credit Note Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Total Amount}", Sale.GrandTotal.ToString());
                    }
                    else if (item == "Refund Amount")
                    {
                        formattedBody = formattedBody.Replace("{Refund Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Refund Date")
                    {
                        formattedBody = formattedBody.Replace("{Refund Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Refund Method")
                    {
                        formattedBody = formattedBody.Replace("{Refund Method}", Payment.PaymentType);
                    }
                    else if (item == "Refund Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Refund Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Refund Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Refund Receipt Url}", Payment.InvoiceUrl);
                    }
                    else if (item == "Refund Notes")
                    {
                        formattedBody = formattedBody.Replace("{Refund Notes}", Payment.Notes);
                    }
                    else if (item == "Balance")
                    {
                        formattedBody = formattedBody.Replace("{Balance}", Payment.AmountRemaining.ToString());
                    }
                }

                WhatsappController oWhatsappController = new WhatsappController();
                return oWhatsappController.WhatsappFunction(CompanyId, ParentSale.CustomerMobileNo, formattedBody, 0);
            }
            string[] arr = { "1", "", "" };
            return arr;
        }

        public dynamic RefundFromCustomerAdvancePayment(ClsNotificationModulesSettingsVm NotificationModulesSetting, long CompanyId, long Id, string CC, string Bcc, long SmsSettingsId, long EmailSettingsId, long WhatsappSettingsId, string Type, long AddedBy, DateTime CurrentDate, string Domain)
        {
            var Payment = oConnectionContext.DbClsCustomerPayment.Where(a => a.CustomerPaymentId == Id).Select(a => new
            {
                a.BranchId,
                a.ParentId,
                InvoiceUrl = Domain + "/sales/ReturnPaymentReceipt?ReferenceId=" + a.ReferenceId,
                a.ReferenceNo,
                a.Notes,
                a.Amount,
                a.PaymentDate,
                a.PaymentTypeId,
                PaymentType = oConnectionContext.DbClsPaymentType.Where(b => b.PaymentTypeId == Id).Select(b => b.PaymentType).FirstOrDefault(),
                AmountRemaining = oConnectionContext.DbClsCustomerPayment.Where(b => b.CustomerPaymentId == a.ParentId
                && b.IsDeleted == false && b.IsCancelled == false && b.IsActive == true).Select(b => b.AmountRemaining).FirstOrDefault(),
            }).FirstOrDefault();

            var AdvancePayment = oConnectionContext.DbClsCustomerPayment.Where(a => a.CustomerPaymentId == Payment.ParentId).Select(a => new
            {
                CustomerName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.Name).FirstOrDefault(),
                CustomerEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.EmailId).FirstOrDefault(),
                CustomerMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.MobileNo).FirstOrDefault(),
                PlaceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.PlaceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                Tax = oConnectionContext.DbClsTax.Where(b => b.TaxId == a.TaxId).Select(b => b.Tax).FirstOrDefault(),
                a.Amount,
                a.PaymentDate,
                PaymentType = oConnectionContext.DbClsPaymentType.Where(b => b.PaymentTypeId == Id).Select(b => b.PaymentType).FirstOrDefault(),
                a.ReferenceNo,
                InvoiceUrl = Domain + "/sales/PaymentReceipt?ReferenceId=" + a.ReferenceId,
                a.Notes,
                a.BranchId,
                a.CustomerId,
            }).FirstOrDefault();

            var Branch = oConnectionContext.DbClsBranch.Where(a => a.BranchId == Payment.BranchId).Select(a => new
            {
                BusinessName = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessName).FirstOrDefault(),
                BusinessLogo = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessLogo).FirstOrDefault(),
                a.Branch,
                a.BranchCode,
                a.Address,
                a.Zipcode,
                Country = oConnectionContext.DbClsCountry.Where(b => b.CountryId == a.CountryId).Select(b => b.Country).FirstOrDefault(),
                State = oConnectionContext.DbClsState.Where(b => b.StateId == a.StateId).Select(b => b.State).FirstOrDefault(),
                City = oConnectionContext.DbClsCity.Where(b => b.CityId == a.CityId).Select(b => b.City).FirstOrDefault(),
                //ContactPersonName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.Name).FirstOrDefault(),
                //ContactPersonMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.MobileNo).FirstOrDefault(),
                a.Mobile,
                a.AltMobileNo,
                a.Email,
                BusinessRegistrationNo = oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNo).FirstOrDefault(),
                BusinessRegistrationName = oConnectionContext.DbClsBusinessRegistrationName.Where(c => c.BusinessRegistrationNameId ==
                oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNameId).FirstOrDefault()).Select(c => c.Name).FirstOrDefault()
            }).FirstOrDefault();

            if (SmsSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.SmsBody;
                string[] array = NotificationModulesSetting.SmsBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", AdvancePayment.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", AdvancePayment.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", AdvancePayment.CustomerEmailId);
                    }
                    else if (item == "Advance Payment Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Place Of Supply}", AdvancePayment.PlaceOfSupply);
                    }
                    else if (item == "Advance Payment Tax")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Tax}", AdvancePayment.Tax);
                    }
                    else if (item == "Advance Payment Amount")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Amount}", AdvancePayment.Amount.ToString());
                    }
                    else if (item == "Advance Payment Date")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Date}", AdvancePayment.PaymentDate.ToString());
                    }
                    else if (item == "Advance Payment Method")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Method}", AdvancePayment.PaymentType);
                    }
                    else if (item == "Advance Payment Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Reference No}", AdvancePayment.ReferenceNo);
                    }
                    else if (item == "Advance Payment Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Receipt Url}", AdvancePayment.InvoiceUrl);
                    }
                    else if (item == "Advance Payment Notes")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Notes}", AdvancePayment.Notes);
                    }
                    else if (item == "Refund Amount")
                    {
                        formattedBody = formattedBody.Replace("{Refund Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Refund Date")
                    {
                        formattedBody = formattedBody.Replace("{Refund Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Refund Method")
                    {
                        formattedBody = formattedBody.Replace("{Refund Method}", Payment.PaymentType);
                    }
                    else if (item == "Refund Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Refund Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Refund Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Refund Receipt Url}", Payment.InvoiceUrl);
                    }
                    else if (item == "Refund Notes")
                    {
                        formattedBody = formattedBody.Replace("{Refund Notes}", Payment.Notes);
                    }
                    else if (item == "Unused Amount")
                    {
                        formattedBody = formattedBody.Replace("{Unused Amount}", Payment.AmountRemaining.ToString());
                    }
                }

                SmsController oSmsController = new SmsController();
                oSmsController.SmsFunction(CompanyId, AdvancePayment.CustomerMobileNo, formattedBody, AddedBy, CurrentDate, Id, Type, Domain, 0);
            }
            if (EmailSettingsId != 0)
            {
                #region Email Subject
                string formattedSubject = "";

                formattedSubject = NotificationModulesSetting.EmailSubject;
                string[] arr1 = NotificationModulesSetting.EmailSubject.Split('{');
                List<string> list1 = new List<string>();

                foreach (var item in arr1)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list1.Add(item.Split('}')[0]);
                    }
                }


                foreach (var item in list1)
                {
                    if (item == "Business Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Name}", AdvancePayment.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Mobile No}", AdvancePayment.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Email}", AdvancePayment.CustomerEmailId);
                    }
                    else if (item == "Advance Payment Place Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Place Of Supply}", AdvancePayment.PlaceOfSupply);
                    }
                    else if (item == "Advance Payment Tax")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Tax}", AdvancePayment.Tax);
                    }
                    else if (item == "Advance Payment Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Amount}", AdvancePayment.Amount.ToString());
                    }
                    else if (item == "Advance Payment Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Date}", AdvancePayment.PaymentDate.ToString());
                    }
                    else if (item == "Advance Payment Method")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Method}", AdvancePayment.PaymentType);
                    }
                    else if (item == "Advance Payment Reference No")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Reference No}", AdvancePayment.ReferenceNo);
                    }
                    else if (item == "Advance Payment Receipt Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Receipt Url}", AdvancePayment.InvoiceUrl);
                    }
                    else if (item == "Advance Payment Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Notes}", AdvancePayment.Notes);
                    }
                    else if (item == "Refund Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Refund Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Refund Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Refund Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Refund Method")
                    {
                        formattedSubject = formattedSubject.Replace("{Refund Method}", Payment.PaymentType);
                    }
                    else if (item == "Refund Reference No")
                    {
                        formattedSubject = formattedSubject.Replace("{Refund Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Refund Receipt Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Refund Receipt Url}", Payment.InvoiceUrl);
                    }
                    else if (item == "Refund Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Refund Notes}", Payment.Notes);
                    }
                    else if (item == "Unused Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Unused Amount}", Payment.AmountRemaining.ToString());
                    }
                }
                #endregion


                #region EmailBody
                string formattedBody = NotificationModulesSetting.EmailBody;
                string[] array = NotificationModulesSetting.EmailBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Logo")
                    {
                        formattedBody = formattedBody.Replace("{Business Logo}", "<img src='" + webUrl + Branch.BusinessLogo + "' />");
                    }
                    else if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", AdvancePayment.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", AdvancePayment.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", AdvancePayment.CustomerEmailId);
                    }
                    else if (item == "Advance Payment Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Place Of Supply}", AdvancePayment.PlaceOfSupply);
                    }
                    else if (item == "Advance Payment Tax")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Tax}", AdvancePayment.Tax);
                    }
                    else if (item == "Advance Payment Amount")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Amount}", AdvancePayment.Amount.ToString());
                    }
                    else if (item == "Advance Payment Date")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Date}", AdvancePayment.PaymentDate.ToString());
                    }
                    else if (item == "Advance Payment Method")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Method}", AdvancePayment.PaymentType);
                    }
                    else if (item == "Advance Payment Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Reference No}", AdvancePayment.ReferenceNo);
                    }
                    else if (item == "Advance Payment Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Receipt Url}", AdvancePayment.InvoiceUrl);
                    }
                    else if (item == "Advance Payment Notes")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Notes}", AdvancePayment.Notes);
                    }
                    else if (item == "Refund Amount")
                    {
                        formattedBody = formattedBody.Replace("{Refund Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Refund Date")
                    {
                        formattedBody = formattedBody.Replace("{Refund Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Refund Method")
                    {
                        formattedBody = formattedBody.Replace("{Refund Method}", Payment.PaymentType);
                    }
                    else if (item == "Refund Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Refund Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Refund Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Refund Receipt Url}", Payment.InvoiceUrl);
                    }
                    else if (item == "Refund Notes")
                    {
                        formattedBody = formattedBody.Replace("{Refund Notes}", Payment.Notes);
                    }
                    else if (item == "Unused Amount")
                    {
                        formattedBody = formattedBody.Replace("{Unused Amount}", Payment.AmountRemaining.ToString());
                    }
                }
                #endregion


                EmailController oEmailController = new EmailController();
                oEmailController.NotificationTemplate(CompanyId, AdvancePayment.CustomerEmailId, formattedSubject, formattedBody, CC, Bcc, AddedBy, CurrentDate, Id, Type, Domain);
            }
            if (WhatsappSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.WhatsappBody;
                string[] array = NotificationModulesSetting.WhatsappBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", AdvancePayment.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", AdvancePayment.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", AdvancePayment.CustomerEmailId);
                    }
                    else if (item == "Advance Payment Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Place Of Supply}", AdvancePayment.PlaceOfSupply);
                    }
                    else if (item == "Advance Payment Tax")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Tax}", AdvancePayment.Tax);
                    }
                    else if (item == "Advance Payment Amount")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Amount}", AdvancePayment.Amount.ToString());
                    }
                    else if (item == "Advance Payment Date")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Date}", AdvancePayment.PaymentDate.ToString());
                    }
                    else if (item == "Advance Payment Method")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Method}", AdvancePayment.PaymentType);
                    }
                    else if (item == "Advance Payment Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Reference No}", AdvancePayment.ReferenceNo);
                    }
                    else if (item == "Advance Payment Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Receipt Url}", AdvancePayment.InvoiceUrl);
                    }
                    else if (item == "Advance Payment Notes")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Notes}", AdvancePayment.Notes);
                    }
                    else if (item == "Refund Amount")
                    {
                        formattedBody = formattedBody.Replace("{Refund Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Refund Date")
                    {
                        formattedBody = formattedBody.Replace("{Refund Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Refund Method")
                    {
                        formattedBody = formattedBody.Replace("{Refund Method}", Payment.PaymentType);
                    }
                    else if (item == "Refund Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Refund Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Refund Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Refund Receipt Url}", Payment.InvoiceUrl);
                    }
                    else if (item == "Refund Notes")
                    {
                        formattedBody = formattedBody.Replace("{Refund Notes}", Payment.Notes);
                    }
                    else if (item == "Unused Amount")
                    {
                        formattedBody = formattedBody.Replace("{Unused Amount}", Payment.AmountRemaining.ToString());
                    }
                }

                WhatsappController oWhatsappController = new WhatsappController();
                return oWhatsappController.WhatsappFunction(CompanyId, AdvancePayment.CustomerMobileNo, formattedBody, 0);
            }
            string[] arr = { "1", "", "" };
            return arr;
        }

        public dynamic CreditsAppliedFromCreditNote(ClsNotificationModulesSettingsVm NotificationModulesSetting, long CompanyId, long Id, string CC, string Bcc, long SmsSettingsId, long EmailSettingsId, long WhatsappSettingsId, string Type, long AddedBy, DateTime CurrentDate, string Domain)
        {
            var Payment = oConnectionContext.DbClsCustomerPayment.Where(a => a.CustomerPaymentId == Id).Select(a => new
            {
                a.BranchId,
                a.ParentId,
                SalesId = a.SalesId,
                ParentSalesId = oConnectionContext.DbClsCustomerPayment.Where(b => b.CustomerPaymentId == a.ParentId
                && b.IsDeleted == false && b.IsCancelled == false && b.IsActive == true).Select(b => b.SalesId).FirstOrDefault(),
                ParentSalesReturnId = oConnectionContext.DbClsCustomerPayment.Where(b => b.CustomerPaymentId == a.ParentId
                && b.IsDeleted == false && b.IsCancelled == false && b.IsActive == true).Select(b => b.SalesReturnId).FirstOrDefault(),
                InvoiceUrl = Domain + "/sales/ReturnPaymentReceipt?ReferenceId=" + a.ReferenceId,
                a.ReferenceNo,
                a.Notes,
                a.Amount,
                a.PaymentDate,
                a.PaymentTypeId,
                PaymentType = oConnectionContext.DbClsPaymentType.Where(b => b.PaymentTypeId == Id).Select(b => b.PaymentType).FirstOrDefault(),
                AmountRemaining = oConnectionContext.DbClsCustomerPayment.Where(b => b.CustomerPaymentId == a.ParentId
                && b.IsDeleted == false && b.IsCancelled == false && b.IsActive == true).Select(b => b.AmountRemaining).FirstOrDefault(),
            }).FirstOrDefault();

            var AppliedSale = oConnectionContext.DbClsSales.Where(a => a.SalesId == Payment.SalesId).Select(a => new
            {
                a.BranchId,
                CustomerName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.Name).FirstOrDefault(),
                CustomerMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.MobileNo).FirstOrDefault(),
                CustomerEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.EmailId).FirstOrDefault(),
                InvoiceNo = a.InvoiceNo,
                InvoiceUrl = Domain + (a.SalesType.ToLower() == "pos" ? "/sales/receipt?InvoiceId=" + a.InvoiceId : "/sales/invoice?InvoiceId=" + a.InvoiceId),
                PlaceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.PlaceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                InvoiceDate = a.SalesDate,
                PaymentTerm = oConnectionContext.DbClsPaymentTerm.Where(b => b.PaymentTermId == a.PaymentTermId).Select(b => b.PaymentTerm).FirstOrDefault(),
                DueDate = a.DueDate,
                SellingPriceGroup = oConnectionContext.DbClsSellingPriceGroup.Where(b => b.SellingPriceGroupId == a.SellingPriceGroupId).
                Select(b => b.SellingPriceGroup).FirstOrDefault(),
                InvoiceNotes = a.Notes,
                Subtotal = a.Subtotal,
                TotalDiscount = a.TotalDiscount,
                TotalTaxAmount = a.TotalTaxAmount,
                NetAmount = a.NetAmount,
                RoundOff = a.RoundOff,
                SpecialDiscount = a.SpecialDiscount,
                GrandTotal = a.GrandTotal,
                a.SalesType
            }).FirstOrDefault();

            var ParentSale = oConnectionContext.DbClsSales.Where(a => a.SalesId == Payment.ParentSalesId).Select(a => new
            {
                a.BranchId,
                CustomerName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.Name).FirstOrDefault(),
                CustomerMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.MobileNo).FirstOrDefault(),
                CustomerEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.EmailId).FirstOrDefault(),
                InvoiceNo = a.InvoiceNo,
                InvoiceUrl = Domain + (a.SalesType.ToLower() == "pos" ? "/sales/receipt?InvoiceId=" + a.InvoiceId : "/sales/invoice?InvoiceId=" + a.InvoiceId),
                PlaceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.PlaceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                InvoiceDate = a.SalesDate,
                PaymentTerm = oConnectionContext.DbClsPaymentTerm.Where(b => b.PaymentTermId == a.PaymentTermId).Select(b => b.PaymentTerm).FirstOrDefault(),
                DueDate = a.DueDate,
                SellingPriceGroup = oConnectionContext.DbClsSellingPriceGroup.Where(b => b.SellingPriceGroupId == a.SellingPriceGroupId).
                Select(b => b.SellingPriceGroup).FirstOrDefault(),
                InvoiceNotes = a.Notes,
                Subtotal = a.Subtotal,
                TotalDiscount = a.TotalDiscount,
                TotalTaxAmount = a.TotalTaxAmount,
                NetAmount = a.NetAmount,
                RoundOff = a.RoundOff,
                SpecialDiscount = a.SpecialDiscount,
                GrandTotal = a.GrandTotal,
                a.SalesType
            }).FirstOrDefault();

            var ParentSaleReturn = oConnectionContext.DbClsSalesReturn.Where(a => a.SalesReturnId == Payment.ParentSalesReturnId).Select(a => new
            {
                a.BranchId,
                PlaceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.PlaceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                Reason = oConnectionContext.DbClsSalesCreditNoteReason.Where(b => b.SalesCreditNoteReasonId == a.SalesCreditNoteReasonId).Select(b => b.SalesCreditNoteReason).FirstOrDefault(),
                Date = a.Date,
                InvoiceNo = a.InvoiceNo,
                InvoiceUrl = Domain + (ParentSale.SalesType.ToLower() == "pos" ? "/sales/salesreturnreceipt?InvoiceId=" + a.InvoiceId : "/sales/salesreturninvoice?InvoiceId=" + a.InvoiceId),
                InvoiceNotes = a.Notes,
                Subtotal = a.Subtotal,
                TotalDiscount = a.TotalDiscount,
                TotalTaxAmount = a.TotalTaxAmount,
                NetAmount = a.NetAmount,
                RoundOff = a.RoundOff,
                SpecialDiscount = a.SpecialDiscount,
                GrandTotal = a.GrandTotal
            }).FirstOrDefault();

            var Branch = oConnectionContext.DbClsBranch.Where(a => a.BranchId == Payment.BranchId).Select(a => new
            {
                BusinessName = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessName).FirstOrDefault(),
                BusinessLogo = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessLogo).FirstOrDefault(),
                a.Branch,
                a.BranchCode,
                a.Address,
                a.Zipcode,
                Country = oConnectionContext.DbClsCountry.Where(b => b.CountryId == a.CountryId).Select(b => b.Country).FirstOrDefault(),
                State = oConnectionContext.DbClsState.Where(b => b.StateId == a.StateId).Select(b => b.State).FirstOrDefault(),
                City = oConnectionContext.DbClsCity.Where(b => b.CityId == a.CityId).Select(b => b.City).FirstOrDefault(),
                //ContactPersonName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.Name).FirstOrDefault(),
                //ContactPersonMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.MobileNo).FirstOrDefault(),
                a.Mobile,
                a.AltMobileNo,
                a.Email,
                BusinessRegistrationNo = oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNo).FirstOrDefault(),
                BusinessRegistrationName = oConnectionContext.DbClsBusinessRegistrationName.Where(c => c.BusinessRegistrationNameId ==
                oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNameId).FirstOrDefault()).Select(c => c.Name).FirstOrDefault()
            }).FirstOrDefault();

            if (SmsSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.SmsBody;
                string[] array = NotificationModulesSetting.SmsBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", ParentSale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", ParentSale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", ParentSale.CustomerEmailId);
                    }
                    else if (item == "Parent Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice No}", ParentSale.InvoiceNo);
                    }
                    else if (item == "Parent Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Parent Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Parent Place Of Supply}", ParentSale.PlaceOfSupply);
                    }
                    else if (item == "Parent Invoice Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Date}", ParentSale.InvoiceDate.ToString());
                    }
                    else if (item == "Parent Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Parent Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Parent Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Parent Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Parent Selling Price Group}", ParentSale.SellingPriceGroup);
                    }
                    else if (item == "Parent Invoice Notes")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Notes}", ParentSale.InvoiceNotes);
                    }
                    else if (item == "Parent Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Parent Discount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Parent Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Parent Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Parent Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Parent Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Parent Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Credit Note Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Place Of Supply}", ParentSaleReturn.PlaceOfSupply);
                    }
                    else if (item == "Credit Note Reason")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Reason}", ParentSaleReturn.Reason);
                    }
                    else if (item == "Credit Note Date")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Date}", ParentSaleReturn.Date.ToString());
                    }
                    else if (item == "Credit Note Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Invoice No}", ParentSaleReturn.InvoiceNo);
                    }
                    else if (item == "Credit Note Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Invoice Url}", ParentSaleReturn.InvoiceUrl);
                    }
                    else if (item == "Credit Note Notes")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Notes}", ParentSaleReturn.InvoiceNotes);
                    }
                    else if (item == "Credit Note Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Gross Amount}", ParentSaleReturn.Subtotal.ToString());
                    }
                    else if (item == "Credit Note Discount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Discount}", ParentSaleReturn.TotalDiscount.ToString());
                    }
                    else if (item == "Credit Note Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Tax Amount}", ParentSaleReturn.TotalTaxAmount.ToString());
                    }
                    else if (item == "Credit Note Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Net Amount}", ParentSaleReturn.NetAmount.ToString());
                    }
                    else if (item == "Credit Note Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Round Off}", ParentSaleReturn.RoundOff.ToString());
                    }
                    else if (item == "Credit Note Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Total Amount}", ParentSaleReturn.GrandTotal.ToString());
                    }
                    else if (item == "Applied Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Applied Invoice No}", AppliedSale.InvoiceNo);
                    }
                    else if (item == "Applied Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Applied Invoice Url}", AppliedSale.InvoiceUrl);
                    }
                    else if (item == "Applied Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Applied Place Of Supply}", AppliedSale.PlaceOfSupply);
                    }
                    else if (item == "Applied Invoice Date")
                    {
                        formattedBody = formattedBody.Replace("{Applied Invoice Date}", AppliedSale.InvoiceDate.ToString());
                    }
                    else if (item == "Applied Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Applied Payment Term}", AppliedSale.PaymentTerm);
                    }
                    else if (item == "Applied Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Applied Due Date}", AppliedSale.DueDate.ToString());
                    }
                    else if (item == "Applied Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Applied Selling Price Group}", AppliedSale.SellingPriceGroup);
                    }
                    else if (item == "Applied Invoice Notes")
                    {
                        formattedBody = formattedBody.Replace("{Applied Invoice Notes}", AppliedSale.InvoiceNotes);
                    }
                    else if (item == "Applied Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Gross Amount}", AppliedSale.Subtotal.ToString());
                    }
                    else if (item == "Applied Discount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Discount}", AppliedSale.TotalDiscount.ToString());
                    }
                    else if (item == "Applied Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Tax Amount}", AppliedSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Applied Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Net Amount}", AppliedSale.NetAmount.ToString());
                    }
                    else if (item == "Applied Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Applied Round Off}", AppliedSale.RoundOff.ToString());
                    }
                    else if (item == "Applied Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Total Amount}", AppliedSale.GrandTotal.ToString());
                    }
                    else if (item == "Credits Applied")
                    {
                        formattedBody = formattedBody.Replace("{Credits Applied}", Payment.Amount.ToString());
                    }
                    else if (item == "Credits Applied Date")
                    {
                        formattedBody = formattedBody.Replace("{Credits Applied Date}", Payment.PaymentDate.ToString());
                    }
                }

                SmsController oSmsController = new SmsController();
                oSmsController.SmsFunction(CompanyId, ParentSale.CustomerMobileNo, formattedBody, AddedBy, CurrentDate, Id, Type, Domain, 0);
            }
            if (EmailSettingsId != 0)
            {
                #region Email Subject
                string formattedSubject = "";

                formattedSubject = NotificationModulesSetting.EmailSubject;
                string[] arr1 = NotificationModulesSetting.EmailSubject.Split('{');
                List<string> list1 = new List<string>();

                foreach (var item in arr1)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list1.Add(item.Split('}')[0]);
                    }
                }


                foreach (var item in list1)
                {
                    if (item == "Business Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Name}", ParentSale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Mobile No}", ParentSale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Email}", ParentSale.CustomerEmailId);
                    }
                    else if (item == "Parent Invoice No")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Invoice No}", ParentSale.InvoiceNo);
                    }
                    else if (item == "Parent Invoice Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Invoice Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Parent Place Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Place Of Supply}", ParentSale.PlaceOfSupply);
                    }
                    else if (item == "Parent Invoice Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Invoice Date}", ParentSale.InvoiceDate.ToString());
                    }
                    else if (item == "Parent Payment Term")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Parent Due Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Parent Selling Price Group")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Selling Price Group}", ParentSale.SellingPriceGroup);
                    }
                    else if (item == "Parent Invoice Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Invoice Notes}", ParentSale.InvoiceNotes);
                    }
                    else if (item == "Parent Gross Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Parent Discount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Parent Tax Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Parent Net Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Parent Round Off")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Parent Total Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Credit Note Place Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Place Of Supply}", ParentSaleReturn.PlaceOfSupply);
                    }
                    else if (item == "Credit Note Reason")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Reason}", ParentSaleReturn.Reason);
                    }
                    else if (item == "Credit Note Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Date}", ParentSaleReturn.Date.ToString());
                    }
                    else if (item == "Credit Note Invoice No")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Invoice No}", ParentSaleReturn.InvoiceNo);
                    }
                    else if (item == "Credit Note Invoice Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Invoice Url}", ParentSaleReturn.InvoiceUrl);
                    }
                    else if (item == "Credit Note Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Notes}", ParentSaleReturn.InvoiceNotes);
                    }
                    else if (item == "Credit Note Gross Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Gross Amount}", ParentSaleReturn.Subtotal.ToString());
                    }
                    else if (item == "Credit Note Discount")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Discount}", ParentSaleReturn.TotalDiscount.ToString());
                    }
                    else if (item == "Credit Note Tax Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Tax Amount}", ParentSaleReturn.TotalTaxAmount.ToString());
                    }
                    else if (item == "Credit Note Net Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Net Amount}", ParentSaleReturn.NetAmount.ToString());
                    }
                    else if (item == "Credit Note Round Off")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Round Off}", ParentSaleReturn.RoundOff.ToString());
                    }
                    else if (item == "Credit Note Total Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Credit Note Total Amount}", ParentSaleReturn.GrandTotal.ToString());
                    }
                    else if (item == "Applied Invoice No")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Invoice No}", AppliedSale.InvoiceNo);
                    }
                    else if (item == "Applied Invoice Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Invoice Url}", AppliedSale.InvoiceUrl);
                    }
                    else if (item == "Applied Place Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Place Of Supply}", AppliedSale.PlaceOfSupply);
                    }
                    else if (item == "Applied Invoice Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Invoice Date}", AppliedSale.InvoiceDate.ToString());
                    }
                    else if (item == "Applied Payment Term")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Payment Term}", AppliedSale.PaymentTerm);
                    }
                    else if (item == "Applied Due Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Due Date}", AppliedSale.DueDate.ToString());
                    }
                    else if (item == "Applied Selling Price Group")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Selling Price Group}", AppliedSale.SellingPriceGroup);
                    }
                    else if (item == "Applied Invoice Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Invoice Notes}", AppliedSale.InvoiceNotes);
                    }
                    else if (item == "Applied Gross Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Gross Amount}", AppliedSale.Subtotal.ToString());
                    }
                    else if (item == "Applied Discount")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Discount}", AppliedSale.TotalDiscount.ToString());
                    }
                    else if (item == "Applied Tax Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Tax Amount}", AppliedSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Applied Net Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Net Amount}", AppliedSale.NetAmount.ToString());
                    }
                    else if (item == "Applied Round Off")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Round Off}", AppliedSale.RoundOff.ToString());
                    }
                    else if (item == "Applied Total Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Total Amount}", AppliedSale.GrandTotal.ToString());
                    }
                    else if (item == "Credits Applied")
                    {
                        formattedSubject = formattedSubject.Replace("{Credits Applied}", Payment.Amount.ToString());
                    }
                    else if (item == "Credits Applied Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Credits Applied Date}", Payment.PaymentDate.ToString());
                    }
                }
                #endregion


                #region EmailBody
                string formattedBody = NotificationModulesSetting.EmailBody;
                string[] array = NotificationModulesSetting.EmailBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Logo")
                    {
                        formattedBody = formattedBody.Replace("{Business Logo}", "<img src='" + webUrl + Branch.BusinessLogo + "' />");
                    }
                    else if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", ParentSale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", ParentSale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", ParentSale.CustomerEmailId);
                    }
                    else if (item == "Parent Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice No}", ParentSale.InvoiceNo);
                    }
                    else if (item == "Parent Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Parent Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Parent Place Of Supply}", ParentSale.PlaceOfSupply);
                    }
                    else if (item == "Parent Invoice Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Date}", ParentSale.InvoiceDate.ToString());
                    }
                    else if (item == "Parent Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Parent Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Parent Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Parent Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Parent Selling Price Group}", ParentSale.SellingPriceGroup);
                    }
                    else if (item == "Parent Invoice Notes")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Notes}", ParentSale.InvoiceNotes);
                    }
                    else if (item == "Parent Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Parent Discount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Parent Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Parent Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Parent Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Parent Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Parent Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Credit Note Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Place Of Supply}", ParentSaleReturn.PlaceOfSupply);
                    }
                    else if (item == "Credit Note Reason")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Reason}", ParentSaleReturn.Reason);
                    }
                    else if (item == "Credit Note Date")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Date}", ParentSaleReturn.Date.ToString());
                    }
                    else if (item == "Credit Note Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Invoice No}", ParentSaleReturn.InvoiceNo);
                    }
                    else if (item == "Credit Note Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Invoice Url}", ParentSaleReturn.InvoiceUrl);
                    }
                    else if (item == "Credit Note Notes")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Notes}", ParentSaleReturn.InvoiceNotes);
                    }
                    else if (item == "Credit Note Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Gross Amount}", ParentSaleReturn.Subtotal.ToString());
                    }
                    else if (item == "Credit Note Discount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Discount}", ParentSaleReturn.TotalDiscount.ToString());
                    }
                    else if (item == "Credit Note Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Tax Amount}", ParentSaleReturn.TotalTaxAmount.ToString());
                    }
                    else if (item == "Credit Note Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Net Amount}", ParentSaleReturn.NetAmount.ToString());
                    }
                    else if (item == "Credit Note Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Round Off}", ParentSaleReturn.RoundOff.ToString());
                    }
                    else if (item == "Credit Note Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Total Amount}", ParentSaleReturn.GrandTotal.ToString());
                    }
                    else if (item == "Applied Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Applied Invoice No}", AppliedSale.InvoiceNo);
                    }
                    else if (item == "Applied Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Applied Invoice Url}", AppliedSale.InvoiceUrl);
                    }
                    else if (item == "Applied Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Applied Place Of Supply}", AppliedSale.PlaceOfSupply);
                    }
                    else if (item == "Applied Invoice Date")
                    {
                        formattedBody = formattedBody.Replace("{Applied Invoice Date}", AppliedSale.InvoiceDate.ToString());
                    }
                    else if (item == "Applied Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Applied Payment Term}", AppliedSale.PaymentTerm);
                    }
                    else if (item == "Applied Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Applied Due Date}", AppliedSale.DueDate.ToString());
                    }
                    else if (item == "Applied Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Applied Selling Price Group}", AppliedSale.SellingPriceGroup);
                    }
                    else if (item == "Applied Invoice Notes")
                    {
                        formattedBody = formattedBody.Replace("{Applied Invoice Notes}", AppliedSale.InvoiceNotes);
                    }
                    else if (item == "Applied Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Gross Amount}", AppliedSale.Subtotal.ToString());
                    }
                    else if (item == "Applied Discount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Discount}", AppliedSale.TotalDiscount.ToString());
                    }
                    else if (item == "Applied Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Tax Amount}", AppliedSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Applied Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Net Amount}", AppliedSale.NetAmount.ToString());
                    }
                    else if (item == "Applied Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Applied Round Off}", AppliedSale.RoundOff.ToString());
                    }
                    else if (item == "Applied Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Total Amount}", AppliedSale.GrandTotal.ToString());
                    }
                    else if (item == "Credits Applied")
                    {
                        formattedBody = formattedBody.Replace("{Credits Applied}", Payment.Amount.ToString());
                    }
                    else if (item == "Credits Applied Date")
                    {
                        formattedBody = formattedBody.Replace("{Credits Applied Date}", Payment.PaymentDate.ToString());
                    }
                }
                #endregion


                EmailController oEmailController = new EmailController();
                oEmailController.NotificationTemplate(CompanyId, ParentSale.CustomerEmailId, formattedSubject, formattedBody, CC, Bcc, AddedBy, CurrentDate, Id, Type, Domain);
            }
            if (WhatsappSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.WhatsappBody;
                string[] array = NotificationModulesSetting.WhatsappBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", ParentSale.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", ParentSale.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", ParentSale.CustomerEmailId);
                    }
                    else if (item == "Parent Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice No}", ParentSale.InvoiceNo);
                    }
                    else if (item == "Parent Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Parent Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Parent Place Of Supply}", ParentSale.PlaceOfSupply);
                    }
                    else if (item == "Parent Invoice Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Date}", ParentSale.InvoiceDate.ToString());
                    }
                    else if (item == "Parent Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Parent Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Parent Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Parent Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Parent Selling Price Group}", ParentSale.SellingPriceGroup);
                    }
                    else if (item == "Parent Invoice Notes")
                    {
                        formattedBody = formattedBody.Replace("{Parent Invoice Notes}", ParentSale.InvoiceNotes);
                    }
                    else if (item == "Parent Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Parent Discount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Parent Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Parent Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Parent Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Parent Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Parent Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Credit Note Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Place Of Supply}", ParentSaleReturn.PlaceOfSupply);
                    }
                    else if (item == "Credit Note Reason")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Reason}", ParentSaleReturn.Reason);
                    }
                    else if (item == "Credit Note Date")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Date}", ParentSaleReturn.Date.ToString());
                    }
                    else if (item == "Credit Note Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Invoice No}", ParentSaleReturn.InvoiceNo);
                    }
                    else if (item == "Credit Note Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Invoice Url}", ParentSaleReturn.InvoiceUrl);
                    }
                    else if (item == "Credit Note Notes")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Notes}", ParentSaleReturn.InvoiceNotes);
                    }
                    else if (item == "Credit Note Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Gross Amount}", ParentSaleReturn.Subtotal.ToString());
                    }
                    else if (item == "Credit Note Discount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Discount}", ParentSaleReturn.TotalDiscount.ToString());
                    }
                    else if (item == "Credit Note Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Tax Amount}", ParentSaleReturn.TotalTaxAmount.ToString());
                    }
                    else if (item == "Credit Note Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Net Amount}", ParentSaleReturn.NetAmount.ToString());
                    }
                    else if (item == "Credit Note Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Round Off}", ParentSaleReturn.RoundOff.ToString());
                    }
                    else if (item == "Credit Note Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Credit Note Total Amount}", ParentSaleReturn.GrandTotal.ToString());
                    }
                    else if (item == "Applied Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Applied Invoice No}", AppliedSale.InvoiceNo);
                    }
                    else if (item == "Applied Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Applied Invoice Url}", AppliedSale.InvoiceUrl);
                    }
                    else if (item == "Applied Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Applied Place Of Supply}", AppliedSale.PlaceOfSupply);
                    }
                    else if (item == "Applied Invoice Date")
                    {
                        formattedBody = formattedBody.Replace("{Applied Invoice Date}", AppliedSale.InvoiceDate.ToString());
                    }
                    else if (item == "Applied Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Applied Payment Term}", AppliedSale.PaymentTerm);
                    }
                    else if (item == "Applied Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Applied Due Date}", AppliedSale.DueDate.ToString());
                    }
                    else if (item == "Applied Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Applied Selling Price Group}", AppliedSale.SellingPriceGroup);
                    }
                    else if (item == "Applied Invoice Notes")
                    {
                        formattedBody = formattedBody.Replace("{Applied Invoice Notes}", AppliedSale.InvoiceNotes);
                    }
                    else if (item == "Applied Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Gross Amount}", AppliedSale.Subtotal.ToString());
                    }
                    else if (item == "Applied Discount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Discount}", AppliedSale.TotalDiscount.ToString());
                    }
                    else if (item == "Applied Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Tax Amount}", AppliedSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Applied Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Net Amount}", AppliedSale.NetAmount.ToString());
                    }
                    else if (item == "Applied Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Applied Round Off}", AppliedSale.RoundOff.ToString());
                    }
                    else if (item == "Applied Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Total Amount}", AppliedSale.GrandTotal.ToString());
                    }
                    else if (item == "Credits Applied")
                    {
                        formattedBody = formattedBody.Replace("{Credits Applied}", Payment.Amount.ToString());
                    }
                    else if (item == "Credits Applied Date")
                    {
                        formattedBody = formattedBody.Replace("{Credits Applied Date}", Payment.PaymentDate.ToString());
                    }
                }

                WhatsappController oWhatsappController = new WhatsappController();
                return oWhatsappController.WhatsappFunction(CompanyId, ParentSale.CustomerMobileNo, formattedBody, 0);
            }
            string[] arr = { "1", "", "" };
            return arr;
        }

        public dynamic CreditsAppliedFromCustomerAdvancePayment(ClsNotificationModulesSettingsVm NotificationModulesSetting, long CompanyId, long Id, string CC, string Bcc, long SmsSettingsId, long EmailSettingsId, long WhatsappSettingsId, string Type, long AddedBy, DateTime CurrentDate, string Domain)
        {
            var Payment = oConnectionContext.DbClsCustomerPayment.Where(a => a.CustomerPaymentId == Id).Select(a => new
            {
                a.BranchId,
                a.ParentId,
                a.SalesId,
                InvoiceUrl = Domain + "/sales/ReturnPaymentReceipt?ReferenceId=" + a.ReferenceId,
                a.ReferenceNo,
                a.Notes,
                a.Amount,
                a.PaymentDate,
                a.PaymentTypeId,
                PaymentType = oConnectionContext.DbClsPaymentType.Where(b => b.PaymentTypeId == Id).Select(b => b.PaymentType).FirstOrDefault(),
                AmountRemaining = oConnectionContext.DbClsCustomerPayment.Where(b => b.CustomerPaymentId == a.ParentId
                && b.IsDeleted == false && b.IsCancelled == false && b.IsActive == true).Select(b => b.AmountRemaining).FirstOrDefault(),
            }).FirstOrDefault();

            var AppliedSale = oConnectionContext.DbClsSales.Where(a => a.SalesId == Payment.SalesId).Select(a => new
            {
                a.BranchId,
                CustomerName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.Name).FirstOrDefault(),
                CustomerMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.MobileNo).FirstOrDefault(),
                CustomerEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.EmailId).FirstOrDefault(),
                InvoiceNo = a.InvoiceNo,
                InvoiceUrl = Domain + (a.SalesType.ToLower() == "pos" ? "/sales/receipt?InvoiceId=" + a.InvoiceId : "/sales/invoice?InvoiceId=" + a.InvoiceId),
                PlaceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.PlaceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                InvoiceDate = a.SalesDate,
                PaymentTerm = oConnectionContext.DbClsPaymentTerm.Where(b => b.PaymentTermId == a.PaymentTermId).Select(b => b.PaymentTerm).FirstOrDefault(),
                DueDate = a.DueDate,
                SellingPriceGroup = oConnectionContext.DbClsSellingPriceGroup.Where(b => b.SellingPriceGroupId == a.SellingPriceGroupId).
                Select(b => b.SellingPriceGroup).FirstOrDefault(),
                InvoiceNotes = a.Notes,
                Subtotal = a.Subtotal,
                TotalDiscount = a.TotalDiscount,
                TotalTaxAmount = a.TotalTaxAmount,
                NetAmount = a.NetAmount,
                RoundOff = a.RoundOff,
                SpecialDiscount = a.SpecialDiscount,
                GrandTotal = a.GrandTotal,
                a.SalesType
            }).FirstOrDefault();

            var AdvancePayment = oConnectionContext.DbClsCustomerPayment.Where(a => a.CustomerPaymentId == Payment.ParentId).Select(a => new
            {
                CustomerName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.Name).FirstOrDefault(),
                CustomerEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.EmailId).FirstOrDefault(),
                CustomerMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.CustomerId).Select(b => b.MobileNo).FirstOrDefault(),
                PlaceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.PlaceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                Tax = oConnectionContext.DbClsTax.Where(b => b.TaxId == a.TaxId).Select(b => b.Tax).FirstOrDefault(),
                a.Amount,
                a.PaymentDate,
                PaymentType = oConnectionContext.DbClsPaymentType.Where(b => b.PaymentTypeId == Id).Select(b => b.PaymentType).FirstOrDefault(),
                a.ReferenceNo,
                InvoiceUrl = Domain + "/sales/PaymentReceipt?ReferenceId=" + a.ReferenceId,
                a.Notes,
                a.BranchId,
                a.CustomerId,
            }).FirstOrDefault();

            var Branch = oConnectionContext.DbClsBranch.Where(a => a.BranchId == Payment.BranchId).Select(a => new
            {
                BusinessName = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessName).FirstOrDefault(),
                BusinessLogo = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessLogo).FirstOrDefault(),
                a.Branch,
                a.BranchCode,
                a.Address,
                a.Zipcode,
                Country = oConnectionContext.DbClsCountry.Where(b => b.CountryId == a.CountryId).Select(b => b.Country).FirstOrDefault(),
                State = oConnectionContext.DbClsState.Where(b => b.StateId == a.StateId).Select(b => b.State).FirstOrDefault(),
                City = oConnectionContext.DbClsCity.Where(b => b.CityId == a.CityId).Select(b => b.City).FirstOrDefault(),
                //ContactPersonName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.Name).FirstOrDefault(),
                //ContactPersonMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.MobileNo).FirstOrDefault(),
                a.Mobile,
                a.AltMobileNo,
                a.Email,
                BusinessRegistrationNo = oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNo).FirstOrDefault(),
                BusinessRegistrationName = oConnectionContext.DbClsBusinessRegistrationName.Where(c => c.BusinessRegistrationNameId ==
                oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNameId).FirstOrDefault()).Select(c => c.Name).FirstOrDefault()
            }).FirstOrDefault();

            if (SmsSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.SmsBody;
                string[] array = NotificationModulesSetting.SmsBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", AdvancePayment.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", AdvancePayment.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", AdvancePayment.CustomerEmailId);
                    }
                    else if (item == "Advance Payment Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Place Of Supply}", AdvancePayment.PlaceOfSupply);
                    }
                    else if (item == "Advance Payment Tax")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Tax}", AdvancePayment.Tax);
                    }
                    else if (item == "Advance Payment Amount")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Amount}", AdvancePayment.Amount.ToString());
                    }
                    else if (item == "Advance Payment Date")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Date}", AdvancePayment.PaymentDate.ToString());
                    }
                    else if (item == "Advance Payment Method")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Method}", AdvancePayment.PaymentType);
                    }
                    else if (item == "Advance Payment Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Reference No}", AdvancePayment.ReferenceNo);
                    }
                    else if (item == "Advance Payment Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Receipt Url}", AdvancePayment.InvoiceUrl);
                    }
                    else if (item == "Advance Payment Notes")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Notes}", AdvancePayment.Notes);
                    }
                    else if (item == "Applied Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Applied Invoice No}", AppliedSale.InvoiceNo);
                    }
                    else if (item == "Applied Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Applied Invoice Url}", AppliedSale.InvoiceUrl);
                    }
                    else if (item == "Applied Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Applied Place Of Supply}", AppliedSale.PlaceOfSupply);
                    }
                    else if (item == "Applied Invoice Date")
                    {
                        formattedBody = formattedBody.Replace("{Applied Invoice Date}", AppliedSale.InvoiceDate.ToString());
                    }
                    else if (item == "Applied Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Applied Payment Term}", AppliedSale.PaymentTerm);
                    }
                    else if (item == "Applied Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Applied Due Date}", AppliedSale.DueDate.ToString());
                    }
                    else if (item == "Applied Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Applied Selling Price Group}", AppliedSale.SellingPriceGroup);
                    }
                    else if (item == "Applied Invoice Notes")
                    {
                        formattedBody = formattedBody.Replace("{Applied Invoice Notes}", AppliedSale.InvoiceNotes);
                    }
                    else if (item == "Applied Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Gross Amount}", AppliedSale.Subtotal.ToString());
                    }
                    else if (item == "Applied Discount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Discount}", AppliedSale.TotalDiscount.ToString());
                    }
                    else if (item == "Applied Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Tax Amount}", AppliedSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Applied Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Net Amount}", AppliedSale.NetAmount.ToString());
                    }
                    else if (item == "Applied Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Applied Round Off}", AppliedSale.RoundOff.ToString());
                    }
                    else if (item == "Applied Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Total Amount}", AppliedSale.GrandTotal.ToString());
                    }
                    else if (item == "Credits Applied")
                    {
                        formattedBody = formattedBody.Replace("{Credits Applied}", Payment.Amount.ToString());
                    }
                    else if (item == "Credits Applied Date")
                    {
                        formattedBody = formattedBody.Replace("{Credits Applied Date}", Payment.PaymentDate.ToString());
                    }
                }

                SmsController oSmsController = new SmsController();
                oSmsController.SmsFunction(CompanyId, AdvancePayment.CustomerMobileNo, formattedBody, AddedBy, CurrentDate, Id, Type, Domain, 0);
            }
            if (EmailSettingsId != 0)
            {
                #region Email Subject
                string formattedSubject = "";

                formattedSubject = NotificationModulesSetting.EmailSubject;
                string[] arr1 = NotificationModulesSetting.EmailSubject.Split('{');
                List<string> list1 = new List<string>();

                foreach (var item in arr1)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list1.Add(item.Split('}')[0]);
                    }
                }


                foreach (var item in list1)
                {
                    if (item == "Business Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Name}", AdvancePayment.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Mobile No}", AdvancePayment.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedSubject = formattedSubject.Replace("{Customer Email}", AdvancePayment.CustomerEmailId);
                    }
                    else if (item == "Advance Payment Place Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Place Of Supply}", AdvancePayment.PlaceOfSupply);
                    }
                    else if (item == "Advance Payment Tax")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Tax}", AdvancePayment.Tax);
                    }
                    else if (item == "Advance Payment Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Amount}", AdvancePayment.Amount.ToString());
                    }
                    else if (item == "Advance Payment Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Date}", AdvancePayment.PaymentDate.ToString());
                    }
                    else if (item == "Advance Payment Method")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Method}", AdvancePayment.PaymentType);
                    }
                    else if (item == "Advance Payment Reference No")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Reference No}", AdvancePayment.ReferenceNo);
                    }
                    else if (item == "Advance Payment Receipt Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Receipt Url}", AdvancePayment.InvoiceUrl);
                    }
                    else if (item == "Advance Payment Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Notes}", AdvancePayment.Notes);
                    }
                    else if (item == "Applied Invoice No")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Invoice No}", AppliedSale.InvoiceNo);
                    }
                    else if (item == "Applied Invoice Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Invoice Url}", AppliedSale.InvoiceUrl);
                    }
                    else if (item == "Applied Place Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Place Of Supply}", AppliedSale.PlaceOfSupply);
                    }
                    else if (item == "Applied Invoice Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Invoice Date}", AppliedSale.InvoiceDate.ToString());
                    }
                    else if (item == "Applied Payment Term")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Payment Term}", AppliedSale.PaymentTerm);
                    }
                    else if (item == "Applied Due Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Due Date}", AppliedSale.DueDate.ToString());
                    }
                    else if (item == "Applied Selling Price Group")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Selling Price Group}", AppliedSale.SellingPriceGroup);
                    }
                    else if (item == "Applied Invoice Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Invoice Notes}", AppliedSale.InvoiceNotes);
                    }
                    else if (item == "Applied Gross Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Gross Amount}", AppliedSale.Subtotal.ToString());
                    }
                    else if (item == "Applied Discount")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Discount}", AppliedSale.TotalDiscount.ToString());
                    }
                    else if (item == "Applied Tax Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Tax Amount}", AppliedSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Applied Net Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Net Amount}", AppliedSale.NetAmount.ToString());
                    }
                    else if (item == "Applied Round Off")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Round Off}", AppliedSale.RoundOff.ToString());
                    }
                    else if (item == "Applied Total Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Total Amount}", AppliedSale.GrandTotal.ToString());
                    }
                    else if (item == "Credits Applied")
                    {
                        formattedSubject = formattedSubject.Replace("{Credits Applied}", Payment.Amount.ToString());
                    }
                    else if (item == "Credits Applied Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Credits Applied Date}", Payment.PaymentDate.ToString());
                    }
                }
                #endregion


                #region EmailBody
                string formattedBody = NotificationModulesSetting.EmailBody;
                string[] array = NotificationModulesSetting.EmailBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Logo")
                    {
                        formattedBody = formattedBody.Replace("{Business Logo}", "<img src='" + webUrl + Branch.BusinessLogo + "' />");
                    }
                    else if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", AdvancePayment.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", AdvancePayment.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", AdvancePayment.CustomerEmailId);
                    }
                    else if (item == "Advance Payment Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Place Of Supply}", AdvancePayment.PlaceOfSupply);
                    }
                    else if (item == "Advance Payment Tax")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Tax}", AdvancePayment.Tax);
                    }
                    else if (item == "Advance Payment Amount")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Amount}", AdvancePayment.Amount.ToString());
                    }
                    else if (item == "Advance Payment Date")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Date}", AdvancePayment.PaymentDate.ToString());
                    }
                    else if (item == "Advance Payment Method")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Method}", AdvancePayment.PaymentType);
                    }
                    else if (item == "Advance Payment Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Reference No}", AdvancePayment.ReferenceNo);
                    }
                    else if (item == "Advance Payment Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Receipt Url}", AdvancePayment.InvoiceUrl);
                    }
                    else if (item == "Advance Payment Notes")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Notes}", AdvancePayment.Notes);
                    }
                    else if (item == "Applied Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Applied Invoice No}", AppliedSale.InvoiceNo);
                    }
                    else if (item == "Applied Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Applied Invoice Url}", AppliedSale.InvoiceUrl);
                    }
                    else if (item == "Applied Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Applied Place Of Supply}", AppliedSale.PlaceOfSupply);
                    }
                    else if (item == "Applied Invoice Date")
                    {
                        formattedBody = formattedBody.Replace("{Applied Invoice Date}", AppliedSale.InvoiceDate.ToString());
                    }
                    else if (item == "Applied Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Applied Payment Term}", AppliedSale.PaymentTerm);
                    }
                    else if (item == "Applied Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Applied Due Date}", AppliedSale.DueDate.ToString());
                    }
                    else if (item == "Applied Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Applied Selling Price Group}", AppliedSale.SellingPriceGroup);
                    }
                    else if (item == "Applied Invoice Notes")
                    {
                        formattedBody = formattedBody.Replace("{Applied Invoice Notes}", AppliedSale.InvoiceNotes);
                    }
                    else if (item == "Applied Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Gross Amount}", AppliedSale.Subtotal.ToString());
                    }
                    else if (item == "Applied Discount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Discount}", AppliedSale.TotalDiscount.ToString());
                    }
                    else if (item == "Applied Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Tax Amount}", AppliedSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Applied Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Net Amount}", AppliedSale.NetAmount.ToString());
                    }
                    else if (item == "Applied Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Applied Round Off}", AppliedSale.RoundOff.ToString());
                    }
                    else if (item == "Applied Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Total Amount}", AppliedSale.GrandTotal.ToString());
                    }
                    else if (item == "Credits Applied")
                    {
                        formattedBody = formattedBody.Replace("{Credits Applied}", Payment.Amount.ToString());
                    }
                    else if (item == "Credits Applied Date")
                    {
                        formattedBody = formattedBody.Replace("{Credits Applied Date}", Payment.PaymentDate.ToString());
                    }
                }
                #endregion


                EmailController oEmailController = new EmailController();
                oEmailController.NotificationTemplate(CompanyId, AdvancePayment.CustomerEmailId, formattedSubject, formattedBody, CC, Bcc, AddedBy, CurrentDate, Id, Type, Domain);
            }
            if (WhatsappSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.WhatsappBody;
                string[] array = NotificationModulesSetting.WhatsappBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Customer Name")
                    {
                        formattedBody = formattedBody.Replace("{Customer Name}", AdvancePayment.CustomerName);
                    }
                    else if (item == "Customer Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Customer Mobile No}", AdvancePayment.CustomerMobileNo);
                    }
                    else if (item == "Customer Email")
                    {
                        formattedBody = formattedBody.Replace("{Customer Email}", AdvancePayment.CustomerEmailId);
                    }
                    else if (item == "Advance Payment Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Place Of Supply}", AdvancePayment.PlaceOfSupply);
                    }
                    else if (item == "Advance Payment Tax")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Tax}", AdvancePayment.Tax);
                    }
                    else if (item == "Advance Payment Amount")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Amount}", AdvancePayment.Amount.ToString());
                    }
                    else if (item == "Advance Payment Date")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Date}", AdvancePayment.PaymentDate.ToString());
                    }
                    else if (item == "Advance Payment Method")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Method}", AdvancePayment.PaymentType);
                    }
                    else if (item == "Advance Payment Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Reference No}", AdvancePayment.ReferenceNo);
                    }
                    else if (item == "Advance Payment Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Receipt Url}", AdvancePayment.InvoiceUrl);
                    }
                    else if (item == "Advance Payment Notes")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Notes}", AdvancePayment.Notes);
                    }
                    else if (item == "Applied Invoice No")
                    {
                        formattedBody = formattedBody.Replace("{Applied Invoice No}", AppliedSale.InvoiceNo);
                    }
                    else if (item == "Applied Invoice Url")
                    {
                        formattedBody = formattedBody.Replace("{Applied Invoice Url}", AppliedSale.InvoiceUrl);
                    }
                    else if (item == "Applied Place Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Applied Place Of Supply}", AppliedSale.PlaceOfSupply);
                    }
                    else if (item == "Applied Invoice Date")
                    {
                        formattedBody = formattedBody.Replace("{Applied Invoice Date}", AppliedSale.InvoiceDate.ToString());
                    }
                    else if (item == "Applied Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Applied Payment Term}", AppliedSale.PaymentTerm);
                    }
                    else if (item == "Applied Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Applied Due Date}", AppliedSale.DueDate.ToString());
                    }
                    else if (item == "Applied Selling Price Group")
                    {
                        formattedBody = formattedBody.Replace("{Applied Selling Price Group}", AppliedSale.SellingPriceGroup);
                    }
                    else if (item == "Applied Invoice Notes")
                    {
                        formattedBody = formattedBody.Replace("{Applied Invoice Notes}", AppliedSale.InvoiceNotes);
                    }
                    else if (item == "Applied Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Gross Amount}", AppliedSale.Subtotal.ToString());
                    }
                    else if (item == "Applied Discount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Discount}", AppliedSale.TotalDiscount.ToString());
                    }
                    else if (item == "Applied Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Tax Amount}", AppliedSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Applied Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Net Amount}", AppliedSale.NetAmount.ToString());
                    }
                    else if (item == "Applied Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Applied Round Off}", AppliedSale.RoundOff.ToString());
                    }
                    else if (item == "Applied Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Total Amount}", AppliedSale.GrandTotal.ToString());
                    }
                    else if (item == "Credits Applied")
                    {
                        formattedBody = formattedBody.Replace("{Credits Applied}", Payment.Amount.ToString());
                    }
                    else if (item == "Credits Applied Date")
                    {
                        formattedBody = formattedBody.Replace("{Credits Applied Date}", Payment.PaymentDate.ToString());
                    }
                }

                WhatsappController oWhatsappController = new WhatsappController();
                return oWhatsappController.WhatsappFunction(CompanyId, AdvancePayment.CustomerMobileNo, formattedBody, 0);
            }
            string[] arr = { "1", "", "" };
            return arr;
        }


        #endregion

        #region Purchase

        public dynamic PurchaseQuotation(ClsNotificationModulesSettingsVm NotificationModulesSetting, long CompanyId, long Id, string CC, string Bcc, long SmsSettingsId, long EmailSettingsId, long WhatsappSettingsId, string Type, long AddedBy, DateTime CurrentDate, string Domain)
        {
            var Sale = oConnectionContext.DbClsPurchaseQuotation.Where(a => a.PurchaseQuotationId == Id).Select(a => new
            {
                a.BranchId,
                SupplierName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.Name).FirstOrDefault(),
                SupplierEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.EmailId).FirstOrDefault(),
                SupplierMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.MobileNo).FirstOrDefault(),
                SourceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.SourceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                DestinationOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.DestinationOfSupplyId).Select(b => b.State).FirstOrDefault(),
                a.ReferenceNo,
                InvoiceUrl = Domain + "/purchasequotation/invoice?InvoiceId=" + a.InvoiceId,
                a.PurchaseQuotationDate,
                a.IsReverseCharge,
                a.Notes,
                a.Subtotal,
                a.TotalDiscount,
                a.TotalTaxAmount,
                a.NetAmount,
                a.RoundOff,
                SpecialDiscount = a.SpecialDiscount,
                a.GrandTotal
            }).FirstOrDefault();

            var Branch = oConnectionContext.DbClsBranch.Where(a => a.BranchId == Sale.BranchId).Select(a => new
            {
                BusinessName = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessName).FirstOrDefault(),
                BusinessLogo = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessLogo).FirstOrDefault(),
                a.Branch,
                a.BranchCode,
                a.Address,
                a.Zipcode,
                Country = oConnectionContext.DbClsCountry.Where(b => b.CountryId == a.CountryId).Select(b => b.Country).FirstOrDefault(),
                State = oConnectionContext.DbClsState.Where(b => b.StateId == a.StateId).Select(b => b.State).FirstOrDefault(),
                City = oConnectionContext.DbClsCity.Where(b => b.CityId == a.CityId).Select(b => b.City).FirstOrDefault(),
                //ContactPersonName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.Name).FirstOrDefault(),
                //ContactPersonMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.MobileNo).FirstOrDefault(),
                a.Mobile,
                a.AltMobileNo,
                a.Email,
                BusinessRegistrationNo = oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNo).FirstOrDefault(),
                BusinessRegistrationName = oConnectionContext.DbClsBusinessRegistrationName.Where(c => c.BusinessRegistrationNameId ==
                oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNameId).FirstOrDefault()).Select(c => c.Name).FirstOrDefault()
            }).FirstOrDefault();

            if (SmsSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.SmsBody;
                string[] array = NotificationModulesSetting.SmsBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Name}", Sale.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Mobile No}", Sale.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Email}", Sale.SupplierEmailId);
                    }
                    else if (item == "Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Source Of Supply}", Sale.SourceOfSupply);
                    }
                    else if (item == "Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Destination Of Supply}", Sale.DestinationOfSupply);
                    }
                    else if (item == "Quotation No")
                    {
                        formattedBody = formattedBody.Replace("{Quotation No}", Sale.ReferenceNo.ToString());
                    }
                    else if (item == "Quotation Url")
                    {
                        formattedBody = formattedBody.Replace("{Quotation Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Quotation Date")
                    {
                        formattedBody = formattedBody.Replace("{Quotation Date}", Sale.PurchaseQuotationDate.ToString());
                    }
                    else if (item == "Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Is Reverse Charge}", Sale.IsReverseCharge.ToString());
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }

                SmsController oSmsController = new SmsController();
                oSmsController.SmsFunction(CompanyId, Sale.SupplierMobileNo, formattedBody, AddedBy, CurrentDate, Id, Type, Domain, 0);
            }
            if (EmailSettingsId != 0)
            {
                #region Email Subject
                string formattedSubject = "";

                formattedSubject = NotificationModulesSetting.EmailSubject;
                string[] arr1 = NotificationModulesSetting.EmailSubject.Split('{');
                List<string> list1 = new List<string>();

                foreach (var item in arr1)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list1.Add(item.Split('}')[0]);
                    }
                }


                foreach (var item in list1)
                {
                    if (item == "Business Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Supplier Name}", Sale.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedSubject = formattedSubject.Replace("{Supplier Mobile No}", Sale.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedSubject = formattedSubject.Replace("{Supplier Email}", Sale.SupplierEmailId);
                    }
                    else if (item == "Source Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Source Of Supply}", Sale.SourceOfSupply);
                    }
                    else if (item == "Destination Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Destination Of Supply}", Sale.DestinationOfSupply);
                    }
                    else if (item == "Quotation No")
                    {
                        formattedSubject = formattedSubject.Replace("{Quotation No}", Sale.ReferenceNo.ToString());
                    }
                    else if (item == "Quotation Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Quotation Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Quotation Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Quotation Date}", Sale.PurchaseQuotationDate.ToString());
                    }
                    else if (item == "Is Reverse Charge")
                    {
                        formattedSubject = formattedSubject.Replace("{Is Reverse Charge}", Sale.IsReverseCharge.ToString());
                    }
                    else if (item == "Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedSubject = formattedSubject.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedSubject = formattedSubject.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }
                #endregion


                #region EmailBody
                string formattedBody = NotificationModulesSetting.EmailBody;
                string[] array = NotificationModulesSetting.EmailBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Logo")
                    {
                        formattedBody = formattedBody.Replace("{Business Logo}", "<img src='" + webUrl + Branch.BusinessLogo + "' />");
                    }
                    else if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Name}", Sale.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Mobile No}", Sale.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Email}", Sale.SupplierEmailId);
                    }
                    else if (item == "Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Source Of Supply}", Sale.SourceOfSupply);
                    }
                    else if (item == "Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Destination Of Supply}", Sale.DestinationOfSupply);
                    }
                    else if (item == "Quotation No")
                    {
                        formattedBody = formattedBody.Replace("{Quotation No}", Sale.ReferenceNo.ToString());
                    }
                    else if (item == "Quotation Url")
                    {
                        formattedBody = formattedBody.Replace("{Quotation Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Quotation Date")
                    {
                        formattedBody = formattedBody.Replace("{Quotation Date}", Sale.PurchaseQuotationDate.ToString());
                    }
                    else if (item == "Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Is Reverse Charge}", Sale.IsReverseCharge.ToString());
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }
                #endregion


                EmailController oEmailController = new EmailController();
                oEmailController.NotificationTemplate(CompanyId, Sale.SupplierEmailId, formattedSubject, formattedBody, CC, Bcc, AddedBy, CurrentDate, Id, Type, Domain);
            }
            if (WhatsappSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.WhatsappBody;
                string[] array = NotificationModulesSetting.WhatsappBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Name}", Sale.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Mobile No}", Sale.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Email}", Sale.SupplierEmailId);
                    }
                    else if (item == "Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Source Of Supply}", Sale.SourceOfSupply);
                    }
                    else if (item == "Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Destination Of Supply}", Sale.DestinationOfSupply);
                    }
                    else if (item == "Quotation No")
                    {
                        formattedBody = formattedBody.Replace("{Quotation No}", Sale.ReferenceNo.ToString());
                    }
                    else if (item == "Quotation Url")
                    {
                        formattedBody = formattedBody.Replace("{Quotation Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Quotation Date")
                    {
                        formattedBody = formattedBody.Replace("{Quotation Date}", Sale.PurchaseQuotationDate.ToString());
                    }
                    else if (item == "Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Is Reverse Charge}", Sale.IsReverseCharge.ToString());
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }

                WhatsappController oWhatsappController = new WhatsappController();
                return oWhatsappController.WhatsappFunction(CompanyId, Sale.SupplierMobileNo, formattedBody, 0);
            }
            string[] arr = { "1", "", "" };
            return arr;
        }

        public dynamic PurchaseOrder(ClsNotificationModulesSettingsVm NotificationModulesSetting, long CompanyId, long Id, string CC, string Bcc, long SmsSettingsId, long EmailSettingsId, long WhatsappSettingsId, string Type, long AddedBy, DateTime CurrentDate, string Domain)
        {
            var Sale = oConnectionContext.DbClsPurchaseOrder.Where(a => a.PurchaseOrderId == Id).Select(a => new
            {
                a.BranchId,
                SupplierName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.Name).FirstOrDefault(),
                SupplierEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.EmailId).FirstOrDefault(),
                SupplierMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.MobileNo).FirstOrDefault(),
                SourceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.SourceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                DestinationOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.DestinationOfSupplyId).Select(b => b.State).FirstOrDefault(),
                a.ReferenceNo,
                InvoiceUrl = Domain + "/purchaseorder/invoice?InvoiceId=" + a.InvoiceId,
                a.PurchaseOrderDate,
                a.IsReverseCharge,
                a.Notes,
                a.Subtotal,
                a.TotalDiscount,
                a.TotalTaxAmount,
                a.NetAmount,
                a.RoundOff,
                SpecialDiscount = a.SpecialDiscount,
                a.GrandTotal
            }).FirstOrDefault();

            var Branch = oConnectionContext.DbClsBranch.Where(a => a.BranchId == Sale.BranchId).Select(a => new
            {
                BusinessName = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessName).FirstOrDefault(),
                BusinessLogo = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessLogo).FirstOrDefault(),
                a.Branch,
                a.BranchCode,
                a.Address,
                a.Zipcode,
                Country = oConnectionContext.DbClsCountry.Where(b => b.CountryId == a.CountryId).Select(b => b.Country).FirstOrDefault(),
                State = oConnectionContext.DbClsState.Where(b => b.StateId == a.StateId).Select(b => b.State).FirstOrDefault(),
                City = oConnectionContext.DbClsCity.Where(b => b.CityId == a.CityId).Select(b => b.City).FirstOrDefault(),
                //ContactPersonName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.Name).FirstOrDefault(),
                //ContactPersonMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.MobileNo).FirstOrDefault(),
                a.Mobile,
                a.AltMobileNo,
                a.Email,
                BusinessRegistrationNo = oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNo).FirstOrDefault(),
                BusinessRegistrationName = oConnectionContext.DbClsBusinessRegistrationName.Where(c => c.BusinessRegistrationNameId ==
                oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNameId).FirstOrDefault()).Select(c => c.Name).FirstOrDefault()
            }).FirstOrDefault();

            if (SmsSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.SmsBody;
                string[] array = NotificationModulesSetting.SmsBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Name}", Sale.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Mobile No}", Sale.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Email}", Sale.SupplierEmailId);
                    }
                    else if (item == "Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Source Of Supply}", Sale.SourceOfSupply);
                    }
                    else if (item == "Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Destination Of Supply}", Sale.DestinationOfSupply);
                    }
                    else if (item == "Order No")
                    {
                        formattedBody = formattedBody.Replace("{Order No}", Sale.ReferenceNo.ToString());
                    }
                    else if (item == "Order Url")
                    {
                        formattedBody = formattedBody.Replace("{Order Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Order Date")
                    {
                        formattedBody = formattedBody.Replace("{Order Date}", Sale.PurchaseOrderDate.ToString());
                    }
                    else if (item == "Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Is Reverse Charge}", Sale.IsReverseCharge.ToString());
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }

                SmsController oSmsController = new SmsController();
                oSmsController.SmsFunction(CompanyId, Sale.SupplierMobileNo, formattedBody, AddedBy, CurrentDate, Id, Type, Domain, 0);
            }
            if (EmailSettingsId != 0)
            {
                #region Email Subject
                string formattedSubject = "";

                formattedSubject = NotificationModulesSetting.EmailSubject;
                string[] arr1 = NotificationModulesSetting.EmailSubject.Split('{');
                List<string> list1 = new List<string>();

                foreach (var item in arr1)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list1.Add(item.Split('}')[0]);
                    }
                }


                foreach (var item in list1)
                {
                    if (item == "Business Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Supplier Name}", Sale.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedSubject = formattedSubject.Replace("{Supplier Mobile No}", Sale.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedSubject = formattedSubject.Replace("{Supplier Email}", Sale.SupplierEmailId);
                    }
                    else if (item == "Source Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Source Of Supply}", Sale.SourceOfSupply);
                    }
                    else if (item == "Destination Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Destination Of Supply}", Sale.DestinationOfSupply);
                    }
                    else if (item == "Order No")
                    {
                        formattedSubject = formattedSubject.Replace("{Order No}", Sale.ReferenceNo.ToString());
                    }
                    else if (item == "Order Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Order Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Order Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Order Date}", Sale.PurchaseOrderDate.ToString());
                    }
                    else if (item == "Is Reverse Charge")
                    {
                        formattedSubject = formattedSubject.Replace("{Is Reverse Charge}", Sale.IsReverseCharge.ToString());
                    }
                    else if (item == "Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedSubject = formattedSubject.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedSubject = formattedSubject.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }
                #endregion


                #region EmailBody
                string formattedBody = NotificationModulesSetting.EmailBody;
                string[] array = NotificationModulesSetting.EmailBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Logo")
                    {
                        formattedBody = formattedBody.Replace("{Business Logo}", "<img src='" + webUrl + Branch.BusinessLogo + "' />");
                    }
                    else if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Name}", Sale.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Mobile No}", Sale.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Email}", Sale.SupplierEmailId);
                    }
                    else if (item == "Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Source Of Supply}", Sale.SourceOfSupply);
                    }
                    else if (item == "Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Destination Of Supply}", Sale.DestinationOfSupply);
                    }
                    else if (item == "Order No")
                    {
                        formattedBody = formattedBody.Replace("{Order No}", Sale.ReferenceNo.ToString());
                    }
                    else if (item == "Order Url")
                    {
                        formattedBody = formattedBody.Replace("{Order Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Order Date")
                    {
                        formattedBody = formattedBody.Replace("{Order Date}", Sale.PurchaseOrderDate.ToString());
                    }
                    else if (item == "Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Is Reverse Charge}", Sale.IsReverseCharge.ToString());
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }
                #endregion


                EmailController oEmailController = new EmailController();
                oEmailController.NotificationTemplate(CompanyId, Sale.SupplierEmailId, formattedSubject, formattedBody, CC, Bcc, AddedBy, CurrentDate, Id, Type, Domain);
            }
            if (WhatsappSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.WhatsappBody;
                string[] array = NotificationModulesSetting.WhatsappBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Name}", Sale.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Mobile No}", Sale.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Email}", Sale.SupplierEmailId);
                    }
                    else if (item == "Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Source Of Supply}", Sale.SourceOfSupply);
                    }
                    else if (item == "Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Destination Of Supply}", Sale.DestinationOfSupply);
                    }
                    else if (item == "Order No")
                    {
                        formattedBody = formattedBody.Replace("{Order No}", Sale.ReferenceNo.ToString());
                    }
                    else if (item == "Order Url")
                    {
                        formattedBody = formattedBody.Replace("{Order Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Order Date")
                    {
                        formattedBody = formattedBody.Replace("{Order Date}", Sale.PurchaseOrderDate.ToString());
                    }
                    else if (item == "Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Is Reverse Charge}", Sale.IsReverseCharge.ToString());
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }

                WhatsappController oWhatsappController = new WhatsappController();
                return oWhatsappController.WhatsappFunction(CompanyId, Sale.SupplierMobileNo, formattedBody, 0);
            }
            string[] arr = { "1", "", "" };
            return arr;
        }

        public dynamic PurchaseBill(ClsNotificationModulesSettingsVm NotificationModulesSetting, long CompanyId, long Id, string CC, string Bcc, long SmsSettingsId, long EmailSettingsId, long WhatsappSettingsId, string Type, long AddedBy, DateTime CurrentDate, string Domain)
        {
            var Sale = oConnectionContext.DbClsPurchase.Where(a => a.PurchaseId == Id).Select(a => new
            {
                a.BranchId,
                SupplierName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.Name).FirstOrDefault(),
                SupplierEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.EmailId).FirstOrDefault(),
                SupplierMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.MobileNo).FirstOrDefault(),
                SourceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.SourceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                DestinationOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.DestinationOfSupplyId).Select(b => b.State).FirstOrDefault(),
                a.ReferenceNo,
                InvoiceUrl = Domain + "/purchase/invoice?InvoiceId=" + a.InvoiceId,
                a.PurchaseDate,
                PaymentTerm = oConnectionContext.DbClsPaymentTerm.Where(b => b.PaymentTermId == a.PaymentTermId).Select(b => b.PaymentTerm).FirstOrDefault(),
                a.DueDate,
                a.IsReverseCharge,
                a.Notes,
                a.Subtotal,
                a.TotalDiscount,
                a.TotalTaxAmount,
                a.NetAmount,
                a.RoundOff,
                SpecialDiscount = a.SpecialDiscount,
                a.GrandTotal
            }).FirstOrDefault();

            var Branch = oConnectionContext.DbClsBranch.Where(a => a.BranchId == Sale.BranchId).Select(a => new
            {
                BusinessName = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessName).FirstOrDefault(),
                BusinessLogo = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessLogo).FirstOrDefault(),
                a.Branch,
                a.BranchCode,
                a.Address,
                a.Zipcode,
                Country = oConnectionContext.DbClsCountry.Where(b => b.CountryId == a.CountryId).Select(b => b.Country).FirstOrDefault(),
                State = oConnectionContext.DbClsState.Where(b => b.StateId == a.StateId).Select(b => b.State).FirstOrDefault(),
                City = oConnectionContext.DbClsCity.Where(b => b.CityId == a.CityId).Select(b => b.City).FirstOrDefault(),
                //ContactPersonName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.Name).FirstOrDefault(),
                //ContactPersonMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.MobileNo).FirstOrDefault(),
                a.Mobile,
                a.AltMobileNo,
                a.Email,
                BusinessRegistrationNo = oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNo).FirstOrDefault(),
                BusinessRegistrationName = oConnectionContext.DbClsBusinessRegistrationName.Where(c => c.BusinessRegistrationNameId ==
                oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNameId).FirstOrDefault()).Select(c => c.Name).FirstOrDefault()
            }).FirstOrDefault();

            if (SmsSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.SmsBody;
                string[] array = NotificationModulesSetting.SmsBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Name}", Sale.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Mobile No}", Sale.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Email}", Sale.SupplierEmailId);
                    }
                    else if (item == "Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Source Of Supply}", Sale.SourceOfSupply);
                    }
                    else if (item == "Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Destination Of Supply}", Sale.DestinationOfSupply);
                    }
                    else if (item == "Bill No")
                    {
                        formattedBody = formattedBody.Replace("{Bill No}", Sale.ReferenceNo.ToString());
                    }
                    else if (item == "Bill Url")
                    {
                        formattedBody = formattedBody.Replace("{Bill Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Bill Date")
                    {
                        formattedBody = formattedBody.Replace("{Bill Date}", Sale.PurchaseDate.ToString());
                    }
                    else if (item == "Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Payment Term}", Sale.PaymentTerm);
                    }
                    else if (item == "Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Due Date}", Sale.DueDate.ToString());
                    }
                    else if (item == "Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Is Reverse Charge}", Sale.IsReverseCharge.ToString());
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }

                SmsController oSmsController = new SmsController();
                oSmsController.SmsFunction(CompanyId, Sale.SupplierMobileNo, formattedBody, AddedBy, CurrentDate, Id, Type, Domain, 0);
            }
            if (EmailSettingsId != 0)
            {
                #region Email Subject
                string formattedSubject = "";

                formattedSubject = NotificationModulesSetting.EmailSubject;
                string[] arr1 = NotificationModulesSetting.EmailSubject.Split('{');
                List<string> list1 = new List<string>();

                foreach (var item in arr1)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list1.Add(item.Split('}')[0]);
                    }
                }


                foreach (var item in list1)
                {
                    if (item == "Business Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Supplier Name}", Sale.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedSubject = formattedSubject.Replace("{Supplier Mobile No}", Sale.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedSubject = formattedSubject.Replace("{Supplier Email}", Sale.SupplierEmailId);
                    }
                    else if (item == "Source Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Source Of Supply}", Sale.SourceOfSupply);
                    }
                    else if (item == "Destination Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Destination Of Supply}", Sale.DestinationOfSupply);
                    }
                    else if (item == "Bill No")
                    {
                        formattedSubject = formattedSubject.Replace("{Bill No}", Sale.ReferenceNo.ToString());
                    }
                    else if (item == "Bill Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Bill Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Bill Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Bill Date}", Sale.PurchaseDate.ToString());
                    }
                    else if (item == "Payment Term")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Term}", Sale.PaymentTerm);
                    }
                    else if (item == "Due Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Due Date}", Sale.DueDate.ToString());
                    }
                    else if (item == "Is Reverse Charge")
                    {
                        formattedSubject = formattedSubject.Replace("{Is Reverse Charge}", Sale.IsReverseCharge.ToString());
                    }
                    else if (item == "Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedSubject = formattedSubject.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedSubject = formattedSubject.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }
                #endregion


                #region EmailBody
                string formattedBody = NotificationModulesSetting.EmailBody;
                string[] array = NotificationModulesSetting.EmailBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Logo")
                    {
                        formattedBody = formattedBody.Replace("{Business Logo}", "<img src='" + webUrl + Branch.BusinessLogo + "' />");
                    }
                    else if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Name}", Sale.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Mobile No}", Sale.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Email}", Sale.SupplierEmailId);
                    }
                    else if (item == "Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Source Of Supply}", Sale.SourceOfSupply);
                    }
                    else if (item == "Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Destination Of Supply}", Sale.DestinationOfSupply);
                    }
                    else if (item == "Bill No")
                    {
                        formattedBody = formattedBody.Replace("{Bill No}", Sale.ReferenceNo.ToString());
                    }
                    else if (item == "Bill Url")
                    {
                        formattedBody = formattedBody.Replace("{Bill Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Bill Date")
                    {
                        formattedBody = formattedBody.Replace("{Bill Date}", Sale.PurchaseDate.ToString());
                    }
                    else if (item == "Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Payment Term}", Sale.PaymentTerm);
                    }
                    else if (item == "Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Due Date}", Sale.DueDate.ToString());
                    }
                    else if (item == "Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Is Reverse Charge}", Sale.IsReverseCharge.ToString());
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }
                #endregion


                EmailController oEmailController = new EmailController();
                oEmailController.NotificationTemplate(CompanyId, Sale.SupplierEmailId, formattedSubject, formattedBody, CC, Bcc, AddedBy, CurrentDate, Id, Type, Domain);
            }
            if (WhatsappSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.WhatsappBody;
                string[] array = NotificationModulesSetting.WhatsappBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Name}", Sale.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Mobile No}", Sale.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Email}", Sale.SupplierEmailId);
                    }
                    else if (item == "Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Source Of Supply}", Sale.SourceOfSupply);
                    }
                    else if (item == "Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Destination Of Supply}", Sale.DestinationOfSupply);
                    }
                    else if (item == "Bill No")
                    {
                        formattedBody = formattedBody.Replace("{Bill No}", Sale.ReferenceNo.ToString());
                    }
                    else if (item == "Bill Url")
                    {
                        formattedBody = formattedBody.Replace("{Bill Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Bill Date")
                    {
                        formattedBody = formattedBody.Replace("{Bill Date}", Sale.PurchaseDate.ToString());
                    }
                    else if (item == "Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Payment Term}", Sale.PaymentTerm);
                    }
                    else if (item == "Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Due Date}", Sale.DueDate.ToString());
                    }
                    else if (item == "Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Is Reverse Charge}", Sale.IsReverseCharge.ToString());
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                }

                WhatsappController oWhatsappController = new WhatsappController();
                return oWhatsappController.WhatsappFunction(CompanyId, Sale.SupplierMobileNo, formattedBody, 0);
            }
            string[] arr = { "1", "", "" };
            return arr;
        }

        public dynamic PurchaseDebitNote(ClsNotificationModulesSettingsVm NotificationModulesSetting, long CompanyId, long Id, string CC, string Bcc, long SmsSettingsId, long EmailSettingsId, long WhatsappSettingsId, string Type, long AddedBy, DateTime CurrentDate, string Domain)
        {
            long ParentPurchaseId = oConnectionContext.DbClsPurchaseReturn.Where(a => a.PurchaseReturnId == Id).Select(a => a.PurchaseId).FirstOrDefault();

            var ParentSale = oConnectionContext.DbClsPurchase.Where(a => a.PurchaseId == ParentPurchaseId).Select(a => new
            {
                a.BranchId,
                SupplierName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.Name).FirstOrDefault(),
                SupplierEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.EmailId).FirstOrDefault(),
                SupplierMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.MobileNo).FirstOrDefault(),
                a.ReferenceNo,
                InvoiceUrl = Domain + "/purchase/invoice?InvoiceId=" + a.InvoiceId,
                SourceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.SourceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                DestinationOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.DestinationOfSupplyId).Select(b => b.State).FirstOrDefault(),
                a.PurchaseDate,
                PaymentTerm = oConnectionContext.DbClsPaymentTerm.Where(b => b.PaymentTermId == a.PaymentTermId).Select(b => b.PaymentTerm).FirstOrDefault(),
                a.DueDate,
                a.IsReverseCharge,
                a.Notes,
                a.Subtotal,
                a.TotalDiscount,
                a.TotalTaxAmount,
                a.NetAmount,
                a.RoundOff,
                SpecialDiscount = a.SpecialDiscount,
                a.GrandTotal
            }).FirstOrDefault();

            var Sale = oConnectionContext.DbClsPurchaseReturn.Where(a => a.PurchaseReturnId == Id).Select(a => new
            {
                a.BranchId,
                SourceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.SourceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                DestinationOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.DestinationOfSupplyId).Select(b => b.State).FirstOrDefault(),
                Date = a.Date,
                InvoiceNo = a.InvoiceNo,
                InvoiceUrl = Domain + "/purchase/PurchaseReturnInvoice?InvoiceId=" + a.InvoiceId,
                Reason = oConnectionContext.DbClsPurchaseDebitNoteReason.Where(b => b.PurchaseDebitNoteReasonId == a.PurchaseDebitNoteReasonId).Select(b => b.PurchaseDebitNoteReason).FirstOrDefault(),
                a.IsReverseCharge,
                InvoiceNotes = a.Notes,
                Subtotal = a.Subtotal,
                TotalDiscount = a.TotalDiscount,
                TotalTaxAmount = a.TotalTaxAmount,
                NetAmount = a.NetAmount,
                RoundOff = a.RoundOff,
                SpecialDiscount = a.SpecialDiscount,
                GrandTotal = a.GrandTotal
            }).FirstOrDefault();

            var Branch = oConnectionContext.DbClsBranch.Where(a => a.BranchId == Sale.BranchId).Select(a => new
            {
                BusinessName = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessName).FirstOrDefault(),
                BusinessLogo = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessLogo).FirstOrDefault(),
                a.Branch,
                a.BranchCode,
                a.Address,
                a.Zipcode,
                Country = oConnectionContext.DbClsCountry.Where(b => b.CountryId == a.CountryId).Select(b => b.Country).FirstOrDefault(),
                State = oConnectionContext.DbClsState.Where(b => b.StateId == a.StateId).Select(b => b.State).FirstOrDefault(),
                City = oConnectionContext.DbClsCity.Where(b => b.CityId == a.CityId).Select(b => b.City).FirstOrDefault(),
                //ContactPersonName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.Name).FirstOrDefault(),
                //ContactPersonMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.MobileNo).FirstOrDefault(),
                a.Mobile,
                a.AltMobileNo,
                a.Email,
                BusinessRegistrationNo = oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNo).FirstOrDefault(),
                BusinessRegistrationName = oConnectionContext.DbClsBusinessRegistrationName.Where(c => c.BusinessRegistrationNameId ==
                oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNameId).FirstOrDefault()).Select(c => c.Name).FirstOrDefault()
            }).FirstOrDefault();

            if (SmsSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.SmsBody;
                string[] array = NotificationModulesSetting.SmsBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Name}", ParentSale.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Mobile No}", ParentSale.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Email}", ParentSale.SupplierEmailId);
                    }
                    else if (item == "Parent Bill No")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill No}", ParentSale.ReferenceNo.ToString());
                    }
                    else if (item == "Parent Bill Url")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Parent Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Parent Source Of Supply}", ParentSale.SourceOfSupply);
                    }
                    else if (item == "Parent Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Parent Destination Of Supply}", ParentSale.DestinationOfSupply);
                    }
                    else if (item == "Parent Bill Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill Date}", ParentSale.PurchaseDate.ToString());
                    }
                    else if (item == "Parent Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Parent Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Parent Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Parent Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Parent Is Reverse Charge}", ParentSale.IsReverseCharge.ToString());
                    }
                    else if (item == "Parent Bill Notes")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill Notes}", ParentSale.Notes);
                    }
                    else if (item == "Parent Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Parent Discount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Parent Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Parent Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Parent Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Parent Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Parent Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Debit Note Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Source Of Supply}", Sale.SourceOfSupply);
                    }
                    else if (item == "Debit Note Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Destination Of Supply}", Sale.DestinationOfSupply);
                    }
                    else if (item == "Debit Note Date")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Date}", Sale.Date.ToString());
                    }
                    else if (item == "Debit Note Bill No")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Bill No}", Sale.InvoiceNo.ToString());
                    }
                    else if (item == "Debit Note Bill Url")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Bill Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Debit Note Reason")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Reason}", Sale.Reason);
                    }
                    else if (item == "Debit Note Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Is Reverse Charge}", Sale.IsReverseCharge.ToString());
                    }
                    else if (item == "Debit Note Notes")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Notes}", Sale.InvoiceNotes);
                    }
                    else if (item == "Debit Note Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Debit Note Discount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Debit Note Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Debit Note Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Debit Note Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Debit Note Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Total Amount}", Sale.GrandTotal.ToString());
                    }
                }

                SmsController oSmsController = new SmsController();
                oSmsController.SmsFunction(CompanyId, ParentSale.SupplierMobileNo, formattedBody, AddedBy, CurrentDate, Id, Type, Domain, 0);
            }
            if (EmailSettingsId != 0)
            {
                #region Email Subject
                string formattedSubject = "";

                formattedSubject = NotificationModulesSetting.EmailSubject;
                string[] arr1 = NotificationModulesSetting.EmailSubject.Split('{');
                List<string> list1 = new List<string>();

                foreach (var item in arr1)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list1.Add(item.Split('}')[0]);
                    }
                }


                foreach (var item in list1)
                {
                    if (item == "Business Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Supplier Name}", ParentSale.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedSubject = formattedSubject.Replace("{Supplier Mobile No}", ParentSale.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedSubject = formattedSubject.Replace("{Supplier Email}", ParentSale.SupplierEmailId);
                    }
                    else if (item == "Parent Bill No")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Bill No}", ParentSale.ReferenceNo.ToString());
                    }
                    else if (item == "Parent Bill Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Bill Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Parent Source Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Source Of Supply}", ParentSale.SourceOfSupply);
                    }
                    else if (item == "Parent Destination Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Destination Of Supply}", ParentSale.DestinationOfSupply);
                    }
                    else if (item == "Parent Bill Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Bill Date}", ParentSale.PurchaseDate.ToString());
                    }
                    else if (item == "Parent Payment Term")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Parent Due Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Parent Is Reverse Charge")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Is Reverse Charge}", ParentSale.IsReverseCharge.ToString());
                    }
                    else if (item == "{Parent Bill Notes}")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Bill Notes}", ParentSale.Notes);
                    }
                    else if (item == "Parent Gross Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Parent Discount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Parent Tax Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Parent Net Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Parent Round Off")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Parent Total Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Debit Note Source Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Source Of Supply}", Sale.SourceOfSupply);
                    }
                    else if (item == "Debit Note Destination Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Destination Of Supply}", Sale.DestinationOfSupply);
                    }
                    else if (item == "Debit Note Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Date}", Sale.Date.ToString());
                    }
                    else if (item == "Debit Note Bill No")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Bill No}", Sale.InvoiceNo.ToString());
                    }
                    else if (item == "Debit Note Bill Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Bill Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Debit Note Reason")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Reason}", Sale.Reason);
                    }
                    else if (item == "Debit Note Is Reverse Charge")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Is Reverse Charge}", Sale.IsReverseCharge.ToString());
                    }
                    else if (item == "Debit Note Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Notes}", Sale.InvoiceNotes);
                    }
                    else if (item == "Debit Note Gross Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Debit Note Discount")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Debit Note Tax Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Debit Note Net Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Debit Note Round Off")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Debit Note Total Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Total Amount}", Sale.GrandTotal.ToString());
                    }
                }
                #endregion


                #region EmailBody
                string formattedBody = NotificationModulesSetting.EmailBody;
                string[] array = NotificationModulesSetting.EmailBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Logo")
                    {
                        formattedBody = formattedBody.Replace("{Business Logo}", "<img src='" + webUrl + Branch.BusinessLogo + "' />");
                    }
                    else if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Name}", ParentSale.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Mobile No}", ParentSale.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Email}", ParentSale.SupplierEmailId);
                    }
                    else if (item == "Parent Bill No")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill No}", ParentSale.ReferenceNo.ToString());
                    }
                    else if (item == "Parent Bill Url")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Parent Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Parent Source Of Supply}", ParentSale.SourceOfSupply);
                    }
                    else if (item == "Parent Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Parent Destination Of Supply}", ParentSale.DestinationOfSupply);
                    }
                    else if (item == "Parent Bill Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill Date}", ParentSale.PurchaseDate.ToString());
                    }
                    else if (item == "Parent Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Parent Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Parent Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Parent Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Parent Is Reverse Charge}", ParentSale.IsReverseCharge.ToString());
                    }
                    else if (item == "{Parent Bill Notes}")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill Notes}", ParentSale.Notes);
                    }
                    else if (item == "Parent Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Parent Discount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Parent Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Parent Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Parent Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Parent Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Parent Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Debit Note Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Source Of Supply}", Sale.SourceOfSupply);
                    }
                    else if (item == "Debit Note Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Destination Of Supply}", Sale.DestinationOfSupply);
                    }
                    else if (item == "Debit Note Date")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Date}", Sale.Date.ToString());
                    }
                    else if (item == "Debit Note Bill No")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Bill No}", Sale.InvoiceNo.ToString());
                    }
                    else if (item == "Debit Note Bill Url")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Bill Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Debit Note Reason")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Reason}", Sale.Reason);
                    }
                    else if (item == "Debit Note Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Is Reverse Charge}", Sale.IsReverseCharge.ToString());
                    }
                    else if (item == "Debit Note Notes")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Notes}", Sale.InvoiceNotes);
                    }
                    else if (item == "Debit Note Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Debit Note Discount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Debit Note Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Debit Note Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Debit Note Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Debit Note Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Total Amount}", Sale.GrandTotal.ToString());
                    }
                }
                #endregion


                EmailController oEmailController = new EmailController();
                oEmailController.NotificationTemplate(CompanyId, ParentSale.SupplierEmailId, formattedSubject, formattedBody, CC, Bcc, AddedBy, CurrentDate, Id, Type, Domain);
            }
            if (WhatsappSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.WhatsappBody;
                string[] array = NotificationModulesSetting.WhatsappBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Name}", ParentSale.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Mobile No}", ParentSale.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Email}", ParentSale.SupplierEmailId);
                    }
                    else if (item == "Parent Bill No")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill No}", ParentSale.ReferenceNo.ToString());
                    }
                    else if (item == "Parent Bill Url")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Parent Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Parent Source Of Supply}", ParentSale.SourceOfSupply);
                    }
                    else if (item == "Parent Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Parent Destination Of Supply}", ParentSale.DestinationOfSupply);
                    }
                    else if (item == "Parent Bill Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill Date}", ParentSale.PurchaseDate.ToString());
                    }
                    else if (item == "Parent Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Parent Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Parent Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Parent Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Parent Is Reverse Charge}", ParentSale.IsReverseCharge.ToString());
                    }
                    else if (item == "{Parent Bill Notes}")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill Notes}", ParentSale.Notes);
                    }
                    else if (item == "Parent Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Parent Discount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Parent Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Parent Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Parent Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Parent Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Parent Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Debit Note Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Source Of Supply}", Sale.SourceOfSupply);
                    }
                    else if (item == "Debit Note Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Destination Of Supply}", Sale.DestinationOfSupply);
                    }
                    else if (item == "Debit Note Date")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Date}", Sale.Date.ToString());
                    }
                    else if (item == "Debit Note Bill No")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Bill No}", Sale.InvoiceNo.ToString());
                    }
                    else if (item == "Debit Note Bill Url")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Bill Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Debit Note Reason")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Reason}", Sale.Reason);
                    }
                    else if (item == "Debit Note Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Is Reverse Charge}", Sale.IsReverseCharge.ToString());
                    }
                    else if (item == "Debit Note Notes")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Notes}", Sale.InvoiceNotes);
                    }
                    else if (item == "Debit Note Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Debit Note Discount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Debit Note Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Debit Note Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Debit Note Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Debit Note Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Total Amount}", Sale.GrandTotal.ToString());
                    }
                }

                WhatsappController oWhatsappController = new WhatsappController();
                return oWhatsappController.WhatsappFunction(CompanyId, ParentSale.SupplierMobileNo, formattedBody, 0);
            }
            string[] arr = { "1", "", "" };
            return arr;
        }

        public dynamic PurchaseBillPayment(ClsNotificationModulesSettingsVm NotificationModulesSetting, long CompanyId, long Id, string CC, string Bcc, long SmsSettingsId, long EmailSettingsId, long WhatsappSettingsId, string Type, long AddedBy, DateTime CurrentDate, string Domain)
        {
            var Payment = oConnectionContext.DbClsSupplierPayment.Where(a => a.SupplierPaymentId == Id).Select(a => new
            {
                SupplierName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.Name).FirstOrDefault(),
                SupplierMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.MobileNo).FirstOrDefault(),
                SupplierEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.EmailId).FirstOrDefault(),
                a.Amount,
                a.PaymentDate,
                PaymentType = oConnectionContext.DbClsPaymentType.Where(b => b.PaymentTypeId == Id).Select(b => b.PaymentType).FirstOrDefault(),
                a.ReferenceNo,
                a.Notes,
                InvoiceUrl = Domain + "/purchase/PaymentReceipt?ReferenceId=" + a.ReferenceId,
                a.PurchaseId,
                a.BranchId,
                SupplierPaymentIds = oConnectionContext.DbClsSupplierPayment.Where(c => c.ParentId == a.SupplierPaymentId && c.IsDeleted == false
                && c.IsCancelled == false).Select(c => new
                {
                    BranchId = oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.BranchId).FirstOrDefault(),
                    //SupplierName = oConnectionContext.DbClsUser.Where(b => b.UserId == oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.SupplierId).FirstOrDefault()).Select(b => b.Name).FirstOrDefault(),
                    //SupplierEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.SupplierId).FirstOrDefault()).Select(b => b.EmailId).FirstOrDefault(),
                    //SupplierMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.SupplierId).FirstOrDefault()).Select(b => b.MobileNo).FirstOrDefault(),
                    SourceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.SourceOfSupplyId).FirstOrDefault()).Select(b => b.State).FirstOrDefault(),
                    DestinationOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.DestinationOfSupplyId).FirstOrDefault()).Select(b => b.State).FirstOrDefault(),
                    ReferenceNo = oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.ReferenceNo).FirstOrDefault(),
                    InvoiceUrl = Domain + "/purchase/invoice?InvoiceId=" + c.PurchaseId,
                    PurchaseDate = oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.PurchaseDate).FirstOrDefault(),
                    PaymentTerm = oConnectionContext.DbClsPaymentTerm.Where(b => b.PaymentTermId == oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.PaymentTermId).FirstOrDefault()).Select(b => b.PaymentTerm).FirstOrDefault(),
                    DueDate = oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.DueDate).FirstOrDefault(),
                    IsReverseCharge = oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.IsReverseCharge).FirstOrDefault(),
                    Notes = oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.Notes).FirstOrDefault(),
                    Subtotal = oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.Subtotal).FirstOrDefault(),
                    TotalDiscount = oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.TotalDiscount).FirstOrDefault(),
                    TotalTaxAmount = oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.TotalTaxAmount).FirstOrDefault(),
                    NetAmount = oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.NetAmount).FirstOrDefault(),
                    RoundOff = oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.RoundOff).FirstOrDefault(),
                    GrandTotal = oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.GrandTotal).FirstOrDefault(),
                    Paid = oConnectionContext.DbClsSupplierPayment.Where(b => b.Type.ToLower() == "purchase payment" && !b.IsDeleted && !b.IsCancelled && b.PurchaseId == c.PurchaseId).Select(b => b.Amount).DefaultIfEmpty().Sum(),
                    Due = oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.GrandTotal).FirstOrDefault() -
      oConnectionContext.DbClsSupplierPayment.Where(b => b.Type.ToLower() == "purchase payment" && !b.IsDeleted && !b.IsCancelled && b.PurchaseId == c.PurchaseId).Select(b => b.Amount).DefaultIfEmpty().Sum(),
                }).Union(
                   oConnectionContext.DbClsSupplierPayment.Where(c => c.SupplierPaymentId == a.SupplierPaymentId && c.IsDirectPayment == true).Select(c => new
                   {
                       BranchId = oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.BranchId).FirstOrDefault(),
                       //SupplierName = oConnectionContext.DbClsUser.Where(b => b.UserId == oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.SupplierId).FirstOrDefault()).Select(b => b.Name).FirstOrDefault(),
                       //SupplierEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.SupplierId).FirstOrDefault()).Select(b => b.EmailId).FirstOrDefault(),
                       //SupplierMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.SupplierId).FirstOrDefault()).Select(b => b.MobileNo).FirstOrDefault(),
                       SourceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.SourceOfSupplyId).FirstOrDefault()).Select(b => b.State).FirstOrDefault(),
                       DestinationOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.DestinationOfSupplyId).FirstOrDefault()).Select(b => b.State).FirstOrDefault(),
                       ReferenceNo = oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.ReferenceNo).FirstOrDefault(),
                       InvoiceUrl = Domain + "/purchase/invoice?InvoiceId=" + c.PurchaseId,
                       PurchaseDate = oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.PurchaseDate).FirstOrDefault(),
                       PaymentTerm = oConnectionContext.DbClsPaymentTerm.Where(b => b.PaymentTermId == oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.PaymentTermId).FirstOrDefault()).Select(b => b.PaymentTerm).FirstOrDefault(),
                       DueDate = oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.DueDate).FirstOrDefault(),
                       IsReverseCharge = oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.IsReverseCharge).FirstOrDefault(),
                       Notes = oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.Notes).FirstOrDefault(),
                       Subtotal = oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.Subtotal).FirstOrDefault(),
                       TotalDiscount = oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.TotalDiscount).FirstOrDefault(),
                       TotalTaxAmount = oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.TotalTaxAmount).FirstOrDefault(),
                       NetAmount = oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.NetAmount).FirstOrDefault(),
                       RoundOff = oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.RoundOff).FirstOrDefault(),
                       GrandTotal = oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.GrandTotal).FirstOrDefault(),
                       Paid = oConnectionContext.DbClsSupplierPayment.Where(b => b.Type.ToLower() == "purchase payment" && !b.IsDeleted && !b.IsCancelled && b.PurchaseId == c.PurchaseId).Select(b => b.Amount).DefaultIfEmpty().Sum(),
                       Due = oConnectionContext.DbClsPurchase.Where(d => d.PurchaseId == c.PurchaseId).Select(d => d.GrandTotal).FirstOrDefault() -
      oConnectionContext.DbClsSupplierPayment.Where(b => b.Type.ToLower() == "purchase payment" && !b.IsDeleted && !b.IsCancelled && b.PurchaseId == c.PurchaseId).Select(b => b.Amount).DefaultIfEmpty().Sum(),

                   }))
            }).FirstOrDefault();

            var Sale = new
            {
                BranchId = Payment.SupplierPaymentIds.AsEnumerable().Select(a => a.BranchId).FirstOrDefault(),
                SupplierName = Payment.SupplierName,
                SupplierEmailId = Payment.SupplierEmailId,
                SupplierMobileNo = Payment.SupplierMobileNo,
                SourceOfSupply = Payment.SupplierPaymentIds.AsEnumerable().Select(a => a.SourceOfSupply).FirstOrDefault(),
                DestinationOfSupply = Payment.SupplierPaymentIds.AsEnumerable().Select(a => a.DestinationOfSupply).FirstOrDefault(),
                ReferenceNo = string.Join(",", Payment.SupplierPaymentIds.AsEnumerable().Select(a => a.ReferenceNo)),
                InvoiceUrl = string.Join(",", Payment.SupplierPaymentIds.AsEnumerable().Select(a => a.InvoiceUrl)),
                PurchaseDate = string.Join(",", Payment.SupplierPaymentIds.AsEnumerable().Select(a => a.PurchaseDate)),
                PaymentTerm = string.Join(",", Payment.SupplierPaymentIds.AsEnumerable().Select(a => a.PaymentTerm)),
                DueDate = string.Join(",", Payment.SupplierPaymentIds.AsEnumerable().Select(a => a.DueDate)),
                IsReverseCharge = string.Join(",", Payment.SupplierPaymentIds.AsEnumerable().Select(a => a.IsReverseCharge)),
                Notes = string.Join(",", Payment.SupplierPaymentIds.AsEnumerable().Select(a => a.Notes)),
                Subtotal = string.Join(",", Payment.SupplierPaymentIds.AsEnumerable().Select(a => a.Subtotal)),
                TotalDiscount = string.Join(",", Payment.SupplierPaymentIds.AsEnumerable().Select(a => a.TotalDiscount)),
                TotalTaxAmount = string.Join(",", Payment.SupplierPaymentIds.AsEnumerable().Select(a => a.TotalTaxAmount)),
                NetAmount = string.Join(",", Payment.SupplierPaymentIds.AsEnumerable().Select(a => a.NetAmount)),
                RoundOff = string.Join(",", Payment.SupplierPaymentIds.AsEnumerable().Select(a => a.RoundOff)),
                GrandTotal = string.Join(",", Payment.SupplierPaymentIds.AsEnumerable().Select(a => a.GrandTotal)),
                Paid = string.Join(",", Payment.SupplierPaymentIds.AsEnumerable().Select(a => a.Paid)),
                Due = string.Join(",", Payment.SupplierPaymentIds.AsEnumerable().Select(a => a.Due)),
            };

            var Branch = oConnectionContext.DbClsBranch.Where(a => a.BranchId == Payment.BranchId).Select(a => new
            {
                BusinessName = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessName).FirstOrDefault(),
                BusinessLogo = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessLogo).FirstOrDefault(),
                a.Branch,
                a.BranchCode,
                a.Address,
                a.Zipcode,
                Country = oConnectionContext.DbClsCountry.Where(b => b.CountryId == a.CountryId).Select(b => b.Country).FirstOrDefault(),
                State = oConnectionContext.DbClsState.Where(b => b.StateId == a.StateId).Select(b => b.State).FirstOrDefault(),
                City = oConnectionContext.DbClsCity.Where(b => b.CityId == a.CityId).Select(b => b.City).FirstOrDefault(),
                //ContactPersonName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.Name).FirstOrDefault(),
                //ContactPersonMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.MobileNo).FirstOrDefault(),
                a.Mobile,
                a.AltMobileNo,
                a.Email,
                BusinessRegistrationNo = oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNo).FirstOrDefault(),
                BusinessRegistrationName = oConnectionContext.DbClsBusinessRegistrationName.Where(c => c.BusinessRegistrationNameId ==
                oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNameId).FirstOrDefault()).Select(c => c.Name).FirstOrDefault()
            }).FirstOrDefault();

            if (SmsSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.SmsBody;
                string[] array = NotificationModulesSetting.SmsBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Bill No")
                    {
                        formattedBody = formattedBody.Replace("{Bill No}", Sale.ReferenceNo.ToString());
                    }
                    else if (item == "Bill Url")
                    {
                        formattedBody = formattedBody.Replace("{Bill Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Name}", Sale.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Mobile No}", Sale.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Email}", Sale.SupplierEmailId);
                    }
                    else if (item == "Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Source Of Supply}", Sale.SourceOfSupply);
                    }
                    else if (item == "Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Destination Of Supply}", Sale.DestinationOfSupply);
                    }
                    else if (item == "Bill Date")
                    {
                        formattedBody = formattedBody.Replace("{Bill Date}", Sale.PurchaseDate.ToString());
                    }
                    else if (item == "Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Payment Term}", Sale.PaymentTerm);
                    }
                    else if (item == "Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Due Date}", Sale.DueDate.ToString());
                    }
                    else if (item == "Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Is Reverse Charge}", Sale.IsReverseCharge.ToString());
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                    else if (item == "Payment Amount")
                    {
                        formattedBody = formattedBody.Replace("{Payment Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Payment Date")
                    {
                        formattedBody = formattedBody.Replace("{Payment Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Payment Method")
                    {
                        formattedBody = formattedBody.Replace("{Payment Method}", Payment.PaymentType.ToString());
                    }
                    else if (item == "Payment Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Payment Reference No}", Payment.ReferenceNo.ToString());
                    }
                    else if (item == "Payment Notes")
                    {
                        formattedBody = formattedBody.Replace("{Payment Notes}", Payment.Notes.ToString());
                    }
                    else if (item == "Payment Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Payment Receipt Url}", Payment.InvoiceUrl.ToString());
                    }
                    else if (item == "Paid Amount")
                    {
                        formattedBody = formattedBody.Replace("{Paid Amount}", Sale.Paid.ToString());
                    }
                    else if (item == "Due Amount")
                    {
                        formattedBody = formattedBody.Replace("{Due Amount}", Sale.Due.ToString());
                    }
                }

                SmsController oSmsController = new SmsController();
                oSmsController.SmsFunction(CompanyId, Sale.SupplierMobileNo, formattedBody, AddedBy, CurrentDate, Id, Type, Domain, 0);
            }
            if (EmailSettingsId != 0)
            {
                #region Email Subject
                string formattedSubject = "";

                formattedSubject = NotificationModulesSetting.EmailSubject;
                string[] arr1 = NotificationModulesSetting.EmailSubject.Split('{');
                List<string> list1 = new List<string>();

                foreach (var item in arr1)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list1.Add(item.Split('}')[0]);
                    }
                }


                foreach (var item in list1)
                {
                    if (item == "Business Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Bill No")
                    {
                        formattedSubject = formattedSubject.Replace("{Bill No}", Sale.ReferenceNo.ToString());
                    }
                    else if (item == "Bill Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Bill Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Supplier Name}", Sale.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedSubject = formattedSubject.Replace("{Supplier Mobile No}", Sale.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedSubject = formattedSubject.Replace("{Supplier Email}", Sale.SupplierEmailId);
                    }
                    else if (item == "Source Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Source Of Supply}", Sale.SourceOfSupply);
                    }
                    else if (item == "Destination Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Destination Of Supply}", Sale.DestinationOfSupply);
                    }
                    else if (item == "Bill Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Bill Date}", Sale.PurchaseDate.ToString());
                    }
                    else if (item == "Payment Term")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Term}", Sale.PaymentTerm);
                    }
                    else if (item == "Due Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Due Date}", Sale.DueDate.ToString());
                    }
                    else if (item == "Is Reverse Charge")
                    {
                        formattedSubject = formattedSubject.Replace("{Is Reverse Charge}", Sale.IsReverseCharge.ToString());
                    }
                    else if (item == "Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedSubject = formattedSubject.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedSubject = formattedSubject.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                    else if (item == "Payment Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Payment Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Payment Method")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Method}", Payment.PaymentType.ToString());
                    }
                    else if (item == "Payment Reference No")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Reference No}", Payment.ReferenceNo.ToString());
                    }
                    else if (item == "Payment Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Notes}", Payment.Notes.ToString());
                    }
                    else if (item == "Payment Receipt Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Receipt Url}", Payment.InvoiceUrl.ToString());
                    }
                    else if (item == "Paid Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Paid Amount}", Sale.Paid.ToString());
                    }
                    else if (item == "Due Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Due Amount}", Sale.Due.ToString());
                    }
                }
                #endregion


                #region EmailBody
                string formattedBody = NotificationModulesSetting.EmailBody;
                string[] array = NotificationModulesSetting.EmailBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Logo")
                    {
                        formattedBody = formattedBody.Replace("{Business Logo}", "<img src='" + webUrl + Branch.BusinessLogo + "' />");
                    }
                    else if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Bill No")
                    {
                        formattedBody = formattedBody.Replace("{Bill No}", Sale.ReferenceNo.ToString());
                    }
                    else if (item == "Bill Url")
                    {
                        formattedBody = formattedBody.Replace("{Bill Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Name}", Sale.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Mobile No}", Sale.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Email}", Sale.SupplierEmailId);
                    }
                    else if (item == "Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Source Of Supply}", Sale.SourceOfSupply);
                    }
                    else if (item == "Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Destination Of Supply}", Sale.DestinationOfSupply);
                    }
                    else if (item == "Bill Date")
                    {
                        formattedBody = formattedBody.Replace("{Bill Date}", Sale.PurchaseDate.ToString());
                    }
                    else if (item == "Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Payment Term}", Sale.PaymentTerm);
                    }
                    else if (item == "Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Due Date}", Sale.DueDate.ToString());
                    }
                    else if (item == "Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Is Reverse Charge}", Sale.IsReverseCharge.ToString());
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                    else if (item == "Payment Amount")
                    {
                        formattedBody = formattedBody.Replace("{Payment Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Payment Date")
                    {
                        formattedBody = formattedBody.Replace("{Payment Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Payment Method")
                    {
                        formattedBody = formattedBody.Replace("{Payment Method}", Payment.PaymentType.ToString());
                    }
                    else if (item == "Payment Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Payment Reference No}", Payment.ReferenceNo.ToString());
                    }
                    else if (item == "Payment Notes")
                    {
                        formattedBody = formattedBody.Replace("{Payment Notes}", Payment.Notes.ToString());
                    }
                    else if (item == "Payment Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Payment Receipt Url}", Payment.InvoiceUrl.ToString());
                    }
                    else if (item == "Paid Amount")
                    {
                        formattedBody = formattedBody.Replace("{Paid Amount}", Sale.Paid.ToString());
                    }
                    else if (item == "Due Amount")
                    {
                        formattedBody = formattedBody.Replace("{Due Amount}", Sale.Due.ToString());
                    }
                }
                #endregion


                EmailController oEmailController = new EmailController();
                oEmailController.NotificationTemplate(CompanyId, Sale.SupplierEmailId, formattedSubject, formattedBody, CC, Bcc, AddedBy, CurrentDate, Id, Type, Domain);
            }
            if (WhatsappSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.WhatsappBody;
                string[] array = NotificationModulesSetting.WhatsappBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Bill No")
                    {
                        formattedBody = formattedBody.Replace("{Bill No}", Sale.ReferenceNo.ToString());
                    }
                    else if (item == "Bill Url")
                    {
                        formattedBody = formattedBody.Replace("{Bill Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Name}", Sale.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Mobile No}", Sale.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Email}", Sale.SupplierEmailId);
                    }
                    else if (item == "Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Source Of Supply}", Sale.SourceOfSupply);
                    }
                    else if (item == "Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Destination Of Supply}", Sale.DestinationOfSupply);
                    }
                    else if (item == "Bill Date")
                    {
                        formattedBody = formattedBody.Replace("{Bill Date}", Sale.PurchaseDate.ToString());
                    }
                    else if (item == "Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Payment Term}", Sale.PaymentTerm);
                    }
                    else if (item == "Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Due Date}", Sale.DueDate.ToString());
                    }
                    else if (item == "Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Is Reverse Charge}", Sale.IsReverseCharge.ToString());
                    }
                    else if (item == "Notes")
                    {
                        formattedBody = formattedBody.Replace("{Notes}", Sale.Notes);
                    }
                    else if (item == "Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Discount")
                    {
                        formattedBody = formattedBody.Replace("{Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Total Amount}", Sale.GrandTotal.ToString());
                    }
                    else if (item == "Payment Amount")
                    {
                        formattedBody = formattedBody.Replace("{Payment Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Payment Date")
                    {
                        formattedBody = formattedBody.Replace("{Payment Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Payment Method")
                    {
                        formattedBody = formattedBody.Replace("{Payment Method}", Payment.PaymentType.ToString());
                    }
                    else if (item == "Payment Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Payment Reference No}", Payment.ReferenceNo.ToString());
                    }
                    else if (item == "Payment Notes")
                    {
                        formattedBody = formattedBody.Replace("{Payment Notes}", Payment.Notes.ToString());
                    }
                    else if (item == "Payment Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Payment Receipt Url}", Payment.InvoiceUrl.ToString());
                    }
                    else if (item == "Paid Amount")
                    {
                        formattedBody = formattedBody.Replace("{Paid Amount}", Sale.Paid.ToString());
                    }
                    else if (item == "Due Amount")
                    {
                        formattedBody = formattedBody.Replace("{Due Amount}", Sale.Due.ToString());
                    }
                }

                WhatsappController oWhatsappController = new WhatsappController();
                return oWhatsappController.WhatsappFunction(CompanyId, Sale.SupplierMobileNo, formattedBody, 0);
            }
            string[] arr = { "1", "", "" };
            return arr;
        }

        public dynamic SupplierAdvancePayment(ClsNotificationModulesSettingsVm NotificationModulesSetting, long CompanyId, long Id, string CC, string Bcc, long SmsSettingsId, long EmailSettingsId, long WhatsappSettingsId, string Type, long AddedBy, DateTime CurrentDate, string Domain)
        {
            var Payment = oConnectionContext.DbClsSupplierPayment.Where(a => a.SupplierPaymentId == Id).Select(a => new
            {
                SupplierName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.Name).FirstOrDefault(),
                SupplierEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.EmailId).FirstOrDefault(),
                SupplierMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.MobileNo).FirstOrDefault(),
                SourceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.SourceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                DestinationOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.DestinationOfSupplyId).Select(b => b.State).FirstOrDefault(),
                a.IsReverseCharge,
                Tax = oConnectionContext.DbClsTax.Where(b => b.TaxId == a.TaxId).Select(b => b.Tax).FirstOrDefault(),
                a.Amount,
                a.PaymentDate,
                PaymentType = oConnectionContext.DbClsPaymentType.Where(b => b.PaymentTypeId == Id).Select(b => b.PaymentType).FirstOrDefault(),
                a.ReferenceNo,
                InvoiceUrl = Domain + "/purchase/PaymentReceipt?ReferenceId=" + a.ReferenceId,
                a.Notes,
                a.BranchId,
                a.SupplierId,
            }).FirstOrDefault();

            var Branch = oConnectionContext.DbClsBranch.Where(a => a.BranchId == Payment.BranchId).Select(a => new
            {
                BusinessName = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessName).FirstOrDefault(),
                BusinessLogo = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessLogo).FirstOrDefault(),
                a.Branch,
                a.BranchCode,
                a.Address,
                a.Zipcode,
                Country = oConnectionContext.DbClsCountry.Where(b => b.CountryId == a.CountryId).Select(b => b.Country).FirstOrDefault(),
                State = oConnectionContext.DbClsState.Where(b => b.StateId == a.StateId).Select(b => b.State).FirstOrDefault(),
                City = oConnectionContext.DbClsCity.Where(b => b.CityId == a.CityId).Select(b => b.City).FirstOrDefault(),
                //ContactPersonName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.Name).FirstOrDefault(),
                //ContactPersonMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.MobileNo).FirstOrDefault(),
                a.Mobile,
                a.AltMobileNo,
                a.Email,
                BusinessRegistrationNo = oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNo).FirstOrDefault(),
                BusinessRegistrationName = oConnectionContext.DbClsBusinessRegistrationName.Where(c => c.BusinessRegistrationNameId ==
                oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNameId).FirstOrDefault()).Select(c => c.Name).FirstOrDefault()
            }).FirstOrDefault();

            if (SmsSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.SmsBody;
                string[] array = NotificationModulesSetting.SmsBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Name}", Payment.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Mobile No}", Payment.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Email}", Payment.SupplierEmailId);
                    }
                    else if (item == "Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Source Of Supply}", Payment.SourceOfSupply);
                    }
                    else if (item == "Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Destination Of Supply}", Payment.DestinationOfSupply);
                    }
                    else if (item == "Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Is Reverse Charge}", Payment.IsReverseCharge.ToString());
                    }
                    else if (item == "Tax")
                    {
                        formattedBody = formattedBody.Replace("{Tax}", Payment.Tax);
                    }
                    else if (item == "Payment Amount")
                    {
                        formattedBody = formattedBody.Replace("{Payment Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Payment Date")
                    {
                        formattedBody = formattedBody.Replace("{Payment Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Payment Method")
                    {
                        formattedBody = formattedBody.Replace("{Payment Method}", Payment.PaymentType);
                    }
                    else if (item == "Payment Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Payment Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Payment Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Payment Receipt Url}", Payment.InvoiceUrl);
                    }
                    else if (item == "Payment Notes")
                    {
                        formattedBody = formattedBody.Replace("{Payment Notes}", Payment.Notes);
                    }
                }

                SmsController oSmsController = new SmsController();
                oSmsController.SmsFunction(CompanyId, Payment.SupplierMobileNo, formattedBody, AddedBy, CurrentDate, Id, Type, Domain, 0);
            }
            if (EmailSettingsId != 0)
            {
                #region Email Subject
                string formattedSubject = "";

                formattedSubject = NotificationModulesSetting.EmailSubject;
                string[] arr1 = NotificationModulesSetting.EmailSubject.Split('{');
                List<string> list1 = new List<string>();

                foreach (var item in arr1)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list1.Add(item.Split('}')[0]);
                    }
                }


                foreach (var item in list1)
                {
                    if (item == "Business Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Supplier Name}", Payment.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedSubject = formattedSubject.Replace("{Supplier Mobile No}", Payment.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedSubject = formattedSubject.Replace("{Supplier Email}", Payment.SupplierEmailId);
                    }
                    else if (item == "Source Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Source Of Supply}", Payment.SourceOfSupply);
                    }
                    else if (item == "Destination Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Destination Of Supply}", Payment.DestinationOfSupply);
                    }
                    else if (item == "Is Reverse Charge")
                    {
                        formattedSubject = formattedSubject.Replace("{Is Reverse Charge}", Payment.IsReverseCharge.ToString());
                    }
                    else if (item == "Tax")
                    {
                        formattedSubject = formattedSubject.Replace("{Tax}", Payment.Tax);
                    }
                    else if (item == "Payment Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Payment Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Payment Method")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Method}", Payment.PaymentType);
                    }
                    else if (item == "Payment Reference No")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Payment Receipt Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Receipt Url}", Payment.InvoiceUrl);
                    }
                    else if (item == "Payment Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Payment Notes}", Payment.Notes);
                    }
                }
                #endregion


                #region EmailBody
                string formattedBody = NotificationModulesSetting.EmailBody;
                string[] array = NotificationModulesSetting.EmailBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Logo")
                    {
                        formattedBody = formattedBody.Replace("{Business Logo}", "<img src='" + webUrl + Branch.BusinessLogo + "' />");
                    }
                    else if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Name}", Payment.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Mobile No}", Payment.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Email}", Payment.SupplierEmailId);
                    }
                    else if (item == "Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Source Of Supply}", Payment.SourceOfSupply);
                    }
                    else if (item == "Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Destination Of Supply}", Payment.DestinationOfSupply);
                    }
                    else if (item == "Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Is Reverse Charge}", Payment.IsReverseCharge.ToString());
                    }
                    else if (item == "Tax")
                    {
                        formattedBody = formattedBody.Replace("{Tax}", Payment.Tax);
                    }
                    else if (item == "Payment Amount")
                    {
                        formattedBody = formattedBody.Replace("{Payment Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Payment Date")
                    {
                        formattedBody = formattedBody.Replace("{Payment Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Payment Method")
                    {
                        formattedBody = formattedBody.Replace("{Payment Method}", Payment.PaymentType);
                    }
                    else if (item == "Payment Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Payment Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Payment Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Payment Receipt Url}", Payment.InvoiceUrl);
                    }
                    else if (item == "Payment Notes")
                    {
                        formattedBody = formattedBody.Replace("{Payment Notes}", Payment.Notes);
                    }
                }
                #endregion


                EmailController oEmailController = new EmailController();
                oEmailController.NotificationTemplate(CompanyId, Payment.SupplierEmailId, formattedSubject, formattedBody, CC, Bcc, AddedBy, CurrentDate, Id, Type, Domain);
            }
            if (WhatsappSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.WhatsappBody;
                string[] array = NotificationModulesSetting.WhatsappBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Name}", Payment.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Mobile No}", Payment.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Email}", Payment.SupplierEmailId);
                    }
                    else if (item == "Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Source Of Supply}", Payment.SourceOfSupply);
                    }
                    else if (item == "Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Destination Of Supply}", Payment.DestinationOfSupply);
                    }
                    else if (item == "Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Is Reverse Charge}", Payment.IsReverseCharge.ToString());
                    }
                    else if (item == "Tax")
                    {
                        formattedBody = formattedBody.Replace("{Tax}", Payment.Tax);
                    }
                    else if (item == "Payment Amount")
                    {
                        formattedBody = formattedBody.Replace("{Payment Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Payment Date")
                    {
                        formattedBody = formattedBody.Replace("{Payment Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Payment Method")
                    {
                        formattedBody = formattedBody.Replace("{Payment Method}", Payment.PaymentType);
                    }
                    else if (item == "Payment Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Payment Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Payment Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Payment Receipt Url}", Payment.InvoiceUrl);
                    }
                    else if (item == "Payment Notes")
                    {
                        formattedBody = formattedBody.Replace("{Payment Notes}", Payment.Notes);
                    }
                }

                WhatsappController oWhatsappController = new WhatsappController();
                return oWhatsappController.WhatsappFunction(CompanyId, Payment.SupplierMobileNo, formattedBody, 0);
            }
            string[] arr = { "1", "", "" };
            return arr;
        }

        public dynamic RefundFromDebitNote(ClsNotificationModulesSettingsVm NotificationModulesSetting, long CompanyId, long Id, string CC, string Bcc, long SmsSettingsId, long EmailSettingsId, long WhatsappSettingsId, string Type, long AddedBy, DateTime CurrentDate, string Domain)
        {
            var Payment = oConnectionContext.DbClsSupplierPayment.Where(a => a.SupplierPaymentId == Id).Select(a => new
            {
                a.BranchId,
                a.ParentId,
                PurchaseId = oConnectionContext.DbClsSupplierPayment.Where(b => b.SupplierPaymentId == a.ParentId
                && b.IsDeleted == false && b.IsCancelled == false && b.IsActive == true).Select(b => b.PurchaseId).FirstOrDefault(),
                PurchaseReturnId = oConnectionContext.DbClsSupplierPayment.Where(b => b.SupplierPaymentId == a.ParentId
                && b.IsDeleted == false && b.IsCancelled == false && b.IsActive == true).Select(b => b.PurchaseReturnId).FirstOrDefault(),
                InvoiceUrl = Domain + "/Purchase/ReturnPaymentReceipt?ReferenceId=" + a.ReferenceId,
                a.ReferenceNo,
                a.Notes,
                a.Amount,
                a.PaymentDate,
                a.PaymentTypeId,
                PaymentType = oConnectionContext.DbClsPaymentType.Where(b => b.PaymentTypeId == Id).Select(b => b.PaymentType).FirstOrDefault(),
                AmountRemaining = oConnectionContext.DbClsSupplierPayment.Where(b => b.SupplierPaymentId == a.ParentId
                && b.IsDeleted == false && b.IsCancelled == false && b.IsActive == true).Select(b => b.AmountRemaining).FirstOrDefault(),
            }).FirstOrDefault();

            var ParentSale = oConnectionContext.DbClsPurchase.Where(a => a.PurchaseId == Payment.PurchaseId).Select(a => new
            {
                a.BranchId,
                SupplierName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.Name).FirstOrDefault(),
                SupplierMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.MobileNo).FirstOrDefault(),
                SupplierEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.EmailId).FirstOrDefault(),
                ReferenceNo = a.ReferenceNo,
                InvoiceUrl = Domain + "/purchase/invoice?InvoiceId=" + a.InvoiceId,
                SourceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.SourceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                DestinationOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.DestinationOfSupplyId).Select(b => b.State).FirstOrDefault(),
                PurchaseDate = a.PurchaseDate,
                PaymentTerm = oConnectionContext.DbClsPaymentTerm.Where(b => b.PaymentTermId == a.PaymentTermId).Select(b => b.PaymentTerm).FirstOrDefault(),
                DueDate = a.DueDate,
                Notes = a.Notes,
                Subtotal = a.Subtotal,
                TotalDiscount = a.TotalDiscount,
                TotalTaxAmount = a.TotalTaxAmount,
                NetAmount = a.NetAmount,
                RoundOff = a.RoundOff,
                SpecialDiscount = a.SpecialDiscount,
                GrandTotal = a.GrandTotal,
                a.PurchaseType,
                a.IsReverseCharge
            }).FirstOrDefault();

            var Sale = oConnectionContext.DbClsPurchaseReturn.Where(a => a.PurchaseReturnId == Payment.PurchaseReturnId).Select(a => new
            {
                a.BranchId,
                SourceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.SourceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                DestinationOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.DestinationOfSupplyId).Select(b => b.State).FirstOrDefault(),
                Reason = oConnectionContext.DbClsPurchaseDebitNoteReason.Where(b => b.PurchaseDebitNoteReasonId == a.PurchaseDebitNoteReasonId).Select(b => b.PurchaseDebitNoteReason).FirstOrDefault(),
                Date = a.Date,
                IsReverseCharge = a.IsReverseCharge,
                InvoiceNo = a.InvoiceNo,
                InvoiceUrl = Domain + "/purchase/invoice?InvoiceId=" + a.InvoiceId,
                InvoiceNotes = a.Notes,
                Subtotal = a.Subtotal,
                TotalDiscount = a.TotalDiscount,
                TotalTaxAmount = a.TotalTaxAmount,
                NetAmount = a.NetAmount,
                RoundOff = a.RoundOff,
                SpecialDiscount = a.SpecialDiscount,
                GrandTotal = a.GrandTotal
            }).FirstOrDefault();

            var Branch = oConnectionContext.DbClsBranch.Where(a => a.BranchId == Payment.BranchId).Select(a => new
            {
                BusinessName = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessName).FirstOrDefault(),
                BusinessLogo = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessLogo).FirstOrDefault(),
                a.Branch,
                a.BranchCode,
                a.Address,
                a.Zipcode,
                Country = oConnectionContext.DbClsCountry.Where(b => b.CountryId == a.CountryId).Select(b => b.Country).FirstOrDefault(),
                State = oConnectionContext.DbClsState.Where(b => b.StateId == a.StateId).Select(b => b.State).FirstOrDefault(),
                City = oConnectionContext.DbClsCity.Where(b => b.CityId == a.CityId).Select(b => b.City).FirstOrDefault(),
                //ContactPersonName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.Name).FirstOrDefault(),
                //ContactPersonMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.MobileNo).FirstOrDefault(),
                a.Mobile,
                a.AltMobileNo,
                a.Email,
                BusinessRegistrationNo = oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNo).FirstOrDefault(),
                BusinessRegistrationName = oConnectionContext.DbClsBusinessRegistrationName.Where(c => c.BusinessRegistrationNameId ==
                oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNameId).FirstOrDefault()).Select(c => c.Name).FirstOrDefault()
            }).FirstOrDefault();

            if (SmsSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.SmsBody;
                string[] array = NotificationModulesSetting.SmsBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Name}", ParentSale.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Mobile No}", ParentSale.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Email}", ParentSale.SupplierEmailId);
                    }
                    else if (item == "Parent Bill No")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill No}", ParentSale.ReferenceNo.ToString());
                    }
                    else if (item == "Parent Bill Url")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Parent Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Parent Source Of Supply}", ParentSale.SourceOfSupply);
                    }
                    else if (item == "Parent Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Parent Destination Of Supply}", ParentSale.DestinationOfSupply);
                    }
                    else if (item == "Parent Bill Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill Date}", ParentSale.PurchaseDate.ToString());
                    }
                    else if (item == "Parent Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Parent Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Parent Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Parent Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Parent Is Reverse Charge}", ParentSale.IsReverseCharge.ToString());
                    }
                    else if (item == "Parent Bill Notes")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill Notes}", ParentSale.Notes);
                    }
                    else if (item == "Parent Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Parent Discount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Parent Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Parent Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Parent Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Parent Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Parent Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Debit Note Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Source Of Supply}", Sale.SourceOfSupply);
                    }
                    else if (item == "Debit Note Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Destination Of Supply}", Sale.DestinationOfSupply);
                    }
                    else if (item == "Debit Note Date")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Date}", Sale.Date.ToString());
                    }
                    else if (item == "Debit Note Bill No")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Bill No}", Sale.InvoiceNo.ToString());
                    }
                    else if (item == "Debit Note Bill Url")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Bill Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Debit Note Reason")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Reason}", Sale.Reason);
                    }
                    else if (item == "Debit Note Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Is Reverse Charge}", Sale.IsReverseCharge.ToString());
                    }
                    else if (item == "Debit Note Notes")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Notes}", Sale.InvoiceNotes);
                    }
                    else if (item == "Debit Note Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Debit Note Discount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Debit Note Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Debit Note Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Debit Note Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Debit Note Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Total Amount}", Sale.GrandTotal.ToString());
                    }
                    else if (item == "Refund Amount")
                    {
                        formattedBody = formattedBody.Replace("{Refund Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Refund Date")
                    {
                        formattedBody = formattedBody.Replace("{Refund Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Refund Method")
                    {
                        formattedBody = formattedBody.Replace("{Refund Method}", Payment.PaymentType);
                    }
                    else if (item == "Refund Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Refund Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Refund Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Refund Receipt Url}", Payment.InvoiceUrl);
                    }
                    else if (item == "Refund Notes")
                    {
                        formattedBody = formattedBody.Replace("{Refund Notes}", Payment.Notes);
                    }
                    else if (item == "Balance")
                    {
                        formattedBody = formattedBody.Replace("{Balance}", Payment.AmountRemaining.ToString());
                    }
                }

                SmsController oSmsController = new SmsController();
                oSmsController.SmsFunction(CompanyId, ParentSale.SupplierMobileNo, formattedBody, AddedBy, CurrentDate, Id, Type, Domain, 0);
            }
            if (EmailSettingsId != 0)
            {
                #region Email Subject
                string formattedSubject = "";

                formattedSubject = NotificationModulesSetting.EmailSubject;
                string[] arr1 = NotificationModulesSetting.EmailSubject.Split('{');
                List<string> list1 = new List<string>();

                foreach (var item in arr1)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list1.Add(item.Split('}')[0]);
                    }
                }


                foreach (var item in list1)
                {
                    if (item == "Business Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Supplier Name}", ParentSale.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedSubject = formattedSubject.Replace("{Supplier Mobile No}", ParentSale.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedSubject = formattedSubject.Replace("{Supplier Email}", ParentSale.SupplierEmailId);
                    }
                    else if (item == "Parent Bill No")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Bill No}", ParentSale.ReferenceNo.ToString());
                    }
                    else if (item == "Parent Bill Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Bill Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Parent Source Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Source Of Supply}", ParentSale.SourceOfSupply);
                    }
                    else if (item == "Parent Destination Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Destination Of Supply}", ParentSale.DestinationOfSupply);
                    }
                    else if (item == "Parent Bill Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Bill Date}", ParentSale.PurchaseDate.ToString());
                    }
                    else if (item == "Parent Payment Term")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Parent Due Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Parent Is Reverse Charge")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Is Reverse Charge}", ParentSale.IsReverseCharge.ToString());
                    }
                    else if (item == "Parent Bill Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Bill Notes}", ParentSale.Notes);
                    }
                    else if (item == "Parent Gross Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Parent Discount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Parent Tax Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Parent Net Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Parent Round Off")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Parent Total Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Debit Note Source Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Source Of Supply}", Sale.SourceOfSupply);
                    }
                    else if (item == "Debit Note Destination Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Destination Of Supply}", Sale.DestinationOfSupply);
                    }
                    else if (item == "Debit Note Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Date}", Sale.Date.ToString());
                    }
                    else if (item == "Debit Note Bill No")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Bill No}", Sale.InvoiceNo.ToString());
                    }
                    else if (item == "Debit Note Bill Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Bill Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Debit Note Reason")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Reason}", Sale.Reason);
                    }
                    else if (item == "Debit Note Is Reverse Charge")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Is Reverse Charge}", Sale.IsReverseCharge.ToString());
                    }
                    else if (item == "Debit Note Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Notes}", Sale.InvoiceNotes);
                    }
                    else if (item == "Debit Note Gross Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Debit Note Discount")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Debit Note Tax Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Debit Note Net Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Debit Note Round Off")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Debit Note Total Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Total Amount}", Sale.GrandTotal.ToString());
                    }
                    else if (item == "Refund Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Refund Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Refund Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Refund Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Refund Method")
                    {
                        formattedSubject = formattedSubject.Replace("{Refund Method}", Payment.PaymentType);
                    }
                    else if (item == "Refund Reference No")
                    {
                        formattedSubject = formattedSubject.Replace("{Refund Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Refund Receipt Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Refund Receipt Url}", Payment.InvoiceUrl);
                    }
                    else if (item == "Refund Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Refund Notes}", Payment.Notes);
                    }
                    else if (item == "Balance")
                    {
                        formattedSubject = formattedSubject.Replace("{Balance}", Payment.AmountRemaining.ToString());
                    }
                }
                #endregion


                #region EmailBody
                string formattedBody = NotificationModulesSetting.EmailBody;
                string[] array = NotificationModulesSetting.EmailBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Logo")
                    {
                        formattedBody = formattedBody.Replace("{Business Logo}", "<img src='" + webUrl + Branch.BusinessLogo + "' />");
                    }
                    else if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Name}", ParentSale.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Mobile No}", ParentSale.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Email}", ParentSale.SupplierEmailId);
                    }
                    else if (item == "Parent Bill No")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill No}", ParentSale.ReferenceNo.ToString());
                    }
                    else if (item == "Parent Bill Url")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Parent Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Parent Source Of Supply}", ParentSale.SourceOfSupply);
                    }
                    else if (item == "Parent Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Parent Destination Of Supply}", ParentSale.DestinationOfSupply);
                    }
                    else if (item == "Parent Bill Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill Date}", ParentSale.PurchaseDate.ToString());
                    }
                    else if (item == "Parent Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Parent Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Parent Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Parent Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Parent Is Reverse Charge}", ParentSale.IsReverseCharge.ToString());
                    }
                    else if (item == "Parent Bill Notes")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill Notes}", ParentSale.Notes);
                    }
                    else if (item == "Parent Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Parent Discount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Parent Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Parent Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Parent Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Parent Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Parent Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Debit Note Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Source Of Supply}", Sale.SourceOfSupply);
                    }
                    else if (item == "Debit Note Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Destination Of Supply}", Sale.DestinationOfSupply);
                    }
                    else if (item == "Debit Note Date")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Date}", Sale.Date.ToString());
                    }
                    else if (item == "Debit Note Bill No")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Bill No}", Sale.InvoiceNo.ToString());
                    }
                    else if (item == "Debit Note Bill Url")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Bill Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Debit Note Reason")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Reason}", Sale.Reason);
                    }
                    else if (item == "Debit Note Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Is Reverse Charge}", Sale.IsReverseCharge.ToString());
                    }
                    else if (item == "Debit Note Notes")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Notes}", Sale.InvoiceNotes);
                    }
                    else if (item == "Debit Note Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Debit Note Discount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Debit Note Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Debit Note Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Debit Note Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Debit Note Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Total Amount}", Sale.GrandTotal.ToString());
                    }
                    else if (item == "Refund Amount")
                    {
                        formattedBody = formattedBody.Replace("{Refund Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Refund Date")
                    {
                        formattedBody = formattedBody.Replace("{Refund Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Refund Method")
                    {
                        formattedBody = formattedBody.Replace("{Refund Method}", Payment.PaymentType);
                    }
                    else if (item == "Refund Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Refund Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Refund Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Refund Receipt Url}", Payment.InvoiceUrl);
                    }
                    else if (item == "Refund Notes")
                    {
                        formattedBody = formattedBody.Replace("{Refund Notes}", Payment.Notes);
                    }
                    else if (item == "Balance")
                    {
                        formattedBody = formattedBody.Replace("{Balance}", Payment.AmountRemaining.ToString());
                    }
                }
                #endregion


                EmailController oEmailController = new EmailController();
                oEmailController.NotificationTemplate(CompanyId, ParentSale.SupplierEmailId, formattedSubject, formattedBody, CC, Bcc, AddedBy, CurrentDate, Id, Type, Domain);
            }
            if (WhatsappSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.WhatsappBody;
                string[] array = NotificationModulesSetting.WhatsappBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Name}", ParentSale.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Mobile No}", ParentSale.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Email}", ParentSale.SupplierEmailId);
                    }
                    else if (item == "Parent Bill No")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill No}", ParentSale.ReferenceNo.ToString());
                    }
                    else if (item == "Parent Bill Url")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Parent Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Parent Source Of Supply}", ParentSale.SourceOfSupply);
                    }
                    else if (item == "Parent Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Parent Destination Of Supply}", ParentSale.DestinationOfSupply);
                    }
                    else if (item == "Parent Bill Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill Date}", ParentSale.PurchaseDate.ToString());
                    }
                    else if (item == "Parent Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Parent Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Parent Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Parent Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Parent Is Reverse Charge}", ParentSale.IsReverseCharge.ToString());
                    }
                    else if (item == "Parent Bill Notes")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill Notes}", ParentSale.Notes);
                    }
                    else if (item == "Parent Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Parent Discount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Parent Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Parent Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Parent Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Parent Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Parent Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Debit Note Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Source Of Supply}", Sale.SourceOfSupply);
                    }
                    else if (item == "Debit Note Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Destination Of Supply}", Sale.DestinationOfSupply);
                    }
                    else if (item == "Debit Note Date")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Date}", Sale.Date.ToString());
                    }
                    else if (item == "Debit Note Bill No")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Bill No}", Sale.InvoiceNo.ToString());
                    }
                    else if (item == "Debit Note Bill Url")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Bill Url}", Sale.InvoiceUrl);
                    }
                    else if (item == "Debit Note Reason")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Reason}", Sale.Reason);
                    }
                    else if (item == "Debit Note Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Is Reverse Charge}", Sale.IsReverseCharge.ToString());
                    }
                    else if (item == "Debit Note Notes")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Notes}", Sale.InvoiceNotes);
                    }
                    else if (item == "Debit Note Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Gross Amount}", Sale.Subtotal.ToString());
                    }
                    else if (item == "Debit Note Discount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Discount}", Sale.TotalDiscount.ToString());
                    }
                    else if (item == "Debit Note Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Tax Amount}", Sale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Debit Note Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Net Amount}", Sale.NetAmount.ToString());
                    }
                    else if (item == "Debit Note Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Round Off}", Sale.RoundOff.ToString());
                    }
                    else if (item == "Debit Note Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Total Amount}", Sale.GrandTotal.ToString());
                    }
                    else if (item == "Refund Amount")
                    {
                        formattedBody = formattedBody.Replace("{Refund Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Refund Date")
                    {
                        formattedBody = formattedBody.Replace("{Refund Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Refund Method")
                    {
                        formattedBody = formattedBody.Replace("{Refund Method}", Payment.PaymentType);
                    }
                    else if (item == "Refund Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Refund Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Refund Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Refund Receipt Url}", Payment.InvoiceUrl);
                    }
                    else if (item == "Refund Notes")
                    {
                        formattedBody = formattedBody.Replace("{Refund Notes}", Payment.Notes);
                    }
                    else if (item == "Balance")
                    {
                        formattedBody = formattedBody.Replace("{Balance}", Payment.AmountRemaining.ToString());
                    }
                }

                WhatsappController oWhatsappController = new WhatsappController();
                return oWhatsappController.WhatsappFunction(CompanyId, ParentSale.SupplierMobileNo, formattedBody, 0);
            }
            string[] arr = { "1", "", "" };
            return arr;
        }

        public dynamic RefundFromSupplierAdvancePayment(ClsNotificationModulesSettingsVm NotificationModulesSetting, long CompanyId, long Id, string CC, string Bcc, long SmsSettingsId, long EmailSettingsId, long WhatsappSettingsId, string Type, long AddedBy, DateTime CurrentDate, string Domain)
        {
            var Payment = oConnectionContext.DbClsSupplierPayment.Where(a => a.SupplierPaymentId == Id).Select(a => new
            {
                a.BranchId,
                a.ParentId,
                InvoiceUrl = Domain + "/Purchase/ReturnPaymentReceipt?ReferenceId=" + a.ReferenceId,
                a.ReferenceNo,
                a.Notes,
                a.Amount,
                a.PaymentDate,
                a.PaymentTypeId,
                PaymentType = oConnectionContext.DbClsPaymentType.Where(b => b.PaymentTypeId == Id).Select(b => b.PaymentType).FirstOrDefault(),
                AmountRemaining = oConnectionContext.DbClsSupplierPayment.Where(b => b.SupplierPaymentId == a.ParentId
                && b.IsDeleted == false && b.IsCancelled == false && b.IsActive == true).Select(b => b.AmountRemaining).FirstOrDefault(),
            }).FirstOrDefault();

            var AdvancePayment = oConnectionContext.DbClsSupplierPayment.Where(a => a.SupplierPaymentId == Payment.ParentId).Select(a => new
            {
                SupplierName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.Name).FirstOrDefault(),
                SupplierEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.EmailId).FirstOrDefault(),
                SupplierMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.MobileNo).FirstOrDefault(),
                SourceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.SourceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                DestinationOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.DestinationOfSupplyId).Select(b => b.State).FirstOrDefault(),
                Tax = oConnectionContext.DbClsTax.Where(b => b.TaxId == a.TaxId).Select(b => b.Tax).FirstOrDefault(),
                a.Amount,
                a.PaymentDate,
                PaymentType = oConnectionContext.DbClsPaymentType.Where(b => b.PaymentTypeId == Id).Select(b => b.PaymentType).FirstOrDefault(),
                a.ReferenceNo,
                InvoiceUrl = Domain + "/Purchase/PaymentReceipt?ReferenceId=" + a.ReferenceId,
                a.Notes,
                a.BranchId,
                a.SupplierId,
                a.IsReverseCharge
            }).FirstOrDefault();

            var Branch = oConnectionContext.DbClsBranch.Where(a => a.BranchId == Payment.BranchId).Select(a => new
            {
                BusinessName = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessName).FirstOrDefault(),
                BusinessLogo = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessLogo).FirstOrDefault(),
                a.Branch,
                a.BranchCode,
                a.Address,
                a.Zipcode,
                Country = oConnectionContext.DbClsCountry.Where(b => b.CountryId == a.CountryId).Select(b => b.Country).FirstOrDefault(),
                State = oConnectionContext.DbClsState.Where(b => b.StateId == a.StateId).Select(b => b.State).FirstOrDefault(),
                City = oConnectionContext.DbClsCity.Where(b => b.CityId == a.CityId).Select(b => b.City).FirstOrDefault(),
                //ContactPersonName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.Name).FirstOrDefault(),
                //ContactPersonMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.MobileNo).FirstOrDefault(),
                a.Mobile,
                a.AltMobileNo,
                a.Email,
                BusinessRegistrationNo = oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNo).FirstOrDefault(),
                BusinessRegistrationName = oConnectionContext.DbClsBusinessRegistrationName.Where(c => c.BusinessRegistrationNameId ==
                oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNameId).FirstOrDefault()).Select(c => c.Name).FirstOrDefault()
            }).FirstOrDefault();

            if (SmsSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.SmsBody;
                string[] array = NotificationModulesSetting.SmsBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Name}", AdvancePayment.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Mobile No}", AdvancePayment.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Email}", AdvancePayment.SupplierEmailId);
                    }
                    else if (item == "Advance Payment Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Source Of Supply}", AdvancePayment.SourceOfSupply);
                    }
                    else if (item == "Advance Payment Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Destination Of Supply}", AdvancePayment.DestinationOfSupply);
                    }
                    else if (item == "Advance Payment Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Is Reverse Charge}", AdvancePayment.IsReverseCharge.ToString());
                    }
                    else if (item == "Advance Payment Tax")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Tax}", AdvancePayment.Tax);
                    }
                    else if (item == "Advance Payment Amount")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Amount}", AdvancePayment.Amount.ToString());
                    }
                    else if (item == "Advance Payment Date")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Date}", AdvancePayment.PaymentDate.ToString());
                    }
                    else if (item == "Advance Payment Method")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Method}", AdvancePayment.PaymentType);
                    }
                    else if (item == "Advance Payment Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Reference No}", AdvancePayment.ReferenceNo);
                    }
                    else if (item == "Advance Payment Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Receipt Url}", AdvancePayment.InvoiceUrl);
                    }
                    else if (item == "Advance Payment Notes")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Notes}", AdvancePayment.Notes);
                    }
                    else if (item == "Refund Amount")
                    {
                        formattedBody = formattedBody.Replace("{Refund Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Refund Date")
                    {
                        formattedBody = formattedBody.Replace("{Refund Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Refund Method")
                    {
                        formattedBody = formattedBody.Replace("{Refund Method}", Payment.PaymentType);
                    }
                    else if (item == "Refund Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Refund Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Refund Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Refund Receipt Url}", Payment.InvoiceUrl);
                    }
                    else if (item == "Refund Notes")
                    {
                        formattedBody = formattedBody.Replace("{Refund Notes}", Payment.Notes);
                    }
                    else if (item == "Unused Amount")
                    {
                        formattedBody = formattedBody.Replace("{Unused Amount}", Payment.AmountRemaining.ToString());
                    }
                }

                SmsController oSmsController = new SmsController();
                oSmsController.SmsFunction(CompanyId, AdvancePayment.SupplierMobileNo, formattedBody, AddedBy, CurrentDate, Id, Type, Domain, 0);
            }
            if (EmailSettingsId != 0)
            {
                #region Email Subject
                string formattedSubject = "";

                formattedSubject = NotificationModulesSetting.EmailSubject;
                string[] arr1 = NotificationModulesSetting.EmailSubject.Split('{');
                List<string> list1 = new List<string>();

                foreach (var item in arr1)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list1.Add(item.Split('}')[0]);
                    }
                }


                foreach (var item in list1)
                {
                    if (item == "Business Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Supplier Name}", AdvancePayment.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedSubject = formattedSubject.Replace("{Supplier Mobile No}", AdvancePayment.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedSubject = formattedSubject.Replace("{Supplier Email}", AdvancePayment.SupplierEmailId);
                    }
                    else if (item == "Advance Payment Source Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Source Of Supply}", AdvancePayment.SourceOfSupply);
                    }
                    else if (item == "Advance Payment Destination Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Destination Of Supply}", AdvancePayment.DestinationOfSupply);
                    }
                    else if (item == "Advance Payment Is Reverse Charge")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Is Reverse Charge}", AdvancePayment.IsReverseCharge.ToString());
                    }
                    else if (item == "Advance Payment Tax")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Tax}", AdvancePayment.Tax);
                    }
                    else if (item == "Advance Payment Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Amount}", AdvancePayment.Amount.ToString());
                    }
                    else if (item == "Advance Payment Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Date}", AdvancePayment.PaymentDate.ToString());
                    }
                    else if (item == "Advance Payment Method")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Method}", AdvancePayment.PaymentType);
                    }
                    else if (item == "Advance Payment Reference No")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Reference No}", AdvancePayment.ReferenceNo);
                    }
                    else if (item == "Advance Payment Receipt Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Receipt Url}", AdvancePayment.InvoiceUrl);
                    }
                    else if (item == "Advance Payment Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Notes}", AdvancePayment.Notes);
                    }
                    else if (item == "Refund Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Refund Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Refund Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Refund Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Refund Method")
                    {
                        formattedSubject = formattedSubject.Replace("{Refund Method}", Payment.PaymentType);
                    }
                    else if (item == "Refund Reference No")
                    {
                        formattedSubject = formattedSubject.Replace("{Refund Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Refund Receipt Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Refund Receipt Url}", Payment.InvoiceUrl);
                    }
                    else if (item == "Refund Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Refund Notes}", Payment.Notes);
                    }
                    else if (item == "Unused Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Unused Amount}", Payment.AmountRemaining.ToString());
                    }
                }
                #endregion


                #region EmailBody
                string formattedBody = NotificationModulesSetting.EmailBody;
                string[] array = NotificationModulesSetting.EmailBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Logo")
                    {
                        formattedBody = formattedBody.Replace("{Business Logo}", "<img src='" + webUrl + Branch.BusinessLogo + "' />");
                    }
                    else if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Name}", AdvancePayment.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Mobile No}", AdvancePayment.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Email}", AdvancePayment.SupplierEmailId);
                    }
                    else if (item == "Advance Payment Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Source Of Supply}", AdvancePayment.SourceOfSupply);
                    }
                    else if (item == "Advance Payment Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Destination Of Supply}", AdvancePayment.DestinationOfSupply);
                    }
                    else if (item == "Advance Payment Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Is Reverse Charge}", AdvancePayment.IsReverseCharge.ToString());
                    }
                    else if (item == "Advance Payment Tax")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Tax}", AdvancePayment.Tax);
                    }
                    else if (item == "Advance Payment Amount")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Amount}", AdvancePayment.Amount.ToString());
                    }
                    else if (item == "Advance Payment Date")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Date}", AdvancePayment.PaymentDate.ToString());
                    }
                    else if (item == "Advance Payment Method")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Method}", AdvancePayment.PaymentType);
                    }
                    else if (item == "Advance Payment Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Reference No}", AdvancePayment.ReferenceNo);
                    }
                    else if (item == "Advance Payment Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Receipt Url}", AdvancePayment.InvoiceUrl);
                    }
                    else if (item == "Advance Payment Notes")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Notes}", AdvancePayment.Notes);
                    }
                    else if (item == "Refund Amount")
                    {
                        formattedBody = formattedBody.Replace("{Refund Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Refund Date")
                    {
                        formattedBody = formattedBody.Replace("{Refund Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Refund Method")
                    {
                        formattedBody = formattedBody.Replace("{Refund Method}", Payment.PaymentType);
                    }
                    else if (item == "Refund Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Refund Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Refund Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Refund Receipt Url}", Payment.InvoiceUrl);
                    }
                    else if (item == "Refund Notes")
                    {
                        formattedBody = formattedBody.Replace("{Refund Notes}", Payment.Notes);
                    }
                    else if (item == "Unused Amount")
                    {
                        formattedBody = formattedBody.Replace("{Unused Amount}", Payment.AmountRemaining.ToString());
                    }
                }
                #endregion


                EmailController oEmailController = new EmailController();
                oEmailController.NotificationTemplate(CompanyId, AdvancePayment.SupplierEmailId, formattedSubject, formattedBody, CC, Bcc, AddedBy, CurrentDate, Id, Type, Domain);
            }
            if (WhatsappSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.WhatsappBody;
                string[] array = NotificationModulesSetting.WhatsappBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Name}", AdvancePayment.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Mobile No}", AdvancePayment.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Email}", AdvancePayment.SupplierEmailId);
                    }
                    else if (item == "Advance Payment Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Source Of Supply}", AdvancePayment.SourceOfSupply);
                    }
                    else if (item == "Advance Payment Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Destination Of Supply}", AdvancePayment.DestinationOfSupply);
                    }
                    else if (item == "Advance Payment Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Is Reverse Charge}", AdvancePayment.IsReverseCharge.ToString());
                    }
                    else if (item == "Advance Payment Tax")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Tax}", AdvancePayment.Tax);
                    }
                    else if (item == "Advance Payment Amount")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Amount}", AdvancePayment.Amount.ToString());
                    }
                    else if (item == "Advance Payment Date")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Date}", AdvancePayment.PaymentDate.ToString());
                    }
                    else if (item == "Advance Payment Method")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Method}", AdvancePayment.PaymentType);
                    }
                    else if (item == "Advance Payment Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Reference No}", AdvancePayment.ReferenceNo);
                    }
                    else if (item == "Advance Payment Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Receipt Url}", AdvancePayment.InvoiceUrl);
                    }
                    else if (item == "Advance Payment Notes")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Notes}", AdvancePayment.Notes);
                    }
                    else if (item == "Refund Amount")
                    {
                        formattedBody = formattedBody.Replace("{Refund Amount}", Payment.Amount.ToString());
                    }
                    else if (item == "Refund Date")
                    {
                        formattedBody = formattedBody.Replace("{Refund Date}", Payment.PaymentDate.ToString());
                    }
                    else if (item == "Refund Method")
                    {
                        formattedBody = formattedBody.Replace("{Refund Method}", Payment.PaymentType);
                    }
                    else if (item == "Refund Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Refund Reference No}", Payment.ReferenceNo);
                    }
                    else if (item == "Refund Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Refund Receipt Url}", Payment.InvoiceUrl);
                    }
                    else if (item == "Refund Notes")
                    {
                        formattedBody = formattedBody.Replace("{Refund Notes}", Payment.Notes);
                    }
                    else if (item == "Unused Amount")
                    {
                        formattedBody = formattedBody.Replace("{Unused Amount}", Payment.AmountRemaining.ToString());
                    }
                }

                WhatsappController oWhatsappController = new WhatsappController();
                return oWhatsappController.WhatsappFunction(CompanyId, AdvancePayment.SupplierMobileNo, formattedBody, 0);
            }
            string[] arr = { "1", "", "" };
            return arr;
        }

        public dynamic CreditsAppliedFromDebitNote(ClsNotificationModulesSettingsVm NotificationModulesSetting, long CompanyId, long Id, string CC, string Bcc, long SmsSettingsId, long EmailSettingsId, long WhatsappSettingsId, string Type, long AddedBy, DateTime CurrentDate, string Domain)
        {
            var Payment = oConnectionContext.DbClsSupplierPayment.Where(a => a.SupplierPaymentId == Id).Select(a => new
            {
                a.BranchId,
                a.ParentId,
                PurchaseId = a.PurchaseId,
                ParentPurchaseId = oConnectionContext.DbClsSupplierPayment.Where(b => b.SupplierPaymentId == a.ParentId
                && b.IsDeleted == false && b.IsCancelled == false && b.IsActive == true).Select(b => b.PurchaseId).FirstOrDefault(),
                ParentPurchaseReturnId = oConnectionContext.DbClsSupplierPayment.Where(b => b.SupplierPaymentId == a.ParentId
                && b.IsDeleted == false && b.IsCancelled == false && b.IsActive == true).Select(b => b.PurchaseReturnId).FirstOrDefault(),
                InvoiceUrl = Domain + "/Purchase/ReturnPaymentReceipt?ReferenceId=" + a.ReferenceId,
                a.ReferenceNo,
                a.Notes,
                a.Amount,
                a.PaymentDate,
                a.PaymentTypeId,
                PaymentType = oConnectionContext.DbClsPaymentType.Where(b => b.PaymentTypeId == Id).Select(b => b.PaymentType).FirstOrDefault(),
                AmountRemaining = oConnectionContext.DbClsSupplierPayment.Where(b => b.SupplierPaymentId == a.ParentId
                && b.IsDeleted == false && b.IsCancelled == false && b.IsActive == true).Select(b => b.AmountRemaining).FirstOrDefault(),
            }).FirstOrDefault();

            var AppliedSale = oConnectionContext.DbClsPurchase.Where(a => a.PurchaseId == Payment.PurchaseId).Select(a => new
            {
                a.BranchId,
                SupplierName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.Name).FirstOrDefault(),
                SupplierMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.MobileNo).FirstOrDefault(),
                SupplierEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.EmailId).FirstOrDefault(),
                ReferenceNo = a.ReferenceNo,
                InvoiceUrl = Domain + (a.PurchaseType.ToLower() == "pos" ? "/Purchase/receipt?InvoiceId=" + a.InvoiceId : "/Purchase/invoice?InvoiceId=" + a.InvoiceId),
                SourceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.SourceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                DestinationOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.DestinationOfSupplyId).Select(b => b.State).FirstOrDefault(),
                PurchaseDate = a.PurchaseDate,
                IsReverseCharge = a.IsReverseCharge,
                PaymentTerm = oConnectionContext.DbClsPaymentTerm.Where(b => b.PaymentTermId == a.PaymentTermId).Select(b => b.PaymentTerm).FirstOrDefault(),
                DueDate = a.DueDate,
                Notes = a.Notes,
                Subtotal = a.Subtotal,
                TotalDiscount = a.TotalDiscount,
                TotalTaxAmount = a.TotalTaxAmount,
                NetAmount = a.NetAmount,
                RoundOff = a.RoundOff,
                SpecialDiscount = a.SpecialDiscount,
                GrandTotal = a.GrandTotal,
                a.PurchaseType
            }).FirstOrDefault();

            var ParentSale = oConnectionContext.DbClsPurchase.Where(a => a.PurchaseId == Payment.ParentPurchaseId).Select(a => new
            {
                a.BranchId,
                SupplierName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.Name).FirstOrDefault(),
                SupplierMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.MobileNo).FirstOrDefault(),
                SupplierEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.EmailId).FirstOrDefault(),
                ReferenceNo = a.ReferenceNo,
                InvoiceUrl = Domain + "/purchase/invoice?InvoiceId=" + a.InvoiceId,
                SourceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.SourceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                DestinationOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.DestinationOfSupplyId).Select(b => b.State).FirstOrDefault(),
                PurchaseDate = a.PurchaseDate,
                IsReverseCharge = a.IsReverseCharge,
                PaymentTerm = oConnectionContext.DbClsPaymentTerm.Where(b => b.PaymentTermId == a.PaymentTermId).Select(b => b.PaymentTerm).FirstOrDefault(),
                DueDate = a.DueDate,
                Notes = a.Notes,
                Subtotal = a.Subtotal,
                TotalDiscount = a.TotalDiscount,
                TotalTaxAmount = a.TotalTaxAmount,
                NetAmount = a.NetAmount,
                RoundOff = a.RoundOff,
                SpecialDiscount = a.SpecialDiscount,
                GrandTotal = a.GrandTotal,
                a.PurchaseType
            }).FirstOrDefault();

            var ParentSaleReturn = oConnectionContext.DbClsPurchaseReturn.Where(a => a.PurchaseReturnId == Payment.ParentPurchaseReturnId).Select(a => new
            {
                a.BranchId,
                SourceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.SourceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                DestinationOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.DestinationOfSupplyId).Select(b => b.State).FirstOrDefault(),
                Reason = oConnectionContext.DbClsPurchaseDebitNoteReason.Where(b => b.PurchaseDebitNoteReasonId == a.PurchaseDebitNoteReasonId).Select(b => b.PurchaseDebitNoteReason).FirstOrDefault(),
                Date = a.Date,
                InvoiceNo = a.InvoiceNo,
                InvoiceUrl = Domain + (ParentSale.PurchaseType.ToLower() == "pos" ? "/Purchase/Purchasereturnreceipt?InvoiceId=" + a.InvoiceId : "/Purchase/Purchasereturninvoice?InvoiceId=" + a.InvoiceId),
                InvoiceNotes = a.Notes,
                Subtotal = a.Subtotal,
                TotalDiscount = a.TotalDiscount,
                TotalTaxAmount = a.TotalTaxAmount,
                NetAmount = a.NetAmount,
                RoundOff = a.RoundOff,
                SpecialDiscount = a.SpecialDiscount,
                GrandTotal = a.GrandTotal,
                IsReverseCharge = a.IsReverseCharge
            }).FirstOrDefault();

            var Branch = oConnectionContext.DbClsBranch.Where(a => a.BranchId == Payment.BranchId).Select(a => new
            {
                BusinessName = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessName).FirstOrDefault(),
                BusinessLogo = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessLogo).FirstOrDefault(),
                a.Branch,
                a.BranchCode,
                a.Address,
                a.Zipcode,
                Country = oConnectionContext.DbClsCountry.Where(b => b.CountryId == a.CountryId).Select(b => b.Country).FirstOrDefault(),
                State = oConnectionContext.DbClsState.Where(b => b.StateId == a.StateId).Select(b => b.State).FirstOrDefault(),
                City = oConnectionContext.DbClsCity.Where(b => b.CityId == a.CityId).Select(b => b.City).FirstOrDefault(),
                //ContactPersonName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.Name).FirstOrDefault(),
                //ContactPersonMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.MobileNo).FirstOrDefault(),
                a.Mobile,
                a.AltMobileNo,
                a.Email,
                BusinessRegistrationNo = oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNo).FirstOrDefault(),
                BusinessRegistrationName = oConnectionContext.DbClsBusinessRegistrationName.Where(c => c.BusinessRegistrationNameId ==
                oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNameId).FirstOrDefault()).Select(c => c.Name).FirstOrDefault()
            }).FirstOrDefault();

            if (SmsSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.SmsBody;
                string[] array = NotificationModulesSetting.SmsBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Name}", ParentSale.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Mobile No}", ParentSale.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Email}", ParentSale.SupplierEmailId);
                    }
                    else if (item == "Parent Bill No")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill No}", ParentSale.ReferenceNo.ToString());
                    }
                    else if (item == "Parent Bill Url")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Parent Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Parent Source Of Supply}", ParentSale.SourceOfSupply);
                    }
                    else if (item == "Parent Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Parent Destination Of Supply}", ParentSale.DestinationOfSupply);
                    }
                    else if (item == "Parent Bill Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill Date}", ParentSale.PurchaseDate.ToString());
                    }
                    else if (item == "Parent Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Parent Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Parent Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Parent Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Parent Is Reverse Charge}", ParentSale.IsReverseCharge.ToString());
                    }
                    else if (item == "Parent Bill Notes")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill Notes}", ParentSale.Notes);
                    }
                    else if (item == "Parent Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Parent Discount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Parent Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Parent Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Parent Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Parent Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Parent Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Debit Note Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Source Of Supply}", ParentSaleReturn.SourceOfSupply);
                    }
                    else if (item == "Debit Note Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Destination Of Supply}", ParentSaleReturn.DestinationOfSupply);
                    }
                    else if (item == "Debit Note Date")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Date}", ParentSaleReturn.Date.ToString());
                    }
                    else if (item == "Debit Note Bill No")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Bill No}", ParentSaleReturn.InvoiceNo.ToString());
                    }
                    else if (item == "Debit Note Bill Url")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Bill Url}", ParentSaleReturn.InvoiceUrl);
                    }
                    else if (item == "Debit Note Reason")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Reason}", ParentSaleReturn.Reason);
                    }
                    else if (item == "Debit Note Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Is Reverse Charge}", ParentSaleReturn.IsReverseCharge.ToString());
                    }
                    else if (item == "Debit Note Notes")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Notes}", ParentSaleReturn.InvoiceNotes);
                    }
                    else if (item == "Debit Note Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Gross Amount}", ParentSaleReturn.Subtotal.ToString());
                    }
                    else if (item == "Debit Note Discount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Discount}", ParentSaleReturn.TotalDiscount.ToString());
                    }
                    else if (item == "Debit Note Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Tax Amount}", ParentSaleReturn.TotalTaxAmount.ToString());
                    }
                    else if (item == "Debit Note Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Net Amount}", ParentSaleReturn.NetAmount.ToString());
                    }
                    else if (item == "Debit Note Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Round Off}", ParentSaleReturn.RoundOff.ToString());
                    }
                    else if (item == "Debit Note Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Total Amount}", ParentSaleReturn.GrandTotal.ToString());
                    }
                    else if (item == "Applied Bill No")
                    {
                        formattedBody = formattedBody.Replace("{Applied Bill No}", AppliedSale.ReferenceNo.ToString());
                    }
                    else if (item == "Applied Bill Url")
                    {
                        formattedBody = formattedBody.Replace("{Applied Bill Url}", AppliedSale.InvoiceUrl);
                    }
                    else if (item == "Applied Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Applied Source Of Supply}", AppliedSale.SourceOfSupply);
                    }
                    else if (item == "Applied Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Applied Destination Of Supply}", AppliedSale.DestinationOfSupply);
                    }
                    else if (item == "Applied Bill Date")
                    {
                        formattedBody = formattedBody.Replace("{Applied Bill Date}", AppliedSale.PurchaseDate.ToString());
                    }
                    else if (item == "Applied Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Applied Payment Term}", AppliedSale.PaymentTerm);
                    }
                    else if (item == "Applied Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Applied Due Date}", AppliedSale.DueDate.ToString());
                    }
                    else if (item == "Applied Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Applied Is Reverse Charge}", AppliedSale.IsReverseCharge.ToString());
                    }
                    else if (item == "Applied Bill Notes")
                    {
                        formattedBody = formattedBody.Replace("{Applied Bill Notes}", AppliedSale.Notes);
                    }
                    else if (item == "Applied Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Gross Amount}", AppliedSale.Subtotal.ToString());
                    }
                    else if (item == "Applied Discount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Discount}", AppliedSale.TotalDiscount.ToString());
                    }
                    else if (item == "Applied Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Tax Amount}", AppliedSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Applied Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Net Amount}", AppliedSale.NetAmount.ToString());
                    }
                    else if (item == "Applied Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Applied Round Off}", AppliedSale.RoundOff.ToString());
                    }
                    else if (item == "Applied Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Total Amount}", AppliedSale.GrandTotal.ToString());
                    }
                    else if (item == "Credits Applied")
                    {
                        formattedBody = formattedBody.Replace("{Credits Applied}", Payment.Amount.ToString());
                    }
                    else if (item == "Credits Applied Date")
                    {
                        formattedBody = formattedBody.Replace("{Credits Applied Date}", Payment.PaymentDate.ToString());
                    }
                }

                SmsController oSmsController = new SmsController();
                oSmsController.SmsFunction(CompanyId, ParentSale.SupplierMobileNo, formattedBody, AddedBy, CurrentDate, Id, Type, Domain, 0);
            }
            if (EmailSettingsId != 0)
            {
                #region Email Subject
                string formattedSubject = "";

                formattedSubject = NotificationModulesSetting.EmailSubject;
                string[] arr1 = NotificationModulesSetting.EmailSubject.Split('{');
                List<string> list1 = new List<string>();

                foreach (var item in arr1)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list1.Add(item.Split('}')[0]);
                    }
                }


                foreach (var item in list1)
                {
                    if (item == "Business Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Supplier Name}", ParentSale.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedSubject = formattedSubject.Replace("{Supplier Mobile No}", ParentSale.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedSubject = formattedSubject.Replace("{Supplier Email}", ParentSale.SupplierEmailId);
                    }
                    else if (item == "Parent Bill No")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Bill No}", ParentSale.ReferenceNo.ToString());
                    }
                    else if (item == "Parent Bill Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Bill Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Parent Source Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Source Of Supply}", ParentSale.SourceOfSupply);
                    }
                    else if (item == "Parent Destination Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Destination Of Supply}", ParentSale.DestinationOfSupply);
                    }
                    else if (item == "Parent Bill Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Bill Date}", ParentSale.PurchaseDate.ToString());
                    }
                    else if (item == "Parent Payment Term")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Parent Due Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Parent Is Reverse Charge")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Is Reverse Charge}", ParentSale.IsReverseCharge.ToString());
                    }
                    else if (item == "Parent Bill Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Bill Notes}", ParentSale.Notes);
                    }
                    else if (item == "Parent Gross Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Parent Discount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Parent Tax Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Parent Net Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Parent Round Off")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Parent Total Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Parent Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Debit Note Source Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Source Of Supply}", ParentSaleReturn.SourceOfSupply);
                    }
                    else if (item == "Debit Note Destination Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Destination Of Supply}", ParentSaleReturn.DestinationOfSupply);
                    }
                    else if (item == "Debit Note Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Date}", ParentSaleReturn.Date.ToString());
                    }
                    else if (item == "Debit Note Bill No")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Bill No}", ParentSaleReturn.InvoiceNo.ToString());
                    }
                    else if (item == "Debit Note Bill Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Bill Url}", ParentSaleReturn.InvoiceUrl);
                    }
                    else if (item == "Debit Note Reason")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Reason}", ParentSaleReturn.Reason);
                    }
                    else if (item == "Debit Note Is Reverse Charge")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Is Reverse Charge}", ParentSaleReturn.IsReverseCharge.ToString());
                    }
                    else if (item == "Debit Note Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Notes}", ParentSaleReturn.InvoiceNotes);
                    }
                    else if (item == "Debit Note Gross Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Gross Amount}", ParentSaleReturn.Subtotal.ToString());
                    }
                    else if (item == "Debit Note Discount")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Discount}", ParentSaleReturn.TotalDiscount.ToString());
                    }
                    else if (item == "Debit Note Tax Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Tax Amount}", ParentSaleReturn.TotalTaxAmount.ToString());
                    }
                    else if (item == "Debit Note Net Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Net Amount}", ParentSaleReturn.NetAmount.ToString());
                    }
                    else if (item == "Debit Note Round Off")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Round Off}", ParentSaleReturn.RoundOff.ToString());
                    }
                    else if (item == "Debit Note Total Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Debit Note Total Amount}", ParentSaleReturn.GrandTotal.ToString());
                    }
                    else if (item == "Applied Bill No")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Bill No}", AppliedSale.ReferenceNo.ToString());
                    }
                    else if (item == "Applied Bill Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Bill Url}", AppliedSale.InvoiceUrl);
                    }
                    else if (item == "Applied Source Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Source Of Supply}", AppliedSale.SourceOfSupply);
                    }
                    else if (item == "Applied Destination Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Destination Of Supply}", AppliedSale.DestinationOfSupply);
                    }
                    else if (item == "Applied Bill Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Bill Date}", AppliedSale.PurchaseDate.ToString());
                    }
                    else if (item == "Applied Payment Term")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Payment Term}", AppliedSale.PaymentTerm);
                    }
                    else if (item == "Applied Due Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Due Date}", AppliedSale.DueDate.ToString());
                    }
                    else if (item == "Applied Is Reverse Charge")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Is Reverse Charge}", AppliedSale.IsReverseCharge.ToString());
                    }
                    else if (item == "Applied Bill Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Bill Notes}", AppliedSale.Notes);
                    }
                    else if (item == "Applied Gross Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Gross Amount}", AppliedSale.Subtotal.ToString());
                    }
                    else if (item == "Applied Discount")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Discount}", AppliedSale.TotalDiscount.ToString());
                    }
                    else if (item == "Applied Tax Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Tax Amount}", AppliedSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Applied Net Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Net Amount}", AppliedSale.NetAmount.ToString());
                    }
                    else if (item == "Applied Round Off")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Round Off}", AppliedSale.RoundOff.ToString());
                    }
                    else if (item == "Applied Total Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Total Amount}", AppliedSale.GrandTotal.ToString());
                    }
                    else if (item == "Credits Applied")
                    {
                        formattedSubject = formattedSubject.Replace("{Credits Applied}", Payment.Amount.ToString());
                    }
                    else if (item == "Credits Applied Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Credits Applied Date}", Payment.PaymentDate.ToString());
                    }
                }
                #endregion


                #region EmailBody
                string formattedBody = NotificationModulesSetting.EmailBody;
                string[] array = NotificationModulesSetting.EmailBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Logo")
                    {
                        formattedBody = formattedBody.Replace("{Business Logo}", "<img src='" + webUrl + Branch.BusinessLogo + "' />");
                    }
                    else if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Name}", ParentSale.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Mobile No}", ParentSale.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Email}", ParentSale.SupplierEmailId);
                    }
                    else if (item == "Parent Bill No")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill No}", ParentSale.ReferenceNo.ToString());
                    }
                    else if (item == "Parent Bill Url")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Parent Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Parent Source Of Supply}", ParentSale.SourceOfSupply);
                    }
                    else if (item == "Parent Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Parent Destination Of Supply}", ParentSale.DestinationOfSupply);
                    }
                    else if (item == "Parent Bill Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill Date}", ParentSale.PurchaseDate.ToString());
                    }
                    else if (item == "Parent Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Parent Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Parent Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Parent Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Parent Is Reverse Charge}", ParentSale.IsReverseCharge.ToString());
                    }
                    else if (item == "Parent Bill Notes")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill Notes}", ParentSale.Notes);
                    }
                    else if (item == "Parent Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Parent Discount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Parent Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Parent Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Parent Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Parent Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Parent Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Debit Note Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Source Of Supply}", ParentSaleReturn.SourceOfSupply);
                    }
                    else if (item == "Debit Note Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Destination Of Supply}", ParentSaleReturn.DestinationOfSupply);
                    }
                    else if (item == "Debit Note Date")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Date}", ParentSaleReturn.Date.ToString());
                    }
                    else if (item == "Debit Note Bill No")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Bill No}", ParentSaleReturn.InvoiceNo.ToString());
                    }
                    else if (item == "Debit Note Bill Url")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Bill Url}", ParentSaleReturn.InvoiceUrl);
                    }
                    else if (item == "Debit Note Reason")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Reason}", ParentSaleReturn.Reason);
                    }
                    else if (item == "Debit Note Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Is Reverse Charge}", ParentSaleReturn.IsReverseCharge.ToString());
                    }
                    else if (item == "Debit Note Notes")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Notes}", ParentSaleReturn.InvoiceNotes);
                    }
                    else if (item == "Debit Note Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Gross Amount}", ParentSaleReturn.Subtotal.ToString());
                    }
                    else if (item == "Debit Note Discount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Discount}", ParentSaleReturn.TotalDiscount.ToString());
                    }
                    else if (item == "Debit Note Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Tax Amount}", ParentSaleReturn.TotalTaxAmount.ToString());
                    }
                    else if (item == "Debit Note Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Net Amount}", ParentSaleReturn.NetAmount.ToString());
                    }
                    else if (item == "Debit Note Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Round Off}", ParentSaleReturn.RoundOff.ToString());
                    }
                    else if (item == "Debit Note Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Total Amount}", ParentSaleReturn.GrandTotal.ToString());
                    }
                    else if (item == "Applied Bill No")
                    {
                        formattedBody = formattedBody.Replace("{Applied Bill No}", AppliedSale.ReferenceNo.ToString());
                    }
                    else if (item == "Applied Bill Url")
                    {
                        formattedBody = formattedBody.Replace("{Applied Bill Url}", AppliedSale.InvoiceUrl);
                    }
                    else if (item == "Applied Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Applied Source Of Supply}", AppliedSale.SourceOfSupply);
                    }
                    else if (item == "Applied Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Applied Destination Of Supply}", AppliedSale.DestinationOfSupply);
                    }
                    else if (item == "Applied Bill Date")
                    {
                        formattedBody = formattedBody.Replace("{Applied Bill Date}", AppliedSale.PurchaseDate.ToString());
                    }
                    else if (item == "Applied Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Applied Payment Term}", AppliedSale.PaymentTerm);
                    }
                    else if (item == "Applied Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Applied Due Date}", AppliedSale.DueDate.ToString());
                    }
                    else if (item == "Applied Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Applied Is Reverse Charge}", AppliedSale.IsReverseCharge.ToString());
                    }
                    else if (item == "Applied Bill Notes")
                    {
                        formattedBody = formattedBody.Replace("{Applied Bill Notes}", AppliedSale.Notes);
                    }
                    else if (item == "Applied Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Gross Amount}", AppliedSale.Subtotal.ToString());
                    }
                    else if (item == "Applied Discount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Discount}", AppliedSale.TotalDiscount.ToString());
                    }
                    else if (item == "Applied Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Tax Amount}", AppliedSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Applied Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Net Amount}", AppliedSale.NetAmount.ToString());
                    }
                    else if (item == "Applied Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Applied Round Off}", AppliedSale.RoundOff.ToString());
                    }
                    else if (item == "Applied Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Total Amount}", AppliedSale.GrandTotal.ToString());
                    }
                    else if (item == "Credits Applied")
                    {
                        formattedBody = formattedBody.Replace("{Credits Applied}", Payment.Amount.ToString());
                    }
                    else if (item == "Credits Applied Date")
                    {
                        formattedBody = formattedBody.Replace("{Credits Applied Date}", Payment.PaymentDate.ToString());
                    }
                }
                #endregion


                EmailController oEmailController = new EmailController();
                oEmailController.NotificationTemplate(CompanyId, ParentSale.SupplierEmailId, formattedSubject, formattedBody, CC, Bcc, AddedBy, CurrentDate, Id, Type, Domain);
            }
            if (WhatsappSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.WhatsappBody;
                string[] array = NotificationModulesSetting.WhatsappBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Name}", ParentSale.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Mobile No}", ParentSale.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Email}", ParentSale.SupplierEmailId);
                    }
                    else if (item == "Parent Bill No")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill No}", ParentSale.ReferenceNo.ToString());
                    }
                    else if (item == "Parent Bill Url")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill Url}", ParentSale.InvoiceUrl);
                    }
                    else if (item == "Parent Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Parent Source Of Supply}", ParentSale.SourceOfSupply);
                    }
                    else if (item == "Parent Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Parent Destination Of Supply}", ParentSale.DestinationOfSupply);
                    }
                    else if (item == "Parent Bill Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill Date}", ParentSale.PurchaseDate.ToString());
                    }
                    else if (item == "Parent Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Parent Payment Term}", ParentSale.PaymentTerm);
                    }
                    else if (item == "Parent Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Parent Due Date}", ParentSale.DueDate.ToString());
                    }
                    else if (item == "Parent Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Parent Is Reverse Charge}", ParentSale.IsReverseCharge.ToString());
                    }
                    else if (item == "Parent Bill Notes")
                    {
                        formattedBody = formattedBody.Replace("{Parent Bill Notes}", ParentSale.Notes);
                    }
                    else if (item == "Parent Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Gross Amount}", ParentSale.Subtotal.ToString());
                    }
                    else if (item == "Parent Discount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Discount}", ParentSale.TotalDiscount.ToString());
                    }
                    else if (item == "Parent Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Tax Amount}", ParentSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Parent Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Net Amount}", ParentSale.NetAmount.ToString());
                    }
                    else if (item == "Parent Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Parent Round Off}", ParentSale.RoundOff.ToString());
                    }
                    else if (item == "Parent Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Parent Total Amount}", ParentSale.GrandTotal.ToString());
                    }
                    else if (item == "Debit Note Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Source Of Supply}", ParentSaleReturn.SourceOfSupply);
                    }
                    else if (item == "Debit Note Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Destination Of Supply}", ParentSaleReturn.DestinationOfSupply);
                    }
                    else if (item == "Debit Note Date")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Date}", ParentSaleReturn.Date.ToString());
                    }
                    else if (item == "Debit Note Bill No")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Bill No}", ParentSaleReturn.InvoiceNo.ToString());
                    }
                    else if (item == "Debit Note Bill Url")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Bill Url}", ParentSaleReturn.InvoiceUrl);
                    }
                    else if (item == "Debit Note Reason")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Reason}", ParentSaleReturn.Reason);
                    }
                    else if (item == "Debit Note Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Is Reverse Charge}", ParentSaleReturn.IsReverseCharge.ToString());
                    }
                    else if (item == "Debit Note Notes")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Notes}", ParentSaleReturn.InvoiceNotes);
                    }
                    else if (item == "Debit Note Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Gross Amount}", ParentSaleReturn.Subtotal.ToString());
                    }
                    else if (item == "Debit Note Discount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Discount}", ParentSaleReturn.TotalDiscount.ToString());
                    }
                    else if (item == "Debit Note Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Tax Amount}", ParentSaleReturn.TotalTaxAmount.ToString());
                    }
                    else if (item == "Debit Note Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Net Amount}", ParentSaleReturn.NetAmount.ToString());
                    }
                    else if (item == "Debit Note Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Round Off}", ParentSaleReturn.RoundOff.ToString());
                    }
                    else if (item == "Debit Note Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Debit Note Total Amount}", ParentSaleReturn.GrandTotal.ToString());
                    }
                    else if (item == "Applied Bill No")
                    {
                        formattedBody = formattedBody.Replace("{Applied Bill No}", AppliedSale.ReferenceNo.ToString());
                    }
                    else if (item == "Applied Bill Url")
                    {
                        formattedBody = formattedBody.Replace("{Applied Bill Url}", AppliedSale.InvoiceUrl);
                    }
                    else if (item == "Applied Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Applied Source Of Supply}", AppliedSale.SourceOfSupply);
                    }
                    else if (item == "Applied Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Applied Destination Of Supply}", AppliedSale.DestinationOfSupply);
                    }
                    else if (item == "Applied Bill Date")
                    {
                        formattedBody = formattedBody.Replace("{Applied Bill Date}", AppliedSale.PurchaseDate.ToString());
                    }
                    else if (item == "Applied Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Applied Payment Term}", AppliedSale.PaymentTerm);
                    }
                    else if (item == "Applied Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Applied Due Date}", AppliedSale.DueDate.ToString());
                    }
                    else if (item == "Applied Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Applied Is Reverse Charge}", AppliedSale.IsReverseCharge.ToString());
                    }
                    else if (item == "Applied Bill Notes")
                    {
                        formattedBody = formattedBody.Replace("{Applied Bill Notes}", AppliedSale.Notes);
                    }
                    else if (item == "Applied Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Gross Amount}", AppliedSale.Subtotal.ToString());
                    }
                    else if (item == "Applied Discount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Discount}", AppliedSale.TotalDiscount.ToString());
                    }
                    else if (item == "Applied Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Tax Amount}", AppliedSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Applied Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Net Amount}", AppliedSale.NetAmount.ToString());
                    }
                    else if (item == "Applied Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Applied Round Off}", AppliedSale.RoundOff.ToString());
                    }
                    else if (item == "Applied Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Total Amount}", AppliedSale.GrandTotal.ToString());
                    }
                    else if (item == "Credits Applied")
                    {
                        formattedBody = formattedBody.Replace("{Credits Applied}", Payment.Amount.ToString());
                    }
                    else if (item == "Credits Applied Date")
                    {
                        formattedBody = formattedBody.Replace("{Credits Applied Date}", Payment.PaymentDate.ToString());
                    }
                }

                WhatsappController oWhatsappController = new WhatsappController();
                return oWhatsappController.WhatsappFunction(CompanyId, ParentSale.SupplierMobileNo, formattedBody, 0);
            }
            string[] arr = { "1", "", "" };
            return arr;
        }

        public dynamic CreditsAppliedFromSupplierAdvancePayment(ClsNotificationModulesSettingsVm NotificationModulesSetting, long CompanyId, long Id, string CC, string Bcc, long SmsSettingsId, long EmailSettingsId, long WhatsappSettingsId, string Type, long AddedBy, DateTime CurrentDate, string Domain)
        {
            var Payment = oConnectionContext.DbClsSupplierPayment.Where(a => a.SupplierPaymentId == Id).Select(a => new
            {
                a.BranchId,
                a.ParentId,
                a.PurchaseId,
                InvoiceUrl = Domain + "/Purchase/ReturnPaymentReceipt?ReferenceId=" + a.ReferenceId,
                a.ReferenceNo,
                a.Notes,
                a.Amount,
                a.PaymentDate,
                a.PaymentTypeId,
                PaymentType = oConnectionContext.DbClsPaymentType.Where(b => b.PaymentTypeId == Id).Select(b => b.PaymentType).FirstOrDefault(),
                AmountRemaining = oConnectionContext.DbClsSupplierPayment.Where(b => b.SupplierPaymentId == a.ParentId
                && b.IsDeleted == false && b.IsCancelled == false && b.IsActive == true).Select(b => b.AmountRemaining).FirstOrDefault(),
            }).FirstOrDefault();

            var AppliedSale = oConnectionContext.DbClsPurchase.Where(a => a.PurchaseId == Payment.PurchaseId).Select(a => new
            {
                a.BranchId,
                SupplierName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.Name).FirstOrDefault(),
                SupplierMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.MobileNo).FirstOrDefault(),
                SupplierEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.EmailId).FirstOrDefault(),
                ReferenceNo = a.ReferenceNo,
                InvoiceUrl = Domain + (a.PurchaseType.ToLower() == "pos" ? "/Purchase/receipt?InvoiceId=" + a.InvoiceId : "/Purchase/invoice?InvoiceId=" + a.InvoiceId),
                SourceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.SourceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                DestinationOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.DestinationOfSupplyId).Select(b => b.State).FirstOrDefault(),
                PurchaseDate = a.PurchaseDate,
                IsReverseCharge = a.IsReverseCharge,
                PaymentTerm = oConnectionContext.DbClsPaymentTerm.Where(b => b.PaymentTermId == a.PaymentTermId).Select(b => b.PaymentTerm).FirstOrDefault(),
                DueDate = a.DueDate,
                Notes = a.Notes,
                Subtotal = a.Subtotal,
                TotalDiscount = a.TotalDiscount,
                TotalTaxAmount = a.TotalTaxAmount,
                NetAmount = a.NetAmount,
                RoundOff = a.RoundOff,
                SpecialDiscount = a.SpecialDiscount,
                GrandTotal = a.GrandTotal,
                a.PurchaseType
            }).FirstOrDefault();

            var AdvancePayment = oConnectionContext.DbClsSupplierPayment.Where(a => a.SupplierPaymentId == Payment.ParentId).Select(a => new
            {
                SupplierName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.Name).FirstOrDefault(),
                SupplierEmailId = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.EmailId).FirstOrDefault(),
                SupplierMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.SupplierId).Select(b => b.MobileNo).FirstOrDefault(),
                SourceOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.SourceOfSupplyId).Select(b => b.State).FirstOrDefault(),
                DestinationOfSupply = oConnectionContext.DbClsState.Where(b => b.StateId == a.DestinationOfSupplyId).Select(b => b.State).FirstOrDefault(),
                Tax = oConnectionContext.DbClsTax.Where(b => b.TaxId == a.TaxId).Select(b => b.Tax).FirstOrDefault(),
                a.Amount,
                a.PaymentDate,
                PaymentType = oConnectionContext.DbClsPaymentType.Where(b => b.PaymentTypeId == Id).Select(b => b.PaymentType).FirstOrDefault(),
                a.ReferenceNo,
                InvoiceUrl = Domain + "/Purchase/PaymentReceipt?ReferenceId=" + a.ReferenceId,
                a.Notes,
                a.BranchId,
                a.SupplierId,
                a.IsReverseCharge
            }).FirstOrDefault();

            var Branch = oConnectionContext.DbClsBranch.Where(a => a.BranchId == Payment.BranchId).Select(a => new
            {
                BusinessName = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessName).FirstOrDefault(),
                BusinessLogo = oConnectionContext.DbClsBusinessSettings.Where(b => b.CompanyId == CompanyId).Select(b => b.BusinessLogo).FirstOrDefault(),
                a.Branch,
                a.BranchCode,
                a.Address,
                a.Zipcode,
                Country = oConnectionContext.DbClsCountry.Where(b => b.CountryId == a.CountryId).Select(b => b.Country).FirstOrDefault(),
                State = oConnectionContext.DbClsState.Where(b => b.StateId == a.StateId).Select(b => b.State).FirstOrDefault(),
                City = oConnectionContext.DbClsCity.Where(b => b.CityId == a.CityId).Select(b => b.City).FirstOrDefault(),
                //ContactPersonName = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.Name).FirstOrDefault(),
                //ContactPersonMobileNo = oConnectionContext.DbClsUser.Where(b => b.UserId == a.ContactPersonId).Select(b => b.MobileNo).FirstOrDefault(),
                a.Mobile,
                a.AltMobileNo,
                a.Email,
                BusinessRegistrationNo = oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNo).FirstOrDefault(),
                BusinessRegistrationName = oConnectionContext.DbClsBusinessRegistrationName.Where(c => c.BusinessRegistrationNameId ==
                oConnectionContext.DbClsTaxSetting.Where(b => b.TaxSettingId == a.TaxSettingId).Select(b => b.BusinessRegistrationNameId).FirstOrDefault()).Select(c => c.Name).FirstOrDefault()
            }).FirstOrDefault();

            if (SmsSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.SmsBody;
                string[] array = NotificationModulesSetting.SmsBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Name}", AdvancePayment.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Mobile No}", AdvancePayment.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Email}", AdvancePayment.SupplierEmailId);
                    }
                    else if (item == "Advance Payment Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Source Of Supply}", AdvancePayment.SourceOfSupply);
                    }
                    else if (item == "Advance Payment Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Destination Of Supply}", AdvancePayment.DestinationOfSupply);
                    }
                    else if (item == "Advance Payment Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Is Reverse Charge}", AdvancePayment.IsReverseCharge.ToString());
                    }
                    else if (item == "Advance Payment Tax")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Tax}", AdvancePayment.Tax);
                    }
                    else if (item == "Advance Payment Amount")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Amount}", AdvancePayment.Amount.ToString());
                    }
                    else if (item == "Advance Payment Date")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Date}", AdvancePayment.PaymentDate.ToString());
                    }
                    else if (item == "Advance Payment Method")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Method}", AdvancePayment.PaymentType);
                    }
                    else if (item == "Advance Payment Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Reference No}", AdvancePayment.ReferenceNo);
                    }
                    else if (item == "Advance Payment Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Receipt Url}", AdvancePayment.InvoiceUrl);
                    }
                    else if (item == "Advance Payment Notes")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Notes}", AdvancePayment.Notes);
                    }
                    else if (item == "Applied Bill No")
                    {
                        formattedBody = formattedBody.Replace("{Applied Bill No}", AppliedSale.ReferenceNo.ToString());
                    }
                    else if (item == "Applied Bill Url")
                    {
                        formattedBody = formattedBody.Replace("{Applied Bill Url}", AppliedSale.InvoiceUrl);
                    }
                    else if (item == "Applied Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Applied Source Of Supply}", AppliedSale.SourceOfSupply);
                    }
                    else if (item == "Applied Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Applied Destination Of Supply}", AppliedSale.DestinationOfSupply);
                    }
                    else if (item == "Applied Bill Date")
                    {
                        formattedBody = formattedBody.Replace("{Applied Bill Date}", AppliedSale.PurchaseDate.ToString());
                    }
                    else if (item == "Applied Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Applied Payment Term}", AppliedSale.PaymentTerm);
                    }
                    else if (item == "Applied Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Applied Due Date}", AppliedSale.DueDate.ToString());
                    }
                    else if (item == "Applied Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Applied Is Reverse Charge}", AppliedSale.IsReverseCharge.ToString());
                    }
                    else if (item == "Applied Bill Notes")
                    {
                        formattedBody = formattedBody.Replace("{Applied Bill Notes}", AppliedSale.Notes);
                    }
                    else if (item == "Applied Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Gross Amount}", AppliedSale.Subtotal.ToString());
                    }
                    else if (item == "Applied Discount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Discount}", AppliedSale.TotalDiscount.ToString());
                    }
                    else if (item == "Applied Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Tax Amount}", AppliedSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Applied Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Net Amount}", AppliedSale.NetAmount.ToString());
                    }
                    else if (item == "Applied Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Applied Round Off}", AppliedSale.RoundOff.ToString());
                    }
                    else if (item == "Applied Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Total Amount}", AppliedSale.GrandTotal.ToString());
                    }
                    else if (item == "Credits Applied")
                    {
                        formattedBody = formattedBody.Replace("{Credits Applied}", Payment.Amount.ToString());
                    }
                    else if (item == "Credits Applied Date")
                    {
                        formattedBody = formattedBody.Replace("{Credits Applied Date}", Payment.PaymentDate.ToString());
                    }
                }

                SmsController oSmsController = new SmsController();
                oSmsController.SmsFunction(CompanyId, AdvancePayment.SupplierMobileNo, formattedBody, AddedBy, CurrentDate, Id, Type, Domain, 0);
            }
            if (EmailSettingsId != 0)
            {
                #region Email Subject
                string formattedSubject = "";

                formattedSubject = NotificationModulesSetting.EmailSubject;
                string[] arr1 = NotificationModulesSetting.EmailSubject.Split('{');
                List<string> list1 = new List<string>();

                foreach (var item in arr1)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list1.Add(item.Split('}')[0]);
                    }
                }


                foreach (var item in list1)
                {
                    if (item == "Business Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedSubject = formattedSubject.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedSubject = formattedSubject.Replace("{Supplier Name}", AdvancePayment.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedSubject = formattedSubject.Replace("{Supplier Mobile No}", AdvancePayment.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedSubject = formattedSubject.Replace("{Supplier Email}", AdvancePayment.SupplierEmailId);
                    }
                    else if (item == "Advance Payment Source Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Source Of Supply}", AdvancePayment.SourceOfSupply);
                    }
                    else if (item == "Advance Payment Destination Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Destination Of Supply}", AdvancePayment.DestinationOfSupply);
                    }
                    else if (item == "Advance Payment Is Reverse Charge")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Is Reverse Charge}", AdvancePayment.IsReverseCharge.ToString());
                    }
                    else if (item == "Advance Payment Tax")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Tax}", AdvancePayment.Tax);
                    }
                    else if (item == "Advance Payment Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Amount}", AdvancePayment.Amount.ToString());
                    }
                    else if (item == "Advance Payment Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Date}", AdvancePayment.PaymentDate.ToString());
                    }
                    else if (item == "Advance Payment Method")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Method}", AdvancePayment.PaymentType);
                    }
                    else if (item == "Advance Payment Reference No")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Reference No}", AdvancePayment.ReferenceNo);
                    }
                    else if (item == "Advance Payment Receipt Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Receipt Url}", AdvancePayment.InvoiceUrl);
                    }
                    else if (item == "Advance Payment Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Advance Payment Notes}", AdvancePayment.Notes);
                    }
                    else if (item == "Applied Bill No")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Bill No}", AppliedSale.ReferenceNo.ToString());
                    }
                    else if (item == "Applied Bill Url")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Bill Url}", AppliedSale.InvoiceUrl);
                    }
                    else if (item == "Applied Source Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Source Of Supply}", AppliedSale.SourceOfSupply);
                    }
                    else if (item == "Applied Destination Of Supply")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Destination Of Supply}", AppliedSale.DestinationOfSupply);
                    }
                    else if (item == "Applied Bill Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Bill Date}", AppliedSale.PurchaseDate.ToString());
                    }
                    else if (item == "Applied Payment Term")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Payment Term}", AppliedSale.PaymentTerm);
                    }
                    else if (item == "Applied Due Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Due Date}", AppliedSale.DueDate.ToString());
                    }
                    else if (item == "Applied Is Reverse Charge")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Is Reverse Charge}", AppliedSale.IsReverseCharge.ToString());
                    }
                    else if (item == "Applied Bill Notes")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Bill Notes}", AppliedSale.Notes);
                    }
                    else if (item == "Applied Gross Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Gross Amount}", AppliedSale.Subtotal.ToString());
                    }
                    else if (item == "Applied Discount")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Discount}", AppliedSale.TotalDiscount.ToString());
                    }
                    else if (item == "Applied Tax Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Tax Amount}", AppliedSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Applied Net Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Net Amount}", AppliedSale.NetAmount.ToString());
                    }
                    else if (item == "Applied Round Off")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Round Off}", AppliedSale.RoundOff.ToString());
                    }
                    else if (item == "Applied Total Amount")
                    {
                        formattedSubject = formattedSubject.Replace("{Applied Total Amount}", AppliedSale.GrandTotal.ToString());
                    }
                    else if (item == "Credits Applied")
                    {
                        formattedSubject = formattedSubject.Replace("{Credits Applied}", Payment.Amount.ToString());
                    }
                    else if (item == "Credits Applied Date")
                    {
                        formattedSubject = formattedSubject.Replace("{Credits Applied Date}", Payment.PaymentDate.ToString());
                    }
                }
                #endregion


                #region EmailBody
                string formattedBody = NotificationModulesSetting.EmailBody;
                string[] array = NotificationModulesSetting.EmailBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Logo")
                    {
                        formattedBody = formattedBody.Replace("{Business Logo}", "<img src='" + webUrl + Branch.BusinessLogo + "' />");
                    }
                    else if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Name}", AdvancePayment.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Mobile No}", AdvancePayment.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Email}", AdvancePayment.SupplierEmailId);
                    }
                    else if (item == "Advance Payment Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Source Of Supply}", AdvancePayment.SourceOfSupply);
                    }
                    else if (item == "Advance Payment Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Destination Of Supply}", AdvancePayment.DestinationOfSupply);
                    }
                    else if (item == "Advance Payment Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Is Reverse Charge}", AdvancePayment.IsReverseCharge.ToString());
                    }
                    else if (item == "Advance Payment Tax")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Tax}", AdvancePayment.Tax);
                    }
                    else if (item == "Advance Payment Amount")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Amount}", AdvancePayment.Amount.ToString());
                    }
                    else if (item == "Advance Payment Date")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Date}", AdvancePayment.PaymentDate.ToString());
                    }
                    else if (item == "Advance Payment Method")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Method}", AdvancePayment.PaymentType);
                    }
                    else if (item == "Advance Payment Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Reference No}", AdvancePayment.ReferenceNo);
                    }
                    else if (item == "Advance Payment Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Receipt Url}", AdvancePayment.InvoiceUrl);
                    }
                    else if (item == "Advance Payment Notes")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Notes}", AdvancePayment.Notes);
                    }
                    else if (item == "Applied Bill No")
                    {
                        formattedBody = formattedBody.Replace("{Applied Bill No}", AppliedSale.ReferenceNo.ToString());
                    }
                    else if (item == "Applied Bill Url")
                    {
                        formattedBody = formattedBody.Replace("{Applied Bill Url}", AppliedSale.InvoiceUrl);
                    }
                    else if (item == "Applied Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Applied Source Of Supply}", AppliedSale.SourceOfSupply);
                    }
                    else if (item == "Applied Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Applied Destination Of Supply}", AppliedSale.DestinationOfSupply);
                    }
                    else if (item == "Applied Bill Date")
                    {
                        formattedBody = formattedBody.Replace("{Applied Bill Date}", AppliedSale.PurchaseDate.ToString());
                    }
                    else if (item == "Applied Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Applied Payment Term}", AppliedSale.PaymentTerm);
                    }
                    else if (item == "Applied Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Applied Due Date}", AppliedSale.DueDate.ToString());
                    }
                    else if (item == "Applied Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Applied Is Reverse Charge}", AppliedSale.IsReverseCharge.ToString());
                    }
                    else if (item == "Applied Bill Notes")
                    {
                        formattedBody = formattedBody.Replace("{Applied Bill Notes}", AppliedSale.Notes);
                    }
                    else if (item == "Applied Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Gross Amount}", AppliedSale.Subtotal.ToString());
                    }
                    else if (item == "Applied Discount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Discount}", AppliedSale.TotalDiscount.ToString());
                    }
                    else if (item == "Applied Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Tax Amount}", AppliedSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Applied Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Net Amount}", AppliedSale.NetAmount.ToString());
                    }
                    else if (item == "Applied Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Applied Round Off}", AppliedSale.RoundOff.ToString());
                    }
                    else if (item == "Applied Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Total Amount}", AppliedSale.GrandTotal.ToString());
                    }
                    else if (item == "Credits Applied")
                    {
                        formattedBody = formattedBody.Replace("{Credits Applied}", Payment.Amount.ToString());
                    }
                    else if (item == "Credits Applied Date")
                    {
                        formattedBody = formattedBody.Replace("{Credits Applied Date}", Payment.PaymentDate.ToString());
                    }
                }
                #endregion


                EmailController oEmailController = new EmailController();
                oEmailController.NotificationTemplate(CompanyId, AdvancePayment.SupplierEmailId, formattedSubject, formattedBody, CC, Bcc, AddedBy, CurrentDate, Id, Type, Domain);
            }
            if (WhatsappSettingsId != 0)
            {
                string formattedBody = NotificationModulesSetting.WhatsappBody;
                string[] array = NotificationModulesSetting.WhatsappBody.Split('{');
                List<string> list = new List<string>();

                foreach (var item in array)
                {
                    if (item.IndexOf('}') > -1)
                    {
                        list.Add(item.Split('}')[0]);
                    }
                }

                foreach (var item in list)
                {
                    if (item == "Business Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Name}", Branch.BusinessName);
                    }
                    else if (item == "Business Location Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Name}", Branch.Branch);
                    }
                    else if (item == "Business Location Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Contact No}", Branch.Mobile);
                    }
                    else if (item == "Business Location Alternative Contact No")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Alternative Contact No}", Branch.AltMobileNo);
                    }
                    else if (item == "Business Location Email Id")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Email Id}", Branch.Email);
                    }
                    else if (item == "Business Registration Name")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration Name}", Branch.BusinessRegistrationName);
                    }
                    else if (item == "Business Registration No")
                    {
                        formattedBody = formattedBody.Replace("{Business Registration No}", Branch.BusinessRegistrationNo);
                    }
                    else if (item == "Business Location Country")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Country}", Branch.Country);
                    }
                    else if (item == "Business Location State")
                    {
                        formattedBody = formattedBody.Replace("{Business Location State}", Branch.State);
                    }
                    else if (item == "Business Location City")
                    {
                        formattedBody = formattedBody.Replace("{Business Location City}", Branch.City);
                    }
                    else if (item == "Business Location Zip Code")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Zip Code}", Branch.Zipcode);
                    }
                    else if (item == "Business Location Address")
                    {
                        formattedBody = formattedBody.Replace("{Business Location Address}", Branch.Address);
                    }
                    else if (item == "Supplier Name")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Name}", AdvancePayment.SupplierName);
                    }
                    else if (item == "Supplier Mobile No")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Mobile No}", AdvancePayment.SupplierMobileNo);
                    }
                    else if (item == "Supplier Email")
                    {
                        formattedBody = formattedBody.Replace("{Supplier Email}", AdvancePayment.SupplierEmailId);
                    }
                    else if (item == "Advance Payment Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Source Of Supply}", AdvancePayment.SourceOfSupply);
                    }
                    else if (item == "Advance Payment Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Destination Of Supply}", AdvancePayment.DestinationOfSupply);
                    }
                    else if (item == "Advance Payment Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Is Reverse Charge}", AdvancePayment.IsReverseCharge.ToString());
                    }
                    else if (item == "Advance Payment Tax")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Tax}", AdvancePayment.Tax);
                    }
                    else if (item == "Advance Payment Amount")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Amount}", AdvancePayment.Amount.ToString());
                    }
                    else if (item == "Advance Payment Date")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Date}", AdvancePayment.PaymentDate.ToString());
                    }
                    else if (item == "Advance Payment Method")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Method}", AdvancePayment.PaymentType);
                    }
                    else if (item == "Advance Payment Reference No")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Reference No}", AdvancePayment.ReferenceNo);
                    }
                    else if (item == "Advance Payment Receipt Url")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Receipt Url}", AdvancePayment.InvoiceUrl);
                    }
                    else if (item == "Advance Payment Notes")
                    {
                        formattedBody = formattedBody.Replace("{Advance Payment Notes}", AdvancePayment.Notes);
                    }
                    else if (item == "Applied Bill No")
                    {
                        formattedBody = formattedBody.Replace("{Applied Bill No}", AppliedSale.ReferenceNo.ToString());
                    }
                    else if (item == "Applied Bill Url")
                    {
                        formattedBody = formattedBody.Replace("{Applied Bill Url}", AppliedSale.InvoiceUrl);
                    }
                    else if (item == "Applied Source Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Applied Source Of Supply}", AppliedSale.SourceOfSupply);
                    }
                    else if (item == "Applied Destination Of Supply")
                    {
                        formattedBody = formattedBody.Replace("{Applied Destination Of Supply}", AppliedSale.DestinationOfSupply);
                    }
                    else if (item == "Applied Bill Date")
                    {
                        formattedBody = formattedBody.Replace("{Applied Bill Date}", AppliedSale.PurchaseDate.ToString());
                    }
                    else if (item == "Applied Payment Term")
                    {
                        formattedBody = formattedBody.Replace("{Applied Payment Term}", AppliedSale.PaymentTerm);
                    }
                    else if (item == "Applied Due Date")
                    {
                        formattedBody = formattedBody.Replace("{Applied Due Date}", AppliedSale.DueDate.ToString());
                    }
                    else if (item == "Applied Is Reverse Charge")
                    {
                        formattedBody = formattedBody.Replace("{Applied Is Reverse Charge}", AppliedSale.IsReverseCharge.ToString());
                    }
                    else if (item == "Applied Bill Notes")
                    {
                        formattedBody = formattedBody.Replace("{Applied Bill Notes}", AppliedSale.Notes);
                    }
                    else if (item == "Applied Gross Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Gross Amount}", AppliedSale.Subtotal.ToString());
                    }
                    else if (item == "Applied Discount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Discount}", AppliedSale.TotalDiscount.ToString());
                    }
                    else if (item == "Applied Tax Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Tax Amount}", AppliedSale.TotalTaxAmount.ToString());
                    }
                    else if (item == "Applied Net Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Net Amount}", AppliedSale.NetAmount.ToString());
                    }
                    else if (item == "Applied Round Off")
                    {
                        formattedBody = formattedBody.Replace("{Applied Round Off}", AppliedSale.RoundOff.ToString());
                    }
                    else if (item == "Applied Total Amount")
                    {
                        formattedBody = formattedBody.Replace("{Applied Total Amount}", AppliedSale.GrandTotal.ToString());
                    }
                    else if (item == "Credits Applied")
                    {
                        formattedBody = formattedBody.Replace("{Credits Applied}", Payment.Amount.ToString());
                    }
                    else if (item == "Credits Applied Date")
                    {
                        formattedBody = formattedBody.Replace("{Credits Applied Date}", Payment.PaymentDate.ToString());
                    }
                }

                WhatsappController oWhatsappController = new WhatsappController();
                return oWhatsappController.WhatsappFunction(CompanyId, AdvancePayment.SupplierMobileNo, formattedBody, 0);
            }
            string[] arr = { "1", "", "" };
            return arr;
        }

        #endregion
    }
}
