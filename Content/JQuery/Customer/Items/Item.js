
$(function () {

    isNewVariationBuilderEnabled = $('#attributeBuilderContainer').length > 0;
    isVariantGridServerRendered = $('#hdnVariantGridServerRendered').length > 0;
    isPurchaseAddonEnabled = ($('#hdnIsPurchaseAddon').val() || '').toLowerCase() === 'true';
    isAccountsAddonEnabled = ($('#hdnIsAccountsAddon').val() || '').toLowerCase() === 'true';
    isMrpEnabled = ($('#hdnEnableMrp').val() || '').toLowerCase() === 'true';
    canAddNewVariations = ($('#hdnVariationPermissionIsAdd').val() || '').toLowerCase() === 'true';

    $('#tblData').DataTable({
        lengthChange: false,
        searching: false,
        autoWidth: false,
        responsive: true,
        paging: false,
        bInfo: false
    });

    var DateFormat = Cookies.get('BusinessSetting').split('&')[0].split('=')[1];
    $('#txtDateRange').daterangepicker({
        locale: {
            format: DateFormat.toUpperCase()
        }
    });

    initializeSelect2InScope();

    $("[data-toggle=popover]").popover({
        html: true,
        trigger: "hover",
        placement: 'auto',
    });

    $('textarea#txtDescription').summernote({
        placeholder: '',
        tabsize: 2,
        height: 100,
        toolbar: [
            ['style', ['style']],
            ['font', ['bold', 'italic', 'underline', 'clear']],
            // ['font', ['bold', 'italic', 'underline', 'strikethrough', 'superscript', 'subscript', 'clear']],
            //['fontname', ['fontname']],
            // ['fontsize', ['fontsize']],
            ['color', ['color']],
            ['para', ['ul', 'ol', 'paragraph']],
            ['height', ['height']],
            ['table', ['table']],
            ['insert', ['link', 'picture', 'hr']],
            //['view', ['fullscreen', 'codeview']],
            ['help', ['help']]
        ],
    });

    if (window.location.href.toLowerCase().indexOf('itemsedit') == -1 && window.location.href.toLowerCase().indexOf('itemsduplicate') == -1) {
        init();
    }
    else {
        if ($('#ddlProductType').val() == "Combo") {
            setComboPrice();
        }
    }

    if (window.location.href.toLowerCase().indexOf('itemsedit') == -1 && window.location.href.toLowerCase().indexOf('itemsduplicate') == -1
        && window.location.href.toLowerCase().indexOf('itemsadd') == -1) {
        $('.hideButton').hide();
        $('.select2').css('width', '100%');
    }

    fetchVariations();
    fetchActiveAccountsDropdown();

    // Only auto-initialize the attribute builder when there are no existing variant rows.
    if (isNewVariationBuilderEnabled && $('#variantGrid tbody tr').length === 0) {
        initializeAttributeBuilder();
    }

    $('#variationModal').on('hidden.bs.modal', function () {
        attributeBuilderTargetKey = null;
    });

    if (window.location.href.toLocaleLowerCase().indexOf('itemid') == -1) {
        checkItemType();
    }
    //else {
    //    setTimeout(function () {
    //        checkItemType();
    //    }, 100);
    //}
});

var EnableSound = Cookies.get('SystemSetting').split('&')[4].split('=')[1];

var ShowHelpText = Cookies.get('SystemSetting').split('&')[0].split('=')[1];
var interval = null;

if (sessionStorage.getItem("showMsg") == '1') {
    interval = setInterval(playSound, 500);
}

function playSound() {
    if (EnableSound == 'True') { document.getElementById('success').play(); }
    toastr.success(sessionStorage.getItem("Msg"));

    if (sessionStorage.getItem('showOpeningStock') == '1') {
        AvailableBranches(sessionStorage.getItem('ItemId'), true);
        sessionStorage.removeItem("showOpeningStock");
        sessionStorage.removeItem("ItemId");
    }

    sessionStorage.removeItem("showMsg");
    sessionStorage.removeItem("Msg");
    clearInterval(interval);
}

var _PageIndex = 1, c = 1, _variationId = 0;
var ProductImage = "";
var fileExtensionProductImage = "";
var ProductBrochure = "";
var fileExtensionProductBrochure = "";
var count = 1; var innerCount = 1; var dropdownHtml = ''; var _OpeningStockId = 0; var _ItemId = 0;
var _isOpeningStockOpen = false, _CheckStockPriceMismatch = true, _i;
var isError = false;
var myInterval;
var BatchNo = Math.floor(Math.random() * 26) + Date.now();
var TotalCount = 0;
var _excelJson = [];
var UploadPath = "", fileExtension = "";
var isExcelUpload = false;
var accountSubTypes;
var isNewVariationBuilderEnabled = false;
// On the edit screen, the variants grid is rendered by the server and should
// not be regenerated by the client-side attribute builder logic.
var isVariantGridServerRendered = false;
var attributeBuilderInitialized = false;
var attributeRowCounter = 0;
var variantAttributeSelections = {};
var variantDetailsCache = {};
var variantRowStateCache = {};
var isInitializingVariantsFromServer = false;
var isPurchaseAddonEnabled = false;
var isAccountsAddonEnabled = false;
var isMrpEnabled = false;
var canAddNewVariations = false;
var attributeBuilderTargetKey = null;

function initializeSelect2InScope(scope) {
    var $scope = scope ? $(scope) : $(document);
    var $selects = $scope.find('select.select2');

    if ($scope.is('select.select2')) {
        $selects = $selects.add($scope);
    }

    $selects.each(function () {
        var $select = $(this);
        if (!$select.data('select2')) {
            $select.select2();
        }
    });
}

function init() {
    $('#singleproduct').show();
    $('#variableproduct').hide();
    $('#comboproduct').hide();
}

function fetchActiveAccountsDropdown() {
    var det = {
    };
    //$("#divLoading").show();
    $.ajax({
        url: '/accounts/ActiveAccountsDropdown',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {

            $("#divLoading").hide();
            if (data == "True") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }
            else if (data == "False") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }

            if (data.Status == 0) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error(data.Message);
            }
            else if (data.Status == 2) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error('Invalid inputs, check and try again !!');
                data.Errors.forEach(function (res) {
                    $('#' + res.Id + '_M').show();
                    $('#' + res.Id + '_M').text(res.Message);


                    if ($('.' + res.Id + '_ctrl').children("select").length > 0) {
                        var element = $("." + res.Id + '_ctrl select');
                        if (element.hasClass("select2-hidden-accessible")) {
                            $('.' + res.Id + '_ctrl .select2-container .select2-selection').css('border', '2px solid #dc3545');
                        } else {
                            $('.' + res.Id + '_ctrl select').css('border', '2px solid #dc3545');
                        }
                    }
                    else {
                        $('.' + res.Id + '_ctrl').css('border', '2px solid #dc3545');
                    }
                });
            }
            else {
                accountSubTypes = data.Data.AccountSubTypes;
            }
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
}

function fetchVariations() {
    var det = {

    };
    //_PageIndex = det.PageIndex;
    //$("#divLoading").show();
    $.ajax({
        url: '/itemsettings/Activevariations',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {

            var dropdown = '';
            for (let i = 0; i < data.Data.Variations.length; i++) {
                dropdown = dropdown + '<option value="' + data.Data.Variations[i].VariationId + '">' + data.Data.Variations[i].Variation + '</option>';
            }
            dropdownHtml = dropdown;
        refreshAttributeDropdownOptions();
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
}

function refreshAttributeDropdownOptions() {
    if (!isNewVariationBuilderEnabled) {
        return;
    }
    $('.attribute-variation').each(function () {
        var selectedValue = $(this).val();
        $(this).empty().append('<option value="">Select</option>' + dropdownHtml);
        if (selectedValue) {
            $(this).val(selectedValue).trigger('change');
        }
    });
}

function initializeAttributeBuilder() {
    if (!isNewVariationBuilderEnabled || attributeBuilderInitialized) {
        return;
    }
    attributeBuilderInitialized = true;
    attributeRowCounter = 0;
    variantAttributeSelections = {};
    $('#attributeBuilderContainer').empty();
    $('#attributeBuilderEmptyState').show();
    $('#variantGrid tbody').empty();
    $('#variantGridEmptyState').show();
    AddNewAttribute();
}

function AddNewAttribute() {
    if (!isNewVariationBuilderEnabled) {
        return;
    }
    var currentCount = Object.keys(variantAttributeSelections).length;
    if (currentCount >= 3) {
        toastr.warning('You can add up to 3 attributes only');
        return;
    }
    attributeRowCounter++;
    $('#attributeBuilderEmptyState').hide();
    variantAttributeSelections[attributeRowCounter] = {
        variationId: 0,
        variationName: '',
        values: []
    };

    var addVariationBtnHtml = canAddNewVariations
        ? '<span class="input-group-append">' +
        '<a href="javascript:void(0)" class="btn btn-info attribute-add-variation" title="Add new attribute" aria-label="Add new attribute" onclick="openAttributeVariationModal(' + attributeRowCounter + ')">+</a>' +
        '</span>'
        : '';

    var rowHtml = '<div class="attribute-row border rounded p-3 mb-2" id="attributeRow' + attributeRowCounter + '">' +
        '<div class="form-row">' +
        '<div class="col-md-3">' +
        '<div class="form-group mb-0">' +
        '<label>Attribute <span class="danger">*</span></label>' +
        '<div class="input-group attribute-variation-group">' +
        '<select class="select2 attribute-variation" style="width:100%;" id="ddlAttributeVariation' + attributeRowCounter + '" data-attr-key="' + attributeRowCounter + '">' +
        '<option value="">Select</option>' + dropdownHtml +
        '</select>' +
        addVariationBtnHtml +
        '</div>' +
        '</div>' +
        '</div>' +
        '<div class="col-md-8">' +
        '<div class="form-group mb-0">' +
        '<label>Values <span class="danger">*</span></label>' +
        '<div class="input-group">' +
        '<select class="select2 attribute-values" style="width:100%;" id="ddlAttributeValues' + attributeRowCounter + '" data-attr-key="' + attributeRowCounter + '" multiple="multiple"></select>' +
        '</div>' +
        '</div>' +
        '</div>' +
        '<div class="col-md-1 d-flex align-items-end justify-content-end">' +
        '<button type="button" class="btn btn-danger btn-sm remove-attribute" onclick="removeAttributeRow(' + attributeRowCounter + ')"><i class="fas fa-times"></i></button>' +
        '</div>' +
        '</div>' +
        '</div>';

    $('#attributeBuilderContainer').append(rowHtml);
    initializeSelect2InScope('#attributeRow' + attributeRowCounter);
    $('#ddlAttributeVariation' + attributeRowCounter).on('change', function () {
        handleAttributeVariationChange($(this).data('attr-key'));
    });
    $('#ddlAttributeValues' + attributeRowCounter).on('change', function () {
        handleAttributeValueChange($(this).data('attr-key'));
    });
    toggleRemoveAttributeButtons();
}

// In edit mode (where the variant grid is already rendered by the server),
// attribute configuration is read-only. This helper disables all controls
// in the attribute builder so that attributes/values cannot be changed.
function lockAttributeBuilderForEdit() {
    if (!isVariantGridServerRendered) {
        return;
    }

    // Disable the underlying selects (including select2 widgets)
    var $attributeSelects = $('.attribute-variation, .attribute-values');
    if ($attributeSelects.length) {
        $attributeSelects.prop('disabled', true).trigger('change.select2');
    }

    // Hide the "add new attribute" plus button next to the attribute dropdown
    $('.attribute-add-variation').addClass('d-none');

    // Hide the remove icons & prevent removing existing attribute rows
    $('.remove-attribute')
        .prop('disabled', true)
        .addClass('d-none');

    // Make SKU fields read-only so codes cannot be modified on ItemsEdit,
    // while still allowing their values to be submitted with the form.
    $('#variantGrid .input_sub_sku').prop('readonly', true);
}

function removeAttributeRow(key) {
    if (!variantAttributeSelections[key]) {
        return;
    }
    delete variantAttributeSelections[key];
    $('#attributeRow' + key).remove();
    if (Object.keys(variantAttributeSelections).length === 0) {
        $('#attributeBuilderEmptyState').show();
        $('#variantGrid tbody').empty();
        $('#variantGridEmptyState').show();
    } else {
        rebuildVariantGrid();
    }
    toggleRemoveAttributeButtons();
}

function toggleRemoveAttributeButtons() {
    var total = Object.keys(variantAttributeSelections).length;
    $('.remove-attribute').prop('disabled', total <= 1);
}

function handleAttributeVariationChange(key) {
    if (!variantAttributeSelections[key]) {
        return;
    }
    var variationId = $('#ddlAttributeVariation' + key).val();
    variantAttributeSelections[key].variationId = variationId ? parseInt(variationId) : 0;
    variantAttributeSelections[key].variationName = $('#ddlAttributeVariation' + key + ' option:selected').text();
    variantAttributeSelections[key].values = [];
    var $valueSelect = $('#ddlAttributeValues' + key);
    $valueSelect.empty().trigger('change');

    if (!variationId) {
        rebuildVariantGrid();
        return;
    }

    fetchVariationDetailsForAttribute(variationId).then(function (details) {
        $valueSelect.empty();
        for (var i = 0; i < details.length; i++) {
            $valueSelect.append(new Option(details[i].VariationDetails, details[i].VariationDetailsId));
        }

        // When initializing from existing variants on the edit screen, we may
        // already know which value ids should be selected for this attribute
        // row. Apply those *after* the options have been populated to avoid a
        // race condition where Select2 renders blank chips.
        var pendingIds = $valueSelect.data('pending-values');
        if (pendingIds && pendingIds.length) {
            $valueSelect.val(pendingIds).trigger('change');
            $valueSelect.removeData('pending-values');
        } else {
            $valueSelect.trigger('change');
        }
    });
}

function handleAttributeValueChange(key) {
    if (!variantAttributeSelections[key]) {
        return;
    }
    var variationId = variantAttributeSelections[key].variationId;
    var selectedValues = $('#ddlAttributeValues' + key).val() || [];
    var values = [];
    if (variationId && variantDetailsCache[variationId]) {
        for (var i = 0; i < selectedValues.length; i++) {
            var val = variantDetailsCache[variationId].find(function (a) { return a.VariationDetailsId == selectedValues[i]; });
            if (val) {
                values.push({
                    VariationId: variationId,
                    VariationDetailsId: val.VariationDetailsId,
                    VariationDetailsName: val.VariationDetails,
                    VariationName: variantAttributeSelections[key].variationName
                });
            }
        }
    }
    variantAttributeSelections[key].values = values;
    // During initial attribute builder setup on edit, we don't want to touch the
    // server-rendered variant grid. In that phase, just cache the selections.
    if (isInitializingVariantsFromServer) {
        return;
    }
    rebuildVariantGrid();
}

function fetchVariationDetailsForAttribute(variationId) {
    return new Promise(function (resolve, reject) {
        if (variantDetailsCache[variationId]) {
            resolve(variantDetailsCache[variationId]);
            return;
        }
        $.ajax({
            url: '/itemsettings/ActiveVariationDetails',
            datatype: "json",
            data: { VariationId: variationId },
            type: "post",
            success: function (data) {
                variantDetailsCache[variationId] = data.Data.VariationDetails;
                resolve(variantDetailsCache[variationId]);
            },
            error: function (xhr) {
                resolve([]);
            }
        });
    });
}

function rebuildVariantGrid() {
    // On edit, when the grid is already rendered by the server, do not let
    // the client-side builder clear or regenerate it.
    if (isVariantGridServerRendered) {
        return;
    }

    var attributes = [];
    for (var key in variantAttributeSelections) {
        if (!variantAttributeSelections.hasOwnProperty(key)) {
            continue;
        }
        var attr = variantAttributeSelections[key];
        if (attr.variationId && attr.values.length > 0) {
            attributes.push(attr);
        }
    }

    if (attributes.length === 0) {
        $('#variantGrid tbody').empty();
        $('#variantGridEmptyState').show();
        return;
    }

    var combinationSource = [];
    for (var i = 0; i < attributes.length; i++) {
        var attrValues = attributes[i].values.map(function (value) {
            return {
                variationId: attributes[i].variationId,
                variationName: attributes[i].variationName,
                variationDetailsId: value.VariationDetailsId,
                variationDetailsName: value.VariationDetailsName
            };
        });
        combinationSource.push(attrValues);
    }

    var combinations = cartesianProduct(combinationSource);
    renderVariantGridRows(combinations);
}

function renderVariantGridRows(combinations) {
    var $tbody = $('#variantGrid tbody');
    $tbody.empty();
    if (!isInitializingVariantsFromServer) {
        variantRowStateCache = collectExistingVariantRowState();
    }

    if (!combinations || combinations.length === 0) {
        $('#variantGridEmptyState').show();
        return;
    }

    $('#variantGridEmptyState').hide();
    for (var i = 0; i < combinations.length; i++) {
        var combo = combinations[i];
        var comboKey = getCombinationKey(combo);
        var existing = variantRowStateCache[comboKey] || {};
        var rowId = existing.rowId ? existing.rowId : ++innerCount;
        if (rowId > innerCount) {
            innerCount = rowId;
        }
        var attributeSummary = buildAttributeSummaryForCombo(combo);
        var encodedAttributes = encodeURIComponent(JSON.stringify(combo));
    var includeChecked = (existing.include !== undefined) ? existing.include : true;
    var rowHtml = '<tr id="product_variation_form_part_inner' + rowId + '" data-combo-key="' + comboKey + '" data-row-id="' + rowId + '">' +
            '<td class="text-center align-middle">' +
            '<div class="custom-control custom-switch">' +
            '<input type="checkbox" class="custom-control-input variant-include" id="chkVariantInclude' + rowId + '" ' + (includeChecked ? 'checked' : '') + '>' +
            '<label class="custom-control-label" for="chkVariantInclude' + rowId + '"></label>' +
            '</div>' +
            '</td>' +
            '<td>' +
            '<div class="variant-attribute-stack">';

        for (var cIndex = 0; cIndex < combo.length; cIndex++) {
            rowHtml += '<span class="badge badge-light text-dark border mr-1 mb-1">' + (combo[cIndex].variationName ? combo[cIndex].variationName + ': ' : '') + combo[cIndex].variationDetailsName + '</span>';
        }
        rowHtml += '</div>' +
            '<input type="hidden" class="variant-attributes" value="' + encodedAttributes + '">' +
            '<input type="hidden" id="hdnItemDetailsId' + rowId + '" value="' + (existing.itemDetailsId || 0) + '">' +
            '<input type="hidden" id="txtValue' + rowId + '" value="' + attributeSummary + '">' +
            '<input type="hidden" id="hdnPriceAddedFor' + rowId + '" value="' + (existing.priceAddedFor || 0) + '">' +
            '</td>';

        rowHtml += buildInventoryAccountColumn(rowId, existing);
        rowHtml += buildSkuColumn(rowId, existing);
        rowHtml += buildPurchasePriceColumn(rowId, existing);
        rowHtml += buildPurchaseAccountColumn(rowId, existing);
        rowHtml += buildProfitMarginColumn(rowId, existing);
        rowHtml += buildSellingPriceColumn(rowId, existing);
        rowHtml += buildSalesAccountColumn(rowId, existing);
        rowHtml += buildMrpColumn(rowId, existing);
        rowHtml += buildVariantImageColumn(rowId, existing);

        rowHtml += '</tr>';
        $tbody.append(rowHtml);
    }

    initializeSelect2InScope('#variantGrid');
    $('[data-toggle=popover]').popover({
        html: true,
        trigger: "hover",
        placement: 'auto',
    });
}

function initializeAttributeBuilderFromExisting(existingVariants) {
    if (!isNewVariationBuilderEnabled || !existingVariants || existingVariants.length === 0) {
        console.log('initializeAttributeBuilderFromExisting: skipped - enabled=', isNewVariationBuilderEnabled, 'variants=', existingVariants ? existingVariants.length : 0);
        return;
    }
    console.log('initializeAttributeBuilderFromExisting: start with', existingVariants.length, 'variants', existingVariants);

    // Ensure variations dropdown is loaded; if not, retry shortly
    if (!dropdownHtml || dropdownHtml.length === 0) {
        console.log('initializeAttributeBuilderFromExisting: dropdownHtml empty, retrying...');
        setTimeout(function () {
            initializeAttributeBuilderFromExisting(existingVariants);
        }, 300);
        return;
    }

    // From this point we are in a special "initialization" mode used on the
    // edit screen: we ONLY want to reconstruct the attribute rows based on
    // existing variants, and we do NOT want to disturb the server-rendered
    // variant grid. This flag is also checked in the change handlers.
    isInitializingVariantsFromServer = true;
    attributeBuilderInitialized = true;
    attributeRowCounter = 0;
    variantAttributeSelections = {};
    $('#attributeBuilderContainer').empty();
    $('#attributeBuilderEmptyState').show();

    // Build attribute configuration (unique attributes and their values)
    var attributeConfigs = {};
    for (var i = 0; i < existingVariants.length; i++) {
        var variant = existingVariants[i];
        var rawMappings = variant.AttributeMappings;
        var effectiveMappings = [];

        if (rawMappings && rawMappings.length) {
            effectiveMappings = rawMappings;
        } else if (variant.VariationId && variant.VariationDetailsId) {
            effectiveMappings.push({
                VariationId: variant.VariationId,
                VariationDetailsId: variant.VariationDetailsId,
                VariationDetailsName: variant.VariationDetailsName || variant.VariationDetails || '',
                VariationName: variant.VariationName || ''
            });
        }

        if (!effectiveMappings.length) {
            continue;
        }

        for (var j = 0; j < effectiveMappings.length; j++) {
            var map = effectiveMappings[j];
            if (!map) {
                continue;
            }
            var variationId = map.VariationId;
            if (!attributeConfigs[variationId]) {
                attributeConfigs[variationId] = {
                    variationId: variationId,
                    variationName: map.VariationName || '',
                    values: {}
                };
            }
            if (!attributeConfigs[variationId].values[map.VariationDetailsId]) {
                attributeConfigs[variationId].values[map.VariationDetailsId] = {
                    VariationId: variationId,
                    VariationDetailsId: map.VariationDetailsId,
                    VariationDetailsName: map.VariationDetailsName,
                    VariationName: map.VariationName || ''
                };
            }
        }
    }

    var attributeIds = Object.keys(attributeConfigs);
    if (attributeIds.length === 0) {
        console.log('initializeAttributeBuilderFromExisting: no attribute configs built');
        return;
    }
    console.log('initializeAttributeBuilderFromExisting: attribute configs', attributeConfigs);

    // Create attribute rows and pre-select their values.
    // IMPORTANT: we rely on handleAttributeVariationChange to load the value
    // options for a given attribute; once those options are populated, we then
    // apply the saved value ids. This avoids a race where values were being
    // selected *before* the options existed, which caused blank chips until
    // the page was refreshed.
    for (var a = 0; a < attributeIds.length; a++) {
        var attrVariationId = attributeIds[a];
        var config = attributeConfigs[attrVariationId];

        AddNewAttribute();
        var rowKey = attributeRowCounter;

        // Store the saved value ids so the change handler can apply them after
        // the value list has been loaded for this attribute.
        var savedValueIds = Object.keys(config.values);
        $('#ddlAttributeValues' + rowKey).data('pending-values', savedValueIds);

        // This will trigger handleAttributeVariationChange, which in turn
        // fetches the active variation details and populates the values
        // dropdown. Once populated, it will look for the pending ids above and
        // select them.
        $('#ddlAttributeVariation' + rowKey).val(String(attrVariationId)).trigger('change');
    }

    // End of initialization phase; subsequent user changes to attributes
    // should regenerate the grid as usual.
    isInitializingVariantsFromServer = false;

    // On the edit screen, once the existing attributes & values are shown,
    // lock the builder so the dropdowns can no longer be modified.
    lockAttributeBuilderForEdit();
}

function buildInventoryAccountColumn(rowId, existing) {
    var columnClass = (isPurchaseAddonEnabled && isAccountsAddonEnabled) ? 'divInventoryAccount service' : 'divInventoryAccount service hidden';
    var inventoryOptions = buildAccountOptionsHtml('Stock', 'Inventory Asset', existing.inventoryAccountId);
    return '<td class="' + columnClass + '">' +
        '<div class="form-group mb-0">' +
        '<select class="form-control select2" id="ddlInventoryAccount' + rowId + '">' + inventoryOptions + '</select>' +
        '</div>' +
        '</td>';
}

function buildSkuColumn(rowId, existing) {
    return '<td>' +
        '<input class="form-control input-sm input_sub_sku divSku' + rowId + '_ctrl" type="text" id="txtSku' + rowId + '" value="' + (existing.sku || '') + '">' +
        '<small class="text-red font-weight-bold errorText" id="divSku' + rowId + '"></small>' +
        '</td>';
}

function buildPurchasePriceColumn(rowId, existing) {
    var html = '<td>' +
        '<input class="form-control input-sm variable_dpp input_number divPurchaseExcTax' + rowId + '_ctrl" type="number" id="txtPurchaseExcTax' + rowId + '" value="' + (existing.purchaseExcTax || '') + '" onchange="UpdateVariationAmount(1,' + rowId + ')">' +
        '<small class="text-red font-weight-bold errorText" id="divPurchaseExcTax' + rowId + '"></small>' +
        '<input class="form-control input-sm variable_dpp_inc_tax input_number mt-2 hidden" type="number" id="txtPurchaseIncTax' + rowId + '" value="' + (existing.purchaseIncTax || '') + '">' +
        '</td>';
    return html;
}

function buildPurchaseAccountColumn(rowId, existing) {
    var columnClass = isAccountsAddonEnabled ? '' : 'hidden';
    var purchaseOptions = buildAccountOptionsHtml('Expense', 'Cost of Goods Sold', existing.purchaseAccountId);
    return '<td class="' + columnClass + '">' +
        '<div class="form-group mb-0">' +
        '<select class="form-control select2" id="ddlPurchaseAccount' + rowId + '">' + purchaseOptions + '</select>' +
        '</div>' +
        '</td>';
}

function buildProfitMarginColumn(rowId, existing) {
    var columnClass = isPurchaseAddonEnabled ? '' : 'hidden';
    return '<td class="' + columnClass + '">' +
        '<input class="form-control input-sm variable_profit_percent input_number divDefaultProfitMargin' + rowId + '_ctrl" type="number" id="txtDefaultProfitMargin' + rowId + '" value="' + (existing.defaultProfitMargin || '') + '" onchange="UpdateVariationAmount(3,' + rowId + ')">' +
        '<small class="text-red font-weight-bold errorText" id="divDefaultProfitMargin' + rowId + '"></small>' +
        '</td>';
}

function buildSellingPriceColumn(rowId, existing) {
    return '<td>' +
        '<input class="form-control input-sm variable_dsp input_number divSalesTax' + rowId + '_ctrl" type="number" id="txtSalesExcTax' + rowId + '" value="' + (existing.salesExcTax || '') + '" onchange="UpdateVariationAmount(4,' + rowId + ')">' +
        '<small class="text-red font-weight-bold errorText" id="divSalesTax' + rowId + '"></small>' +
        '<input class="form-control input-sm variable_dsp input_number mt-2 hidden" type="number" id="txtSalesIncTax' + rowId + '" value="' + (existing.salesIncTax || '') + '">' +
        '</td>';
}

function buildSalesAccountColumn(rowId, existing) {
    var columnClass = isAccountsAddonEnabled ? '' : 'hidden';
    var salesOptions = buildAccountOptionsHtml('Income', 'Sales', existing.salesAccountId);
    return '<td class="' + columnClass + '">' +
        '<div class="form-group mb-0">' +
        '<select class="form-control select2" id="ddlSalesAccount' + rowId + '">' + salesOptions + '</select>' +
        '</div>' +
        '</td>';
}

function buildMrpColumn(rowId, existing) {
    var columnClass = isMrpEnabled ? '' : 'hidden';
    return '<td class="' + columnClass + '">' +
        '<input class="form-control input-sm variable_profit_percent input_number" type="number" id="txtDefaultMrp' + rowId + '" value="' + (existing.defaultMrp || '') + '">' +
        '<small class="text-red font-weight-bold errorText" id="divDefaultMrp' + rowId + '"></small>' +
        '</td>';
}

function buildVariantImageColumn(rowId, existing) {
    var imgSrc = existing.imagePreview || '';
    return '<td>' +
        '<div class="custom-file">' +
        '<input type="file" class="custom-file-input" id="ProductImage' + rowId + '" accept=".png,.jpg,.jpeg" onchange="getImageBase64(' + rowId + ')">' +
        '<input type="hidden" id="txtHiddenFile' + rowId + '" value="' + (existing.productImage || '') + '">' +
        '<input type="hidden" id="txtHiddenFileExtension' + rowId + '" value="' + (existing.productImageExt || '') + '">' +
        '<label class="custom-file-label" for="ProductImage' + rowId + '">Choose file</label>' +
        '</div>' +
        '<img id="blahProductImage' + rowId + '" alt="" height="60" style="padding-top:10px;" src="' + imgSrc + '">' +
        '</td>';
}

function buildAccountOptionsHtml(filterType, preferredType, selectedValue) {
    if (!accountSubTypes || accountSubTypes.length === 0) {
        return '';
    }
    var html = '';
    for (var i = 0; i < accountSubTypes.length; i++) {
        var typeMatch = false;
        if (filterType === 'Stock') {
            typeMatch = accountSubTypes[i].Type === 'Stock';
        }
        else {
            typeMatch = accountSubTypes[i].AccountType === filterType;
        }
        if (!typeMatch || !accountSubTypes[i].Accounts || accountSubTypes[i].Accounts.length === 0) {
            continue;
        }
        html += '<optgroup label="' + accountSubTypes[i].DisplayAs + '">';
        for (var j = 0; j < accountSubTypes[i].Accounts.length; j++) {
            var account = accountSubTypes[i].Accounts[j];
            var isSelected = '';
            if (selectedValue && selectedValue == account.AccountId) {
                isSelected = ' selected';
            }
            else if (!selectedValue && preferredType && account.Type === preferredType) {
                isSelected = ' selected';
            }
            html += '<option value="' + account.AccountId + '"' + isSelected + '>' + account.AccountName + '</option>';
        }
        html += '</optgroup>';
    }
    return html;
}

function collectExistingVariantRowState() {
    var state = {};
    $('#variantGrid tbody tr').each(function () {
        var key = $(this).data('combo-key');
        var rowId = $(this).data('row-id');
        state[key] = {
            rowId: rowId,
            sku: $('#txtSku' + rowId).val(),
            purchaseExcTax: $('#txtPurchaseExcTax' + rowId).val(),
            purchaseIncTax: $('#txtPurchaseIncTax' + rowId).val(),
            defaultProfitMargin: $('#txtDefaultProfitMargin' + rowId).val(),
            salesExcTax: $('#txtSalesExcTax' + rowId).val(),
            salesIncTax: $('#txtSalesIncTax' + rowId).val(),
            defaultMrp: $('#txtDefaultMrp' + rowId).val(),
            purchaseAccountId: $('#ddlPurchaseAccount' + rowId).val(),
            salesAccountId: $('#ddlSalesAccount' + rowId).val(),
            inventoryAccountId: $('#ddlInventoryAccount' + rowId).val(),
            itemDetailsId: $('#hdnItemDetailsId' + rowId).val(),
            productImage: $('#txtHiddenFile' + rowId).val(),
            productImageExt: $('#txtHiddenFileExtension' + rowId).val(),
            include: $('#chkVariantInclude' + rowId).is(':checked'),
            imagePreview: $('#blahProductImage' + rowId).attr('src')
        };
    });
    return state;
}

function cartesianProduct(arr) {
    if (arr.length === 0) {
        return [];
    }
    return arr.reduce(function (a, b) {
        var ret = [];
        for (var i = 0; i < a.length; i++) {
            for (var j = 0; j < b.length; j++) {
                ret.push(a[i].concat([b[j]]));
            }
        }
        return ret;
    }, [[]]);
}

function getCombinationKey(combo) {
    return combo.map(function (item) { return item.variationId + ':' + item.variationDetailsId; }).join('|');
}

function buildAttributeSummaryForCombo(combo) {
    return combo.map(function (item) {
        if (item.variationName) {
            return item.variationName + ': ' + item.variationDetailsName;
        }
        return item.variationDetailsName;
    }).join(' / ');
}

function collectVariantsFromBuilder() {
    var variants = [];
    $('#variantGrid tbody tr').each(function () {
        var rowId = $(this).data('row-id');
        if (!$('#chkVariantInclude' + rowId).is(':checked')) {
            return;
        }
        var attributesEncoded = $(this).find('.variant-attributes').val();
        var attributes = [];
        if (attributesEncoded) {
            try {
                attributes = JSON.parse(decodeURIComponent(attributesEncoded));
            } catch (e) {
                attributes = [];
            }
        }
        variants.push({
            SKU: $('#txtSku' + rowId).val(),
            VariationId: attributes.length > 0 ? attributes[0].variationId : 0,
            VariationDetailsId: attributes.length > 0 ? attributes[0].variationDetailsId : 0,
            AttributeMappings: attributes,
            PurchaseExcTax: $('#txtPurchaseExcTax' + rowId).val(),
            PurchaseIncTax: $('#txtPurchaseIncTax' + rowId).val(),
            DefaultProfitMargin: $('#txtDefaultProfitMargin' + rowId).val(),
            SalesExcTax: $('#txtSalesExcTax' + rowId).val(),
            SalesIncTax: $('#txtSalesIncTax' + rowId).val(),
            DefaultMrp: $('#txtDefaultMrp' + rowId).val(),
            ProductImage: $('#txtHiddenFile' + rowId).val(),
            FileExtensionProductImage: $('#txtHiddenFileExtension' + rowId).val(),
            ItemDetailsId: $('#hdnItemDetailsId' + rowId).val(),
            VariationName: $('#txtValue' + rowId).val(),
            DivId: rowId,
            PurchaseAccountId: $('#ddlPurchaseAccount' + rowId).val(),
            SalesAccountId: $('#ddlSalesAccount' + rowId).val(),
            InventoryAccountId: $('#ddlInventoryAccount' + rowId).val(),
        });
    });
    return variants;
}

// Used on the edit screen to collect variants from the server-rendered grid.
// Unlike collectVariantsFromBuilder (used on insert), this helper always
// returns all rows and uses the "Use" toggle to mark rows as deleted so
// the API can soft-delete unchecked variants.
function collectVariantsFromGridForUpdate() {
    var variants = [];
    $('#variantGrid tbody tr').each(function () {
        var rowId = $(this).data('row-id');
        var attributesEncoded = $(this).find('.variant-attributes').val();
        var attributes = [];
        if (attributesEncoded) {
            try {
                attributes = JSON.parse(decodeURIComponent(attributesEncoded));
            } catch (e) {
                attributes = [];
            }
        }
        var include = $('#chkVariantInclude' + rowId).is(':checked');
        variants.push({
            SKU: $('#txtSku' + rowId).val(),
            VariationId: attributes.length > 0 ? attributes[0].variationId : 0,
            VariationDetailsId: attributes.length > 0 ? attributes[0].variationDetailsId : 0,
            AttributeMappings: attributes,
            PurchaseExcTax: $('#txtPurchaseExcTax' + rowId).val(),
            PurchaseIncTax: $('#txtPurchaseIncTax' + rowId).val(),
            DefaultProfitMargin: $('#txtDefaultProfitMargin' + rowId).val(),
            SalesExcTax: $('#txtSalesExcTax' + rowId).val(),
            SalesIncTax: $('#txtSalesIncTax' + rowId).val(),
            DefaultMrp: $('#txtDefaultMrp' + rowId).val(),
            ProductImage: $('#txtHiddenFile' + rowId).val(),
            FileExtensionProductImage: $('#txtHiddenFileExtension' + rowId).val(),
            ItemDetailsId: $('#hdnItemDetailsId' + rowId).val(),
            VariationName: $('#txtValue' + rowId).val(),
            DivId: rowId,
            PurchaseAccountId: $('#ddlPurchaseAccount' + rowId).val(),
            SalesAccountId: $('#ddlSalesAccount' + rowId).val(),
            InventoryAccountId: $('#ddlInventoryAccount' + rowId).val(),
            IsDeleted: !include
        });
    });
    return variants;
}

function hideAll() {
    $('.errorText').hide();
    $('[style*="border: 2px"]').css('border', '');

    $('#singleproduct').hide();
    $('#variableproduct').hide();
    $('#comboproduct').hide();
}

function chooseProductType() {
    hideAll();
    $('.divChkSecondaryUnit').show();
    $('#chkIsManageStock').prop('disabled', false);
    if ($('#ddlProductType').val() == "Single") {
        $('#singleproduct').show();
    }
    else if ($('#ddlProductType').val() == "Variable") {
        $('#variableproduct').show();
        if (isNewVariationBuilderEnabled) {
            initializeAttributeBuilder();
        }
        else {
            AddNewVariation();
        }
    }
    else {
        $('#comboproduct').show();
        $('#chkIsManageStock').prop('checked', false);
        $('#chkIsManageStock').prop('disabled', true);
        CheckManageStock();

        $('#chkEnableSecondaryUnit').prop('checked', false);
        fetchActiveSecondaryUnits();
        $('.divChkSecondaryUnit').hide();
    }
}

function fetchList(PageIndex) {
    var DateFormat = Cookies.get('BusinessSetting').split('&')[0].split('=')[1];
    var det = {
        PageIndex: PageIndex == undefined ? _PageIndex : PageIndex,
        PageSize: $('#txtPageSize').val(),
        BranchId: $('#ddlBranch').val(),
        CategoryId: $('#ddlCategory').val(),
        SubCategoryId: $('#ddlSubCategory').val(),
        SubSubCategoryId: $('#ddlSubSubCategory').val(),
        //FromDate: moment($('#txtDateRange').val().split(' ')[0], DateFormat.toUpperCase()).format('DD-MM-YYYY'),
        //ToDate: moment($('#txtDateRange').val().split(' ')[2], DateFormat.toUpperCase()).format('DD-MM-YYYY'),
        //FromDate: $('#txtFromDate').val(),
        //ToDate: $('#txtToDate').val(),
        BrandId: $('#ddlBrand').val(),
        UnitId: $('#ddlUnit').val(),
        SkuCode: $('#txtSkuCode').val(),
        HsnCode: $('#txtHsnCode').val(),
        ItemName: $('#txtItemName').val(),
        ItemType: $('#ddlItemType').val()
    };
    _PageIndex = det.PageIndex;
    $("#divLoading").show();
    $.ajax({
        url: '/items/itemsFetch',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {
            $("#tblData").html(data);
            $('.chkIsActive').bootstrapToggle();
            $("#divLoading").hide();

            $('#tblData').DataTable({
                lengthChange: false,
                searching: false,
                autoWidth: false,
                responsive: false,
                paging: false,
                bInfo: false,
                "bDestroy": true
            });
            $("#thead").insertBefore(".table-body");
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
};

function View(ItemId) {
    var det = {
        ItemId: ItemId
    };
    $("#divLoading").show();
    $.ajax({
        url: '/Items/itemsview',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {
            $('#ViewModal').modal('toggle');
            $("#divView").html(data);
            //$("#ViewModal").parent().appendTo($("form:first"));
            //checkItemType();

            $("[data-toggle=popover]").popover({
                html: true,
                trigger: "hover",
                placement: 'auto',
            });

            $("#divLoading").hide();
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
};

function insert(i) {
    $('.errorText').hide();
    $('[style*="border: 2px"]').css('border', '');

    $('.form-control').css('border-color', '#ced4da');

    var ItemDetails = []; var ItemBranchMaps = [];
    if ($('#ddlProductType').val() == 'Single') {

        ItemDetails.push({
            SKU: $('#txtSkuHsnCode').val(),
            PurchaseExcTax: $('#txtPurchaseExcTax').val(),
            PurchaseIncTax: $('#txtPurchaseIncTax').val(),
            DefaultProfitMargin: $('#txtDefaultProfitMargin').val(),
            SalesExcTax: $('#txtSalesExcTax').val(),
            SalesIncTax: $('#txtSalesIncTax').val(),
            DefaultMrp: $('#txtDefaultMRP').val(),
            ProductImage: $('#txtHiddenFile0').val(),
            FileExtensionProductImage: $('#txtHiddenFileExtension0').val(),
            PurchaseAccountId: $('#ddlPurchaseAccount').val(),
            SalesAccountId: $('#ddlSalesAccount').val(),
            InventoryAccountId: $('#ddlInventoryAccount').val(),
        })
    }
    else if ($('#ddlProductType').val() == 'Variable') {
        if (isNewVariationBuilderEnabled) {
            var builderItems = collectVariantsFromBuilder();
            if (builderItems.length == 0) {
                isError = true;
                $('#divAttributeSelections').show();
                $('#divAttributeSelections').text('Add at least one variant');
            }
            ItemDetails = ItemDetails.concat(builderItems);
        }
        else {
        var variationDetails = [];
        $('#divVariation table').each(function () {
            var _id = this.id.split('product_variation_form_part')[1];
            if (_id != undefined) {
                $('#divInnerVariation' + _id + ' tr').each(function () {
                    var _innerid = this.id.split('product_variation_form_part_inner')[1];

                    //if (!$('#ddlVariation' + _id).val() || $('#ddlVariation' + _id).val() == 0) {
                    //    isError = true;
                    //    $('#divVariation' + _id).show();
                    //    $('#divVariation' + _id).text('This field is required');
                    //}

                    //if (IsPurchaseAddon == 'true') {
                    //    if (!$('#txtPurchaseExcTax' + _innerid).val()) {
                    //        isError = true;
                    //        $('#divPurchaseExcTax' + _innerid).show();
                    //        $('#divPurchaseExcTax' + _innerid).text('This field is required');
                    //    }

                    //    //if (!$('#txtPurchaseIncTax' + _innerid).val()) {
                    //    //    isError = true;
                    //    //    $('#divPurchaseIncTax' + _innerid).show();
                    //    //    $('#divPurchaseIncTax' + _innerid).text('This field is required');
                    //    //}

                    //    if (!$('#txtDefaultProfitMargin' + _innerid).val()) {
                    //        isError = true;
                    //        $('#divDefaultProfitMargin' + _innerid).show();
                    //        $('#divDefaultProfitMargin' + _innerid).text('This field is required');
                    //    }
                    //}
                    //else {
                    //    $('#txtPurchaseExcTax' + _innerid).val($('#txtSalesExcTax' + _innerid).val());
                    //    $('#txtPurchaseIncTax' + _innerid).val($('#txtSalesIncTax' + _innerid).val());
                    //}

                    //if (!$('#txtSalesExcTax' + _innerid).val() && !$('#txtSalesIncTax' + _innerid).val()) {
                    //    isError = true;
                    //    $('#divSalesTax' + _innerid).show();
                    //    $('#divSalesTax' + _innerid).text('This field is required');
                    //}

                    //if (!$('#txtValue' + _innerid).val()) {
                    //    isError = true;
                    //    $('#divValue' + _innerid).show();
                    //    $('#divValue' + _innerid).text('This field is required');
                    //}

                    ItemDetails.push({
                        SKU: $('#txtSku' + _innerid).val(),
                        VariationId: $('#ddlVariation' + _id).val(),
                        VariationDetailsId: $('#hdnValue' + _innerid).val(),
                        PurchaseExcTax: $('#txtPurchaseExcTax' + _innerid).val(),
                        PurchaseIncTax: $('#txtPurchaseIncTax' + _innerid).val(),
                        DefaultProfitMargin: $('#txtDefaultProfitMargin' + _innerid).val(),
                        SalesExcTax: $('#txtSalesExcTax' + _innerid).val(),
                        SalesIncTax: $('#txtSalesIncTax' + _innerid).val(),
                        DefaultMrp: $('#txtDefaultMrp' + _innerid).val(),
                        ProductImage: $('#txtHiddenFile' + _innerid).val(),
                        FileExtensionProductImage: $('#txtHiddenFileExtension' + _innerid).val(),
                        ItemDetailsId: $('#hdnItemDetailsId' + _innerid).val(),
                        VariationName: $('#txtValue' + _innerid).val(),
                        DivId: _innerid,
                        PurchaseAccountId: $('#ddlPurchaseAccount' + _innerid).val(),
                        SalesAccountId: $('#ddlSalesAccount' + _innerid).val(),
                        InventoryAccountId: $('#ddlInventoryAccount' + _innerid).val(),
                    })
                });
            }
        });
        }
    }
    else if ($('#ddlProductType').val() == 'Combo') {
        var variationDetails = [];
        $('#divCombo tr').each(function () {
            var _id = this.id.split('divCombo')[1];
            if (_id != undefined) {

                //if (!$('#txtComboQuantity' + _id).val() || $('#txtComboQuantity' + _id).val() <= 0) {
                //    isError = true;
                //    $('#divComboQuantity' + _id).show();
                //    $('#divComboQuantity' + _id).text('Quantity is required');
                //}

                ItemDetails.push({
                    DivId: _id,
                    ItemDetailsId: $('#hdnItemDetailsId' + _id).val(),
                    ComboItemDetailsId: $('#hdnComboItemDetailsId' + _id).val(),
                    Quantity: $('#txtComboQuantity' + _id).val(),
                    TotalCost: $('#hdnComboTotalAmount' + _id).val(),
                    DefaultProfitMargin: $('#txtComboDefaultMargin').val(),
                    SalesExcTax: $('#txtComboSalesExcTax').val(),
                    SalesIncTax: $('#txtComboSalesIncTax').val(),
                    PriceAddedFor: $("#ddlComboUnit" + _id).val().split('-')[1],
                    DefaultMrp: $('#txtComboDefaultMrp').val(),
                    SalesAccountId: $('#ddlComboSalesAccount').val(),
                })
            }
        });        
    }

    $('.divBranch').each(function () {
        var _innerid = this.id.split('tr')[1];
        if ($('#chkBranch' + _innerid).is(':checked')) {
            ItemBranchMaps.push({
                BranchId: _innerid,
                Rack: $('#txtRack' + _innerid).val(),
                Row: $('#txtRow' + _innerid).val(),
                Position: $('#txtPosition' + _innerid).val()
            });
        }
    });

    var det = {
        ItemId: window.location.href.split('=')[1],
        ItemType: $('#ddlItemType').val(),
        ItemCode: $('#txtItemCode').val(),
        ItemName: $('#txtItemName').val(),
        Description: $('#txtDescription').val(),
        SkuCode: $('#txtSkuCode').val(),
        HsnCode: $('#txtHsnCode').val(),
        BarcodeType: $('#ddlBarcodeType').val(),
        UnitId: $('#ddlUnit').val(),
        SecondaryUnitId: $('#ddlSecondaryUnit').val(),
        UToSValue: $('#txtUToSValue').val(),
        TertiaryUnitId: $('#ddlTertiaryUnit').val(),
        SToTValue: $('#txtSToTValue').val(),
        QuaternaryUnitId: $('#ddlQuaternaryUnit').val(),
        TToQValue: $('#txtTToQValue').val(),
        BrandId: $('#ddlBrand').val(),
        CategoryId: $('#ddlCategory').val(),
        SubCategoryId: $('#ddlSubCategory').val(),
        SubSubCategoryId: $('#ddlSubSubCategory').val(),
        IsManageStock: $('#chkIsManageStock').is(':checked'),
        AlertQuantity: $('#txtAlertQuantity').val(),
        ProductImage: ProductImage,
        FileExtensionProductImage: fileExtensionProductImage,
        ProductBrochure: ProductBrochure,
        FileExtensionProductBrochure: fileExtensionProductBrochure,
        TaxId: $('#ddlTax').val() == null ? 0 : $('#ddlTax').val().split('-')[0],
        InterStateTaxId: $('#ddlInterStateTax').val() == null ? 0 : $('#ddlInterStateTax').val().split('-')[0],
        TaxType: $('#ddlTaxType').val(),
        ProductType: $('#ddlProductType').val(),
        ManufacturingDate: $('#txtManufacturingDate').val(),
        ExpiryPeriod: $('#txtExpiryPeriod').val(),
        ExpiryPeriodType: $('#ddlExpiryPeriodType').val(),
        PackagingCharge: $('#txtPackagingCharge').val(),
        IsActive: true,
        IsDeleted: false,
        ItemDetails: ItemDetails,
        Branchs: $('#ddlBranch').val() == null ? [] : $('#ddlBranch').val(),
        WarrantyId: $('#ddlWarranty').val(),
        ItemBranchMaps: ItemBranchMaps,
        PriceAddedFor: $('#ddlPriceAddedFor').val(),
        EnableImei: $('#chkEnableImei').is(':checked'),
        ItemCodeId: $('#ddlItemCode').val(),
        TaxPreference: $("#ddlTaxPreference option:selected").text(),
        TaxPreferenceId: $('#ddlTaxPreference').val(),
        TaxExemptionId: $('#ddlTaxExemption').val(),
        SaltId: $('#ddlSalt').val(),
    };
    $("#divLoading").show();
    $.ajax({
        url: '/items/itemsInsert',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {

            $("#divLoading").hide();
            if (data == "True") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }
            else if (data == "False") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }

            if (data.Status == 0) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error(data.Message);
            }
            else if (data.Status == 2) {
                if (EnableSound == 'True') { document.getElementById('error').play(); } toastr.error('Invalid inputs, check and try again !!');
                data.Errors.forEach(function (res) {
                    $('#' + res.Id).show();
                    $('#' + res.Id).text(res.Message);


                    if ($('.' + res.Id + '_ctrl').children("select").length > 0) {
                        var element = $("." + res.Id + '_ctrl select');
                        if (element.hasClass("select2-hidden-accessible")) {
                            $('.' + res.Id + '_ctrl .select2-container .select2-selection').css('border', '2px solid #dc3545');
                        } else {
                            $('.' + res.Id + '_ctrl select').css('border', '2px solid #dc3545');
                        }
                    }
                    else {
                        $('.' + res.Id + '_ctrl').css('border', '2px solid #dc3545');
                    }
                });
                //$("html, body").animate({ scrollTop: 0 }, "slow");
            }
            else {
                if (isError == true) {
                    if (EnableSound == 'True') { document.getElementById('error').play(); }
                    return
                }
                sessionStorage.setItem('showMsg', '1');
                sessionStorage.setItem('Msg', data.Message);

                if ($('#chkIsManageStock').is(':checked') == true) {
                    sessionStorage.setItem('showOpeningStock', '1');
                    sessionStorage.setItem('ItemId', data.Data.Item.ItemId);
                }
                
                if (i == 1) {
                    window.location.href = "/items/items";
                }
                else {
                    window.location.href = "/items/itemsadd";
                }
            }

        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
};

function update(i) {
    $('.errorText').hide();
    $('[style*="border: 2px"]').css('border', '');


    //isError = false;
    //if (!$('#txtItemName').val()) {
    //    isError = true;
    //    $('#divItemName').show();
    //    $('#divItemName').text('This field is required');
    //}

    //if ($('#ddlItemType').val() == "Product") {
    //    if ($('#ddlUnit').val() == 0) {
    //        isError = true;
    //        $('#divUnit').show();
    //        $('#divUnit').text('This field is required');
    //    }
    //}

    //if ($('#ddlCategory').val() == 0) {
    //    isError = true;
    //    $('#divCategory').show();
    //    $('#divCategory').text('This field is required');
    //}

    //if ($("#ddlTaxPreference option:selected").text() == "Taxable") {
    //    if ($('#hdnCountryId').val() == 2) {
    //        if (!$('#ddlTax').val()) {
    //            isError = true;
    //            $('#divTax').show();
    //            $('#divTax').text('This field is required');
    //        }

    //        if (!$('#ddlInterStateTax').val()) {
    //            isError = true;
    //            $('#divInterStateTax').show();
    //            $('#divInterStateTax').text('This field is required');
    //        }
    //    }
    //    else {
    //        if (!$('#ddlTax').val()) {
    //            isError = true;
    //            $('#divTax').show();
    //            $('#divTax').text('This field is required');
    //        }
    //    }
    //}
    //else if ($("#ddlTaxPreference option:selected").text() == "Non-Taxable") {
    //    if (!$('#ddlTaxExemption').val()) {
    //        isError = true;
    //        $('#divTaxExemption').show();
    //        $('#divTaxExemption').text('This field is required');
    //    }
    //}

    //var IsPurchaseAddon = $('#hdnIsPurchaseAddon').val().toLocaleLowerCase();
    var ItemDetails = []; var ItemBranchMaps = [];
    if ($('#ddlProductType').val() == 'Single') {

        //if (IsPurchaseAddon == 'true') {
        //    if (!$('#txtPurchaseExcTax').val()) {
        //        isError = true;
        //        $('#divPurchaseExcTax').show();
        //        $('#divPurchaseExcTax').text('This field is required');
        //    }

        //    //if (!$('#txtPurchaseIncTax').val()) {
        //    //    isError = true;
        //    //    $('#divPurchaseIncTax').show();
        //    //    $('#divPurchaseIncTax').text('This field is required');
        //    //}

        //    if (!$('#txtDefaultProfitMargin').val()) {
        //        isError = true;
        //        $('#divDefaultProfitMargin').show();
        //        $('#divDefaultProfitMargin').text('This field is required');
        //    }
        //}

        //if (!$('#txtSalesExcTax').val()) {
        //    isError = true;
        //    $('#divSalesExcTax').show();
        //    $('#divSalesExcTax').text('This field is required');
        //}

        ////if (!$('#txtSalesIncTax').val()) {
        ////    isError = true;
        ////    $('#divSalesIncTax').show();
        ////    $('#divSalesIncTax').text('This field is required');
        ////}

        ItemDetails.push({
            SKU: $('#txtSkuHsnCode').val(),
            PurchaseExcTax: $('#txtPurchaseExcTax').val(),
            PurchaseIncTax: $('#txtPurchaseIncTax').val(),
            DefaultProfitMargin: $('#txtDefaultProfitMargin').val(),
            SalesExcTax: $('#txtSalesExcTax').val(),
            SalesIncTax: $('#txtSalesIncTax').val(),
            DefaultMrp: $('#txtDefaultMRP').val(),
            ProductImage: $('#txtHiddenFile0').val(),
            FileExtensionProductImage: $('#txtHiddenFileExtension0').val(),
            ItemDetailsId: $('#hdnItemDetailsId').val(),
            PurchaseAccountId: $('#ddlPurchaseAccount').val(),
            SalesAccountId: $('#ddlSalesAccount').val(),
            InventoryAccountId: $('#ddlInventoryAccount').val(),
        })
    }
    else if ($('#ddlProductType').val() == 'Variable') {
        if (isNewVariationBuilderEnabled) {
            var builderItemsForUpdate = collectVariantsFromGridForUpdate();
            if (builderItemsForUpdate.length === 0) {
                isError = true;
                $('#divAttributeSelections').show();
                $('#divAttributeSelections').text('Add at least one variant');
            }
            ItemDetails = ItemDetails.concat(builderItemsForUpdate);
        } else {
        var variationDetails = [];
        $('#divVariation table').each(function () {
            var _id = this.id.split('product_variation_form_part')[1];
            if (_id != undefined) {
                $('#divInnerVariation' + _id + ' tr').each(function () {
                    var _innerid = this.id.split('product_variation_form_part_inner')[1];

                    //if (!$('#ddlVariation' + _id).val() || $('#ddlVariation' + _id).val() == 0) {
                    //    isError = true;
                    //    $('#divVariation' + _id).show();
                    //    $('#divVariation' + _id).text('This field is required');
                    //}

                    //if (IsPurchaseAddon == 'true') {
                    //    if (!$('#txtPurchaseExcTax' + _innerid).val()) {
                    //        isError = true;
                    //        $('#divPurchaseExcTax' + _innerid).show();
                    //        $('#divPurchaseExcTax' + _innerid).text('This field is required');
                    //    }

                    //    //if (!$('#txtPurchaseIncTax' + _innerid).val()) {
                    //    //    isError = true;
                    //    //    $('#divPurchaseIncTax' + _innerid).show();
                    //    //    $('#divPurchaseIncTax' + _innerid).text('This field is required');
                    //    //}

                    //    if (!$('#txtDefaultProfitMargin' + _innerid).val()) {
                    //        isError = true;
                    //        $('#divDefaultProfitMargin' + _innerid).show();
                    //        $('#divDefaultProfitMargin' + _innerid).text('This field is required');
                    //    }
                    //}

                    //if (!$('#txtSalesExcTax' + _innerid).val() && !$('#txtSalesIncTax' + _innerid).val()) {
                    //    isError = true;
                    //    $('#divSalesTax' + _innerid).show();
                    //    $('#divSalesTax' + _innerid).text('This field is required');
                    //}

                    //if (!$('#txtValue' + _innerid).val()) {
                    //    isError = true;
                    //    $('#divValue' + _innerid).show();
                    //    $('#divValue' + _innerid).text('This field is required');
                    //}

                    ItemDetails.push({
                        SKU: $('#txtSku' + _innerid).val(),
                        VariationId: $('#ddlVariation' + _id).val(),
                        VariationDetailsId: $('#hdnValue' + _innerid).val(),
                        PurchaseExcTax: $('#txtPurchaseExcTax' + _innerid).val(),
                        PurchaseIncTax: $('#txtPurchaseIncTax' + _innerid).val(),
                        DefaultProfitMargin: $('#txtDefaultProfitMargin' + _innerid).val(),
                        SalesExcTax: $('#txtSalesExcTax' + _innerid).val(),
                        SalesIncTax: $('#txtSalesIncTax' + _innerid).val(),
                        DefaultMrp: $('#txtDefaultMrp' + _innerid).val(),
                        ProductImage: $('#txtHiddenFile' + _innerid).val(),
                        FileExtensionProductImage: $('#txtHiddenFileExtension' + _innerid).val(),
                        ItemDetailsId: $('#hdnItemDetailsId' + _innerid).val(),
                        VariationName: $('#txtValue' + _innerid).val(),
                        DivId: _innerid,
                        PurchaseAccountId: $('#ddlPurchaseAccount' + _innerid).val(),
                        SalesAccountId: $('#ddlSalesAccount' + _innerid).val(),
                        InventoryAccountId: $('#ddlInventoryAccount' + _innerid).val(),
                        IsDeleted: $("#product_variation_form_part_inner" + _innerid).is(":hidden")
                    })
                });
            }
        });
        }
    }
    else if ($('#ddlProductType').val() == 'Combo') {
        var variationDetails = [];
        $('#divCombo tr').each(function () {
            var _id = this.id.split('divCombo')[1];
            if (_id != undefined) {

                //if (!$('#txtComboQuantity' + _id).val() || $('#txtComboQuantity' + _id).val() <= 0) {
                //    isError = true;
                //    $('#divComboQuantity' + _id).show();
                //    $('#divComboQuantity' + _id).text('Quantity is required');
                //}

                ItemDetails.push({
                    ItemDetailsId: $('#hdnItemDetailsId' + _id).val(),
                    ComboItemDetailsId: $('#hdnComboItemDetailsId' + _id).val(),
                    Quantity: $('#txtComboQuantity' + _id).val(),
                    TotalCost: $('#hdnComboTotalAmount' + _id).val(),
                    DefaultProfitMargin: $('#txtComboDefaultMargin').val(),
                    SalesExcTax: $('#txtComboSalesExcTax').val(),
                    SalesIncTax: $('#txtComboSalesIncTax').val(),
                    IsDeleted: $("#divCombo" + _id).is(":hidden"),
                    PriceAddedFor: $("#ddlComboUnit" + _id).val().split('-')[1],
                    DefaultMrp: $('#txtComboDefaultMrp').val(),
                    SalesAccountId: $('#ddlComboSalesAccount').val(),
                })
            }
        });

        //if (ItemDetails.length == 0) {
        //    isError = true;
        //    $('#divtags').show();
        //    $('#divtags').text('Search Item first');
        //}
    }

    //if (isError == true) {
    //    if (EnableSound == 'True') { document.getElementById('error').play(); }
    //    toastr.error('Invalid inputs, check and try again !!');
    //    return;
    //}

    $('.divBranch').each(function () {
        var _innerid = this.id.split('tr')[1];
        if ($('#chkBranch' + _innerid).is(':checked')) {
            ItemBranchMaps.push({
                BranchId: _innerid,
                Rack: $('#txtRack' + _innerid).val(),
                Row: $('#txtRow' + _innerid).val(),
                Position: $('#txtPosition' + _innerid).val()
            });
        }
    });

    var det = {
        ItemId: window.location.href.split('=')[1],
        ItemType: $('#ddlItemType').val(),
        ItemCode: $('#txtItemCode').val(),
        ItemName: $('#txtItemName').val(),
        Description: $('#txtDescription').val(),
        //SkuCode: $('#txtSkuCode').val(),
        HsnCode: $('#txtHsnCode').val(),
        BarcodeType: $('#ddlBarcodeType').val(),
        UnitId: $('#ddlUnit').val(),
        SecondaryUnitId: $('#ddlSecondaryUnit').val(),
        UToSValue: $('#txtUToSValue').val(),
        TertiaryUnitId: $('#ddlTertiaryUnit').val(),
        SToTValue: $('#txtSToTValue').val(),
        QuaternaryUnitId: $('#ddlQuaternaryUnit').val(),
        TToQValue: $('#txtTToQValue').val(),
        BrandId: $('#ddlBrand').val(),
        CategoryId: $('#ddlCategory').val(),
        SubCategoryId: $('#ddlSubCategory').val(),
        SubSubCategoryId: $('#ddlSubSubCategory').val(),
        IsManageStock: $('#chkIsManageStock').is(':checked'),
        AlertQuantity: $('#txtAlertQuantity').val(),
        ProductImage: ProductImage,
        FileExtensionProductImage: fileExtensionProductImage,
        ProductBrochure: ProductBrochure,
        FileExtensionProductBrochure: fileExtensionProductBrochure,
        TaxId: $('#ddlTax').val() == null ? 0 : $('#ddlTax').val().split('-')[0],
        InterStateTaxId: $('#ddlInterStateTax').val() == null ? 0 : $('#ddlInterStateTax').val().split('-')[0],
        TaxType: $('#ddlTaxType').val(),
        ProductType: $('#ddlProductType').val(),
        ManufacturingDate: $('#txtManufacturingDate').val(),
        ExpiryPeriod: $('#txtExpiryPeriod').val(),
        ExpiryPeriodType: $('#ddlExpiryPeriodType').val(),
        PackagingCharge: $('#txtPackagingCharge').val(),
        IsActive: true,
        IsDeleted: false,
        ItemDetails: ItemDetails,
        Branchs: $('#ddlBranch').val() == null ? [] : $('#ddlBranch').val(),
        WarrantyId: $('#ddlWarranty').val(),
        ItemBranchMaps: ItemBranchMaps,
        PriceAddedFor: $('#ddlPriceAddedFor').val(),
        EnableImei: $('#chkEnableImei').is(':checked'),
        ItemCodeId: $('#ddlItemCode').val(),
        TaxPreference: $("#ddlTaxPreference option:selected").text(),
        TaxPreferenceId: $('#ddlTaxPreference').val(),
        TaxExemptionId: $('#ddlTaxExemption').val(),
        TaxExemptionId: $('#ddlTaxExemption').val(),
        SaltId: $('#ddlSalt').val(),
    };

    $("#divLoading").show();
    $.ajax({
        url: '/items/itemsUpdate',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {

            $("#divLoading").hide();
            if (data == "True") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }
            else if (data == "False") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }

            if (data.Status == 0) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error(data.Message);
            }
            else if (data.Status == 2) {
                if (EnableSound == 'True') { document.getElementById('error').play(); } toastr.error('Invalid inputs, check and try again !!');
                data.Errors.forEach(function (res) {
                    $('#' + res.Id).show();
                    $('#' + res.Id).text(res.Message);


                    if ($('.' + res.Id + '_ctrl').children("select").length > 0) {
                        var element = $("." + res.Id + '_ctrl select');
                        if (element.hasClass("select2-hidden-accessible")) {
                            $('.' + res.Id + '_ctrl .select2-container .select2-selection').css('border', '2px solid #dc3545');
                        } else {
                            $('.' + res.Id + '_ctrl select').css('border', '2px solid #dc3545');
                        }
                    }
                    else {
                        $('.' + res.Id + '_ctrl').css('border', '2px solid #dc3545');
                    }
                });
                //$("html, body").animate({ scrollTop: 0 }, "slow");
            }
            else {
                if (isError == true) {
                    if (EnableSound == 'True') { document.getElementById('error').play(); }
                    return
                }

                sessionStorage.setItem('showMsg', '1');
                sessionStorage.setItem('Msg', data.Message);

                //sessionStorage.setItem('showOpeningStock', '1');
                //sessionStorage.setItem('ItemId', det.ItemId);
                if (i == 1) {
                    window.location.href = "/items/items";
                }
                else {
                    window.location.href = "/items/itemsadd";
                }
            }
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
};

function ActiveInactive(ItemId, IsActive) {
    var det = {
        ItemId: ItemId,
        IsActive: IsActive
    };
    $("#divLoading").show();
    $.ajax({
        url: '/items/itemsActiveInactive',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {

            $("#divLoading").hide();
            if (data == "True") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                fetchList(_PageIndex);
                return
            }
            else if (data == "False") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                fetchList(_PageIndex);
                return
            }

            if (data.Status == 0) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error(data.Message);
            }
            else {
                if (EnableSound == 'True') { document.getElementById('success').play(); }
                toastr.success(data.Message);
                fetchList();
            }
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
};

function Delete(ItemId, ItemName) {
    var r = confirm("This will delete \"" + ItemName + "\" permanently. This process cannot be undone. Are you sure you want to continue?");
    if (r == true) {
        var det = {
            ItemId: ItemId,
        };
        $("#divLoading").show();
        $.ajax({
            url: '/items/itemsdelete',
            datatype: "json",
            data: det,
            type: "post",
            success: function (data) {

                $("#divLoading").hide();
                if (data == "True") {
                    $('#subscriptionExpiryModal').modal('toggle');
                    $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                    $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                    return
                }
                else if (data == "False") {
                    $('#subscriptionExpiryModal').modal('toggle');
                    $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                    $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                    return
                }

                if (data.Status == 0) {
                    if (EnableSound == 'True') { document.getElementById('error').play(); }
                    toastr.error(data.Message);
                }
                else {
                    if (EnableSound == 'True') { document.getElementById('success').play(); }
                    toastr.success(data.Message);
                    fetchList();
                }
            },
            error: function (xhr) {
                $("#divLoading").hide();
            }
        });
    }
};

function fetchActiveSubCategories() {
    var det = {
        CategoryId: $('#ddlCategory').val()
    };
    _PageIndex = det.PageIndex;
    $("#divLoading").show();
    $.ajax({
        url: '/itemsettings/ActiveSubCategories',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {
            $("#divLoading").hide();
            $("#p_SubCategories_Dropdown").html(data);

            //if (window.location.href.toLowerCase().indexOf('itemsedit') == -1 && window.location.href.toLowerCase().indexOf('itemsduplicate') == -1
            //    && window.location.href.toLowerCase().indexOf('itemsadd') == -1) {
            //    $('.hideButton').hide();
            //    $('.select2').css('width', '100%');
            //}
            initializeSelect2InScope('#p_SubCategories_Dropdown');
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
};

function fetchActiveSubSubCategories() {
    var det = {
        SubCategoryId: $('#ddlSubCategory').val()
    };
    _PageIndex = det.PageIndex;
    $("#divLoading").show();
    $.ajax({
        url: '/itemsettings/ActiveSubSubCategories',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {
            $("#divLoading").hide();
            $("#p_SubSubCategories_Dropdown").html(data);

            //if (window.location.href.toLowerCase().indexOf('itemsedit') == -1 && window.location.href.toLowerCase().indexOf('itemsduplicate') == -1
            //    && window.location.href.toLowerCase().indexOf('itemsadd') == -1) {
            //    $('.hideButton').hide();
            //    $('.select2').css('width', '100%');
            //}
            initializeSelect2InScope('#p_SubSubCategories_Dropdown');
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
}

function CheckManageStock() {
    if ($('#chkIsManageStock').is(":checked")) {
        $('#divAlertQuantity').show();
        $('#divExpiresIn').show();

        var IsPurchaseAddon = $('#hdnIsPurchaseAddon').val().toLocaleLowerCase();
        var IsAccountsAddon = $('#hdnIsAccountsAddon').val().toLocaleLowerCase();

        if (IsPurchaseAddon == 'true' && IsAccountsAddon == 'true') {
            $('.divInventoryAccount').show();
        }
        else {
            $('.divInventoryAccount').hide();
        }
    }
    else {
        $('#divAlertQuantity').hide();
        $('#divExpiresIn').hide();
        $('.divInventoryAccount').hide();
    }
}

function getProductImageBase64() {
    var file1 = $("#ProductImage").prop("files")[0];

    // The size of the file. 
    if (file1.size >= 2097152) {
        if (EnableSound == 'True') { document.getElementById('error').play(); }
        toastr.error('File too Big, please select a file less than 2mb');
        $("#ProductImage").val('');
        return false;
    }
    else {
        var reader = new FileReader();
        reader.readAsDataURL(file1);
        reader.onload = function () {
            ProductImage = reader.result;
            fileExtensionProductImage = '.' + file1.name.split('.').pop();

            $('#blahProductImage').attr('src', reader.result);
        };
        reader.onerror = function (error) {
            console.log(error);
            ProductImage = error;
        };
    }
}

function getProductBrochureBase64() {
    var file1 = $("#ProductBrochure").prop("files")[0];

    // The size of the file. 
    if (file1.size >= 2097152) {
        if (EnableSound == 'True') { document.getElementById('error').play(); }
        toastr.error('File too Big, please select a file less than 2mb');
        $("#ProductBrochure").val('');
        return false;
    }
    else {
        var reader = new FileReader();
        reader.readAsDataURL(file1);
        reader.onload = function () {
            ProductBrochure = reader.result;
            fileExtensionProductBrochure = '.' + file1.name.split('.').pop();

            $('#blahProductBrochure').attr('src', reader.result);
        };
        reader.onerror = function (error) {
            console.log(error);
            ProductBrochure = error;
        };
    }
}

function getImageBase64(id) {
    var file1 = $("#ProductImage" + id).prop("files")[0];

    // The size of the file. 
    if (file1.size >= 2097152) {
        if (EnableSound == 'True') { document.getElementById('error').play(); }
        toastr.error('File too Big, please select a file less than 2mb');
        $("#ProductImage" + 0).val('');
        return false;
    }
    else {
        var reader = new FileReader();
        reader.readAsDataURL(file1);
        reader.onload = function () {
            $('#txtHiddenFile' + id).val(reader.result);
            $('#txtHiddenFileExtension' + id).val('.' + file1.name.split('.').pop());

            $('#blahProductImage' + id).attr('src', reader.result);
        };
        reader.onerror = function (error) {
            console.log(error);
            ProductImage = error;
        };
    }
}

function checkTaxType() {
    if ($('#ddlTaxType').val() == 'Inclusive') {
        $('.divSellingPriceExcTax').hide();
        $('.divSellingPriceIncTax').show();
        $('.lblTaxName').text('(Inc. Tax)');
    }
    else {
        $('.divSellingPriceExcTax').show();
        $('.divSellingPriceIncTax').hide();
        $('.lblTaxName').text('(Exc. Tax)');
    }

    if ($('#ddlProductType').val() == 'Single') {
        UpdateSingleAmount('PExc');
    }
    else if ($('#ddlProductType').val() == 'Variable') {
        UpdateVariationAmount(1);
    }
}

function AddNewVariation() {
    var incomeAccountSubTypes = '', expenseAccountSubTypes = '', inventoryAccountSubTypes = '';
    for (let i = 0; i < accountSubTypes.length; i++) {
        if (accountSubTypes[i].Accounts.length > 0) {
            if (accountSubTypes[i].AccountType == "Income") {
                incomeAccountSubTypes = incomeAccountSubTypes + '<optgroup label="' + accountSubTypes[i].DisplayAs + '">';
                for (let j = 0; j < accountSubTypes[i].Accounts.length; j++) {
                    if (accountSubTypes[i].Accounts[j].Type == "Sales") {
                        incomeAccountSubTypes = incomeAccountSubTypes + '<option value="' + accountSubTypes[i].Accounts[j].AccountId + '" selected>' + accountSubTypes[i].Accounts[j].AccountName + '</option>';
                    }
                    else {
                        incomeAccountSubTypes = incomeAccountSubTypes + '<option value="' + accountSubTypes[i].Accounts[j].AccountId + '">' + accountSubTypes[i].Accounts[j].AccountName + '</option>';
                    }
                }
                '</optgroup>';
            }
            else if (accountSubTypes[i].AccountType == "Expense") {
                expenseAccountSubTypes = expenseAccountSubTypes + '<optgroup label="' + accountSubTypes[i].DisplayAs + '">';
                for (let j = 0; j < accountSubTypes[i].Accounts.length; j++) {
                    if (accountSubTypes[i].Accounts[j].Type == "Cost of Goods Sold") {
                        expenseAccountSubTypes = expenseAccountSubTypes + '<option value="' + accountSubTypes[i].Accounts[j].AccountId + '" selected>' + accountSubTypes[i].Accounts[j].AccountName + '</option>';
                    }
                    else {
                        expenseAccountSubTypes = expenseAccountSubTypes + '<option value="' + accountSubTypes[i].Accounts[j].AccountId + '">' + accountSubTypes[i].Accounts[j].AccountName + '</option>';
                    }
                }
                '</optgroup>';
            }
            else if (accountSubTypes[i].Type == "Stock") {
                inventoryAccountSubTypes = inventoryAccountSubTypes + '<optgroup label="' + accountSubTypes[i].DisplayAs + '">';
                for (let j = 0; j < accountSubTypes[i].Accounts.length; j++) {
                    if (accountSubTypes[i].Accounts[j].Type == "Inventory Asset") {
                        inventoryAccountSubTypes = inventoryAccountSubTypes + '<option value="' + accountSubTypes[i].Accounts[j].AccountId + '" selected>' + accountSubTypes[i].Accounts[j].AccountName + '</option>';
                    }
                    else {
                        inventoryAccountSubTypes = inventoryAccountSubTypes + '<option value="' + accountSubTypes[i].Accounts[j].AccountId + '">' + accountSubTypes[i].Accounts[j].AccountName + '</option>';
                    }

                }
                '</optgroup>';
            }
        }
    }

    var IsPurchaseAddon = $('#hdnIsPurchaseAddon').val().toLocaleLowerCase();
    var IsAccountsAddon = $('#hdnIsAccountsAddon').val().toLocaleLowerCase();
    var EnableMrp = $('#hdnEnableMrp').val().toLocaleLowerCase();

    var VariationPermissionIsAdd = $('#hdnVariationPermissionIsAdd').val().toLocaleLowerCase();
    var html = '<table class="table table-bordered add-product-price-table table-condensed" id="product_variation_form_part' + count + '">' +
        '<thead>' +
        '<tr>' +
        '<th class="col-12 col-sm-6 col-md-4 col-lg-3 col-xl-2">Variation</th>' +
        '<th class="col-sm-10">Variation Values <button type="button" class="btn btn-danger btn-sm float-right" onclick="deleteVariable(' + count + ')"><i class="fas fa-times"></i></button></th>' +
        '</tr>' +
        '</thead>' +
        '<tbody>' +
        '<tr class="variation_row">' +
        '<td style="min-width:150px" class="divVariation' + count + '_ctrl">' +
        '<select onchange="FetchVariationDetails(' + count + ')" id="ddlVariation' + count + '" class="form-control input-sm variation_template valid select2" required="" name="product_variation[0][variation_template_id]" aria-required="true" aria-invalid="false">' +
        /*'<option value="0">Select</option>' +*/
        dropdownHtml +
        '</select><a href="javascript:void(0)" class="btn-xs ml-2 text-decoration-none float-right font-weight-bold ' + (VariationPermissionIsAdd == 'true' ? '' : 'hidden') + '" onclick="openVariationModal(' + count + ')"><i class="fas fa-plus"></i> Add New</a>' +
        '<small class="text-red font-weight-bold errorText" id="divVariation' + count + '"></small>' +
        '</td>' +
        '<td>' +
        '<table class="table table-bordered table-striped blue-header variation_value_table">' +
        '<thead>' +
        '<tr>' +
        '<th class="divInventoryAccount service" ' + ((IsPurchaseAddon == 'true' && IsAccountsAddon == 'true') ? '' : 'hidden') + '>Inventory Account </th>' +
        '<th>SKU <span class="danger">*</span> <i tabindex="0" class="fa fa-info-circle text-info hover-q no-print" ' + (ShowHelpText == "True" ? "" : "hidden") + ' role="button" data-toggle="popover" data-trigger="focus" title="" data-content="Leave blank to auto generate"></i></th>' +
        '<th>Value <span class="danger">*</span></th>' +
        '<th class="" ' + (IsPurchaseAddon == 'true' ? '' : 'hidden') + '>' +
        'Purchase Price <span class="danger">*</span><br /> <small class="lblTaxName"></small>' +
        '</th>' +
        '<th class="" ' + (IsAccountsAddon == 'true' ? '' : 'hidden') + '>' +
        'Purchase Account' +
        '</th>' +
        '<th class="" ' + (IsPurchaseAddon == 'true' ? '' : 'hidden') + '> Profit Margin(%)</th>' +
        '<th class="">' +
        'Selling Price <span class="danger">*</span><br /> <small class="lblTaxName"></small>' +
        '</th>' +
        '<th class="" ' + (IsAccountsAddon == 'true' ? '' : 'hidden') + '>' +
        'Sales Account<br>' +
        '</th>' +
        '<th class="" ' + (EnableMrp == 'true' ? '' : 'hidden') + '> MRP </th>' +
        '<th> Variation Images</th>' +
        '<th> <button type="button" class="btn btn-success btn-sm" onclick="AddNewInnerVariation(' + count + ')"><i class="fas fa-plus"></i></button></th>' +
        '</tr>' +
        '</thead>' +
        '<tbody id="divInnerVariation' + count + '">' +
        //'<tr id="product_variation_form_part_inner' + innerCount + '">' +
        //'<td style="min-width:150px" class="divInventoryAccount ' + ((IsPurchaseAddon == 'true' && IsAccountsAddon == 'true') ? '' : 'hidden') + '">' +
        //'<div class="row">' +
        //'<div class="col-sm-12" >' +
        //'<div class="form-group">' +
        //'<div class="input-group">' +
        //'<select class="form-control select2" id="ddlInventoryAccount' + innerCount + '">' +
        //inventoryAccountSubTypes +
        //'</select>' +
        //'</div>' +
        //'</div>' +
        //'</div>' +
        //'</div>' +
        //'</td>' +
        //'<td style="min-width:150px">' +
        //'<input class="form-control input-sm input_sub_sku" name="product_variation[0][variations][0][sub_sku]" type="text" placeholder="" id="txtSku' + innerCount + '">' +
        //'<small class="text-red font-weight-bold errorText" id="divSku' + innerCount + '"></small>' +
        //'</td>' +
        //'<td style="min-width:150px">' +
        //'<input class="form-control input-sm variation_value_name" required="" name="product_variation" type="text" value="" id="txtValue' + innerCount + '" placeholder=""> ' +
        //'<input name="product_variation[0][variations][0][variation_value_id]" type="hidden" id="hdnValue' + innerCount + '" value="0">' +
        //'<small class="text-red font-weight-bold errorText" id="divValue' + innerCount + '"></small>' +
        //'</td>' +
        //'<td style="min-width:150px" class="' + (IsPurchaseAddon == 'true' ? '' : 'hidden') + '">' +
        //'<div class="row">' +
        //'<div class="col-12 ">' +
        //'<input class="form-control input-sm variable_dpp input_number" placeholder="" required="" name="product_variation" type="number" id="txtPurchaseExcTax' + innerCount + '" onchange="UpdateVariationAmount(1,' + innerCount + ')">' +
        //'<small class="text-red font-weight-bold errorText" id="divPurchaseExcTax' + innerCount + '"></small>' +
        //'</div>' +
        ////'<div class="col-6 ">' +
        ////'<input class="form-control input-sm variable_dpp_inc_tax input_number" placeholder="Inc. Tax" required="" name="product_variation" type="number" id="txtPurchaseIncTax' + innerCount + '" onchange="UpdateVariationAmount(2,' + innerCount + ')">' +
        ////'<small class="text-red font-weight-bold errorText" id="divPurchaseIncTax' + innerCount + '"></small>' +
        ////'</div>' +
        //'</div>' +
        //'</td >' +
        //'<td style="min-width:150px" class="' + (IsAccountsAddon == 'true' ? '' : 'hidden') + '">' +
        //'<div class="row">' +
        //'<div class="col-sm-12" >' +
        //'<div class="form-group">' +
        //'<div class="input-group">' +
        //'<select style="min-width:150px" class="form-control select2" id="ddlPurchaseAccount' + innerCount + '">' +
        //expenseAccountSubTypes +
        //'</select>' +
        //'</div>' +
        //'</div>' +
        //'</div>' +
        //'</div>' +
        //'</td >' +
        //'<td style="min-width:150px" class="' + (IsPurchaseAddon == 'true' ? '' : 'hidden') + '">' +
        //'<input class="form-control input-sm variable_profit_percent input_number" required="" name="product_variation" type="number" value="' + $('#hdnDefaultProfitMargin').val() + '" placeholder="" id="txtDefaultProfitMargin' + innerCount + '" onchange="UpdateVariationAmount(3,' + innerCount + ')">' +
        //'<small class="text-red font-weight-bold errorText" id="divDefaultProfitMargin' + innerCount + '"></small>' +
        //'</td>' +
        //'<td style="min-width:150px">' +
        //'<div class="row">' +
        //'<div class="col-12">' +
        //'<input class="form-control input-sm variable_dsp input_number" placeholder="" required="" name="product_variation" type="number" id="txtSalesExcTax' + innerCount + '" onchange="UpdateVariationAmount(4,' + innerCount + ')">' +
        //'<small class="text-red font-weight-bold errorText" id="divSalesTax' + innerCount + '"></small>' +
        //'</div>' +
        //'<div class="col-12">' +
        //'<input class="form-control input-sm variable_dsp input_number" placeholder="" required="" name="product_variation" type="number" id="txtSalesIncTax' + innerCount + '" onchange="UpdateVariationAmount(5,' + innerCount + ')">' +
        //'<small class="text-red font-weight-bold errorText" id="divSalesTax' + innerCount + '"></small>' +
        //'</div>' +
        //'</td>' +
        //'<td style="min-width:200px" class="' + (IsAccountsAddon == 'true' ? '' : 'hidden') + '">' +
        //'<div class="row">' +
        //'<div class="col-sm-12" >' +
        //'<div class="form-group" id="divFTAccount">' +
        //'<div class="input-group">' +
        //'<select style="min-width:50px" class="form-control select2" id="ddlSalesAccount' + innerCount + '">' +
        //incomeAccountSubTypes +
        //'</select>' +
        //'</div>' +
        //'</div>' +
        //'</div>' +
        //'</div>' +
        //'</td >' +
        //'<td style="min-width:200px" class="' + (EnableMrp == 'true' ? '' : 'hidden') + '">' +
        //'<input class="form-control input-sm variable_profit_percent input_number" required="" name="product_variation" type="number" placeholder="" id="txtDefaultMrp' + innerCount + '">' +
        //'<small class="text-red font-weight-bold errorText" id="divDefaultMrp' + innerCount + '"></small>' +
        //'</td>' +
        //'<td style="min-width:300px">' +
        //'<div class="custom-file">' +
        //'<input type="file" class="custom-file-input" id="ProductImage' + innerCount + '" accept=".png,.jpg,.jpeg" onchange="getImageBase64(' + innerCount + ')">' +
        //'<input type="hidden" id="txtHiddenFile' + innerCount + '">' +
        //'<input type="hidden" id="txtHiddenFileExtension' + innerCount + '">' +
        //'<label class="custom-file-label" for="ProductImage' + innerCount + '"> Choose file</label>' +
        //'</div></br>' +
        //'<img id="blahProductImage' + innerCount + '" alt="" height="60" style="padding-top:10px;">' +
        //'</td>' +
        //'<td >' +
        //'<button type="button" class="btn btn-danger btn-sm" onclick="deleteInnerVariable(' + innerCount + ')">' +
        //'<i class="fas fa-times">' +
        //'</i>' +
        //'</button>' +
        //'</td>' +
        //'</tr>' +
        '</tbody>' +
        '</table>' +
        '</td>' +
        '</tr>' +
        '</tbody>' +
        '</table>';
    $('#divVariation').append(html);
    FetchVariationDetails(count);
    count++;
    innerCount++;
    //checkTaxType();

    initializeSelect2InScope('#divVariation');
    $("[data-toggle=popover]").popover({
        html: true,
        trigger: "hover",
        placement: 'auto',
    });
}

function AddNewInnerVariation(id) {
    var incomeAccountSubTypes = '', expenseAccountSubTypes = '', inventoryAccountSubTypes = '';
    for (let i = 0; i < accountSubTypes.length; i++) {
        if (accountSubTypes[i].Accounts.length > 0) {
            if (accountSubTypes[i].AccountType == "Income") {
                incomeAccountSubTypes = incomeAccountSubTypes + '<optgroup label="' + accountSubTypes[i].DisplayAs + '">';
                for (let j = 0; j < accountSubTypes[i].Accounts.length; j++) {
                    if (accountSubTypes[i].Accounts[j].Type == "Sales") {
                        incomeAccountSubTypes = incomeAccountSubTypes + '<option value="' + accountSubTypes[i].Accounts[j].AccountId + '" selected>' + accountSubTypes[i].Accounts[j].AccountName + '</option>';
                    }
                    else {
                        incomeAccountSubTypes = incomeAccountSubTypes + '<option value="' + accountSubTypes[i].Accounts[j].AccountId + '">' + accountSubTypes[i].Accounts[j].AccountName + '</option>';
                    }
                }
                '</optgroup>';
            }
            else if (accountSubTypes[i].AccountType == "Expense") {
                expenseAccountSubTypes = expenseAccountSubTypes + '<optgroup label="' + accountSubTypes[i].DisplayAs + '">';
                for (let j = 0; j < accountSubTypes[i].Accounts.length; j++) {
                    if (accountSubTypes[i].Accounts[j].Type == "Cost of Goods Sold") {
                        expenseAccountSubTypes = expenseAccountSubTypes + '<option value="' + accountSubTypes[i].Accounts[j].AccountId + '" selected>' + accountSubTypes[i].Accounts[j].AccountName + '</option>';
                    }
                    else {
                        expenseAccountSubTypes = expenseAccountSubTypes + '<option value="' + accountSubTypes[i].Accounts[j].AccountId + '">' + accountSubTypes[i].Accounts[j].AccountName + '</option>';
                    }

                }
                '</optgroup>';
            }
            else if (accountSubTypes[i].Type == "Stock") {
                inventoryAccountSubTypes = inventoryAccountSubTypes + '<optgroup label="' + accountSubTypes[i].DisplayAs + '">';
                for (let j = 0; j < accountSubTypes[i].Accounts.length; j++) {
                    if (accountSubTypes[i].Accounts[j].Type == "Inventory Asset") {
                        inventoryAccountSubTypes = inventoryAccountSubTypes + '<option value="' + accountSubTypes[i].Accounts[j].AccountId + '" selected>' + accountSubTypes[i].Accounts[j].AccountName + '</option>';
                    }
                    else {
                        inventoryAccountSubTypes = inventoryAccountSubTypes + '<option value="' + accountSubTypes[i].Accounts[j].AccountId + '">' + accountSubTypes[i].Accounts[j].AccountName + '</option>';
                    }

                }
                '</optgroup>';
            }
        }
    }

    var IsPurchaseAddon = $('#hdnIsPurchaseAddon').val().toLocaleLowerCase();
    var IsAccountsAddon = $('#hdnIsAccountsAddon').val().toLocaleLowerCase();
    var EnableMrp = $('#hdnEnableMrp').val().toLocaleLowerCase();

    var html = '<tr id="product_variation_form_part_inner' + innerCount + '">' +
        '<td style="min-width:150px" class="divInventoryAccount service" ' + ((IsPurchaseAddon == 'true' && IsAccountsAddon == 'true') ? '' : 'hidden') + '>' +
        '<div class="row">' +
        '<div class="col-sm-12">' +
        '<div class="form-group">' +
        '<div class="input-group">' +
        '<select class="form-control select2" id="ddlInventoryAccount' + innerCount + '">' +
        inventoryAccountSubTypes +
        '</select>' +
        '</div>' +
        '</div>' +
        '</div>' +
        '</div>' +
        '</td>' +
        '<td style="min-width:150px">' +
        '<input class="form-control input-sm input_sub_sku divSku' + innerCount + '_ctrl" name="product_variation[0][variations][0][sub_sku]" type="text" id="txtSku' + innerCount + '">' +
        '<small class="text-red font-weight-bold errorText" id="divSku' + innerCount + '"></small>' +
        '</td>' +
        '<td style="min-width:150px">' +
        '<input class="form-control input-sm variation_value_name divValue' + innerCount + '_ctrl" required="" name="product_variation" type="text" value="" id="txtValue' + innerCount + '"> ' +
        '<input name="product_variation[0][variations][0][variation_value_id]" type="hidden" id="hdnValue' + innerCount + '" value="0">' +
        '<small class="text-red font-weight-bold errorText" id="divValue' + innerCount + '"></small>' +
        '</td>' +
        '<td style="min-width:150px" class="" ' + (IsPurchaseAddon == 'true' ? '' : 'hidden') + '>' +
        '<div class="row">' +
        '<div class="col-12">' +
        '<input class="form-control input-sm variable_dpp input_number divPurchaseExcTax' + innerCount + '_ctrl" required="" name="product_variation" type="number" id="txtPurchaseExcTax' + innerCount + '" onchange="UpdateVariationAmount(1,' + innerCount + ')">' +
        '<small class="text-red font-weight-bold errorText" id="divPurchaseExcTax' + innerCount + '"></small>' +
        '</div>' +
        //'<div class="col-6 ">' +
        //'<input class="form-control input-sm variable_dpp_inc_tax input_number" required="" name="product_variation" type="number" id="txtPurchaseIncTax' + innerCount + '" onchange="UpdateVariationAmount(2,' + innerCount + ')">' +
        //'<small class="text-red font-weight-bold errorText" id="divPurchaseIncTax' + innerCount + '"></small>' +
        //'</div>' +
        '</div>' +
        '</td >' +
        '<td style="min-width:150px" class="" ' + (IsAccountsAddon == 'true' ? '' : 'hidden') + '>' +
        '<div class="row">' +
        '<div class="col-sm-12">' +
        '<div class="form-group">' +
        /*'<label> Purchase Account<span class="danger">*</span></label>' +*/
        '<div class="input-group">' +
        '<select class="form-control select2" id="ddlPurchaseAccount' + innerCount + '">' +
        expenseAccountSubTypes +
        '</select>' +
        '</div>' +
        '</div>' +
        '</div>' +
        '</div>' +
        '</td >' +
        '<td class="" ' + (IsPurchaseAddon == 'true' ? '' : 'hidden') + ' style="min-width:150px" >' +
        '<input class="form-control input-sm variable_profit_percent input_number divDefaultProfitMargin' + innerCount + '_ctrl" required="" name="product_variation" type="number" value="" id="txtDefaultProfitMargin' + innerCount + '" onchange="UpdateVariationAmount(3,' + innerCount + ')">' +
        '<small class="text-red font-weight-bold errorText" id="divDefaultProfitMargin' + innerCount + '"></small>' +
        '</td>' +
        '<td style="min-width:150px">' +
        '<div class="row">' +
        '<div class="col-12">' +
        '<input class="form-control input-sm variable_dsp input_number divSalesTax' + innerCount + '_ctrl" required="" name="product_variation" type="number" id="txtSalesExcTax' + innerCount + '" onchange="UpdateVariationAmount(4,' + innerCount + ')">' +
        '<small class="text-red font-weight-bold errorText" id="divSalesTax' + innerCount + '"></small>' +
        '</div>' +
        //'<div class="col-12 divSellingPriceIncTax">' +
        //'<input class="form-control input-sm variable_dsp input_number divSellingPriceIncTax" required="" name="product_variation" type="number" id="txtSalesIncTax' + innerCount + '" onchange="UpdateVariationAmount(5,' + innerCount + ')">' +
        //'<small class="text-red font-weight-bold errorText" id="divSalesTax' + innerCount + '"></small>' +
        //'</div>' +
        '</div>' +
        '</td>' +
        '<td style="min-width:150px" ' + (IsAccountsAddon == 'true' ? '' : 'hidden') + '>' +
        '<div class="row">' +
        '<div class="col-sm-12">' +
        '<div class="form-group" id="divFTAccount">' +
        /*'<label> Sales Account<span class="danger">*</span></label>' +*/
        '<div class="input-group">' +
        '<select class="form-control select2" id="ddlSalesAccount' + innerCount + '">' +
        incomeAccountSubTypes +
        '</select>' +
        '</div>' +
        '</div>' +
        '</div>' +
        '</div>' +
        '</td>' +
        '<td style="min-width:150px" class="" ' + (EnableMrp == 'true' ? '' : 'hidden') + '>' +
        '<input class="form-control input-sm variable_profit_percent input_number" required="" name="product_variation" type="number" placeholder="" id="txtDefaultMrp' + innerCount + '">' +
        '<small class="text-red font-weight-bold errorText" id="divDefaultMrp' + innerCount + '"></small>' +
        '</td>' +
        '<td style="min-width:200px">' +
        '<div class="custom-file">' +
        '<input type="file" class="custom-file-input" id="ProductImage' + innerCount + '" accept=".png,.jpg,.jpeg" onchange="getImageBase64(' + innerCount + ')">' +
        '<input type="hidden" id="txtHiddenFile' + innerCount + '">' +
        '<input type="hidden" id="txtHiddenFileExtension' + innerCount + '">' +
        '<label class="custom-file-label" for="ProductImage' + innerCount + '"> Choose file</label>' +
        '</div></br>' +
        '<img id="blahProductImage' + innerCount + '" alt="" height="60" style="padding-top:10px;">' +
        '</td>' +
        '<td>' +
        '<button type="button" class="btn btn-danger btn-sm" onclick="deleteInnerVariable(' + innerCount + ')">' +
        '<i class="fas fa-times">' +
        '</i>' +
        '</button>' +
        '</td>' +
        '</tr>';
    $('#divInnerVariation' + id).append(html);
    innerCount++;
    //checkTaxType();
    checkItemType();
    initializeSelect2InScope('#divInnerVariation' + id);
}

function FetchVariationDetails(id) {
    var det = {
        VariationId: $('#ddlVariation' + id).val()
    };
    _PageIndex = det.PageIndex;
    $("#divLoading").show();
    $.ajax({
        url: '/itemsettings/ActiveVariationDetails',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {
            $("#divLoading").hide();
            $('#divInnerVariation' + id).empty();

            var incomeAccountSubTypes = '', expenseAccountSubTypes = '', inventoryAccountSubTypes = '';
            for (let i = 0; i < accountSubTypes.length; i++) {
                if (accountSubTypes[i].Accounts.length > 0) {
                    if (accountSubTypes[i].AccountType == "Income") {
                        incomeAccountSubTypes = incomeAccountSubTypes + '<optgroup label="' + accountSubTypes[i].DisplayAs + '">';
                        for (let j = 0; j < accountSubTypes[i].Accounts.length; j++) {
                            if (accountSubTypes[i].Accounts[j].Type == "Sales") {
                                incomeAccountSubTypes = incomeAccountSubTypes + '<option value="' + accountSubTypes[i].Accounts[j].AccountId + '" selected>' + accountSubTypes[i].Accounts[j].AccountName + '</option>';
                            }
                            else {
                                incomeAccountSubTypes = incomeAccountSubTypes + '<option value="' + accountSubTypes[i].Accounts[j].AccountId + '">' + accountSubTypes[i].Accounts[j].AccountName + '</option>';
                            }
                        }
                        '</optgroup>';
                    }
                    else if (accountSubTypes[i].AccountType == "Expense") {
                        expenseAccountSubTypes = expenseAccountSubTypes + '<optgroup label="' + accountSubTypes[i].DisplayAs + '">';
                        for (let j = 0; j < accountSubTypes[i].Accounts.length; j++) {
                            if (accountSubTypes[i].Accounts[j].Type == "Cost of Goods Sold") {
                                expenseAccountSubTypes = expenseAccountSubTypes + '<option value="' + accountSubTypes[i].Accounts[j].AccountId + '" selected>' + accountSubTypes[i].Accounts[j].AccountName + '</option>';
                            }
                            else {
                                expenseAccountSubTypes = expenseAccountSubTypes + '<option value="' + accountSubTypes[i].Accounts[j].AccountId + '">' + accountSubTypes[i].Accounts[j].AccountName + '</option>';
                            }

                        }
                        '</optgroup>';
                    }
                    else if (accountSubTypes[i].Type == "Stock") {
                        inventoryAccountSubTypes = inventoryAccountSubTypes + '<optgroup label="' + accountSubTypes[i].DisplayAs + '">';
                        for (let j = 0; j < accountSubTypes[i].Accounts.length; j++) {
                            if (accountSubTypes[i].Accounts[j].Type == "Inventory Asset") {
                                inventoryAccountSubTypes = inventoryAccountSubTypes + '<option value="' + accountSubTypes[i].Accounts[j].AccountId + '" selected>' + accountSubTypes[i].Accounts[j].AccountName + '</option>';
                            }
                            else {
                                inventoryAccountSubTypes = inventoryAccountSubTypes + '<option value="' + accountSubTypes[i].Accounts[j].AccountId + '">' + accountSubTypes[i].Accounts[j].AccountName + '</option>';
                            }
                        }
                        '</optgroup>';
                    }
                }
            }

            var IsPurchaseAddon = $('#hdnIsPurchaseAddon').val().toLocaleLowerCase();
            var IsAccountsAddon = $('#hdnIsAccountsAddon').val().toLocaleLowerCase();
            var EnableMrp = $('#hdnEnableMrp').val().toLocaleLowerCase();

            var html = '';
            for (let i = 0; i < data.Data.VariationDetails.length; i++) {
                html = html + '<tr id="product_variation_form_part_inner' + innerCount + '">' +
                    '<td style="min-width:150px" class="divInventoryAccount service" ' + ((IsPurchaseAddon == 'true' && IsAccountsAddon == 'true') ? '' : 'hidden') + '>' +
                    '<div class="row">' +
                    '<div class="col-sm-12" >' +
                    '<div class="form-group">' +
                    '<div class="input-group">' +
                    '<select class="form-control select2" id="ddlInventoryAccount' + innerCount + '">' +
                    inventoryAccountSubTypes +
                    '</select>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</td>' +
                    '<td style="min-width:150px">' +
                    '<input class="form-control input-sm input_sub_sku divSku' + innerCount + '_ctrl" name="product_variation[0][variations][0][sub_sku]" type="text" id="txtSku' + innerCount + '">' +
                    '<small class="text-red font-weight-bold errorText" id="divSku' + innerCount + '"></small>' +
                    '</td>' +
                    '<td style="min-width:150px">' +
                    '<input class="form-control input-sm variation_value_name divValue' + innerCount + '_ctrl" required="" disabled name="product_variation" type="text" id="txtValue' + innerCount + '" value="' + data.Data.VariationDetails[i].VariationDetails + '">' +
                    '<input name="product_variation[0][variations][0][variation_value_id]" type="hidden" id="hdnValue' + innerCount + '" value="' + data.Data.VariationDetails[i].VariationDetailsId + '">' +
                    '<small class="text-red font-weight-bold errorText" id="divValue' + innerCount + '"></small>' +
                    '</td>' +
                    '<td style="min-width:150px" class="" ' + (IsPurchaseAddon == 'true' ? '' : 'hidden') + '>' +
                    '<div class="row">' +
                    '<div class="col-12 ">' +
                    '<input class="form-control input-sm variable_dpp input_number divPurchaseExcTax' + innerCount + '_ctrl" required="" name="product_variation" type="number" id="txtPurchaseExcTax' + innerCount + '" onchange="UpdateVariationAmount(1,' + innerCount + ')">' +
                    '<small class="text-red font-weight-bold errorText" id="divPurchaseExcTax' + innerCount + '"></small>' +
                    '</div>' +
                    //'<div class="col-6 ">' +
                    //'<input class="form-control input-sm variable_dpp_inc_tax input_number" required="" name="product_variation" type="number" id="txtPurchaseIncTax' + innerCount + '" onchange="UpdateVariationAmount(2,' + innerCount + ')">' +
                    //'<small class="text-red font-weight-bold errorText" id="divPurchaseIncTax' + innerCount + '"></small>' +
                    //'</div>' +
                    '</div>' +
                    '</td >' +
                    '<td style="min-width:150px" class="" ' + (IsAccountsAddon == 'true' ? '' : 'hidden') + '>' +
                    '<div class="row">' +
                    '<div class="col-sm-12">' +
                    '<div class="form-group">' +
                    '<div class="input-group">' +
                    '<select class="form-control select2" id="ddlPurchaseAccount' + innerCount + '">' +
                    expenseAccountSubTypes +
                    '</select>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</td >' +
                    '<td class="" ' + (IsPurchaseAddon == 'true' ? '' : 'hidden') + ' style="min-width:150px;">' +
                    '<input class="form-control input-sm variable_profit_percent input_number divDefaultProfitMargin' + innerCount + '_ctrl" required="" name="product_variation" type="number" value="' + ($('#hdnDefaultProfitMargin').val() > 0 ? $('#hdnDefaultProfitMargin').val() : "") + '" id="txtDefaultProfitMargin' + innerCount + '" onchange="UpdateVariationAmount(3,' + innerCount + ')">' +
                    '<small class="text-red font-weight-bold errorText" id="divDefaultProfitMargin' + innerCount + '"></small>' +
                    '</td>' +
                    '<td style="min-width:150px">' +
                    '<div class="row">' +
                    /*'<div class="col-12 divSellingPriceExcTax">' +*/
                    '<div class="col-12">' +
                    '<input class="form-control input-sm variable_dsp input_number divSalesTax' + innerCount + '_ctrl" required="" name="product_variation" type="number" id="txtSalesExcTax' + innerCount + '" onchange="UpdateVariationAmount(4,' + innerCount + ')">' +
                    '<small class="text-red font-weight-bold errorText" id="divSalesTax' + innerCount + '"></small>' +
                    '</div>' +
                    //'<div class="col-12 divSellingPriceIncTax">' +
                    //'<input class="form-control input-sm variable_dsp input_number divSellingPriceIncTax" required="" name="product_variation" type="number" id="txtSalesIncTax' + innerCount + '" onchange="UpdateVariationAmount(5,' + innerCount + ')">' +
                    //'<small class="text-red font-weight-bold errorText" id="divSalesTax' + innerCount + '"></small>' +
                    //'</div>' +
                    '</div>' +
                    '</td>' +
                    '<td style="min-width:150px" ' + (IsAccountsAddon == 'true' ? '' : 'hidden') + '>' +
                    '<div class="row">' +
                    '<div class="col-sm-12">' +
                    '<div class="form-group" id="divFTAccount">' +
                    '<div class="input-group">' +
                    '<select class="form-control select2" id="ddlSalesAccount' + innerCount + '">' +
                    incomeAccountSubTypes +
                    '</select>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</td>' +
                    '<td style="min-width:150px" class="" ' + (EnableMrp == 'true' ? '' : 'hidden') + '>' +
                    '<input class="form-control input-sm variable_profit_percent input_number" required="" name="product_variation" type="number" id="txtDefaultMrp' + innerCount + '">' +
                    '<small class="text-red font-weight-bold errorText" id="divDefaultMrp' + innerCount + '"></small>' +
                    '</td>' +
                    '<td style="min-width:200px">' +
                    '<div class="custom-file">' +
                    '<input type="file" class="custom-file-input" id="ProductImage' + innerCount + '" accept=".png,.jpg,.jpeg" onchange="getImageBase64(' + innerCount + ')">' +
                    '<input type="hidden" id="txtHiddenFile' + innerCount + '">' +
                    '<input type="hidden" id="txtHiddenFileExtension' + innerCount + '">' +
                    '<label class="custom-file-label" for="ProductImage' + innerCount + '"> Choose file</label>' +
                    '</div></br>' +
                    '<img id="blahProductImage' + innerCount + '" alt="" height="60" style="padding-top:10px;">' +
                    '</td>' +
                    '<td>' +
                    '<button type="button" class="btn btn-danger btn-sm" onclick="deleteInnerVariable(' + innerCount + ')">' +
                    '<i class="fas fa-times">' +
                    '</i>' +
                    '</button>' +
                    '</td>' +
                    '</tr>';
                innerCount++;
            }
            $('#divInnerVariation' + id).append(html);
            //checkTaxType();
            checkItemType();
            initializeSelect2InScope('#divInnerVariation' + id);
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
}

function deleteVariable(id, ItemId, VariationId) {
    if (ItemId != undefined) {
        var r = confirm("Are you sure you want to delete?");
        if (r == true) {

            $('#divVariation table').each(function () {
                var _id = this.id.split('product_variation_form_part')[1];
                if (_id != undefined) {
                    $('#divInnerVariation' + _id + ' tr').each(function () {
                        var _innerid = this.id.split('product_variation_form_part_inner')[1];
                        $('#product_variation_form_part' + id).hide();
                    })
                }
            });

            //var det = {
            //    ItemId: ItemId,
            //    VariationId: VariationId
            //}
            //$("#divLoading").show();
            //$.ajax({
            //    url: '/items/itemDetailsDelete',
            //    datatype: "json",
            //    data: det,
            //    type: "post",
            //    success: function (data) {

            //        $("#divLoading").hide();
            //        if (data == "True") {
            //            $('#subscriptionExpiryModal').modal('toggle');
            //            $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
            //            $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
            //            return
            //        }
            //        else if (data == "False") {
            //            $('#subscriptionExpiryModal').modal('toggle');
            //            $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
            //            $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
            //            return
            //        }

            //        if (data.Status == 0) {
            //            if (EnableSound == 'True') { document.getElementById('error').play(); }
            //            toastr.error(data.Message);
            //        }
            //        else {
            //            $('#product_variation_form_part' + id).remove();
            //        }
            //    },
            //    error: function (xhr) {
            //        $("#divLoading").hide();
            //    }
            //});
        }
    }
    else {
        $('#product_variation_form_part' + id).remove();
    }
}

function deleteInnerVariable(id, ItemDetailsId) {
    if (ItemDetailsId != undefined) {
        var r = confirm("Are you sure you want to delete?");
        if (r == true) {

            $('#product_variation_form_part_inner' + id).hide();

            //var det = {
            //    ItemDetailsId: ItemDetailsId
            //}
            //$("#divLoading").show();
            //$.ajax({
            //    url: '/items/itemDetailsDelete',
            //    datatype: "json",
            //    data: det,
            //    type: "post",
            //    success: function (data) {

            //        $("#divLoading").hide();
            //        if (data == "True") {
            //            $('#subscriptionExpiryModal').modal('toggle');
            //            $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
            //            $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
            //            return
            //        }
            //        else if (data == "False") {
            //            $('#subscriptionExpiryModal').modal('toggle');
            //            $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
            //            $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
            //            return
            //        }

            //        if (data.Status == 0) {
            //            if (EnableSound == 'True') { document.getElementById('error').play(); }
            //            toastr.error(data.Message);
            //        }
            //        else {
            //            $('#product_variation_form_part_inner' + id).remove();
            //        }
            //    },
            //    error: function (xhr) {
            //        $("#divLoading").hide();
            //    }
            //});
        }
    }
    else {
        $('#product_variation_form_part_inner' + id).remove();
    }
}

$('#txttags').autocomplete({
    type: "POST",
    minLength: 3,
    source: function (request, response) {
        $.ajax({
            url: "/items/itemAutocomplete",
            dataType: "json",
            data: { Search: request.term, BranchId: $('#ddlBranch').val(), BranchIds: 'item', MenuType: 'combo' },
            success: function (data) {
                if (data.Status == 0) {
                    if (EnableSound == 'True') { document.getElementById('error').play(); }
                    toastr.error(data.Message);
                }
                else if (data.Status == 2) {
                    if (EnableSound == 'True') { document.getElementById('error').play(); } toastr.error('Invalid inputs, check and try again !!');
                    data.Errors.forEach(function (res) {
                        $('#' + res.Id).show();
                        $('#' + res.Id).text(res.Message);


                        if ($('.' + res.Id + '_ctrl').children("select").length > 0) {
                            var element = $("." + res.Id + '_ctrl select');
                            if (element.hasClass("select2-hidden-accessible")) {
                                $('.' + res.Id + '_ctrl .select2-container .select2-selection').css('border', '2px solid #dc3545');
                            } else {
                                $('.' + res.Id + '_ctrl select').css('border', '2px solid #dc3545');
                            }
                        }
                        else {
                            $('.' + res.Id + '_ctrl').css('border', '2px solid #dc3545');
                        }
                    });
                }
                else {
                    //response(data.Data.ItemsArray);
                    if (data.Data.ItemsArray.length == 1) {
                        $('#txttags').val('');
                        // Reset autocomplete term to allow re-searching the same value
                        var autocompleteInstance = $('#txttags').data('ui-autocomplete') || $('#txttags').data('autocomplete');
                        if (autocompleteInstance) {
                            autocompleteInstance.term = '';
                        }
                        var splitVal = data.Data.ItemsArray[0].split('~');
                        fetchItem(splitVal[splitVal.length - 1]);
                    }
                    else {
                        response(data.Data.ItemsArray);
                    }
                }
            },
            error: function (a, b, c) {
                HandleLookUpError(a);
            }
        });
    },
    select: function (event, ui) {
        var splitVal = ui.item.value.split('~');
        fetchItem(splitVal[splitVal.length - 1]);
    }
});

// Reset autocomplete term when input is cleared manually to allow re-searching the same value
$('#txttags').on('input', function() {
    if ($(this).val() === '') {
        var autocompleteInstance = $(this).data('ui-autocomplete') || $(this).data('autocomplete');
        if (autocompleteInstance) {
            autocompleteInstance.term = '';
        }
    }
});

function fetchItem(SkuHsnCode) {
    $('.errorText').hide();
    $('[style*="border: 2px"]').css('border', '');

    var det = {
        ItemCode: SkuHsnCode
    };
    $("#divLoading").show();
    $.ajax({
        url: '/items/SearchItemsWithoutBranch',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {
            $("#divLoading").hide();
            var html = ''; var variation = '';
            $('#txttags').val('');
            // Reset autocomplete term to allow re-searching the same value
            var autocompleteInstance = $('#txttags').data('ui-autocomplete') || $('#txttags').data('autocomplete');
            if (autocompleteInstance) {
                autocompleteInstance.term = '';
            }
            var IsPurchaseAddon = $('#hdnIsPurchaseAddon').val().toLocaleLowerCase();
            for (let i = 0; i < data.Data.ItemDetails.length; i++) {

                var isPresent = false;
                //$('#divCombo tr').each(function () {
                //    var _id = this.id.split('divCombo')[1];
                //    var ItemDetailsId = $('#hdnComboItemDetailsId' + _id).val();
                //    if (ItemDetailsId == data.Data.ItemDetails[i].ItemDetailsId) {
                //        $('#txtComboQuantity' + _id).val(parseInt($('#txtComboQuantity' + _id).val()) + 1);
                //        isPresent = true;
                //    }
                //});

                if (isPresent == false) {

                    var ddlUnit = '<select class="form-control" id="ddlComboUnit' + count + '" onchange="toggleUnitCombo(' + count + ')">';
                    if (data.Data.ItemDetails[i].QuaternaryUnitId != 0) {
                        if (data.Data.ItemDetails[i].PriceAddedFor == 1) {
                            ddlUnit = ddlUnit + '<option selected value="' + data.Data.ItemDetails[i].UnitId + '-1-1' + '">' + data.Data.ItemDetails[i].UnitShortName + '</option>';
                        }
                        else {
                            ddlUnit = ddlUnit + '<option value="' + data.Data.ItemDetails[i].UnitId + '-1-1' + '">' + data.Data.ItemDetails[i].UnitShortName + '</option>';
                        }
                        if (data.Data.ItemDetails[i].PriceAddedFor == 2) {
                            ddlUnit = ddlUnit + '<option selected value="' + data.Data.ItemDetails[i].SecondaryUnitId + '-2-2' + '">' + data.Data.ItemDetails[i].SecondaryUnitShortName + '</option>';
                        }
                        else {
                            ddlUnit = ddlUnit + '<option value="' + data.Data.ItemDetails[i].SecondaryUnitId + '-2-2' + '">' + data.Data.ItemDetails[i].SecondaryUnitShortName + '</option>';
                        }
                        if (data.Data.ItemDetails[i].PriceAddedFor == 3) {
                            ddlUnit = ddlUnit + '<option selected value="' + data.Data.ItemDetails[i].TertiaryUnitId + '-3-3' + '">' + data.Data.ItemDetails[i].TertiaryUnitShortName + '</option>';
                        }
                        else {
                            ddlUnit = ddlUnit + '<option value="' + data.Data.ItemDetails[i].TertiaryUnitId + '-3-3' + '">' + data.Data.ItemDetails[i].TertiaryUnitShortName + '</option>';
                        }
                        if (data.Data.ItemDetails[i].PriceAddedFor == 4) {
                            ddlUnit = ddlUnit + '<option value="' + data.Data.ItemDetails[i].QuaternaryUnitId + '-4-4' + '">' + data.Data.ItemDetails[i].QuaternaryUnitShortName + '</option>';
                        }
                        else {
                            ddlUnit = ddlUnit + '<option value="' + data.Data.ItemDetails[i].QuaternaryUnitId + '-4-4' + '">' + data.Data.ItemDetails[i].QuaternaryUnitShortName + '</option>';
                        }
                    }
                    else if (data.Data.ItemDetails[i].TertiaryUnitId != 0) {
                        //ddlUnit = ddlUnit + '<option selected value="' + data.Data.ItemDetails[i].UnitId + '" hidden>' + data.Data.ItemDetails[i].UnitShortName + '</option>';
                        if (data.Data.ItemDetails[i].PriceAddedFor == 2) {
                            ddlUnit = ddlUnit + '<option selected value="' + data.Data.ItemDetails[i].UnitId + '-2-1' + '">' + data.Data.ItemDetails[i].UnitShortName + '</option>';
                        }
                        else {
                            ddlUnit = ddlUnit + '<option value="' + data.Data.ItemDetails[i].UnitId + '-2-1' + '">' + data.Data.ItemDetails[i].UnitShortName + '</option>';
                        }
                        if (data.Data.ItemDetails[i].PriceAddedFor == 3) {
                            ddlUnit = ddlUnit + '<option selected value="' + data.Data.ItemDetails[i].SecondaryUnitId + '-3-2' + '">' + data.Data.ItemDetails[i].SecondaryUnitShortName + '</option>';
                        }
                        else {
                            ddlUnit = ddlUnit + '<option value="' + data.Data.ItemDetails[i].SecondaryUnitId + '-3-2' + '">' + data.Data.ItemDetails[i].SecondaryUnitShortName + '</option>';
                        }
                        if (data.Data.ItemDetails[i].PriceAddedFor == 4) {
                            ddlUnit = ddlUnit + '<option selected value="' + data.Data.ItemDetails[i].TertiaryUnitId + '-4-3' + '">' + data.Data.ItemDetails[i].TertiaryUnitShortName + '</option>';
                        }
                        else {
                            ddlUnit = ddlUnit + '<option value="' + data.Data.ItemDetails[i].TertiaryUnitId + '-4-3' + '">' + data.Data.ItemDetails[i].TertiaryUnitShortName + '</option>';
                        }
                    }
                    else if (data.Data.ItemDetails[i].SecondaryUnitId != 0) {
                        //ddlUnit = ddlUnit + '<option selected value="' + data.Data.ItemDetails[i].UnitId + '" hidden>' + data.Data.ItemDetails[i].UnitShortName + '</option>';
                        //ddlUnit = ddlUnit + '<option selected value="' + data.Data.ItemDetails[i].UnitId + '" hidden>' + data.Data.ItemDetails[i].UnitShortName + '</option>';
                        if (data.Data.ItemDetails[i].PriceAddedFor == 3) {
                            ddlUnit = ddlUnit + '<option selected value="' + data.Data.ItemDetails[i].UnitId + '-3-1' + '">' + data.Data.ItemDetails[i].UnitShortName + '</option>';
                        }
                        else {
                            ddlUnit = ddlUnit + '<option value="' + data.Data.ItemDetails[i].UnitId + '-3-1' + '">' + data.Data.ItemDetails[i].UnitShortName + '</option>';
                        }
                        if (data.Data.ItemDetails[i].PriceAddedFor == 4) {
                            ddlUnit = ddlUnit + '<option selected value="' + data.Data.ItemDetails[i].SecondaryUnitId + '-4-2' + '">' + data.Data.ItemDetails[i].SecondaryUnitShortName + '</option>';
                        }
                        else {
                            ddlUnit = ddlUnit + '<option value="' + data.Data.ItemDetails[i].SecondaryUnitId + '-4-2' + '">' + data.Data.ItemDetails[i].SecondaryUnitShortName + '</option>';
                        }
                    }
                    else {
                        //ddlUnit = ddlUnit + '<option selected value="' + data.Data.ItemDetails[i].UnitId + '" hidden>' + data.Data.ItemDetails[i].UnitShortName + '</option>';
                        //ddlUnit = ddlUnit + '<option selected value="' + data.Data.ItemDetails[i].UnitId + '" hidden>' + data.Data.ItemDetails[i].UnitShortName + '</option>';
                        //ddlUnit = ddlUnit + '<option selected value="' + data.Data.ItemDetails[i].UnitId + '" hidden>' + data.Data.ItemDetails[i].UnitShortName + '</option>';
                        ddlUnit = ddlUnit + '<option selected value="' + data.Data.ItemDetails[i].UnitId + '-4-1' + '">' + data.Data.ItemDetails[i].UnitShortName + '</option>';
                    }

                    ddlUnit = ddlUnit + '</select >';

                    if (data.Data.ItemDetails[i].ProductType.toLowerCase() == 'variable') {
                        variation = '(' + data.Data.ItemDetails[i].VariationName + ')';
                    }
                    html = html + '<tr id="divCombo' + count + '">' +
                        '<td style="min-width:125px" class="text-center">' + data.Data.ItemDetails[i].ItemName + variation + ' - ' + data.Data.ItemDetails[i].SKU + '' +
                        '<input type="hidden" id="hdnComboItemDetailsId' + count + '" value="' + data.Data.ItemDetails[i].ItemDetailsId + '"/>' +
                        '</td>' +
                        '<td style="min-width:250px" class="text-center">' +
                        '<div class="input-group divComboQuantity' + count + '_ctrl">' +
                        '<input type="number" class="form-control" placeholder="Quantity" value="1" id="txtComboQuantity' + count + '" onkeypress="return onlyDecimalKey(event)" onchange="UpdateComboAmount(1)">' +
                        '<span class="input-group-append ' + (data.Data.ItemDetails[i].UnitId ? '' : 'hidden') + '">' + ddlUnit +
                        '<input type="text" hidden class="form-control" id="hdnPriceAddedFor' + count + '" value="' + data.Data.ItemDetails[i].PriceAddedFor + '">' +
                        '<input type="text" hidden class="form-control" id="hdnUToSValue' + count + '" value="' + data.Data.ItemDetails[i].UToSValue + '">' +
                        '<input type="text" hidden class="form-control" id="hdnSToTValue' + count + '" value="' + data.Data.ItemDetails[i].SToTValue + '">' +
                        '<input type="text" hidden class="form-control" id="hdnTToQValue' + count + '" value="' + data.Data.ItemDetails[i].TToQValue + '">' +
                        '<input type="text" hidden class="form-control" id="hdnUnitCost' + count + '" value="' + data.Data.ItemDetails[i].PurchaseExcTax + '">' +
                        '<input type="text" hidden class="form-control" id="hdnSalesIncTax' + count + '" value="' + data.Data.ItemDetails[i].OpeningStockSalesIncTax + '">' +
                        '<input type="text" hidden class="form-control" id="hdnMrp' + count + '" value="' + data.Data.ItemDetails[i].Mrp + '">' +
                        '<input type="text" hidden class="form-control" id="hdnAllowDecimal' + count + '" value="' + data.Data.ItemDetails[i].AllowDecimal + '">' +
                        '<input type="text" hidden class="form-control" id="hdnSecondaryUnitAllowDecimal' + count + '" value="' + data.Data.ItemDetails[i].SecondaryUnitAllowDecimal + '">' +
                        '<input type="text" hidden class="form-control" id="hdnTertiaryUnitAllowDecimal' + count + '" value="' + data.Data.ItemDetails[i].TertiaryUnitAllowDecimal + '">' +
                        '<input type="text" hidden class="form-control" id="hdnQuaternaryUnitAllowDecimal' + count + '" value="' + data.Data.ItemDetails[i].QuaternaryUnitAllowDecimal + '">' +
                        '</span>' +
                        '</div>' +
                        '<small class="text-red font-weight-bold float-left errorText" id="divComboQuantity' + count + '"></small>' +
                        '</td>' +
                        //'<td style="min-width:125px" class="text-center ' + (IsPurchaseAddon == 'true' ? '' : 'hidden') + '" id="divComboPurchaseExcTax' + count + '">' + ($('#ddlTaxType').val() == "Inclusive" ? data.Data.ItemDetails[i].PurchaseIncTax : data.Data.ItemDetails[i].PurchaseExcTax) + ' <input type="hidden" value="' + ($('#ddlTaxType').val() == "Inclusive" ? data.Data.ItemDetails[i].PurchaseIncTax : data.Data.ItemDetails[i].PurchaseExcTax) + '" id="hdnComboPurchaseExcTax' + count + '"/></td>' +
                        //'<td style="min-width:125px" class="text-center ' + (IsPurchaseAddon == 'true' ? '' : 'hidden') + '" id="divComboTotalAmount' + count + '">' + ($('#ddlTaxType').val() == "Inclusive" ? data.Data.ItemDetails[i].PurchaseIncTax : data.Data.ItemDetails[i].PurchaseExcTax) + '<input type="hidden" value="' + ($('#ddlTaxType').val() == "Inclusive" ? data.Data.ItemDetails[i].PurchaseIncTax : data.Data.ItemDetails[i].PurchaseExcTax) + '" id="hdnComboTotalAmount' + count + '"/></td>' +
                        '<td class="text-center">' +
                        '<button type="button" class="btn btn-danger btn-sm" onclick="deleteCombo(' + count + ')">' +
                        '<i class="fas fa-times">' +
                        '</i>' +
                        '</button>' +
                        '</td>' +
                        '</tr>';
                }

                count++;
            }
            $('#divCombo').append(html);
            checkTaxType();
            //calulation();
            //UpdateComboAmount('1');
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
}

function deleteCombo(id, ItemDetailsId) {
    if (ItemDetailsId != undefined) {
        //var r = confirm("This will delete permanently. This process cannot be undone. Are you sure you want to continue?");
        //if (r == true) {

        $('#divCombo' + id).hide();

        //var det = {
        //    ItemDetailsId: ItemDetailsId
        //}
        //$("#divLoading").show();
        //$.ajax({
        //    url: '/items/itemDetailsDelete',
        //    datatype: "json",
        //    data: det,
        //    type: "post",
        //    success: function (data) {

        //        $("#divLoading").hide();
        //        if (data == "True") {
        //            $('#subscriptionExpiryModal').modal('toggle');
        //            $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
        //            $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
        //            return
        //        }
        //        else if (data == "False") {
        //            $('#subscriptionExpiryModal').modal('toggle');
        //            $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
        //            $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
        //            return
        //        }

        //        if (data.Status == 0) {
        //            if (EnableSound == 'True') { document.getElementById('error').play(); }
        //            toastr.error(data.Message);
        //        }
        //        else {
        //            document.getElementById('success').play();
        //            toastr.success(data.Message);
        //            $('#divCombo' + id).remove();
        //        }
        //    },
        //    error: function (xhr) {
        //        $("#divLoading").hide();
        //    }
        //});
        //}
    }
    else {
        $('#divCombo' + id).remove();
    }
    UpdateComboAmount('1');
}

function deleteFullCombo(ItemId) {
    if (ItemId != undefined) {
        //var r = confirm("This will delete permanently. This process cannot be undone. Are you sure you want to continue?");
        //if (r == true) {
        $('#divCombo tr').each(function () {
            var _id = this.id.split('divCombo')[1];
            if (_id != undefined) {
                $('#divCombo' + _id).hide();
                $('#divComboNetAmount').text(0);
                $('#txtComboDefaultMargin').val(0);
                $('#txtComboSalesExcTax').val(0);
                $('#txtComboSalesIncTax').val(0);
            }
        });

        //var det = {
        //    ItemId: ItemId
        //}
        //$("#divLoading").show();
        //$.ajax({
        //    url: '/items/itemDetailsDelete',
        //    datatype: "json",
        //    data: det,
        //    type: "post",
        //    success: function (data) {

        //        $("#divLoading").hide();
        //        if (data == "True") {
        //            $('#subscriptionExpiryModal').modal('toggle');
        //            $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
        //            $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
        //            return
        //        }
        //        else if (data == "False") {
        //            $('#subscriptionExpiryModal').modal('toggle');
        //            $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
        //            $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
        //            return
        //        }

        //        if (data.Status == 0) {
        //            if (EnableSound == 'True') { document.getElementById('error').play(); }
        //            toastr.error(data.Message);
        //        }
        //        else {
        //            document.getElementById('success').play();
        //            toastr.success(data.Message);
        //            $('#divCombo').empty();
        //            $('#divComboNetAmount').text(0);
        //        }
        //    },
        //    error: function (xhr) {
        //        $("#divLoading").hide();
        //    }
        //});
        //}
    }
    else {
        $('#divCombo').empty();
        $('#divComboNetAmount').text(0);
        $('#txtComboDefaultMargin').val(0);
        $('#txtComboSalesExcTax').val(0);
        $('#txtComboSalesIncTax').val(0);
    }
}

function UpdateComboAmount(type) {
    var IsPurchaseAddon = $('#hdnIsPurchaseAddon').val().toLocaleLowerCase();

    var PurchaseExcTax = 0, PurchaseIncTax = 0, DefaultProfitMargin = 0;
    var taxPer = 0;

    var SalesIncTax = $('#txtComboSalesIncTax').val() == '' ? 0 : parseFloat($('#txtComboSalesIncTax').val());
    var SalesExcTax = $('#txtComboSalesExcTax').val() == '' ? 0 : parseFloat($('#txtComboSalesExcTax').val());

    if ($('#txtComboDefaultMargin').val()) {
        DefaultProfitMargin = parseFloat($('#txtComboDefaultMargin').val());
    }

    $('#divCombo tr').each(function () {
        var _id = this.id.split('divCombo')[1];
        var _comboQty = parseFloat($('#txtComboQuantity' + _id).val()) || 0;
        $('#divComboTotalAmount' + _id).text((_comboQty * parseFloat($('#divComboPurchaseExcTax' + _id).text())).toFixed(2));
        PurchaseExcTax = PurchaseExcTax + (_comboQty * parseFloat($('#divComboPurchaseExcTax' + _id).text()));
    });

    //if (type == '1') {
    //    $('#divComboNetAmount').text(Math.round(PurchaseExcTax * 100) / 100);
    //    $('#txtComboSalesExcTax').val(Math.round((((DefaultProfitMargin / 100) * PurchaseExcTax) + PurchaseExcTax) * 100) / 100);
    //}
    //else if (type == '2') {
    //    $('#txtComboSalesExcTax').val((((DefaultProfitMargin / 100) * PurchaseExcTax) + PurchaseExcTax).toFixed(2));
    //}
    //else {
    //    DefaultProfitMargin = ((SalesExcTax - PurchaseExcTax) / PurchaseExcTax) * 100;
    //    $('#txtComboDefaultMargin').val(DefaultProfitMargin.toFixed(2));
    //}
    //}
}

function UpdateVariationAmount(type, id) {
    var IsPurchaseAddon = $('#hdnIsPurchaseAddon').val().toLocaleLowerCase();

    if (id == undefined) {
        $('#divVariation table').each(function () {
            var _id = this.id.split('product_variation_form_part')[1];
            if (_id != undefined) {
                $('#divInnerVariation' + _id + ' tr').each(function () {
                    var _innerid = this.id.split('product_variation_form_part_inner')[1];
                    var PurchaseExcTax = parseFloat($('#txtPurchaseExcTax' + _innerid).val());
                    var PurchaseIncTax = $('#txtPurchaseIncTax' + _innerid).val() == '' ? 0 : parseFloat($('#txtPurchaseIncTax' + _innerid).val());
                    var DefaultProfitMargin = $('#txtDefaultProfitMargin' + _innerid).val() == '' ? 0 : parseFloat($('#txtDefaultProfitMargin' + _innerid).val());
                    var SalesIncTax = $('#txtSalesIncTax' + _innerid).val() == '' ? 0 : parseFloat($('#txtSalesIncTax' + _innerid).val());
                    var SalesExcTax = $('#txtSalesExcTax' + _innerid).val() == '' ? 0 : parseFloat($('#txtSalesExcTax' + _innerid).val());
                    var taxPer = 0;
                    //if ($('#ddlTax').val() != 0) {
                    //    taxPer = $("#ddlTax").val().split('-')[1];
                    //}

                    //if (IsPurchaseAddon == 'false') {
                    //    if ($('#ddlTaxType').val() == 'Exclusive') {
                    //        $('#txtSalesIncTax' + _innerid).val((((taxPer / 100) * SalesExcTax) + SalesExcTax).toFixed(2));
                    //    }
                    //    else {
                    //        $('#txtSalesExcTax' + _innerid).val(((SalesIncTax * 100) / (100 + parseFloat(taxPer))).toFixed(2));
                    //    }
                    //}
                    //else {
                    if (type == '1') {
                        //if (taxPer == 0) {
                        //    PurchaseIncTax = PurchaseExcTax;
                        //}
                        //else {
                        //    PurchaseIncTax = ((taxPer / 100) * PurchaseExcTax) + PurchaseExcTax;
                        //}
                        //$('#txtPurchaseIncTax' + _innerid).val(PurchaseIncTax.toFixed(2));
                        //$('#txtSalesIncTax' + _innerid).val((((DefaultProfitMargin / 100) * PurchaseIncTax) + PurchaseIncTax).toFixed(2));
                        $('#txtSalesExcTax' + _innerid).val((((DefaultProfitMargin / 100) * PurchaseExcTax) + PurchaseExcTax).toFixed(2));
                    }
                    else if (type == '3') {
                        //$('#txtSalesIncTax' + _innerid).val((((DefaultProfitMargin / 100) * PurchaseIncTax) + PurchaseIncTax).toFixed(2));
                        $('#txtSalesExcTax' + _innerid).val((((DefaultProfitMargin / 100) * PurchaseExcTax) + PurchaseExcTax).toFixed(2));
                    }
                    else if (type == '2') {
                        PurchaseExcTax = (PurchaseIncTax * 100) / (100 + parseFloat(taxPer));
                        $('#txtPurchaseExcTax' + _innerid).val(PurchaseExcTax.toFixed(2));
                        //$('#txtSalesIncTax' + _innerid).val((((DefaultProfitMargin / 100) * PurchaseIncTax) + PurchaseIncTax).toFixed(2));
                        $('#txtSalesExcTax' + _innerid).val((((DefaultProfitMargin / 100) * PurchaseExcTax) + PurchaseExcTax).toFixed(2));
                    }
                    else {
                        //if ($('#ddlTaxType').val() == 'Exclusive') {
                        DefaultProfitMargin = ((SalesExcTax - PurchaseExcTax) / PurchaseExcTax) * 100;
                        //}
                        //else {
                        //    DefaultProfitMargin = ((SalesIncTax - PurchaseIncTax) / PurchaseIncTax) * 100;
                        //}
                        $('#txtDefaultProfitMargin' + _innerid).val(DefaultProfitMargin.toFixed(2));
                    }
                    //}
                });
            }
        });
    }
    else {
        var PurchaseExcTax = parseFloat($('#txtPurchaseExcTax' + id).val());
        var PurchaseIncTax = $('#txtPurchaseIncTax' + id).val() == '' ? 0 : parseFloat($('#txtPurchaseIncTax' + id).val());
        var DefaultProfitMargin = $('#txtDefaultProfitMargin' + id).val() == '' ? 0 : parseFloat($('#txtDefaultProfitMargin' + id).val());
        var SalesIncTax = $('#txtSalesIncTax' + id).val() == '' ? 0 : parseFloat($('#txtSalesIncTax' + id).val());
        var SalesExcTax = $('#txtSalesExcTax' + id).val() == '' ? 0 : parseFloat($('#txtSalesExcTax' + id).val());
        var taxPer = 0;
        //if ($('#ddlTax').val() != 0) {
        //    taxPer = $("#ddlTax").val().split('-')[1];
        //}

        //if (IsPurchaseAddon == 'false') {
        //    if ($('#ddlTaxType').val() == 'Exclusive') {
        //        $('#txtSalesIncTax' + id).val((((taxPer / 100) * SalesExcTax) + SalesExcTax).toFixed(2));
        //    }
        //    else {
        //        $('#txtSalesExcTax' + id).val(((SalesIncTax * 100) / (100 + parseFloat(taxPer))).toFixed(2));
        //    }
        //}
        //else {
        if (type == '1') {
            //if (taxPer == 0) {
            //    PurchaseIncTax = PurchaseExcTax;
            //}
            //else {
            //    PurchaseIncTax = ((taxPer / 100) * PurchaseExcTax) + PurchaseExcTax;
            //}
            //$('#txtPurchaseIncTax' + id).val(PurchaseIncTax.toFixed(2));
            //$('#txtSalesIncTax' + id).val((((DefaultProfitMargin / 100) * PurchaseIncTax) + PurchaseIncTax).toFixed(2));
            $('#txtSalesExcTax' + id).val((((DefaultProfitMargin / 100) * PurchaseExcTax) + PurchaseExcTax).toFixed(2));
        }
        else if (type == '3') {
            //$('#txtSalesIncTax' + id).val((((DefaultProfitMargin / 100) * PurchaseIncTax) + PurchaseIncTax).toFixed(2));
            $('#txtSalesExcTax' + id).val((((DefaultProfitMargin / 100) * PurchaseExcTax) + PurchaseExcTax).toFixed(2));
        }
        else if (type == '2') {
            PurchaseExcTax = (PurchaseIncTax * 100) / (100 + parseFloat(taxPer));
            $('#txtPurchaseExcTax' + id).val(PurchaseExcTax.toFixed(2));
            //$('#txtSalesIncTax' + id).val((((DefaultProfitMargin / 100) * PurchaseIncTax) + PurchaseIncTax).toFixed(2));
            $('#txtSalesExcTax' + id).val((((DefaultProfitMargin / 100) * PurchaseExcTax) + PurchaseExcTax).toFixed(2));
        }
        else {
            //if ($('#ddlTaxType').val() == 'Exclusive') {
            DefaultProfitMargin = ((SalesExcTax - PurchaseExcTax) / PurchaseExcTax) * 100;
            //}
            //else {
            //    DefaultProfitMargin = ((SalesIncTax - PurchaseIncTax) / PurchaseIncTax) * 100;
            //}
            $('#txtDefaultProfitMargin' + id).val(DefaultProfitMargin.toFixed(2));
        }
        //}
    }
}

function UpdateSingleAmount(type) {
    var IsPurchaseAddon = $('#hdnIsPurchaseAddon').val().toLocaleLowerCase();
    var PurchaseExcTax = parseFloat($('#txtPurchaseExcTax').val());
    var PurchaseIncTax = $('#txtPurchaseIncTax').val() == '' ? 0 : parseFloat($('#txtPurchaseIncTax').val());
    var DefaultProfitMargin = $('#txtDefaultProfitMargin').val() == '' ? 0 : parseFloat($('#txtDefaultProfitMargin').val());
    var SalesIncTax = $('#txtSalesIncTax').val() == '' ? 0 : parseFloat($('#txtSalesIncTax').val());
    var SalesExcTax = $('#txtSalesExcTax').val() == '' ? 0 : parseFloat($('#txtSalesExcTax').val());
    var taxPer = 0;
    //if ($('#ddlTax').val() != 0) {
    //    taxPer = $("#ddlTax").val().split('-')[1];
    //}

    //if (IsPurchaseAddon == 'false') {
    //    //if ($('#ddlTaxType').val() == 'Exclusive') {
    //    //    $('#txtSalesIncTax').val((((taxPer / 100) * SalesExcTax) + SalesExcTax).toFixed(2));
    //    //}
    //    //else {
    //    //    $('#txtSalesExcTax').val(((SalesIncTax * 100) / (100 + parseFloat(taxPer))).toFixed(2));
    //    //}
    //}
    //else {
    if (type == 'PExc') {
        //if (taxPer == 0) {
        //    PurchaseIncTax = PurchaseExcTax;
        //}
        //else {
        //    PurchaseIncTax = ((taxPer / 100) * PurchaseExcTax) + PurchaseExcTax;
        //}
        //$('#txtPurchaseIncTax').val(PurchaseIncTax.toFixed(2));
        //$('#txtSalesIncTax').val((((DefaultProfitMargin / 100) * PurchaseIncTax) + PurchaseIncTax).toFixed(2));
        $('#txtSalesExcTax').val((((DefaultProfitMargin / 100) * PurchaseExcTax) + PurchaseExcTax).toFixed(2));
    }
    else if (type == 'Margin') {
        //$('#txtSalesIncTax').val((((DefaultProfitMargin / 100) * PurchaseIncTax) + PurchaseIncTax).toFixed(2));
        $('#txtSalesExcTax').val((((DefaultProfitMargin / 100) * PurchaseExcTax) + PurchaseExcTax).toFixed(2));
    }
    //else if (type == 'PInc') {
    //    PurchaseExcTax = (PurchaseIncTax * 100) / (100 + parseFloat(taxPer));
    //    $('#txtPurchaseExcTax').val(PurchaseExcTax.toFixed(2));
    //    $('#txtSalesIncTax').val((((DefaultProfitMargin / 100) * PurchaseIncTax) + PurchaseIncTax).toFixed(2));
    //    $('#txtSalesExcTax').val((((DefaultProfitMargin / 100) * PurchaseExcTax) + PurchaseExcTax).toFixed(2));
    //}
    else {
        //if ($('#ddlTaxType').val() == 'Exclusive') {
        DefaultProfitMargin = ((SalesExcTax - PurchaseExcTax) / PurchaseExcTax) * 100;
        //}
        //else {
        //    DefaultProfitMargin = ((SalesIncTax - PurchaseIncTax) / PurchaseIncTax) * 100;
        //}
        $('#txtDefaultProfitMargin').val(DefaultProfitMargin.toFixed(2));
    }
    /*}*/

}

function calulation() {
    if ($('#ddlProductType').val() == 'Single') {
        UpdateSingleAmount('PExc');
    }
    else if ($('#ddlProductType').val() == 'Variable') {
        UpdateVariationAmount(1);
    }
    else {
        UpdateComboAmount('1');
        //var amount = 0;
        //$('#divCombo tr').each(function () {

        //    var _id = this.id.split('divCombo')[1];
        //    amount = amount + (parseFloat($('#txtComboQuantity' + _id).val()) * parseFloat($('#hdnComboPurchaseExcTax' + _id).val()));
        //});
        //$('#divComboNetAmount').text(amount);
    }
}

function insertBrand() {
    $('.errorText').hide();
    $('[style*="border: 2px"]').css('border', '');


    var det = {
        brandCode: $('#txtBrandCode').val(),
        brand: $('#txtBrand').val(),
        IsActive: true,
        IsDeleted: false,
    };
    $("#divLoading").show();
    $.ajax({
        url: '/itemsettings/brandInsert',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {

            $("#divLoading").hide();
            if (data == "True") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }
            else if (data == "False") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }

            if (data.Status == 0) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error(data.Message);
            }
            else if (data.Status == 2) {
                if (EnableSound == 'True') { document.getElementById('error').play(); } toastr.error('Invalid inputs, check and try again !!');
                data.Errors.forEach(function (res) {
                    $('#' + res.Id + '_M').show();
                    $('#' + res.Id + '_M').text(res.Message);

                    if ($('.' + res.Id + '_M_ctrl').children("select").length > 0) {
                        var element = $("." + res.Id + '_M_ctrl select');
                        if (element.hasClass("select2-hidden-accessible")) {
                            $('.' + res.Id + '_M_ctrl .select2-container .select2-selection').css('border', '2px solid #dc3545');
                        } else {
                            $('.' + res.Id + '_M_ctrl select').css('border', '2px solid #dc3545');
                        }
                    }
                    else {
                        $('.' + res.Id + '_M_ctrl').css('border', '2px solid #dc3545');
                    }
                });
            }
            else {
                $('#ddlBrand').append($('<option>', { value: data.Data.Brand.BrandId, text: data.Data.Brand.Brand }));
                $('#ddlBrand').val(data.Data.Brand.BrandId);
                $('#brandModal').modal('toggle');

                $('#txtBrandCode').val('');
                $('#txtBrand').val('');
            }
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
};

function insertCategory() {
    $('.errorText').hide();
    $('[style*="border: 2px"]').css('border', '');


    var det = {
        CategoryCode: $('#txtCategoryCode').val(),
        Category: $('#txtCategory').val(),
        IsActive: true,
        IsDeleted: false,
    };
    $("#divLoading").show();
    $.ajax({
        url: '/itemsettings/CategoryInsert',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {

            $("#divLoading").hide();
            if (data == "True") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }
            else if (data == "False") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }

            if (data.Status == 0) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error(data.Message);
            }
            else if (data.Status == 2) {
                if (EnableSound == 'True') { document.getElementById('error').play(); } toastr.error('Invalid inputs, check and try again !!');
                data.Errors.forEach(function (res) {
                    $('#' + res.Id + '_M').show();
                    $('#' + res.Id + '_M').text(res.Message);


                    if ($('.' + res.Id + '_M_ctrl').children("select").length > 0) {
                        var element = $("." + res.Id + '_M_ctrl select');
                        if (element.hasClass("select2-hidden-accessible")) {
                            $('.' + res.Id + '_M_ctrl .select2-container .select2-selection').css('border', '2px solid #dc3545');
                        } else {
                            $('.' + res.Id + '_M_ctrl select').css('border', '2px solid #dc3545');
                        }
                    }
                    else {
                        $('.' + res.Id + '_M_ctrl').css('border', '2px solid #dc3545');
                    }
                });
            }
            else {
                $('#ddlCategory').append($('<option>', { value: data.Data.Category.CategoryId, text: data.Data.Category.Category }));
                $('#ddlCategory').val(data.Data.Category.CategoryId);
                $('#categoryModal').modal('toggle');

                $('#ddlNewCategory').append($('<option>', { value: data.Data.Category.CategoryId, text: data.Data.Category.Category }));
                $('#ddlModalCategory').append($('<option>', { value: data.Data.Category.CategoryId, text: data.Data.Category.Category }));

                $('#ddlSubCategory').html('');
                $('#ddlSubSubCategory').html('');

                $('#txtCategoryCode').val('');
                $('#txtCategory').val('');
            }
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
};

function insertSubCategory() {
    $('.errorText').hide();
    $('[style*="border: 2px"]').css('border', '');


    var det = {
        CategoryId: $('#ddlCategory').val(),
        SubCategoryCode: $('#txtSubCategoryCode').val(),
        SubCategory: $('#txtSubCategory').val(),
        IsActive: true,
        IsDeleted: false,
    };
    $("#divLoading").show();
    $.ajax({
        url: '/itemsettings/SubCategoryInsert',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {

            $("#divLoading").hide();
            if (data == "True") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }
            else if (data == "False") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }

            if (data.Status == 0) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error(data.Message);
            }
            else if (data.Status == 2) {
                if (EnableSound == 'True') { document.getElementById('error').play(); } toastr.error('Invalid inputs, check and try again !!');
                data.Errors.forEach(function (res) {
                    $('#' + res.Id + '_M').show();
                    $('#' + res.Id + '_M').text(res.Message);


                    if ($('.' + res.Id + '_M_ctrl').children("select").length > 0) {
                        var element = $("." + res.Id + '_M_ctrl select');
                        if (element.hasClass("select2-hidden-accessible")) {
                            $('.' + res.Id + '_M_ctrl .select2-container .select2-selection').css('border', '2px solid #dc3545');
                        } else {
                            $('.' + res.Id + '_M_ctrl select').css('border', '2px solid #dc3545');
                        }
                    }
                    else {
                        $('.' + res.Id + '_M_ctrl').css('border', '2px solid #dc3545');
                    }
                });
            }
            else {
                $('#ddlSubCategory').append($('<option>', { value: data.Data.SubCategory.SubCategoryId, text: data.Data.SubCategory.SubCategory }));
                $('#ddlSubCategory').val(data.Data.SubCategory.SubCategoryId);
                $('#subCategoryModal').modal('toggle');

                $('#ddlSubSubCategory').html('');

                $('#txtSubCategoryCode').val('');
                $('#txtSubCategory').val('');
            }
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
};

function fetchActiveModalSubCategories() {
    var det = {
        CategoryId: $('#ddlModalCategory').val()
    };
    _PageIndex = det.PageIndex;
    $("#divLoading").show();
    $.ajax({
        url: '/itemsettings/ActiveModalSubCategories',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {
            $("#divLoading").hide();
            var dropdown = '<label>Sub Category <span class="danger">*</span></label><select class="form-control select2" id="ddlModalSubCategory">';
            $.each(data.Data.SubCategories, function (index, value) {
                dropdown = dropdown + '<option value="' + value.SubCategoryId + '">' + value.SubCategory + '</option>';
            });

            dropdown = dropdown + '</select>';
            $('#p_ModalSubCategories_Dropdown').html('');
            $('#p_ModalSubCategories_Dropdown').append(dropdown);

        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
};

function insertSubSubCategory() {
    $('.errorText').hide();
    $('[style*="border: 2px"]').css('border', '');


    var det = {
        CategoryId: $('#ddlCategory').val(),
        SubCategoryId: $('#ddlSubCategory').val(),
        SubSubCategoryCode: $('#txtSubSubCategoryCode').val(),
        SubSubCategory: $('#txtSubSubCategory').val(),
        IsActive: true,
        IsDeleted: false,
    };
    $("#divLoading").show();
    $.ajax({
        url: '/itemsettings/SubSubCategoryInsert',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {

            $("#divLoading").hide();
            if (data == "True") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }
            else if (data == "False") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }

            if (data.Status == 0) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error(data.Message);
            }
            else if (data.Status == 2) {
                if (EnableSound == 'True') { document.getElementById('error').play(); } toastr.error('Invalid inputs, check and try again !!');
                data.Errors.forEach(function (res) {
                    $('#' + res.Id + '_M').show();
                    $('#' + res.Id + '_M').text(res.Message);


                    if ($('.' + res.Id + '_M_ctrl').children("select").length > 0) {
                        var element = $("." + res.Id + '_M_ctrl select');
                        if (element.hasClass("select2-hidden-accessible")) {
                            $('.' + res.Id + '_M_ctrl .select2-container .select2-selection').css('border', '2px solid #dc3545');
                        } else {
                            $('.' + res.Id + '_M_ctrl select').css('border', '2px solid #dc3545');
                        }
                    }
                    else {
                        $('.' + res.Id + '_M_ctrl').css('border', '2px solid #dc3545');
                    }
                });
            }
            else {
                $('#ddlSubSubCategory').append($('<option>', { value: data.Data.SubSubCategory.SubSubCategoryId, text: data.Data.SubSubCategory.SubSubCategory }));
                $('#ddlSubSubCategory').val(data.Data.SubSubCategory.SubSubCategoryId);
                $('#subSubCategoryModal').modal('toggle');

                $('#txtSubSubCategoryCode').val('');
                $('#txtSubSubCategory').val('');
            }
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
};

function insertWarranty() {
    $('.errorText').hide();
    $('[style*="border: 2px"]').css('border', '');


    var det = {
        Warranty: $('#txtWarranty').val(),
        Description: $('#txtDescription').val(),
        DurationNo: $('#txtDurationNo').val(),
        Duration: $('#ddlDuration').val(),
        IsActive: true,
        IsDeleted: false,
    };
    $("#divLoading").show();
    $.ajax({
        url: '/itemsettings/warrantiesInsert',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {

            $("#divLoading").hide();
            if (data == "True") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }
            else if (data == "False") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }

            if (data.Status == 0) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error(data.Message);
            }
            else if (data.Status == 2) {
                if (EnableSound == 'True') { document.getElementById('error').play(); } toastr.error('Invalid inputs, check and try again !!');
                data.Errors.forEach(function (res) {
                    $('#' + res.Id + '_M').show();
                    $('#' + res.Id + '_M').text(res.Message);


                    if ($('.' + res.Id + '_M_ctrl').children("select").length > 0) {
                        var element = $("." + res.Id + '_M_ctrl select');
                        if (element.hasClass("select2-hidden-accessible")) {
                            $('.' + res.Id + '_M_ctrl .select2-container .select2-selection').css('border', '2px solid #dc3545');
                        } else {
                            $('.' + res.Id + '_M_ctrl select').css('border', '2px solid #dc3545');
                        }
                    }
                    else {
                        $('.' + res.Id + '_M_ctrl').css('border', '2px solid #dc3545');
                    }
                });
            }
            else {
                $('#ddlWarranty').append($('<option>', { value: data.Data.Warranty.WarrantyId, text: data.Data.Warranty.Warranty }));
                $('#ddlWarranty').val(data.Data.Warranty.WarrantyId);
                $('#warrantyModal').modal('toggle');

                $('#txtWarranty').val('');
                $('#txtDescription').val('');
                $('#txtDurationNo').val('');
                $('#ddlDuration').val('Days');
            }
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
};

function OpeningStock() {
    var det = {
        ItemId: _ItemId,
        Date: $('#txtDate').val(),
        BranchId: $('#ddlStockBranch').val(),
        ItemDetailsId: $('#ddlItemDetails').val()
    };
    $("#divLoading").show();
    $.ajax({
        url: '/items/OpeningStock',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {
            //_OpeningStockId = data.Data.OpeningStock.OpeningStockId;
            //var DateFormat = Cookies.get('BusinessSetting').split('&')[0].split('=')[1];

            var ExpiryDateFormat = Cookies.get('ItemSetting').split('&')[0].split('=')[1];
            var DateFormat = Cookies.get('BusinessSetting').split('&')[0].split('=')[1];
            var TimeFormat = Cookies.get('BusinessSetting').split('&')[1].split('=')[1].replace('tt', 'a').replace('tt', 'a');
            var html = '';
            $.each(data.Data.OpeningStocks, function () {
                var _variation = this.VariationName == null ? '' : '<br /><span> <b>Variation:</b> ' + this.VariationName + '</span>';

                var ddlUnit = '<select class="form-control select2" style="width: 100 %; " id="ddlUnit' + count + '" onchange="toggleUnit(' + count + ')">';
                if (this.QuaternaryUnitId != 0) {
                    if (this.PriceAddedFor == 1) {
                        ddlUnit = ddlUnit + '<option selected value="' + this.UnitId + '-1-1' + '">' + this.UnitShortName + '</option>';
                    }
                    else {
                        ddlUnit = ddlUnit + '<option value="' + this.UnitId + '-1-1' + '">' + this.UnitShortName + '</option>';
                    }
                    if (this.PriceAddedFor == 2) {
                        ddlUnit = ddlUnit + '<option selected value="' + this.SecondaryUnitId + '-2-2' + '">' + this.SecondaryUnitShortName + '</option>';
                    }
                    else {
                        ddlUnit = ddlUnit + '<option value="' + this.SecondaryUnitId + '-2-2' + '">' + this.SecondaryUnitShortName + '</option>';
                    }
                    if (this.PriceAddedFor == 3) {
                        ddlUnit = ddlUnit + '<option selected value="' + this.TertiaryUnitId + '-3-3' + '">' + this.TertiaryUnitShortName + '</option>';
                    }
                    else {
                        ddlUnit = ddlUnit + '<option value="' + this.TertiaryUnitId + '-3-3' + '">' + this.TertiaryUnitShortName + '</option>';
                    }
                    if (this.PriceAddedFor == 4) {
                        ddlUnit = ddlUnit + '<option value="' + this.QuaternaryUnitId + '-4-4' + '">' + this.QuaternaryUnitShortName + '</option>';
                    }
                    else {
                        ddlUnit = ddlUnit + '<option value="' + this.QuaternaryUnitId + '-4-4' + '">' + this.QuaternaryUnitShortName + '</option>';
                    }
                }
                else if (this.TertiaryUnitId != 0) {
                    //ddlUnit = ddlUnit + '<option selected value="' + this.UnitId + '" hidden>' + this.UnitShortName + '</option>';
                    if (this.PriceAddedFor == 2) {
                        ddlUnit = ddlUnit + '<option selected value="' + this.UnitId + '-2-1' + '">' + this.UnitShortName + '</option>';
                    }
                    else {
                        ddlUnit = ddlUnit + '<option value="' + this.UnitId + '-2-1' + '">' + this.UnitShortName + '</option>';
                    }
                    if (this.PriceAddedFor == 3) {
                        ddlUnit = ddlUnit + '<option selected value="' + this.SecondaryUnitId + '-3-2' + '">' + this.SecondaryUnitShortName + '</option>';
                    }
                    else {
                        ddlUnit = ddlUnit + '<option value="' + this.SecondaryUnitId + '-3-2' + '">' + this.SecondaryUnitShortName + '</option>';
                    }
                    if (this.PriceAddedFor == 4) {
                        ddlUnit = ddlUnit + '<option selected value="' + this.TertiaryUnitId + '-4-3' + '">' + this.TertiaryUnitShortName + '</option>';
                    }
                    else {
                        ddlUnit = ddlUnit + '<option value="' + this.TertiaryUnitId + '-4-3' + '">' + this.TertiaryUnitShortName + '</option>';
                    }
                }
                else if (this.SecondaryUnitId != 0) {
                    //ddlUnit = ddlUnit + '<option selected value="' + this.UnitId + '" hidden>' + this.UnitShortName + '</option>';
                    //ddlUnit = ddlUnit + '<option selected value="' + this.UnitId + '" hidden>' + this.UnitShortName + '</option>';
                    if (this.PriceAddedFor == 3) {
                        ddlUnit = ddlUnit + '<option selected value="' + this.UnitId + '-3-1' + '">' + this.UnitShortName + '</option>';
                    }
                    else {
                        ddlUnit = ddlUnit + '<option value="' + this.UnitId + '-3-1' + '">' + this.UnitShortName + '</option>';
                    }
                    if (this.PriceAddedFor == 4) {
                        ddlUnit = ddlUnit + '<option selected value="' + this.SecondaryUnitId + '-4-2' + '">' + this.SecondaryUnitShortName + '</option>';
                    }
                    else {
                        ddlUnit = ddlUnit + '<option value="' + this.SecondaryUnitId + '-4-2' + '">' + this.SecondaryUnitShortName + '</option>';
                    }
                }
                else {
                    //ddlUnit = ddlUnit + '<option selected value="' + this.UnitId + '" hidden>' + this.UnitShortName + '</option>';
                    //ddlUnit = ddlUnit + '<option selected value="' + this.UnitId + '" hidden>' + this.UnitShortName + '</option>';
                    //ddlUnit = ddlUnit + '<option selected value="' + this.UnitId + '" hidden>' + this.UnitShortName + '</option>';
                    ddlUnit = ddlUnit + '<option selected value="' + this.UnitId + '-4-1' + '">' + this.UnitShortName + '</option>';
                }
                ddlUnit = ddlUnit + '</select >';

                //var EnableEditingProductPrice = $('#hdnEnableEditingProductPrice').val().toLocaleLowerCase();
                var EnableLotNo = $('#hdnEnableLotNo').val().toLocaleLowerCase();
                var EnableItemExpiry = $('#hdnEnableItemExpiry').val().toLocaleLowerCase();
                var ExpiryType = $('#hdnExpiryType').val();
                var EnableMrp = $('#hdnEnableMrp').val().toLocaleLowerCase();

                html = html + '<tr id="trOpeningStock_' + count + '">' +
                    '<td style="min-width:150px;white-space:nowrap;">' +
                    '<input type="text" hidden class="form-control" id="txtItemId' + count + '" value="' + this.ItemId + '">' +
                    '<input type="text" hidden class="form-control" id="txtItemDetailsId' + count + '" value="' + this.ItemDetailsId + '">' +
                    '<input type="text" hidden class="form-control" id="txtOpeningStockId' + count + '" value="' + this.OpeningStockId + '">' +
                    '<span class="' + (this.ItemName.length > 15 ? '' : 'hidden') + '"><b>Name :</b> ' + this.ItemName.substring(0, 15) + '...</span>' +
                    '<span class="' + (this.ItemName.length <= 15 ? '' : 'hidden') + '"><b>Name :</b> ' + this.ItemName + '</span>' +
                    _variation +
                    ' </br> <b>SKU :</b> ' + this.SKU + '' +
                    '</td>' +
                    //'<td> ' + ddlUnit +
                    //'<input type="text" hidden class="form-control" id="hdnPriceAddedFor' + count + '" value="' + this.PriceAddedFor + '">' +
                    //'<input type="text" hidden class="form-control" id="hdnUToSValue' + count + '" value="' + this.UToSValue + '">' +
                    //'<input type="text" hidden class="form-control" id="hdnSToTValue' + count + '" value="' + this.SToTValue + '">' +
                    //'<input type="text" hidden class="form-control" id="hdnTToQValue' + count + '" value="' + this.TToQValue + '">' +
                    //'<input type="text" hidden class="form-control" id="hdnUnitCost' + count + '" value="' + this.UnitCost + '">' +
                    //'<input type="text" hidden class="form-control" id="hdnSalesIncTax' + count + '" value="' + this.OpeningStockSalesIncTax + '">' +
                    //'<input type="text" hidden class="form-control" id="hdnMrp' + count + '" value="' + this.Mrp + '">' +
                    //'<input type="text" hidden class="form-control" id="hdnAllowDecimal' + count + '" value="' + this.AllowDecimal + '">' +
                    //'<input type="text" hidden class="form-control" id="hdnSecondaryUnitAllowDecimal' + count + '" value="' + this.SecondaryUnitAllowDecimal + '">' +
                    //'<input type="text" hidden class="form-control" id="hdnTertiaryUnitAllowDecimal' + count + '" value="' + this.TertiaryUnitAllowDecimal + '">' +
                    //'<input type="text" hidden class="form-control" id="hdnQuaternaryUnitAllowDecimal' + count + '" value="' + this.QuaternaryUnitAllowDecimal + '">' +
                    //'</td>' +
                    '<td>' +
                    '<div class="input-group" style="min-width:150px">' +
                    '<input type="number" class="form-control divQuantity' + count + '_ctrl" value="' + this.Quantity + '" id="txtQuantity' + count + '" onkeypress="return toggleDecimal(event,' + count + ')" onchange="updateOpeningStockSubTotal(' + count + ')"/>' +
                    ddlUnit +
                    '<input type="text" hidden class="form-control" id="hdnPriceAddedFor' + count + '" value="' + this.PriceAddedFor + '">' +
                    '<input type="text" hidden class="form-control" id="hdnUToSValue' + count + '" value="' + this.UToSValue + '">' +
                    '<input type="text" hidden class="form-control" id="hdnSToTValue' + count + '" value="' + this.SToTValue + '">' +
                    '<input type="text" hidden class="form-control" id="hdnTToQValue' + count + '" value="' + this.TToQValue + '">' +
                    '<input type="text" hidden class="form-control" id="hdnUnitCost' + count + '" value="' + this.UnitCost + '">' +
                    '<input type="text" hidden class="form-control" id="hdnSalesIncTax' + count + '" value="' + this.OpeningStockSalesIncTax + '">' +
                    '<input type="text" hidden class="form-control" id="hdnMrp' + count + '" value="' + this.Mrp + '">' +
                    '<input type="text" hidden class="form-control" id="hdnAllowDecimal' + count + '" value="' + this.AllowDecimal + '">' +
                    '<input type="text" hidden class="form-control" id="hdnSecondaryUnitAllowDecimal' + count + '" value="' + this.SecondaryUnitAllowDecimal + '">' +
                    '<input type="text" hidden class="form-control" id="hdnTertiaryUnitAllowDecimal' + count + '" value="' + this.TertiaryUnitAllowDecimal + '">' +
                    '<input type="text" hidden class="form-control" id="hdnQuaternaryUnitAllowDecimal' + count + '" value="' + this.QuaternaryUnitAllowDecimal + '">' +
                    '</div >' +
                    '<small class="text-red font-weight-bold errorText" id="divQuantity' + count + '"></small>' +
                    '</td>' +
                    //'<td>' +
                    //'<input type="text" class="form-control" value="' + this.QuantitySold + '" id="txtQuantitySold' + count + '" disabled/>' +
                    //'</td>' +
                    //'<td>' +
                    //'<input type="text" class="form-control" value="' + this.QuantityRemaining + '" id="txtQuantityRemaining' + count + '" disabled/>' +
                    //'</td>' +
                    '<td style="min-width:130px">' +
                    '<input type="number" class="form-control divUnitCost' + count + '_ctrl" value="' + this.UnitCost + '" id="txtUnitCost' + count + '"  onchange="updateOpeningStockSubTotal(' + count + ')"/>' +
                    '<small class="text-red font-weight-bold errorText" id="divUnitCost' + count + '"></small>' +
                    '</td>' +
                    '<td style="min-width:150px;display:none" id="txtSubTotal' + count + '">' + this.SubTotal + '</td>' +
                    '<td style="min-width:150px" class="' + (EnableLotNo == 'true' ? '' : 'hidden') + '">' +
                    '<input type="text" class="form-control divLotNo' + count + '_ctrl" id="txtLotNo' + count + '" value="' + (this.LotNo == null ? '' : this.LotNo) + '">' +
                    '<small class="text-red font-weight-bold errorText" id="divLotNo' + count + '"></small>' +
                    '</td>' +
                    '<td style="min-width:180px" class="' + ((EnableItemExpiry == 'true' && ExpiryType == '2') ? '' : 'hidden') + '">' +
                    '<div class="input-group date _ManufacturingDate" id="_ManufacturingDate' + count + '" data-target-input="nearest">' +
                    /*'<input id="txtManufacturingDate' + count + '" type="text" class="form-control datetimepicker-input" data-target="#_ManufacturingDate' + count + '" onchange="CalculateExpiryDate(' + count + ')" value="' + (!this.ManufacturingDate ? "" : getFormattedDate(new Date(parseInt(this.ManufacturingDate.replaceAll('/', '').replaceAll('Date', '').replace('(', '').replace(')', ''))).toUTCString())) + '"/>' +*/
                    '<input id="txtManufacturingDate' + count + '" type="text" class="form-control datetimepicker-input" data-target="#_ManufacturingDate' + count + '" onchange="CalculateExpiryDate(' + count + ')" value="' + (!this.ManufacturingDate ? "" : formatDynamicDate(this.ManufacturingDate, ExpiryDateFormat.toUpperCase())) + '"/>' +
                    '<div class="input-group-append" data-target="#_ManufacturingDate' + count + '" data-toggle="datetimepicker">' +
                    '<div class="input-group-text"><i class="fa fa-calendar"></i></div>' +
                    '</div>' +
                    '</div>' +
                    /*'<input type="date" class="form-control" id="txtManufacturingDate' + count + '"  value="' + (!this.ManufacturingDate ? "" : DateFormat(new Date(parseInt(this.ManufacturingDate.replaceAll('/', '').replaceAll('Date', '').replace('(', '').replace(')', ''))).toUTCString())) + '" onchange="CalculateExpiryDate(' + count + ')">' +*/
                    '</td>' +
                    '<td style="min-width:180px" class="' + (EnableItemExpiry == 'true' ? '' : 'hidden') + '">' +
                    '<div class="input-group date _ExpiryDate" id="_ExpiryDate' + count + '" data-target-input="nearest">' +
                    /*'<input id="txtExpiryDate' + count + '" type="text" class="form-control datetimepicker-input" data-target="#_ExpiryDate' + count + '" value="' + (!this.ExpiryDate ? "" : getFormattedDate(new Date(parseInt(this.ExpiryDate.replaceAll('/', '').replaceAll('Date', '').replace('(', '').replace(')', ''))).toUTCString())) + '"/>' +*/
                    '<input id="txtExpiryDate' + count + '" type="text" class="form-control datetimepicker-input" data-target="#_ExpiryDate' + count + '" value="' + (!this.ExpiryDate ? "" : formatDynamicDate(this.ExpiryDate, ExpiryDateFormat.toUpperCase())) + '"/>' +
                    '<div class="input-group-append" data-target="#_ExpiryDate' + count + '" data-toggle="datetimepicker">' +
                    '<div class="input-group-text"><i class="fa fa-calendar"></i></div>' +
                    '</div>' +
                    '</div>' +
                    /*'<input type="date" class="form-control" id="txtExpiryDate' + count + '" value="' + (!this.ExpiryDate ? "" : DateFormat(new Date(parseInt(this.ExpiryDate.replaceAll('/', '').replaceAll('Date', '').replace('(', '').replace(')', ''))).toUTCString())) + '">' +*/
                    '</td>' +
                    '<td style="min-width:250px">' +
                    '<div class="input-group date _Date" id="_Date' + count + '" data-target-input="nearest">' +
                    /*'<input id="txtDate' + count + '" type="text" class="form-control datetimepicker-input divDate' + count + '_ctrl" data-target="#_Date' + count + '" value="' + getFormattedDateTime(new Date(parseInt(this.Date.replaceAll('/', '').replaceAll('Date', '').replace('(', '').replace(')', ''))).toUTCString()) + '"/>' +*/
                    '<input id="txtDate' + count + '" type="text" class="form-control datetimepicker-input divDate' + count + '_ctrl" data-target="#_Date' + count + '" value="' + (!this.Date ? "" : formatDynamicDate(this.Date, DateFormat.toUpperCase())) + '"/>' +
                    '<div class="input-group-append" data-target="#_Date' + count + '" data-toggle="datetimepicker">' +
                    '<div class="input-group-text"><i class="fa fa-calendar"></i></div>' +
                    '</div>' +
                    '</div>' +
                    /*'<input type="datetime-local" class="form-control" value="' + DateTimeFormat(new Date(parseInt(this.Date.replaceAll('/', '').replaceAll('Date', '').replace('(', '').replace(')', ''))).toUTCString()) + '" id="txtDate' + count + '"/>' +*/
                    '<small class="text-red font-weight-bold errorText" id="divDate' + count + '"></small>' +
                    '</td>' +
                    '<td style="min-width:250px">' +
                    /*'<textarea id="txtNotes' + count + '" class="form-control">' + (this.Notes == null ? '' : this.Notes) + '</textarea>' +*/
                    '<input type="text" class="form-control" value="' + (this.Notes == null ? '' : this.Notes) + '" id="txtNotes' + count + '"/>' +
                    '</td>' +
                    '<td style="min-width:130px;">' +
                    /*'<input type="hidden" class="form-control" value="' + this.OpeningStockSalesIncTax + '" id="txtSalesExcTax' + count + '"/>' +*/
                    '<input type="number" class="form-control divSalesExcTax' + count + '_ctrl" value="' + this.SalesExcTax + '" id="txtSalesExcTax' + count + '"/>' +
                    '<input type="hidden" class="form-control" id="txtDefaultProfitMargin' + count + '"  value="' + this.DefaultProfitMargin + '">' +
                    '<small class="text-red font-weight-bold errorText" id="divSalesExcTax' + count + '"></small>' +
                    '</td>' +
                    '<td style="min-width:130px" class="' + (EnableMrp == 'true' ? '' : 'hidden') + '">' +
                    '<input type="number" class="form-control" id="txtMrp' + count + '"  value="' + this.Mrp + '">' +
                    '</td>' +
                    '<td>' +
                    '<button type="button" class="btn btn-danger btn-sm" onclick="deleteOpeningStockCombo(' + count + ',' + this.OpeningStockId + ')">' +
                    '<i class="fas fa-times">' +
                    '</i>' +
                    '</button>' +
                    '</td>' +
                    '</tr>';

                count++;
            });
            $('#divOpeningStock').html('');
            $('#divOpeningStock').append(html);
            
            $('._ManufacturingDate').datetimepicker({ widgetPositioning: { horizontal: 'auto', vertical: 'bottom' }, format: ExpiryDateFormat.toUpperCase() });
            $('._ExpiryDate').datetimepicker({ widgetPositioning: { horizontal: 'auto', vertical: 'bottom' }, format: ExpiryDateFormat.toUpperCase() });
            $('._Date').datetimepicker({ widgetPositioning: { horizontal: 'auto', vertical: 'bottom' }, format: DateFormat.toUpperCase() + ' ' + TimeFormat });
            //$('._ManufacturingDate').addClass('notranslate');
            //$('._ExpiryDate').addClass('notranslate');
            //$('._Date').addClass('notranslate');

            //console.log(new Date());
            //$('#divOpeningStock tr').each(function () {
            //    var i = this.id.split('trOpeningStock_')[1];
            //    if (i != undefined) {
            //        //var _ManufacturingDate = new Date(parseInt($('#txtManufacturingDate' + i).val().replaceAll('/', '').replaceAll('Date', '').replace('(', '').replace(')', ''))).toUTCString();
            //        //var _ExpiryDate = new Date(parseInt($('#txtExpiryDate' + i).val().replaceAll('/', '').replaceAll('Date', '').replace('(', '').replace(')', ''))).toUTCString();
            //        //var _Date = new Date(parseInt($('#txtDate' + i).val().replaceAll('/', '').replaceAll('Date', '').replace('(', '').replace(')', ''))).toUTCString();
            //        var _ExpiryDate = $('#txtExpiryDate' + i).val();
            //        console.log(_ExpiryDate)
            //        //$('#_ManufacturingDate' + i).datetimepicker({ widgetPositioning: { horizontal: 'auto', vertical: 'bottom' }, format: DateFormat.toUpperCase(), defaultDate: _ManufacturingDate });
            //        $('#_ExpiryDate' + i).datetimepicker({ widgetPositioning: { horizontal: 'auto', vertical: 'bottom' }, format: DateFormat.toUpperCase(), defaultDate: _ExpiryDate });
            //        //$('#_Date' + i).datetimepicker({ widgetPositioning: { horizontal: 'auto', vertical: 'bottom' }, format: DateFormat.toUpperCase(), defaultDate: _Date });
            //        //$('#_ManufacturingDate').addClass('notranslate');
            //        //$('#_ExpiryDate').addClass('notranslate');
            //        //$('#_Date').addClass('notranslate');
            //    }
            //});


            $("#divLoading").hide();
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
}

function ItemDetailsForOpeningStock() {
    var det = {
        ItemId: _ItemId,
        Date: $('#txtDate').val(),
        BranchId: $('#ddlStockBranch').val(),
        ItemDetailsId: $('#ddlItemDetails').val()
    };
    $("#divLoading").show();
    $.ajax({
        url: '/items/ItemDetailsForOpeningStock',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {
            var html = '';
            $.each(data.Data.OpeningStocks, function () {
                var _variation = this.VariationName == null ? '' : '<br /><span> <b>Variation:</b> ' + this.VariationName + '</span>';

                var ddlUnit = '<select class="form-control select2" style="width: 100 %; " id="ddlUnit' + count + '" onchange="toggleUnit(' + count + ')">';
                if (this.QuaternaryUnitId != 0) {
                    if (this.PriceAddedFor == 1) {
                        ddlUnit = ddlUnit + '<option selected value="' + this.UnitId + '-1-1' + '">' + this.UnitShortName + '</option>';
                    }
                    else {
                        ddlUnit = ddlUnit + '<option value="' + this.UnitId + '-1-1' + '">' + this.UnitShortName + '</option>';
                    }
                    if (this.PriceAddedFor == 2) {
                        ddlUnit = ddlUnit + '<option selected value="' + this.SecondaryUnitId + '-2-2' + '">' + this.SecondaryUnitShortName + '</option>';
                    }
                    else {
                        ddlUnit = ddlUnit + '<option value="' + this.SecondaryUnitId + '-2-2' + '">' + this.SecondaryUnitShortName + '</option>';
                    }
                    if (this.PriceAddedFor == 3) {
                        ddlUnit = ddlUnit + '<option selected value="' + this.TertiaryUnitId + '-3-3' + '">' + this.TertiaryUnitShortName + '</option>';
                    }
                    else {
                        ddlUnit = ddlUnit + '<option value="' + this.TertiaryUnitId + '-3-3' + '">' + this.TertiaryUnitShortName + '</option>';
                    }
                    if (this.PriceAddedFor == 4) {
                        ddlUnit = ddlUnit + '<option value="' + this.QuaternaryUnitId + '-4-4' + '">' + this.QuaternaryUnitShortName + '</option>';
                    }
                    else {
                        ddlUnit = ddlUnit + '<option value="' + this.QuaternaryUnitId + '-4-4' + '">' + this.QuaternaryUnitShortName + '</option>';
                    }
                }
                else if (this.TertiaryUnitId != 0) {
                    //ddlUnit = ddlUnit + '<option selected value="' + this.UnitId + '" hidden>' + this.UnitShortName + '</option>';
                    if (this.PriceAddedFor == 2) {
                        ddlUnit = ddlUnit + '<option selected value="' + this.UnitId + '-2-1' + '">' + this.UnitShortName + '</option>';
                    }
                    else {
                        ddlUnit = ddlUnit + '<option value="' + this.UnitId + '-2-1' + '">' + this.UnitShortName + '</option>';
                    }
                    if (this.PriceAddedFor == 3) {
                        ddlUnit = ddlUnit + '<option selected value="' + this.SecondaryUnitId + '-3-2' + '">' + this.SecondaryUnitShortName + '</option>';
                    }
                    else {
                        ddlUnit = ddlUnit + '<option value="' + this.SecondaryUnitId + '-3-2' + '">' + this.SecondaryUnitShortName + '</option>';
                    }
                    if (this.PriceAddedFor == 4) {
                        ddlUnit = ddlUnit + '<option selected value="' + this.TertiaryUnitId + '-4-3' + '">' + this.TertiaryUnitShortName + '</option>';
                    }
                    else {
                        ddlUnit = ddlUnit + '<option value="' + this.TertiaryUnitId + '-4-3' + '">' + this.TertiaryUnitShortName + '</option>';
                    }
                }
                else if (this.SecondaryUnitId != 0) {
                    //ddlUnit = ddlUnit + '<option selected value="' + this.UnitId + '" hidden>' + this.UnitShortName + '</option>';
                    //ddlUnit = ddlUnit + '<option selected value="' + this.UnitId + '" hidden>' + this.UnitShortName + '</option>';
                    if (this.PriceAddedFor == 3) {
                        ddlUnit = ddlUnit + '<option selected value="' + this.UnitId + '-3-1' + '">' + this.UnitShortName + '</option>';
                    }
                    else {
                        ddlUnit = ddlUnit + '<option value="' + this.UnitId + '-3-1' + '">' + this.UnitShortName + '</option>';
                    }
                    if (this.PriceAddedFor == 4) {
                        ddlUnit = ddlUnit + '<option selected value="' + this.SecondaryUnitId + '-4-2' + '">' + this.SecondaryUnitShortName + '</option>';
                    }
                    else {
                        ddlUnit = ddlUnit + '<option value="' + this.SecondaryUnitId + '-4-2' + '">' + this.SecondaryUnitShortName + '</option>';
                    }
                }
                else {
                    //ddlUnit = ddlUnit + '<option selected value="' + this.UnitId + '" hidden>' + this.UnitShortName + '</option>';
                    //ddlUnit = ddlUnit + '<option selected value="' + this.UnitId + '" hidden>' + this.UnitShortName + '</option>';
                    //ddlUnit = ddlUnit + '<option selected value="' + this.UnitId + '" hidden>' + this.UnitShortName + '</option>';
                    ddlUnit = ddlUnit + '<option selected value="' + this.UnitId + '-4-1' + '">' + this.UnitShortName + '</option>';
                }

                ddlUnit = ddlUnit + '</select >';

                //var EnableEditingProductPrice = $('#hdnEnableEditingProductPrice').val().toLocaleLowerCase();
                var EnableLotNo = $('#hdnEnableLotNo').val().toLocaleLowerCase();
                var EnableItemExpiry = $('#hdnEnableItemExpiry').val().toLocaleLowerCase();
                var ExpiryType = $('#hdnExpiryType').val();
                var EnableMrp = $('#hdnEnableMrp').val().toLocaleLowerCase();

                html = html + '<tr id="trOpeningStock_' + count + '">' +
                    '<td style="min-width:150px;white-space:nowrap;">' +
                    '<input type="text" hidden class="form-control" id="txtItemId' + count + '" value="' + this.ItemId + '">' +
                    '<input type="text" hidden class="form-control" id="txtItemDetailsId' + count + '" value="' + this.ItemDetailsId + '">' +
                    '<input type="text" hidden class="form-control" id="txtOpeningStockId' + count + '" value="' + this.OpeningStockId + '">' +
                    '<span class="' + (this.ItemName.length > 15 ? '' : 'hidden') + '"><b>Name :</b> ' + this.ItemName.substring(0, 15) + '...</span>' +
                    '<span class="' + (this.ItemName.length <= 15 ? '' : 'hidden') + '"><b>Name :</b> ' + this.ItemName + '</span>' +
                    _variation +
                    ' </br> <b>SKU :</b> ' + this.SKU + '' +
                    '</td>' +
                    //'<td style="min-width:130px"> ' + ddlUnit +
                    //'<input type="text" hidden class="form-control" id="hdnPriceAddedFor' + count + '" value="' + this.PriceAddedFor + '">' +
                    //'<input type="text" hidden class="form-control" id="hdnUToSValue' + count + '" value="' + this.UToSValue + '">' +
                    //'<input type="text" hidden class="form-control" id="hdnSToTValue' + count + '" value="' + this.SToTValue + '">' +
                    //'<input type="text" hidden class="form-control" id="hdnTToQValue' + count + '" value="' + this.TToQValue + '">' +
                    //'<input type="text" hidden class="form-control" id="hdnUnitCost' + count + '" value="' + this.PurchaseExcTax + '">' +
                    //'<input type="text" hidden class="form-control" id="hdnSalesIncTax' + count + '" value="' + this.SalesIncTax + '">' +
                    //'<input type="text" hidden class="form-control" id="hdnMrp' + count + '" value="' + this.DefaultMrp + '">' +
                    //'</td>' +
                    '<td>' +
                    '<div class="input-group" style="min-width:150px">' +
                    '<input type="number" class="form-control divQuantity' + count + '_ctrl" value="0" id="txtQuantity' + count + '" onchange="updateOpeningStockSubTotal(' + count + ')"/>' +
                    ddlUnit +
                    '<input type="text" hidden class="form-control" id="hdnPriceAddedFor' + count + '" value="' + this.PriceAddedFor + '">' +
                    '<input type="text" hidden class="form-control" id="hdnUToSValue' + count + '" value="' + this.UToSValue + '">' +
                    '<input type="text" hidden class="form-control" id="hdnSToTValue' + count + '" value="' + this.SToTValue + '">' +
                    '<input type="text" hidden class="form-control" id="hdnTToQValue' + count + '" value="' + this.TToQValue + '">' +
                    '<input type="text" hidden class="form-control" id="hdnUnitCost' + count + '" value="' + this.PurchaseExcTax + '">' +
                    '<input type="text" hidden class="form-control" id="hdnSalesIncTax' + count + '" value="' + this.SalesIncTax + '">' +
                    '<input type="text" hidden class="form-control" id="hdnMrp' + count + '" value="' + this.DefaultMrp + '">' +
                    '</div >' +
                    '<small class="text-red font-weight-bold errorText" id="divQuantity' + count + '"></small>' +
                    '</td>' +
                    //'<td>' +
                    //'<input type="text" class="form-control" value="' + this.QuantitySold + '" id="txtQuantitySold' + count + '" disabled/>' +
                    //'</td>' +
                    //'<td>' +
                    //'<input type="text" class="form-control" value="' + this.QuantityRemaining + '" id="txtQuantityRemaining' + count + '" disabled/>' +
                    //'</td>' +
                    '<td style="min-width:130px">' +
                    '<input type="number" class="form-control divUnitCost' + count + '_ctrl" value="' + this.PurchaseExcTax + '" id="txtUnitCost' + count + '"  onchange="updateOpeningStockSubTotal(' + count + ')"/>' +
                    '<small class="text-red font-weight-bold errorText" id="divUnitCost' + count + '"></small>' +
                    '</td>' +
                    '<td style="display:none" id="txtSubTotal' + count + '">0</td>' +
                    '<td style="min-width:150px" class="' + (EnableLotNo == 'true' ? '' : 'hidden') + '">' +
                    '<input type="text" class="form-control divLotNo' + count + '_ctrl" id="txtLotNo' + count + '">' +
                    '<small class="text-red font-weight-bold errorText" id="divLotNo' + count + '"></small>' +
                    '</td>' +
                    '<td style="min-width:180px" class="' + ((EnableItemExpiry == 'true' && ExpiryType == '2') ? '' : 'hidden') + '" >' +
                    '<div class="input-group date _ManufacturingDate" id="_ManufacturingDate' + count + '" data-target-input="nearest">' +
                    '<input id="txtManufacturingDate' + count + '" type="text" class="form-control datetimepicker-input" data-target="#_ManufacturingDate' + count + '" onchange="CalculateExpiryDate(' + count + ')"/>' +
                    '<div class="input-group-append" data-target="#_ManufacturingDate' + count + '" data-toggle="datetimepicker">' +
                    '<div class="input-group-text"><i class="fa fa-calendar"></i></div>' +
                    '</div>' +
                    '</div>' +
                    /*'<input type="date" class="form-control" id="txtManufacturingDate' + count + '" onchange="CalculateExpiryDate(' + count + ')">' +*/
                    '</td>' +
                    '<td style="min-width:180px" class="' + (EnableItemExpiry == 'true' ? '' : 'hidden') + '">' +
                    '<div class="input-group date _ExpiryDate" id="_ExpiryDate' + count + '" data-target-input="nearest">' +
                    '<input id="txtExpiryDate' + count + '" type="text" class="form-control datetimepicker-input" data-target="#_ExpiryDate' + count + '" />' +
                    '<div class="input-group-append" data-target="#_ExpiryDate' + count + '" data-toggle="datetimepicker">' +
                    '<div class="input-group-text"><i class="fa fa-calendar"></i></div>' +
                    '</div>' +
                    '</div>' +
                    /*'<input type="date" class="form-control" id="txtExpiryDate' + count + '">' +*/
                    '</td>' +
                    '<td style="min-width:250px">' +
                    '<div class="input-group date _Date" id="_Date' + count + '" data-target-input="nearest">' +
                    '<input id="txtDate' + count + '" type="text" class="form-control datetimepicker-input divDate' + count + '_ctrl" data-target="#_Date' + count + '" />' +
                    '<div class="input-group-append" data-target="#_Date' + count + '" data-toggle="datetimepicker">' +
                    '<div class="input-group-text"><i class="fa fa-calendar"></i></div>' +
                    '</div>' +
                    '</div>' +
                    /*'<input type="datetime-local" class="form-control" value="' + this.Date + '" id="txtDate' + count + '"/>' +*/
                    '<small class="text-red font-weight-bold errorText" id="divDate' + count + '"></small>' +
                    '</td>' +
                    '<td style="min-width:250px">' +
                    /*  '<textarea id="txtNotes' + count + '" class="form-control">' + this.Notes + '</textarea>' +*/
                    '<input type="text" class="form-control" value="' + this.Notes + '" id="txtNotes' + count + '"/>' +
                    '</td>' +
                    '<td style="min-width:130px;">' +
                    /*'<input type="hidden" class="form-control" value="' + this.SalesIncTax + '" id="txtSalesExcTax' + count + '"/>' +*/
                    '<input type="number" class="form-control divSalesExcTax' + count + '_ctrl" value="' + this.SalesExcTax + '" id="txtSalesExcTax' + count + '" />' +
                    '<input type="hidden" class="form-control" id="txtDefaultProfitMargin' + count + '"  value="' + this.DefaultProfitMargin + '">' +
                    '<small class="text-red font-weight-bold errorText" id="divSalesExcTax' + count + '"></small>' +
                    '</td>' +
                    '<td style="min-width:130px" class="' + (EnableMrp == 'true' ? '' : 'hidden') + '">' +
                    '<input type="number" class="form-control" id="txtMrp' + count + '"  value="' + this.DefaultMrp + '">' +
                    '</td>' +
                    '<td>' +
                    '<button type="button" class="btn btn-danger btn-sm" onclick="deleteOpeningStockCombo(' + count + ')">' +
                    '<i class="fas fa-times">' +
                    '</i>' +
                    '</button>' +
                    '</td>' +
                    '</tr>';
                count++;
            });
            $('#divOpeningStock').append(html);

            var ExpiryDateFormat = Cookies.get('ItemSetting').split('&')[0].split('=')[1];
            var DateFormat = Cookies.get('BusinessSetting').split('&')[0].split('=')[1];
            var TimeFormat = Cookies.get('BusinessSetting').split('&')[1].split('=')[1].replace('tt', 'a').replace('tt', 'a');
            $('._ManufacturingDate').datetimepicker({ widgetPositioning: { horizontal: 'auto', vertical: 'bottom' }, format: ExpiryDateFormat.toUpperCase() });
            $('._ExpiryDate').datetimepicker({ widgetPositioning: { horizontal: 'auto', vertical: 'bottom' }, format: ExpiryDateFormat.toUpperCase() });
            $('._Date').datetimepicker({ widgetPositioning: { horizontal: 'auto', vertical: 'bottom' }, format: DateFormat.toUpperCase() + ' ' + TimeFormat, defaultDate: new Date() });
            $('._ManufacturingDate').addClass('notranslate');
            $('._ExpiryDate').addClass('notranslate');
            $('._Date').addClass('notranslate');

            $("#divLoading").hide();
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
}

function AvailableBranches(itemid, isOpeningStockOpen) {
    _isOpeningStockOpen = isOpeningStockOpen;
    _ItemId = itemid;
    var det = {
        ItemId: itemid,
    };
    $("#divLoading").show();
    $.ajax({
        url: '/items/AvailableBranches',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {
            $("#ddlStockBranch").html('');
            $.each(data.Data.Branchs, function () {
                $("#ddlStockBranch").append($("<option/>").val(this.BranchId).text(this.Branch));
            });

            if (data.Data.Branchs.length == 1) {
                $("#ddlStockBranch").prop('disabled', true);
            }
            else {
                $("#ddlStockBranch").prop('disabled', false);
            }

            $("#ddlItemDetails").html('');
            $.each(data.Data.ItemDetails, function () {
                $("#ddlItemDetails").append($("<option/>").val(this.ItemDetailsId).text(this.VariationName + '-' + this.SKU));
            });

            if (data.Data.ItemDetails[0].ProductType.toLowerCase() == 'variable') {
                $('.divVariations').show();
            }
            else {
                $('.divVariations').hide();
            }
            OpeningStock();
            $("#openingStockModal").modal('show');
            $("#divLoading").hide();
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
}

function UpdateOpeningStock(type) {
    var ExpiryDateFormat = Cookies.get('ItemSetting').split('&')[0].split('=')[1];
    var DateFormat = Cookies.get('BusinessSetting').split('&')[0].split('=')[1];
    var TimeFormat = Cookies.get('BusinessSetting').split('&')[1].split('=')[1].replace('tt', 'a').replace('tt', 'a');

    $('.errorText').hide();
    $('[style*="border: 2px"]').css('border', '');

    _i = type;
    var OpeningStock = [];
    $('#tblOpeningStock tr').each(function () {
        var _id = this.id.split('trOpeningStock_')[1];
        if (_id != undefined) {

            //var hiddenOptionsCount = 0;
            //$("#ddlUnit" + _id + " option").each(function () {
            //    if ($(this)[0].outerHTML.indexOf('hidden') > -1) {
            //        hiddenOptionsCount++;
            //    }
            //});

            //if ($('#txtQuantity' + _id).val() > 0) {
            OpeningStock.push({
                OpeningStockId: $('#txtOpeningStockId' + _id).val(),
                ItemDetailsId: $('#txtItemDetailsId' + _id).val(),
                Quantity: $('#txtQuantity' + _id).val(),
                UnitCost: $('#txtUnitCost' + _id).val(),
                SubTotal: $('#txtSubTotal' + _id).text(),
                Notes: $('#txtNotes' + _id).val(),
                //PriceAddedFor: $("#ddlUnit" + _id)[0].selectedIndex + 1,
                PriceAddedFor: $("#ddlUnit" + _id).val().split('-')[1],
                Date: moment($("#txtDate" + _id).val(), DateFormat.toUpperCase() + ' ' + TimeFormat).format('DD-MM-YYYY HH:mm'),
                SalesExcTax: $('#txtSalesExcTax' + _id).val(),
                SalesIncTax: $('#txtSalesIncTax' + _id).val(),
                LotNo: $('#txtLotNo' + _id).val(),
                ManufacturingDate: moment($("#txtManufacturingDate" + _id).val(), ExpiryDateFormat.toUpperCase()).format('DD-MM-YYYY'),
                ExpiryDate: moment($("#txtExpiryDate" + _id).val(), ExpiryDateFormat.toUpperCase()).format('DD-MM-YYYY'),
                DivId: _id,
                //UnitAddedFor: ($("#ddlUnit" + _id)[0].selectedIndex + 1) - hiddenOptionsCount,
                UnitAddedFor: $("#ddlUnit" + _id).val().split('-')[2],
                Mrp: $("#txtMrp" + _id).val(),
                IsDeleted: $("#trOpeningStock_" + _id).is(":hidden")
            })
            //}
        }
    });

    var det = {
        OpeningStockId: _OpeningStockId,
        ItemId: _ItemId,
        Date: $('#txtDate').val(),
        BranchId: $('#ddlStockBranch').val(),
        ItemDetailsId: $('#ddlItemDetails').val(),
        IsActive: true,
        IsDeleted: false,
        OpeningStocks: OpeningStock,
        CheckStockPriceMismatch: _CheckStockPriceMismatch,
    };
    $("#divLoading").show();
    $.ajax({
        url: '/items/OpeningStockInsert',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {

            $("#divLoading").hide();
            if (data == "True") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }
            else if (data == "False") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }

            if (data.Status == 0) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error(data.Message);
            }
            else if (data.Status == 2) {
                if (EnableSound == 'True') { document.getElementById('error').play(); } toastr.error('Invalid inputs, check and try again !!');

                data.Errors.forEach(function (res) {
                    $('#' + res.Id).show();
                    $('#' + res.Id).text(res.Message);


                    if ($('.' + res.Id + '_ctrl').children("select").length > 0) {
                        var element = $("." + res.Id + '_ctrl select');
                        if (element.hasClass("select2-hidden-accessible")) {
                            $('.' + res.Id + '_ctrl .select2-container .select2-selection').css('border', '2px solid #dc3545');
                        } else {
                            $('.' + res.Id + '_ctrl select').css('border', '2px solid #dc3545');
                        }
                    }
                    else {
                        $('.' + res.Id + '_ctrl').css('border', '2px solid #dc3545');
                    }
                });
            }
            else if (data.Status == 3) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                $('#divStockAlertMsg').html('');
                $('#divStockAlertMsg').append('<label> Stock Items Selling Price mismatch. Check details below</label><br /><br />');

                var stockAlertCounter = 1;
                data.Errors.forEach(function (res) {
                    $('#divStockAlertMsg').append('<div>' + stockAlertCounter + '. ' + res.Message + '</div>');
                    stockAlertCounter = stockAlertCounter + 1;
                });

                $('#divStockAlertMsg').append('<br /><br /><br /><div style="font-size:0.9rem"> Your can click cancel button to wait till your previous stock gets cleared out or you can click on continue button and add these stock and start selling at new price</div> ');

                $('#stockAlertModal').modal('toggle');
            }
            else {
                if (EnableSound == 'True') { document.getElementById('success').play(); }
                toastr.success(data.Message);
                if (type == 2) {
                    $("#openingStockModal").modal('hide');
                }
                else {
                    refreshOpeningStock();
                }
                //if (_isOpeningStockOpen == false) {
                //    $("#openingStockModal").modal('hide');
                //    //$('#txtDate').val('');
                //    //$('#txtNotes').val('');
                //}
            }
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
};

function confirmStockAlertInsert() {
    _CheckStockPriceMismatch = false;
    UpdateOpeningStock(_i);
    $('#stockAlertModal').modal('toggle');
}

function refreshOpeningStock() {
    OpeningStock();
}

function updateOpeningStockSubTotal(id) {
    $('#txtSubTotal' + id).text((parseFloat($('#txtQuantity' + id).val()) * parseFloat($('#txtUnitCost' + id).val())).toFixed(2));

    let ProfitMargin = $('#txtDefaultProfitMargin' + id).val() == undefined ? 0 : $('#txtDefaultProfitMargin' + id).val();
    $('#txtSalesExcTax' + id).val(Math.round((((parseFloat(ProfitMargin) / 100) * parseFloat($('#txtUnitCost' + id).val())) + parseFloat($('#txtUnitCost' + id).val())) * 100) / 100);
    $('#txtSalesIncTax' + id).val(Math.round((((parseFloat(ProfitMargin) / 100) * parseFloat($('#txtUnitCost' + id).val())) + parseFloat($('#txtUnitCost' + id).val())) * 100) / 100);
}

function openStockReport(itemid) {
    //window.location.href = '/inventoryreports/stockledger?ItemId=' + itemid + '&ItemDetailsId=0&BranchId=' + $('#ddlBranch').val();
    window.location.href = '/inventoryreports/stockledger?ItemId=' + itemid + '&ItemDetailsId=0&BranchId=0';
}

function fetchItemCodes() {
    var det = {
        ItemCodeType: $('#ddlItemType').val() == 'Product' ? "HSN" : "SAC"
    };
    //$("#divLoading").show();
    $.ajax({
        url: '/othersettings/ActiveItemCodes',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {
            $("#divLoading").hide();
            //$("#p_ItemCodes_Dropdown").html(data);

            $("#ddlItemCode").empty();
            $("#ddlItemCode").append($("<option/>").val(0).text('Select'));
            for (let i = 0; i < data.Data.ItemCodes.length; i++) {
                $("#ddlItemCode").append($("<option/>").val(data.Data.ItemCodes[i].ItemCodeId).text(data.Data.ItemCodes[i].Code));
            }


            checkItemType();
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
}

function checkItemType() {
    if ($('#ddlItemType').val() == 'Product') {
        $('#lblSkuCode').html('Sku Code / Product Code <i tabindex="0" class="fa fa-info-circle text-info hover-q no-print ' + (ShowHelpText == "True" ? "" : "hidden") + '" role="button" data-toggle="popover" data-trigger="focus" title="" data-content="Leave blank to auto generate"></i>');
        $('#lblHsnCode').text('HSN Code');
        $('#lblProductName').html('Product Name <span class="danger">*</span>');
        $('#lblProductImage').text('Product Image');
        $('#lblProductBrochure').text('Product Brochure');
        $('#lblProductDescription').text('Product Description');
        $('.service').show();
        $('.divSecondaryUnit').hide();
        $('.divTertiaryUnit').hide();
        $('.divQuaternaryUnit').hide();
        $('#chkEnableSecondaryUnit').prop('checked', false);
        $('#chkEnableTertiaryUnit').prop('checked', false);
        $('#chkEnableQuaternaryUnit').prop('checked', false);
        $('#chkIsManageStock').prop('checked', true);
        $('#divAlertQuantity').show();
    }
    else {
        $('#lblSkuCode').html('Sku Code / Service Code <i tabindex="0" class="fa fa-info-circle text-info hover-q no-print ' + (ShowHelpText == "True" ? "" : "hidden") + '" role="button" data-toggle="popover" data-trigger="focus" title="" data-content="Leave blank to auto generate"></i>');
        $('#lblHsnCode').text('SAC Code');
        $('#lblProductName').html('Service Name <span class="danger">*</span>');
        $('#lblProductImage').text('Service Image');
        $('#lblProductBrochure').text('Service Brochure');
        $('#lblProductDescription').text('Service Description');
        $('.service').hide();
        $('#divExpiresIn').hide();
        $('#chkIsManageStock').prop('checked', false);
        $('#divAlertQuantity').hide();
    }

    $("[data-toggle=popover]").popover({
        html: true,
        trigger: "hover",
        placement: 'auto',
    });

    initializeSelect2InScope();
}

function AvailableSellingPriceGroups(id) {
    var det = {
        ItemId: id,
    };
    $("#divLoading").show();
    $.ajax({
        url: '/items/AvailableSellingPriceGroups',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {
            $("#AvailableSellingPriceGroupsModal").modal('show');
            $("#divSellingPriceGroups").html(data);
            $("#divLoading").hide();

            $("[data-toggle=popover]").popover({
                html: true,
                trigger: "hover",
                placement: 'auto',
            });
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
}

function UpdateAvailableSellingPriceGroups() {
    var c = 1, counter = 0;
    var ItemDetails = [];
    var ItemId = 0; var ItemDetailsId = 0; var SellingPrice = 0;

    $('#tblAvailableSellingPriceGroups tr').each(function () {
        var _id = this.id.split('divAvailableSellingPriceGroups')[1];
        if (_id != undefined) {
            ItemId = $('#hdnItemId' + _id).val();
            ItemDetailsId = $('#hdnItemDetailsId' + _id).val();
            counter = $('#hdnSellingPriceGroupsCount' + _id).val();

            for (var i = 1; i < counter; i++) {
                var _innerId = _id + i;
                ItemDetails.push({
                    ItemId: ItemId,
                    ItemDetailsId: ItemDetailsId,
                    SellingPrice: $('#txtSellingPice' + _innerId).val(),
                    DiscountType: $('#ddlDiscountType' + _innerId).val(),
                    SellingPriceGroupId: $('#hdnSellingPriceGroupId' + _innerId).val(),
                });
            }
        }
    });

    //$("#tblAvailableSellingPriceGroups tr").each(function () {
    //    $(this).find("input").each(function () {
    //        debugger
    //        if (c == 1) {
    //            ItemId = this.value;
    //        }
    //        else if (c == 2) {
    //            ItemDetailsId = this.value;
    //        }
    //        else if (c > 2 && c % 2 != 0) {
    //            SellingPrice = this.value;
    //        }
    //        else {
    //            ItemDetails.push({
    //                ItemId: ItemId,
    //                ItemDetailsId: ItemDetailsId,
    //                SellingPrice: SellingPrice,
    //                SellingPriceGroupId: this.value
    //            });

    //            SellingPrice = 0;
    //        }

    //        c++;
    //    });
    //    c = 1;
    //});

    var det = {
        ItemDetails
    };
    $("#divLoading").show();
    $.ajax({
        url: '/items/UpdateAvailableSellingPriceGroups',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {
            $("#AvailableSellingPriceGroupsModal").modal('toggle');
            $("#divLoading").hide();
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
}

function fetchActiveSecondaryUnits() {
    if ($('#chkEnableSecondaryUnit').is(':checked')) {
        if ($('#ddlUnit').val() == '0') {
            if (EnableSound == 'True') { document.getElementById('error').play(); }
            toastr.error('Select Unit first');

            $('#chkEnableSecondaryUnit').attr('checked', false);
            return;
        }
        $('.divSecondaryUnit').show();
        var det = {
            UnitId: $('#ddlUnit').val()
        };
        _PageIndex = det.PageIndex;
        $("#divLoading").show();
        $.ajax({
            url: '/itemsettings/ActiveSecondaryUnits',
            datatype: "json",
            data: det,
            type: "post",
            success: function (data) {
                $("#ddlSecondaryUnit").html('');
                //$("#ddlSecondaryUnit").append($("<option></option>").val(0).html('Select'));
                $.each(data.Data.SecondaryUnits, function (i, value) {
                    $("#ddlSecondaryUnit").append($("<option></option>").val(value.SecondaryUnitId).html(value.SecondaryUnitShortName));
                });
                $('.txtUnit').text('1 ' + $("#ddlUnit").children("option").filter(":selected").text() + ' =');
                $('.txtSecondaryUnit').text($("#ddlSecondaryUnit").children("option").filter(":selected").text());

                $('#ddlPriceAddedFor').html('');
                $('#ddlPriceAddedFor').append($('<option selected="selected" value="3">Unit</option><option value="4"> Secondary Unit</option>'));

                $("#divLoading").hide();
            },
            error: function (xhr) {
                $("#divLoading").hide();
            }
        });
    }
    else {
        $('.divSecondaryUnit').hide();
        $('#ddlSecondaryUnit').html('');
        $('#txtUToSValue').val(0);

        $('.divTertiaryUnit').hide();
        $('#chkEnableTertiaryUnit').prop('checked', false);
        $('#ddlTertiaryUnit').html('');
        $('#txtSToTValue').val(0);

        $('.divQuaternaryUnit').hide();
        $('#chkEnableQuaternaryUnit').prop('checked', false);
        $('#ddlQuaternaryUnit').html('');
        $('#txtTToQValue').val(0);

        $('#ddlPriceAddedFor').html('');
        $('#ddlPriceAddedFor').append($('<option selected="selected" value="4">Unit</option>'));
    }
};

function fetchActiveTertiaryUnits() {
    if ($('#chkEnableTertiaryUnit').is(':checked')) {
        if ($('#ddlSecondaryUnit').val() == '0') {
            if (EnableSound == 'True') { document.getElementById('error').play(); }
            toastr.error('Select Secondary Unit first');

            $('#chkEnableTertiaryUnit').attr('checked', false);
            return;
        }
        $('.divTertiaryUnit').show();
        var det = {
            SecondaryUnitId: $('#ddlSecondaryUnit').val()
        };
        _PageIndex = det.PageIndex;
        $("#divLoading").show();
        $.ajax({
            url: '/itemsettings/ActiveTertiaryUnits',
            datatype: "json",
            data: det,
            type: "post",
            success: function (data) {
                $("#ddlTertiaryUnit").html('');
                //$("#ddlTertiaryUnit").append($("<option></option>").val(0).html('Select'));
                $.each(data.Data.TertiaryUnits, function (i, value) {
                    $("#ddlTertiaryUnit").append($("<option></option>").val(value.TertiaryUnitId).html(value.TertiaryUnitShortName));
                });
                $('.txtSecondaryUnit_').text('1 ' + $("#ddlSecondaryUnit").children("option").filter(":selected").text() + ' =');
                $('.txtTertiaryUnit').text($("#ddlTertiaryUnit").children("option").filter(":selected").text());

                $('#ddlPriceAddedFor').html('');
                $('#ddlPriceAddedFor').append($('<option selected="selected" value="2">Unit</option><option value="3"> Secondary Unit</option> <option value="4">Tertiary Unit</option>'));

                $("#divLoading").hide();
            },
            error: function (xhr) {
                $("#divLoading").hide();
            }
        });
    }
    else {
        $('.txtSecondaryUnit').text($("#ddlSecondaryUnit").children("option").filter(":selected").text());
        $('.divTertiaryUnit').hide();
        $('#ddlTertiaryUnit').html('');
        $('#txtSToTValue').val(0);

        $('.divQuaternaryUnit').hide();
        $('#chkEnableQuaternaryUnit').prop('checked', false);
        $('#ddlQuaternaryUnit').html('');
        $('#txtTToQValue').val(0);

        $('#ddlPriceAddedFor').html('');
        $('#ddlPriceAddedFor').append($('<option selected="selected" value="3">Unit</option><option value="4"> Secondary Unit</option>'));
    }
}

function fetchActiveQuaternaryUnits() {
    if ($('#chkEnableQuaternaryUnit').is(':checked')) {
        if ($('#ddlTertiaryUnit').val() == '0') {
            if (EnableSound == 'True') { document.getElementById('error').play(); }
            toastr.error('Select Tertiary Unit first');

            $('#chkEnableQuaternaryUnit').attr('checked', false);
            return;
        }
        $('.divQuaternaryUnit').show();
        var det = {
            TertiaryUnitId: $('#ddlTertiaryUnit').val()
        };
        _PageIndex = det.PageIndex;
        $("#divLoading").show();
        $.ajax({
            url: '/itemsettings/ActiveQuaternaryUnits',
            datatype: "json",
            data: det,
            type: "post",
            success: function (data) {
                $("#ddlQuaternaryUnit").html('');
                //$("#ddlQuaternaryUnit").append($("<option></option>").val(0).html('Select'));
                $.each(data.Data.QuaternaryUnits, function (i, value) {
                    $("#ddlQuaternaryUnit").append($("<option></option>").val(value.QuaternaryUnitId).html(value.QuaternaryUnitName));
                });
                $('.txtTertiaryUnit_').text('1 ' + $("#ddlTertiaryUnit").children("option").filter(":selected").text() + ' =');
                $('.txtQuaternaryUnit').text($("#ddlQuaternaryUnit").children("option").filter(":selected").text());

                $('#ddlPriceAddedFor').html('');
                $('#ddlPriceAddedFor').append($('<option selected="selected" value="1">Unit</option><option value="2"> Secondary Unit</option> <option value="3">Tertiary Unit</option><option value="4">Quaternary Unit</option>'));

                $("#divLoading").hide();
            },
            error: function (xhr) {
                $("#divLoading").hide();
            }
        });
    }
    else {
        $('.txtTertiaryUnit').text($("#ddlTertiaryUnit").children("option").filter(":selected").text());
        $('.divQuaternaryUnit').hide();
        $('#ddlQuaternaryUnit').html('');
        $('#txtTToQValue').val(0);

        $('#ddlPriceAddedFor').html('');
        $('#ddlPriceAddedFor').append($('<option selected="selected" value="2">Unit</option><option value="3"> Secondary Unit</option> <option value="4">Tertiary Unit</option>'));
    }
}

function toggleQuaternaryUnit() {
    $('.txtQuaternaryUnit').text($("#ddlQuaternaryUnit").children("option").filter(":selected").text());
}

function toggleUnit(i) {
    var index = $("#ddlUnit" + i).val().split('-')[1];//[0].selectedIndex + 1;
    var PriceAddedFor = $('#hdnPriceAddedFor' + i).val();
    var UToSValue = parseFloat($('#hdnUToSValue' + i).val());// == 0 ? 1 : $('#hdnUToSValue' + i).val());
    var SToTValue = parseFloat($('#hdnSToTValue' + i).val());// == 0 ? 1 : $('#hdnSToTValue' + i).val());
    var TToQValue = parseFloat($('#hdnTToQValue' + i).val());// == 0 ? 1 : $('#hdnTToQValue' + i).val());

    var UnitCost = $('#hdnUnitCost' + i).val();
    var SalesCost = $('#hdnSalesIncTax' + i).val();
    var Mrp = $('#hdnMrp' + i).val();
    var newUnitCost = 0, newSalesCost = 0, newMrp = 0;

    var PrimaryUnitCost = 0, SecondaryUnitCost = 0, TertiaryUnitCost = 0, QuaternaryUnitCost = 0;
    var PrimarySalesCost = 0, SecondarySalesCost = 0, TertiarySalesCost = 0, QuaternarySalesCost = 0;
    var PrimaryMrp = 0, SecondaryMrp = 0, TertiaryMrp = 0, QuaternaryMrp = 0;

    if (UToSValue == 0 && SToTValue == 0 && TToQValue == 0) {
        PrimaryUnitCost = UnitCost;
        PrimarySalesCost = SalesCost;
        PrimaryMrp = Mrp;
    }
    else if (SToTValue == 0 && TToQValue == 0) {
        if (PriceAddedFor == 4) {
            PrimaryUnitCost = UnitCost * UToSValue;
            PrimarySalesCost = SalesCost * UToSValue;
            PrimaryMrp = Mrp * UToSValue;

            SecondaryUnitCost = UnitCost;
            SecondarySalesCost = SalesCost;
            SecondaryMrp = Mrp;
        }
        else if (PriceAddedFor == 3) {
            PrimaryUnitCost = UnitCost;
            PrimarySalesCost = SalesCost;
            PrimaryMrp = Mrp;

            SecondaryUnitCost = UnitCost / UToSValue;
            SecondarySalesCost = SalesCost / UToSValue;
            SecondaryMrp = Mrp / UToSValue;
        }
    }
    else if (TToQValue == 0) {
        if (PriceAddedFor == 4) {
            PrimaryUnitCost = UnitCost * UToSValue * SToTValue;
            PrimarySalesCost = SalesCost * UToSValue * SToTValue;
            PrimaryMrp = Mrp * UToSValue * SToTValue;

            SecondaryUnitCost = UnitCost * SToTValue;
            SecondarySalesCost = SalesCost * SToTValue;
            SecondaryMrp = Mrp * SToTValue;

            TertiaryUnitCost = UnitCost;
            TertiarySalesCost = SalesCost;
            TertiaryMrp = Mrp;
        }
        else if (PriceAddedFor == 3) {
            PrimaryUnitCost = UnitCost * UToSValue;
            PrimarySalesCost = SalesCost * UToSValue;
            PrimaryMrp = Mrp * UToSValue;

            SecondaryUnitCost = UnitCost;
            SecondarySalesCost = SalesCost;
            SecondaryMrp = Mrp;

            TertiaryUnitCost = UnitCost / SToTValue;
            TertiarySalesCost = SalesCost / SToTValue;
            TertiaryMrp = Mrp / SToTValue;
        }
        else if (PriceAddedFor == 2) {
            PrimaryUnitCost = UnitCost;
            PrimarySalesCost = SalesCost;
            PrimaryMrp = Mrp;

            SecondaryUnitCost = UnitCost / UToSValue;
            SecondarySalesCost = SalesCost / UToSValue;
            SecondaryMrp = Mrp / UToSValue;

            TertiaryUnitCost = UnitCost / UToSValue / SToTValue;
            TertiarySalesCost = SalesCost / UToSValue / SToTValue;
            TertiaryMrp = Mrp / UToSValue / SToTValue;
        }
    }
    else {
        if (PriceAddedFor == 4) {
            PrimaryUnitCost = UnitCost * UToSValue * SToTValue * TToQValue;
            PrimarySalesCost = SalesCost * UToSValue * SToTValue * TToQValue;
            PrimaryMrp = Mrp * UToSValue * SToTValue * TToQValue;

            SecondaryUnitCost = UnitCost * SToTValue * TToQValue;
            SecondarySalesCost = SalesCost * SToTValue * TToQValue;
            SecondaryMrp = Mrp * SToTValue * TToQValue;

            TertiaryUnitCost = UnitCost * TToQValue;
            TertiarySalesCost = SalesCost * TToQValue;
            TertiaryMrp = Mrp * TToQValue;

            QuaternaryUnitCost = UnitCost;
            QuaternarySalesCost = SalesCost;
            QuaternaryMrp = Mrp;
        }
        else if (PriceAddedFor == 3) {
            PrimaryUnitCost = UnitCost * UToSValue * SToTValue;
            PrimarySalesCost = SalesCost * UToSValue * SToTValue;
            PrimaryMrp = Mrp * UToSValue * SToTValue;

            SecondaryUnitCost = UnitCost * SToTValue;
            SecondarySalesCost = SalesCost * SToTValue;
            SecondaryMrp = Mrp * SToTValue;

            TertiaryUnitCost = UnitCost;
            TertiarySalesCost = SalesCost;
            TertiaryMrp = Mrp;

            QuaternaryUnitCost = UnitCost / TToQValue;
            QuaternarySalesCost = SalesCost / TToQValue;
            QuaternaryMrp = Mrp / TToQValue;
        }
        else if (PriceAddedFor == 2) {
            PrimaryUnitCost = UnitCost * UToSValue;
            PrimarySalesCost = SalesCost * UToSValue;
            PrimaryMrp = Mrp * UToSValue;

            SecondaryUnitCost = UnitCost;
            SecondarySalesCost = SalesCost;
            SecondaryMrp = Mrp;

            TertiaryUnitCost = UnitCost / SToTValue;
            TertiarySalesCost = SalesCost / SToTValue;
            TertiaryMrp = Mrp / SToTValue;

            QuaternaryUnitCost = UnitCost / SToTValue / TToQValue;
            QuaternarySalesCost = SalesCost / SToTValue / TToQValue;
            QuaternaryMrp = Mrp / SToTValue / TToQValue;
        }
        else if (PriceAddedFor == 1) {
            PrimaryUnitCost = UnitCost;
            PrimarySalesCost = SalesCost;
            PrimaryMrp = Mrp;

            SecondaryUnitCost = UnitCost / UToSValue;
            SecondarySalesCost = SalesCost / UToSValue;
            SecondaryMrp = Mrp / UToSValue;

            TertiaryUnitCost = UnitCost / UToSValue / SToTValue;
            TertiarySalesCost = SalesCost / UToSValue / SToTValue;
            TertiaryMrp = Mrp / UToSValue / SToTValue;

            QuaternaryUnitCost = UnitCost / UToSValue / SToTValue / TToQValue;
            QuaternarySalesCost = SalesCost / UToSValue / SToTValue / TToQValue;
            QuaternaryMrp = Mrp / UToSValue / SToTValue / TToQValue;
        }
    }

    if (TToQValue != 0) {
        if (index == 1) {
            newUnitCost = PrimaryUnitCost;
            newSalesCost = PrimarySalesCost;
            newMrp = PrimaryMrp;
        }
        else if (index == 2) {
            newUnitCost = SecondaryUnitCost;
            newSalesCost = SecondarySalesCost;
            newMrp = SecondaryMrp;
        }
        else if (index == 3) {
            newUnitCost = TertiaryUnitCost;
            newSalesCost = TertiarySalesCost;
            newMrp = TertiaryMrp;
        }
        else {
            newUnitCost = QuaternaryUnitCost;
            newSalesCost = QuaternarySalesCost;
            newMrp = QuaternaryMrp;
        }
    }
    else if (SToTValue != 0) {
        if (index == 2) {
            newUnitCost = PrimaryUnitCost;
            newSalesCost = PrimarySalesCost;
            newMrp = PrimaryMrp;
        }
        else if (index == 3) {
            newUnitCost = SecondaryUnitCost;
            newSalesCost = SecondarySalesCost;
            newMrp = SecondaryMrp;
        }
        else if (index == 4) {
            newUnitCost = TertiaryUnitCost;
            newSalesCost = TertiarySalesCost;
            newMrp = TertiaryMrp;
        }
    }
    else if (UToSValue != 0) {
        if (index == 3) {
            newUnitCost = PrimaryUnitCost;
            newSalesCost = PrimarySalesCost;
            newMrp = PrimaryMrp;
        }
        else if (index == 4) {
            newUnitCost = SecondaryUnitCost;
            newSalesCost = SecondarySalesCost;
            newMrp = SecondaryMrp;
        }
    }
    else {
        newUnitCost = PrimaryUnitCost;
        newSalesCost = PrimarySalesCost;
        newMrp = PrimaryMrp;
    }


    $('#txtUnitCost' + i).val(parseFloat(newUnitCost).toFixed(2));
    $('#txtSalesIncTax' + i).val(parseFloat(newSalesCost).toFixed(2));
    $('#txtMrp' + i).val(parseFloat(newMrp).toFixed(2));
    updateOpeningStockSubTotal(i);
}

function toggleUnitCombo(i) {
    var index = $("#ddlComboUnit" + i).val().split('-')[1];
    var PriceAddedFor = $('#hdnPriceAddedFor' + i).val();
    var UToSValue = parseFloat($('#hdnUToSValue' + i).val());
    var SToTValue = parseFloat($('#hdnSToTValue' + i).val());
    var TToQValue = parseFloat($('#hdnTToQValue' + i).val());

    var UnitCost = $('#hdnUnitCost' + i).val();
    var SalesCost = $('#hdnSalesIncTax' + i).val();
    var Mrp = $('#hdnMrp' + i).val();
    var newUnitCost = 0, newSalesCost = 0, newMrp = 0;

    var PrimaryUnitCost = 0, SecondaryUnitCost = 0, TertiaryUnitCost = 0, QuaternaryUnitCost = 0;
    var PrimarySalesCost = 0, SecondarySalesCost = 0, TertiarySalesCost = 0, QuaternarySalesCost = 0;
    var PrimaryMrp = 0, SecondaryMrp = 0, TertiaryMrp = 0, QuaternaryMrp = 0;

    if (UToSValue == 0 && SToTValue == 0 && TToQValue == 0) {
        PrimaryUnitCost = UnitCost;
        PrimarySalesCost = SalesCost;
        PrimaryMrp = Mrp;
    }
    else if (SToTValue == 0 && TToQValue == 0) {
        if (PriceAddedFor == 4) {
            PrimaryUnitCost = UnitCost * UToSValue;
            PrimarySalesCost = SalesCost * UToSValue;
            PrimaryMrp = Mrp * UToSValue;

            SecondaryUnitCost = UnitCost;
            SecondarySalesCost = SalesCost;
            SecondaryMrp = Mrp;
        }
        else if (PriceAddedFor == 3) {
            PrimaryUnitCost = UnitCost;
            PrimarySalesCost = SalesCost;
            PrimaryMrp = Mrp;

            SecondaryUnitCost = UnitCost / UToSValue;
            SecondarySalesCost = SalesCost / UToSValue;
            SecondaryMrp = Mrp / UToSValue;
        }
    }
    else if (TToQValue == 0) {
        if (PriceAddedFor == 4) {
            PrimaryUnitCost = UnitCost * UToSValue * SToTValue;
            PrimarySalesCost = SalesCost * UToSValue * SToTValue;
            PrimaryMrp = Mrp * UToSValue * SToTValue;

            SecondaryUnitCost = UnitCost * SToTValue;
            SecondarySalesCost = SalesCost * SToTValue;
            SecondaryMrp = Mrp * SToTValue;

            TertiaryUnitCost = UnitCost;
            TertiarySalesCost = SalesCost;
            TertiaryMrp = Mrp;
        }
        else if (PriceAddedFor == 3) {
            PrimaryUnitCost = UnitCost * UToSValue;
            PrimarySalesCost = SalesCost * UToSValue;
            PrimaryMrp = Mrp * UToSValue;

            SecondaryUnitCost = UnitCost;
            SecondarySalesCost = SalesCost;
            SecondaryMrp = Mrp;

            TertiaryUnitCost = UnitCost / SToTValue;
            TertiarySalesCost = SalesCost / SToTValue;
            TertiaryMrp = Mrp / SToTValue;
        }
        else if (PriceAddedFor == 2) {
            PrimaryUnitCost = UnitCost;
            PrimarySalesCost = SalesCost;
            PrimaryMrp = Mrp;

            SecondaryUnitCost = UnitCost / UToSValue;
            SecondarySalesCost = SalesCost / UToSValue;
            SecondaryMrp = Mrp / UToSValue;

            TertiaryUnitCost = UnitCost / UToSValue / SToTValue;
            TertiarySalesCost = SalesCost / UToSValue / SToTValue;
            TertiaryMrp = Mrp / UToSValue / SToTValue;
        }
    }
    else {
        if (PriceAddedFor == 4) {
            PrimaryUnitCost = UnitCost * UToSValue * SToTValue * TToQValue;
            PrimarySalesCost = SalesCost * UToSValue * SToTValue * TToQValue;
            PrimaryMrp = Mrp * UToSValue * SToTValue * TToQValue;

            SecondaryUnitCost = UnitCost * SToTValue * TToQValue;
            SecondarySalesCost = SalesCost * SToTValue * TToQValue;
            SecondaryMrp = Mrp * SToTValue * TToQValue;

            TertiaryUnitCost = UnitCost * TToQValue;
            TertiarySalesCost = SalesCost * TToQValue;
            TertiaryMrp = Mrp * TToQValue;

            QuaternaryUnitCost = UnitCost;
            QuaternarySalesCost = SalesCost;
            QuaternaryMrp = Mrp;
        }
        else if (PriceAddedFor == 3) {
            PrimaryUnitCost = UnitCost * UToSValue * SToTValue;
            PrimarySalesCost = SalesCost * UToSValue * SToTValue;
            PrimaryMrp = Mrp * UToSValue * SToTValue;

            SecondaryUnitCost = UnitCost * SToTValue;
            SecondarySalesCost = SalesCost * SToTValue;
            SecondaryMrp = Mrp * SToTValue;

            TertiaryUnitCost = UnitCost;
            TertiarySalesCost = SalesCost;
            TertiaryMrp = Mrp;

            QuaternaryUnitCost = UnitCost / TToQValue;
            QuaternarySalesCost = SalesCost / TToQValue;
            QuaternaryMrp = Mrp / TToQValue;
        }
        else if (PriceAddedFor == 2) {
            PrimaryUnitCost = UnitCost * UToSValue;
            PrimarySalesCost = SalesCost * UToSValue;
            PrimaryMrp = Mrp * UToSValue;

            SecondaryUnitCost = UnitCost;
            SecondarySalesCost = SalesCost;
            SecondaryMrp = Mrp;

            TertiaryUnitCost = UnitCost / SToTValue;
            TertiarySalesCost = SalesCost / SToTValue;
            TertiaryMrp = Mrp / SToTValue;

            QuaternaryUnitCost = UnitCost / SToTValue / TToQValue;
            QuaternarySalesCost = SalesCost / SToTValue / TToQValue;
            QuaternaryMrp = Mrp / SToTValue / TToQValue;
        }
        else if (PriceAddedFor == 1) {
            PrimaryUnitCost = UnitCost;
            PrimarySalesCost = SalesCost;
            PrimaryMrp = Mrp;

            SecondaryUnitCost = UnitCost / UToSValue;
            SecondarySalesCost = SalesCost / UToSValue;
            SecondaryMrp = Mrp / UToSValue;

            TertiaryUnitCost = UnitCost / UToSValue / SToTValue;
            TertiarySalesCost = SalesCost / UToSValue / SToTValue;
            TertiaryMrp = Mrp / UToSValue / SToTValue;

            QuaternaryUnitCost = UnitCost / UToSValue / SToTValue / TToQValue;
            QuaternarySalesCost = SalesCost / UToSValue / SToTValue / TToQValue;
            QuaternaryMrp = Mrp / UToSValue / SToTValue / TToQValue;
        }
    }

    if (TToQValue != 0) {
        if (index == 1) {
            newUnitCost = PrimaryUnitCost;
            newSalesCost = PrimarySalesCost;
            newMrp = PrimaryMrp;
        }
        else if (index == 2) {
            newUnitCost = SecondaryUnitCost;
            newSalesCost = SecondarySalesCost;
            newMrp = SecondaryMrp;
        }
        else if (index == 3) {
            newUnitCost = TertiaryUnitCost;
            newSalesCost = TertiarySalesCost;
            newMrp = TertiaryMrp;
        }
        else {
            newUnitCost = QuaternaryUnitCost;
            newSalesCost = QuaternarySalesCost;
            newMrp = QuaternaryMrp;
        }
    }
    else if (SToTValue != 0) {
        if (index == 2) {
            newUnitCost = PrimaryUnitCost;
            newSalesCost = PrimarySalesCost;
            newMrp = PrimaryMrp;
        }
        else if (index == 3) {
            newUnitCost = SecondaryUnitCost;
            newSalesCost = SecondarySalesCost;
            newMrp = SecondaryMrp;
        }
        else if (index == 4) {
            newUnitCost = TertiaryUnitCost;
            newSalesCost = TertiarySalesCost;
            newMrp = TertiaryMrp;
        }
    }
    else if (UToSValue != 0) {
        if (index == 3) {
            newUnitCost = PrimaryUnitCost;
            newSalesCost = PrimarySalesCost;
            newMrp = PrimaryMrp;
        }
        else if (index == 4) {
            newUnitCost = SecondaryUnitCost;
            newSalesCost = SecondarySalesCost;
            newMrp = SecondaryMrp;
        }
    }
    else {
        newUnitCost = PrimaryUnitCost;
        newSalesCost = PrimarySalesCost;
        newMrp = PrimaryMrp;
    }

    var comboQty = $('#txtComboQuantity' + i).val();
    $('#divComboPurchaseExcTax' + i).text(parseFloat(newUnitCost).toFixed(2));
    $('#divComboTotalAmount' + i).text(parseFloat(newUnitCost * comboQty).toFixed(2));
    //$('#txtSalesIncTax' + i).val(parseFloat(newSalesCost).toFixed(2));
    //$('#txtMrp' + i).val(parseFloat(newMrp).toFixed(2));
    UpdateComboAmount('1');
}

function setComboPrice() {
    var totalCost = 0;
    $('#divCombo tr').each(function () {
        var i = this.id.split('divCombo')[1];
        if (i != undefined) {
            var index = $("#ddlComboUnit" + i).val().split('-')[1];
            var PriceAddedFor = $('#hdnPriceAddedFor' + i).val();
            var UToSValue = parseFloat($('#hdnUToSValue' + i).val());
            var SToTValue = parseFloat($('#hdnSToTValue' + i).val());
            var TToQValue = parseFloat($('#hdnTToQValue' + i).val());

            var UnitCost = $('#hdnUnitCost' + i).val();
            var SalesCost = $('#hdnSalesIncTax' + i).val();
            var Mrp = $('#hdnMrp' + i).val();
            var newUnitCost = 0, newSalesCost = 0, newMrp = 0;

            var PrimaryUnitCost = 0, SecondaryUnitCost = 0, TertiaryUnitCost = 0, QuaternaryUnitCost = 0;
            var PrimarySalesCost = 0, SecondarySalesCost = 0, TertiarySalesCost = 0, QuaternarySalesCost = 0;
            var PrimaryMrp = 0, SecondaryMrp = 0, TertiaryMrp = 0, QuaternaryMrp = 0;

            if (UToSValue == 0 && SToTValue == 0 && TToQValue == 0) {
                PrimaryUnitCost = UnitCost;
                PrimarySalesCost = SalesCost;
                PrimaryMrp = Mrp;
            }
            else if (SToTValue == 0 && TToQValue == 0) {
                if (PriceAddedFor == 4) {
                    PrimaryUnitCost = UnitCost * UToSValue;
                    PrimarySalesCost = SalesCost * UToSValue;
                    PrimaryMrp = Mrp * UToSValue;

                    SecondaryUnitCost = UnitCost;
                    SecondarySalesCost = SalesCost;
                    SecondaryMrp = Mrp;
                }
                else if (PriceAddedFor == 3) {
                    PrimaryUnitCost = UnitCost;
                    PrimarySalesCost = SalesCost;
                    PrimaryMrp = Mrp;

                    SecondaryUnitCost = UnitCost / UToSValue;
                    SecondarySalesCost = SalesCost / UToSValue;
                    SecondaryMrp = Mrp / UToSValue;
                }
            }
            else if (TToQValue == 0) {
                if (PriceAddedFor == 4) {
                    PrimaryUnitCost = UnitCost * UToSValue * SToTValue;
                    PrimarySalesCost = SalesCost * UToSValue * SToTValue;
                    PrimaryMrp = Mrp * UToSValue * SToTValue;

                    SecondaryUnitCost = UnitCost * SToTValue;
                    SecondarySalesCost = SalesCost * SToTValue;
                    SecondaryMrp = Mrp * SToTValue;

                    TertiaryUnitCost = UnitCost;
                    TertiarySalesCost = SalesCost;
                    TertiaryMrp = Mrp;
                }
                else if (PriceAddedFor == 3) {
                    PrimaryUnitCost = UnitCost * UToSValue;
                    PrimarySalesCost = SalesCost * UToSValue;
                    PrimaryMrp = Mrp * UToSValue;

                    SecondaryUnitCost = UnitCost;
                    SecondarySalesCost = SalesCost;
                    SecondaryMrp = Mrp;

                    TertiaryUnitCost = UnitCost / SToTValue;
                    TertiarySalesCost = SalesCost / SToTValue;
                    TertiaryMrp = Mrp / SToTValue;
                }
                else if (PriceAddedFor == 2) {
                    PrimaryUnitCost = UnitCost;
                    PrimarySalesCost = SalesCost;
                    PrimaryMrp = Mrp;

                    SecondaryUnitCost = UnitCost / UToSValue;
                    SecondarySalesCost = SalesCost / UToSValue;
                    SecondaryMrp = Mrp / UToSValue;

                    TertiaryUnitCost = UnitCost / UToSValue / SToTValue;
                    TertiarySalesCost = SalesCost / UToSValue / SToTValue;
                    TertiaryMrp = Mrp / UToSValue / SToTValue;
                }
            }
            else {
                if (PriceAddedFor == 4) {
                    PrimaryUnitCost = UnitCost * UToSValue * SToTValue * TToQValue;
                    PrimarySalesCost = SalesCost * UToSValue * SToTValue * TToQValue;
                    PrimaryMrp = Mrp * UToSValue * SToTValue * TToQValue;

                    SecondaryUnitCost = UnitCost * SToTValue * TToQValue;
                    SecondarySalesCost = SalesCost * SToTValue * TToQValue;
                    SecondaryMrp = Mrp * SToTValue * TToQValue;

                    TertiaryUnitCost = UnitCost * TToQValue;
                    TertiarySalesCost = SalesCost * TToQValue;
                    TertiaryMrp = Mrp * TToQValue;

                    QuaternaryUnitCost = UnitCost;
                    QuaternarySalesCost = SalesCost;
                    QuaternaryMrp = Mrp;
                }
                else if (PriceAddedFor == 3) {
                    PrimaryUnitCost = UnitCost * UToSValue * SToTValue;
                    PrimarySalesCost = SalesCost * UToSValue * SToTValue;
                    PrimaryMrp = Mrp * UToSValue * SToTValue;

                    SecondaryUnitCost = UnitCost * SToTValue;
                    SecondarySalesCost = SalesCost * SToTValue;
                    SecondaryMrp = Mrp * SToTValue;

                    TertiaryUnitCost = UnitCost;
                    TertiarySalesCost = SalesCost;
                    TertiaryMrp = Mrp;

                    QuaternaryUnitCost = UnitCost / TToQValue;
                    QuaternarySalesCost = SalesCost / TToQValue;
                    QuaternaryMrp = Mrp / TToQValue;
                }
                else if (PriceAddedFor == 2) {
                    PrimaryUnitCost = UnitCost * UToSValue;
                    PrimarySalesCost = SalesCost * UToSValue;
                    PrimaryMrp = Mrp * UToSValue;

                    SecondaryUnitCost = UnitCost;
                    SecondarySalesCost = SalesCost;
                    SecondaryMrp = Mrp;

                    TertiaryUnitCost = UnitCost / SToTValue;
                    TertiarySalesCost = SalesCost / SToTValue;
                    TertiaryMrp = Mrp / SToTValue;

                    QuaternaryUnitCost = UnitCost / SToTValue / TToQValue;
                    QuaternarySalesCost = SalesCost / SToTValue / TToQValue;
                    QuaternaryMrp = Mrp / SToTValue / TToQValue;
                }
                else if (PriceAddedFor == 1) {
                    PrimaryUnitCost = UnitCost;
                    PrimarySalesCost = SalesCost;
                    PrimaryMrp = Mrp;

                    SecondaryUnitCost = UnitCost / UToSValue;
                    SecondarySalesCost = SalesCost / UToSValue;
                    SecondaryMrp = Mrp / UToSValue;

                    TertiaryUnitCost = UnitCost / UToSValue / SToTValue;
                    TertiarySalesCost = SalesCost / UToSValue / SToTValue;
                    TertiaryMrp = Mrp / UToSValue / SToTValue;

                    QuaternaryUnitCost = UnitCost / UToSValue / SToTValue / TToQValue;
                    QuaternarySalesCost = SalesCost / UToSValue / SToTValue / TToQValue;
                    QuaternaryMrp = Mrp / UToSValue / SToTValue / TToQValue;
                }
            }

            if (TToQValue != 0) {
                if (index == 1) {
                    newUnitCost = PrimaryUnitCost;
                    newSalesCost = PrimarySalesCost;
                    newMrp = PrimaryMrp;
                }
                else if (index == 2) {
                    newUnitCost = SecondaryUnitCost;
                    newSalesCost = SecondarySalesCost;
                    newMrp = SecondaryMrp;
                }
                else if (index == 3) {
                    newUnitCost = TertiaryUnitCost;
                    newSalesCost = TertiarySalesCost;
                    newMrp = TertiaryMrp;
                }
                else {
                    newUnitCost = QuaternaryUnitCost;
                    newSalesCost = QuaternarySalesCost;
                    newMrp = QuaternaryMrp;
                }
            }
            else if (SToTValue != 0) {
                if (index == 2) {
                    newUnitCost = PrimaryUnitCost;
                    newSalesCost = PrimarySalesCost;
                    newMrp = PrimaryMrp;
                }
                else if (index == 3) {
                    newUnitCost = SecondaryUnitCost;
                    newSalesCost = SecondarySalesCost;
                    newMrp = SecondaryMrp;
                }
                else if (index == 4) {
                    newUnitCost = TertiaryUnitCost;
                    newSalesCost = TertiarySalesCost;
                    newMrp = TertiaryMrp;
                }
            }
            else if (UToSValue != 0) {
                if (index == 3) {
                    newUnitCost = PrimaryUnitCost;
                    newSalesCost = PrimarySalesCost;
                    newMrp = PrimaryMrp;
                }
                else if (index == 4) {
                    newUnitCost = SecondaryUnitCost;
                    newSalesCost = SecondarySalesCost;
                    newMrp = SecondaryMrp;
                }
            }
            else {
                newUnitCost = PrimaryUnitCost;
                newSalesCost = PrimarySalesCost;
                newMrp = PrimaryMrp;
            }

            var comboQty = $('#txtComboQuantity' + i).val();
            $('#divComboPurchaseExcTax' + i).text(parseFloat(newUnitCost).toFixed(2));
            $('#divComboTotalAmount' + i).text(parseFloat(newUnitCost * comboQty).toFixed(2));

            var val = parseFloat(parseFloat(newUnitCost) * parseFloat(comboQty)).toFixed(2);
            totalCost = totalCost + parseFloat(val);
        }
    });
    $('#divComboNetAmount').text(totalCost);

}

function insertUnit() {
    $('.errorText').hide();
    $('[style*="border: 2px"]').css('border', '');

    var det = {
        UnitCode: $('#txtUnitCode').val(),
        UnitName: $('#txtUnitName').val(),
        UnitShortName: $('#txtUnitShortName').val(),
        AllowDecimal: $('#ddlAllowDecimal').val(),
        IsActive: true,
        IsDeleted: false,
    };
    $("#divLoading").show();
    $.ajax({
        url: '/itemsettings/UnitInsert',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {

            $("#divLoading").hide();
            if (data == "True") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }
            else if (data == "False") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }

            if (data.Status == 0) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error(data.Message);
            }
            else if (data.Status == 2) {
                if (EnableSound == 'True') { document.getElementById('error').play(); } toastr.error('Invalid inputs, check and try again !!');
                data.Errors.forEach(function (res) {
                    $('#' + res.Id + '_M').show();
                    $('#' + res.Id + '_M').text(res.Message);


                    if ($('.' + res.Id + '_M_ctrl').children("select").length > 0) {
                        var element = $("." + res.Id + '_M_ctrl select');
                        if (element.hasClass("select2-hidden-accessible")) {
                            $('.' + res.Id + '_M_ctrl .select2-container .select2-selection').css('border', '2px solid #dc3545');
                        } else {
                            $('.' + res.Id + '_M_ctrl select').css('border', '2px solid #dc3545');
                        }
                    }
                    else {
                        $('.' + res.Id + '_M_ctrl').css('border', '2px solid #dc3545');
                    }
                });
            }
            else {
                $('#ddlUnit').append($('<option>', { value: data.Data.Unit.UnitId, text: data.Data.Unit.UnitShortName }));
                $('#ddlUnit').val(data.Data.Unit.UnitId);
                $('#unitModal').modal('toggle');

                $('#ddlSecondaryUnit').html('');
                $('#ddlTertiaryUnit').html('');
                $('#ddlQuaternaryUnit').html('');

                $('#txtUnitName').val('');
                $('#txtUnitShortName').val('');

            }
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
};

function insertSecondaryUnit() {
    $('.errorText').hide();
    $('[style*="border: 2px"]').css('border', '');

    var det = {
        SecondaryUnitName: $('#txtSecondaryUnitName').val(),
        UnitId: $('#ddlUnit').val(),
        SecondaryUnitShortName: $('#txtSecondaryUnitShortName').val(),
        SecondaryUnitAllowDecimal: $('#ddlAllowDecimal').val(),
        IsActive: true,
        IsDeleted: false,
    };
    $("#divLoading").show();
    $.ajax({
        url: '/itemsettings/SecondaryUnitInsert',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {

            $("#divLoading").hide();
            if (data == "True") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }
            else if (data == "False") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }

            if (data.Status == 0) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error(data.Message);
            }
            else if (data.Status == 2) {
                if (EnableSound == 'True') { document.getElementById('error').play(); } toastr.error('Invalid inputs, check and try again !!');
                data.Errors.forEach(function (res) {
                    $('#' + res.Id + '_M').show();
                    $('#' + res.Id + '_M').text(res.Message);


                    if ($('.' + res.Id + '_M_ctrl').children("select").length > 0) {
                        var element = $("." + res.Id + '_M_ctrl select');
                        if (element.hasClass("select2-hidden-accessible")) {
                            $('.' + res.Id + '_M_ctrl .select2-container .select2-selection').css('border', '2px solid #dc3545');
                        } else {
                            $('.' + res.Id + '_M_ctrl select').css('border', '2px solid #dc3545');
                        }
                    }
                    else {
                        $('.' + res.Id + '_M_ctrl').css('border', '2px solid #dc3545');
                    }
                });
            }
            else {
                $('#ddlSecondaryUnit').append($('<option>', { value: data.Data.SecondaryUnit.SecondaryUnitId, text: data.Data.SecondaryUnit.SecondaryUnitShortName }));
                $('#ddlSecondaryUnit').val(data.Data.SecondaryUnit.SecondaryUnitId);
                $('#secondaryUnitModal').modal('toggle');

                $('.txtSecondaryUnit').text(data.Data.SecondaryUnit.SecondaryUnitShortName);

                $('#ddlTertiaryUnit').html('');
                $('#ddlQuaternaryUnit').html('');

                $('#txtSecondaryUnitName').val('');
                $('#txtSecondaryUnitShortName').val('');
            }
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
};

function insertTertiaryUnit() {
    $('.errorText').hide();
    $('[style*="border: 2px"]').css('border', '');


    var det = {
        UnitId: $('#ddlUnit').val(),
        SecondaryUnitId: $('#ddlSecondaryUnit').val(),
        TertiaryUnitName: $('#txtTertiaryUnitName').val(),
        TertiaryUnitShortName: $('#txtTertiaryUnitShortName').val(),
        TertiaryUnitAllowDecimal: $('#ddlAllowDecimal').val(),
        IsActive: true,
        IsDeleted: false,
    };
    $("#divLoading").show();
    $.ajax({
        url: '/itemsettings/TertiaryUnitInsert',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {

            $("#divLoading").hide();
            if (data == "True") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }
            else if (data == "False") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }

            if (data.Status == 0) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error(data.Message);
            }
            else if (data.Status == 2) {
                if (EnableSound == 'True') { document.getElementById('error').play(); } toastr.error('Invalid inputs, check and try again !!');
                data.Errors.forEach(function (res) {
                    $('#' + res.Id + '_M').show();
                    $('#' + res.Id + '_M').text(res.Message);


                    if ($('.' + res.Id + '_M_ctrl').children("select").length > 0) {
                        var element = $("." + res.Id + '_M_ctrl select');
                        if (element.hasClass("select2-hidden-accessible")) {
                            $('.' + res.Id + '_M_ctrl .select2-container .select2-selection').css('border', '2px solid #dc3545');
                        } else {
                            $('.' + res.Id + '_M_ctrl select').css('border', '2px solid #dc3545');
                        }
                    }
                    else {
                        $('.' + res.Id + '_M_ctrl').css('border', '2px solid #dc3545');
                    }
                });
            }
            else {
                $('#ddlTertiaryUnit').append($('<option>', { value: data.Data.TertiaryUnit.TertiaryUnitId, text: data.Data.TertiaryUnit.TertiaryUnitShortName }));
                $('#ddlTertiaryUnit').val(data.Data.TertiaryUnit.TertiaryUnitId);
                $('#tertiaryUnitModal').modal('toggle');

                $('.txtTertiaryUnit').html(data.Data.TertiaryUnit.TertiaryUnitShortName);

                $('#ddlQuaternaryUnit').html('');

                $('#txtTertiaryUnitName').val('');
                $('#txtTertiaryUnitShortName').val('');
            }
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
};

function insertQuaternaryUnit() {
    $('.errorText').hide();
    $('[style*="border: 2px"]').css('border', '');


    var det = {
        UnitId: $('#ddlUnit').val(),
        SecondaryUnitId: $('#ddlSecondaryUnit').val(),
        TertiaryUnitId: $('#ddlTertiaryUnit').val(),
        QuaternaryUnitName: $('#txtQuaternaryUnitName').val(),
        QuaternaryUnitShortName: $('#txtQuaternaryUnitShortName').val(),
        QuaternaryUnitAllowDecimal: $('#ddlAllowDecimal').val(),
        IsActive: true,
        IsDeleted: false,
    };
    $("#divLoading").show();
    $.ajax({
        url: '/itemsettings/QuaternaryUnitInsert',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {

            $("#divLoading").hide();
            if (data == "True") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }
            else if (data == "False") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }

            if (data.Status == 0) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error(data.Message);
            }
            else if (data.Status == 2) {
                if (EnableSound == 'True') { document.getElementById('error').play(); } toastr.error('Invalid inputs, check and try again !!');
                data.Errors.forEach(function (res) {
                    $('#' + res.Id + '_M').show();
                    $('#' + res.Id + '_M').text(res.Message);


                    if ($('.' + res.Id + '_M_ctrl').children("select").length > 0) {
                        var element = $("." + res.Id + '_M_ctrl select');
                        if (element.hasClass("select2-hidden-accessible")) {
                            $('.' + res.Id + '_M_ctrl .select2-container .select2-selection').css('border', '2px solid #dc3545');
                        } else {
                            $('.' + res.Id + '_M_ctrl select').css('border', '2px solid #dc3545');
                        }
                    }
                    else {
                        $('.' + res.Id + '_M_ctrl').css('border', '2px solid #dc3545');
                    }
                });
            }
            else {
                $('#ddlQuaternaryUnit').append($('<option>', { value: data.Data.QuaternaryUnit.QuaternaryUnitId, text: data.Data.QuaternaryUnit.QuaternaryUnitShortName }));
                $('#ddlQuaternaryUnit').val(data.Data.QuaternaryUnit.QuaternaryUnitId);
                $('#quaternaryUnitModal').modal('toggle');

                $('.txtQuaternaryUnit').text(data.Data.QuaternaryUnit.QuaternaryUnitShortName);

                $('#txtQuaternaryUnitName').val('');
                $('#txtQuaternaryUnitShortName').val('');
            }
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
};

function openSecondaryUnitModal() {
    $('.errorText').hide();
    $('[style*="border: 2px"]').css('border', '');


    if ($('#ddlUnit').val() == 0) {
        if (EnableSound == 'True') { document.getElementById('error').play(); }
        toastr.error('Please select Unit first');
    }
    else {
        $('#secondaryUnitModal').modal('toggle');
    }
}

function openTertiaryUnitModal() {
    $('.errorText').hide();
    $('[style*="border: 2px"]').css('border', '');


    if ($('#ddlUnit').val() == 0) {
        if (EnableSound == 'True') { document.getElementById('error').play(); }
        toastr.error('Please select Unit first');
    }
    else {
        if ($('#ddlSecondaryUnit').val() == 0) {
            if (EnableSound == 'True') { document.getElementById('error').play(); }
            toastr.error('Please select Secondary Unit first');
        }
        else {
            $('#tertiaryUnitModal').modal('toggle');
        }
    }
}

function openQuaternaryUnitModal() {
    $('.errorText').hide();
    $('[style*="border: 2px"]').css('border', '');


    if ($('#ddlUnit').val() == 0) {
        if (EnableSound == 'True') { document.getElementById('error').play(); }
        toastr.error('Please select Unit first');
    }
    else {
        if ($('#ddlSecondaryUnit').val() == 0) {
            if (EnableSound == 'True') { document.getElementById('error').play(); }
            toastr.error('Please select Secondary Unit first');
        }
        else {
            if ($('#ddlSecondaryUnit').val() == 0) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error('Please select Tertiary Unit first');
            }
            else {
                $('#quaternaryUnitModal').modal('toggle');
            }
        }
    }
}

function openSubCategoryModal() {
    $('.errorText').hide();
    $('[style*="border: 2px"]').css('border', '');


    if ($('#ddlCategory').val() == 0) {
        if (EnableSound == 'True') { document.getElementById('error').play(); }
        toastr.error('Please select Category first');
    }
    else {
        $('#subCategoryModal').modal('toggle');
    }
}

function openSubSubCategoryModal() {
    $('.errorText').hide();
    $('[style*="border: 2px"]').css('border', '');


    if ($('#ddlCategory').val() == 0) {
        if (EnableSound == 'True') { document.getElementById('error').play(); }
        toastr.error('Please select Category first');
    }
    else {
        if ($('#ddlSubCategory').val() == 0) {
            if (EnableSound == 'True') { document.getElementById('error').play(); }
            toastr.error('Please select Sub Category first');
        }
        else {
            $('#subSubCategoryModal').modal('toggle');
        }
    }
}

function deleteOpeningStockCombo(id, OpeningStockId) {
    if (OpeningStockId != undefined) {
        //var r = confirm("Are you sure you want to delete?");
        //if (r == true) {
        var det = {
            OpeningStockId: OpeningStockId
        }
        $("#divLoading").show();
        $.ajax({
            url: '/Items/OpeningStockDelete',
            datatype: "json",
            data: det,
            type: "post",
            success: function (data) {

                $("#divLoading").hide();
                if (data == "True") {
                    $('#subscriptionExpiryModal').modal('toggle');
                    $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                    $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                    return
                }
                else if (data == "False") {
                    $('#subscriptionExpiryModal').modal('toggle');
                    $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                    $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                    return
                }

                if (data.Status == 0) {
                    if (EnableSound == 'True') { document.getElementById('error').play(); }
                    toastr.error(data.Message);
                }
                else {
                    /*$('#trOpeningStock_' + id).remove();*/
                    $('#trOpeningStock_' + id).hide();
                }
            },
            error: function (xhr) {
                $("#divLoading").hide();
            }
        });
        //}
    }
    else {
        $('#trOpeningStock_' + id).remove();
    }
}

function deleteOpeningStockFullCombo() {
    $("#divLoading").show();
    $('#tblOpeningStock tr').each(function () {
        var _id = this.id.split('trOpeningStock_')[1];
        if (_id != undefined) {
            var det = {
                OpeningStockId: $('#txtOpeningStockId' + _id).val(),
            }

            $.ajax({
                url: '/Items/OpeningStockDelete',
                datatype: "json",
                data: det,
                type: "post",
                success: function (data) {

                    if (data == "True") {
                        $('#subscriptionExpiryModal').modal('toggle');
                        $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                        $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                        return
                    }
                    else if (data == "False") {
                        $('#subscriptionExpiryModal').modal('toggle');
                        $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                        $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                        return
                    }

                    if (data.Status == 0) {
                        if (EnableSound == 'True') { document.getElementById('error').play(); }
                        toastr.error(data.Message);
                    }
                    else {
                        /*$('#trOpeningStock_' + id).remove();*/
                        $('#trOpeningStock_' + _id).hide();
                    }
                },
                error: function (xhr) {
                    $("#divLoading").hide();
                }
            });
        }
    });

    $("#divLoading").hide();
}

function toggleDecimal(evt, i) {
    var index = $("#ddlUnit" + i).val().split('-')[1];//[0].selectedIndex + 1;
    var isDecimal = "false";
    if (index == 1) {
        isDecimal = $('#hdnAllowDecimal' + i).val();
    }
    else if (index == 2) {
        isDecimal = $('#hdnSecondaryUnitAllowDecimal' + i).val();
    }
    else if (index == 3) {
        isDecimal = $('#hdnTertiaryUnitAllowDecimal' + i).val();
    }
    else if (index == 4) {
        isDecimal = $('#hdnQuaternaryUnitAllowDecimal' + i).val();
    }
    if (isDecimal.toLowerCase() == "false") {
        // Only ASCII character in that range allowed
        var ASCIICode = (evt.which) ? evt.which : evt.keyCode
        // if (ASCIICode > 31 && (ASCIICode < 48 || ASCIICode > 57))
        if (ASCIICode == 46)
            return false;
        return true;
    }

    return true;
}

function openAttributeVariationModal(attributeKey) {
    if (!canAddNewVariations) {
        return;
    }
    attributeBuilderTargetKey = attributeKey;
    _variationId = 0;
    $('#variationModal').modal('toggle');
}

function openVariationModal(_count) {
    attributeBuilderTargetKey = null;
    _variationId = _count;
    $('#variationModal').modal('toggle');
}

function insertVariation() {
    $('.errorText').hide();
    $('[style*="border: 2px"]').css('border', '');


    var variationDetails = [];
    $('#addNewRow input[type="text"]').each(function () {
        if ($('#' + this.id).val()) {
            variationDetails.push({ VariationDetails: $('#' + this.id).val() });
        }
    });

    var det = {
        VariationCode: $('#txtVariationCode').val(),
        Variation: $('#txtVariation').val(),
        VariationDetails: variationDetails,
        IsActive: true,
        IsDeleted: false,
    };
    $("#divLoading").show();
    $.ajax({
        url: '/itemsettings/VariationInsert',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {

            $("#divLoading").hide();
            if (data == "True") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }
            else if (data == "False") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }

            if (data.Status == 0) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error(data.Message);
            }
            else if (data.Status == 2) {
                if (EnableSound == 'True') { document.getElementById('error').play(); } toastr.error('Invalid inputs, check and try again !!');

                data.Errors.forEach(function (res) {
                    $('#' + res.Id + '_M').show();
                    $('#' + res.Id + '_M').text(res.Message);


                    if ($('.' + res.Id + '_M_ctrl').children("select").length > 0) {
                        var element = $("." + res.Id + '_M_ctrl select');
                        if (element.hasClass("select2-hidden-accessible")) {
                            $('.' + res.Id + '_M_ctrl .select2-container .select2-selection').css('border', '2px solid #dc3545');
                        } else {
                            $('.' + res.Id + '_M_ctrl select').css('border', '2px solid #dc3545');
                        }
                    }
                    else {
                        $('.' + res.Id + '_M_ctrl').css('border', '2px solid #dc3545');
                    }
                });
            }
            else {
                var newVariationId = data.Data.Variation.VariationId;
                var newVariationName = data.Data.Variation.Variation;
                $('.variation_template').append($('<option>', { value: newVariationId, text: newVariationName }));
                dropdownHtml += '<option value="' + newVariationId + '">' + newVariationName + '</option>';
                refreshAttributeDropdownOptions();
                $('#variationModal').modal('toggle');
                if (_variationId > 0 && $('#ddlVariation' + _variationId).length) {
                    $('#ddlVariation' + _variationId).val(newVariationId).trigger('change');
                    FetchVariationDetails(_variationId);
                }
                else if (attributeBuilderTargetKey !== null) {
                    $('#ddlAttributeVariation' + attributeBuilderTargetKey).val(newVariationId).trigger('change');
                    attributeBuilderTargetKey = null;
                }

                $('.errorText').hide();
                $('[style*="border: 2px"]').css('border', '');


                $('#addNewRow').html('');
                $('#txtVariationCode').val('');
                $('#txtVariation').val('');
            }
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
};

// Use delegated event binding so it works for dynamically loaded modals (e.g., ItemsEdit)
$(document).on('click', '.add-new-row', function () {
    c = c + 1;
    var markup = '<div class="input-group mb-1" id="row' + c + '">' +
        '    <input type="text" class="form-control" id="txtNew' + c + '">' +
        '     <span class="input-group-append">' +
        '       <a href="javascript:void(0)" class="btn btn-danger btn-sm delete-new-row" id="btnNew' + c + '"><i class="fas fa-minus pt-2"></i></a>' +
        '     </span>' +
        '  </div>';
    $("#addNewRow").append(markup);
});

$('#addNewRow').on('click', '.delete-new-row', function () {
    var i = $(this).attr('id');
    $("#row" + i.split('btnNew')[1]).remove();
});

function CalculateExpiryDate(expCount) {
    var det = {
        ItemId: _ItemId,
        ManufacturingDate: $('#txtManufacturingDate' + expCount).val(),
    };
    $("#divLoading").show();
    $.ajax({
        url: '/items/CalculateExpiryDate',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {
            if (data.Status == 0) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error(data.Message);
            }
            else {
                $('#txtExpiryDate' + expCount).val(DateFormat(new Date(parseInt(data.Data.OpeningStock.ExpiryDate.replaceAll('/', '').replaceAll('Date', '').replace('(', '').replace(')', ''))).toUTCString()));
            }
            $("#divLoading").hide();
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
}

function openTaxModal(_type) {
    type = _type;

    $('.divTaxModal').show();
    $('.divTaxGroupModal').hide();

    $('#taxModal').modal('toggle');
}

function toggleTaxModal(d) {

    $('.divTaxModal').hide();
    $('.divTaxGroupModal').hide();

    if (d == 'TaxGroup') {
        $('.divTaxGroupModal').show();
    }
    else {
        $('.divTaxModal').show();
    }
}

function toggleForTaxGroupOnly(c) {
    if (c == 1) {
        if ($('#chkNewForTaxGroupOnly').is(':checked') == true) {
            $('.divNewAccounts').hide();
        }
        else {
            $('.divNewAccounts').show();
        }
    }
    else {
        if ($('#chkForTaxGroupOnly_N').is(':checked') == true) {
            $('.divAccounts_N').hide();
        }
        else {
            $('.divAccounts_N').show();
        }
    }
}

function insertTax() {
    $('.errorText').hide();
    $('[style*="border: 2px"]').css('border', '');


    var det = {
        Taxpercent: $('#txtNewTaxpercent').val(),
        Tax: $('#txtNewTax').val(),
        IsActive: true,
        IsDeleted: false,
        ForTaxGroupOnly: $('#chkNewForTaxGroupOnly').is(':checked'),
        PurchaseAccountId: $('#ddlNewPurchaseAccount').val(),
        SalesAccountId: $('#ddlNewSalesAccount').val(),
        SupplierPaymentAccountId: $('#ddlNewSupplierPaymentAccount').val(),
        CustomerPaymentAccountId: $('#ddlNewCustomerPaymentAccount').val(),
        ExpenseAccountId: $('#ddlNewExpenseAccount').val(),
        IncomeAccountId: $('#ddlNewIncomeAccount').val(),
        TaxTypeId: $('#ddlNewTaxType').val(),
    };
    $("#divLoading").show();
    $.ajax({
        url: '/taxsettings/TaxInsert',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {

            $("#divLoading").hide();
            if (data == "True") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }
            else if (data == "False") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }

            if (data.Status == 0) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error(data.Message);
            }
            else if (data.Status == 2) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error('Invalid inputs, check and try again !!');
                data.Errors.forEach(function (res) {
                    $('#' + res.Id + '_M').show();
                    $('#' + res.Id + '_M').text(res.Message);

                    if ($('.' + res.Id + '_M_ctrl').children("select").length > 0) {
                        var element = $("." + res.Id + '_M_ctrl select');
                        if (element.hasClass("select2-hidden-accessible")) {
                            $('.' + res.Id + '_M_ctrl .select2-container .select2-selection').css('border', '2px solid #dc3545');
                        } else {
                            $('.' + res.Id + '_M_ctrl select').css('border', '2px solid #dc3545');
                        }
                    }
                    else {
                        $('.' + res.Id + '_M_ctrl').css('border', '2px solid #dc3545');
                    }
                });
            }
            else {
                $('#ddlTax').append($('<option>', { value: data.Data.Tax.TaxId + '-' + data.Data.Tax.TaxPercent, text: data.Data.Tax.Tax }));
                $('#ddlTax').val(data.Data.Tax.TaxId + '-' + data.Data.Tax.TaxPercent);

                $('#ddlIntraStateTax_N').append($('<option>', { value: data.Data.Tax.TaxId + '-' + data.Data.Tax.TaxPercent, text: data.Data.Tax.Tax }));
                if (type == 'IntraStateTax') {
                    $('#ddlIntraStateTax_N').val(data.Data.Tax.TaxId + '-' + data.Data.Tax.TaxPercent);
                }

                $('#ddlInterStateTax_N').append($('<option>', { value: data.Data.Tax.TaxId + '-' + data.Data.Tax.TaxPercent, text: data.Data.Tax.Tax }));
                if (type == 'InterStateTax') {
                    $('#ddlInterStateTax_N').val(data.Data.Tax.TaxId + '-' + data.Data.Tax.TaxPercent);
                }

                $('#ddlNewSubTax').append($('<option>', { value: data.Data.Tax.TaxId, text: data.Data.Tax.Tax }));
                var d = $('#ddlNewSubTax').val();
                if (d == null) d = [];
                d.push(data.Data.Tax.TaxId);
                //$('#ddlNewSubTax').val(d);

                $('#taxModal').modal('toggle');

                $('#txtNewTaxpercent').val('');
                $('#txtNewTax').val('');

                calulation();
            }
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
};

function insertTaxGroup(i) {
    $('.errorText').hide();
    $('[style*="border: 2px"]').css('border', '');


    var det = {
        Taxpercent: $('#txtNewTaxpercentGroup').val(),
        Tax: $('#txtNewTaxGroup').val(),
        SubTaxs: $('#ddlNewSubTax').val(),
        IsActive: true,
        IsDeleted: false,
        PurchaseAccountId: $('#ddlNewSubTaxPurchaseAccount').val(),
        SalesAccountId: $('#ddlNewSubTaxSalesAccount').val(),
        SupplierPaymentAccountId: $('#ddlNewSubTaxSupplierPaymentAccount').val(),
        CustomerPaymentAccountId: $('#ddlNewSubTaxCustomerPaymentAccount').val(),
        ExpenseAccountId: $('#ddlNewSubTaxExpenseAccount').val(),
        IncomeAccountId: $('#ddlNewSubTaxIncomeAccount').val(),
    };
    $("#divLoading").show();
    $.ajax({
        url: '/taxsettings/TaxgroupInsert',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {

            $("#divLoading").hide();
            if (data == "True") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }
            else if (data == "False") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }

            if (data.Status == 0) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error(data.Message);
            }
            else if (data.Status == 2) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error('Invalid inputs, check and try again !!');
                data.Errors.forEach(function (res) {
                    $('#' + res.Id + '_M').show();
                    $('#' + res.Id + '_M').text(res.Message);

                    if ($('.' + res.Id + '_M_ctrl').children("select").length > 0) {
                        var element = $("." + res.Id + '_M_ctrl select');
                        if (element.hasClass("select2-hidden-accessible")) {
                            $('.' + res.Id + '_M_ctrl .select2-container .select2-selection').css('border', '2px solid #dc3545');
                        } else {
                            $('.' + res.Id + '_M_ctrl select').css('border', '2px solid #dc3545');
                        }
                    }
                    else {
                        $('.' + res.Id + '_M_ctrl').css('border', '2px solid #dc3545');
                    }
                });
            }
            else {
                $('#ddlTax').append($('<option>', { value: data.Data.Tax.TaxId + '-' + data.Data.Tax.TaxPercent, text: data.Data.Tax.Tax }));
                $('#ddlTax').val(data.Data.Tax.TaxId + '-' + data.Data.Tax.TaxPercent);
                $('#taxModal').modal('toggle');

                $('#txtNewTaxpercentGroup').val('');
                $('#txtNewTaxGroup').val('');
                $('#ddlNewSubTax').val('');
                initializeSelect2InScope('#taxModal');

                calulation();
            }
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
};

function insertInnerTax() {
    $('.errorText').hide();
    $('[style*="border: 2px"]').css('border', '');


    var det = {
        Taxpercent: $('#txtNewTaxpercent_N').val(),
        Tax: $('#txtNewTax_N').val(),
        IsActive: true,
        IsDeleted: false,
        ForTaxGroupOnly: $('#chkForTaxGroupOnly_N').is(':checked'),
        PurchaseAccountId: $('#ddlPurchaseAccount_N').val(),
        SalesAccountId: $('#ddlSalesAccount_N').val(),
        SupplierPaymentAccountId: $('#ddlSupplierPaymentAccount_N').val(),
        CustomerPaymentAccountId: $('#ddlCustomerPaymentAccount_N').val(),
        ExpenseAccountId: $('#ddlExpenseAccount_N').val(),
        IncomeAccountId: $('#ddlIncomeAccount_N').val(),
        TaxTypeId: $('#ddlTaxType_N').val(),
    };
    $("#divLoading").show();
    $.ajax({
        url: '/taxsettings/TaxInsert',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {

            $("#divLoading").hide();
            if (data == "True") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }
            else if (data == "False") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }

            if (data.Status == 0) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error(data.Message);
            }
            else if (data.Status == 2) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error('Invalid inputs, check and try again !!');
                data.Errors.forEach(function (res) {
                    $('#' + res.Id + '_N').show();
                    $('#' + res.Id + '_N').text(res.Message);

                    if ($('.' + res.Id + '_N_ctrl').children("select").length > 0) {
                        var element = $("." + res.Id + '_N_ctrl select');
                        if (element.hasClass("select2-hidden-accessible")) {
                            $('.' + res.Id + '_N_ctrl .select2-container .select2-selection').css('border', '2px solid #dc3545');
                        } else {
                            $('.' + res.Id + '_N_ctrl select').css('border', '2px solid #dc3545');
                        }
                    }
                    else {
                        $('.' + res.Id + '_N_ctrl').css('border', '2px solid #dc3545');
                    }
                });
            }
            else {
                if ($('#chkForTaxGroupOnly_N').is(':checked') == false) {
                    $('#ddlTax').append($('<option>', { value: data.Data.Tax.TaxId + '-' + data.Data.Tax.TaxPercent, text: data.Data.Tax.Tax }));
                    $('#ddlTax').val(data.Data.Tax.TaxId + '-' + data.Data.Tax.TaxPercent);

                    $('#ddlIntraStateTax_N').append($('<option>', { value: data.Data.Tax.TaxId + '-' + data.Data.Tax.TaxPercent, text: data.Data.Tax.Tax }));
                    if (type == 'IntraStateTax') {
                        $('#ddlIntraStateTax_N').val(data.Data.Tax.TaxId + '-' + data.Data.Tax.TaxPercent);
                    }

                    $('#ddlInterStateTax_N').append($('<option>', { value: data.Data.Tax.TaxId + '-' + data.Data.Tax.TaxPercent, text: data.Data.Tax.Tax }));
                    if (type == 'InterStateTax') {
                        $('#ddlInterStateTax_N').val(data.Data.Tax.TaxId + '-' + data.Data.Tax.TaxPercent);
                    }
                }

                $('#ddlNewSubTax').append($('<option>', { value: data.Data.Tax.TaxId, text: data.Data.Tax.Tax }));
                var d = $('#ddlNewSubTax').val();
                if (d == null) d = [];
                d.push(data.Data.Tax.TaxId);
                $('#ddlNewSubTax').val(d);

                $('#taxInnerModal').modal('toggle');

                $('#txtNewTaxpercent_N').val('');
                $('#txtNewTax_N').val('');

                FetchTaxPercent();
            }
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
};

function FetchTaxPercent() {
    var det = {
        SubTaxs: $('#ddlNewSubTax').val(),
    };
    _PageIndex = det.PageIndex;
    $("#divLoading").show();
    $.ajax({
        url: '/taxsettings/FetchTaxPercent',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {
            $("#divLoading").hide();
            if (data.Data == null) {
                $('#txtNewTaxpercentGroup').val(0);
            }
            else {
                $('#txtNewTaxpercentGroup').val(data.Data.TaxPercent);
            }

        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
}

function uploadExcel() {
    //var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.xlsx|.xls)$/;
    var regex = (/\.(xlsx|xls|xlsm)$/i);
    /*Checks whether the file is a valid excel file*/
    if (regex.test($("#excelfile").val().toLowerCase())) {
        var xlsxflag = false; /*Flag for checking whether excel is .xls format or .xlsx format*/
        if ($("#excelfile").val().toLowerCase().indexOf(".xlsx") > 0) {
            xlsxflag = true;
        }
        /*Checks whether the browser supports HTML5*/
        if (typeof (FileReader) != "undefined") {
            var reader = new FileReader();
            reader.onload = function (e) {
                var data = e.target.result;
                /*Converts the excel data in to object*/
                if (xlsxflag) {
                    var workbook = XLSX.read(data, { type: 'binary' });
                }
                else {
                    var workbook = XLS.read(data, { type: 'binary' });
                }
                /*Gets all the sheetnames of excel in to a variable*/
                var sheet_name_list = workbook.SheetNames;

                var cnt = 0; /*This is used for restricting the script to consider only first sheet of excel*/
                sheet_name_list.forEach(function (y) { /*Iterate through all sheets*/
                    /*Convert the cell value to Json*/

                    if (xlsxflag) {
                        var exceljson = XLSX.utils.sheet_to_json(workbook.Sheets[y]);
                    }
                    else {
                        var exceljson = XLS.utils.sheet_to_row_object_array(workbook.Sheets[y]);
                    }
                    if (exceljson.length > 0 && cnt == 0) {
                        _excelJson = exceljson;
                    }
                });
                isExcelUpload = true;
                $('#exceltable').show();
            }
            if (xlsxflag) {/*If excel file is .xlsx extension than creates a Array Buffer from excel*/
                reader.readAsArrayBuffer($("#excelfile")[0].files[0]);
            }
            else {
                reader.readAsBinaryString($("#excelfile")[0].files[0]);
            }
        }
        else {
            if (EnableSound == 'True') { document.getElementById('error').play(); }
            toastr.error('Sorry! Your browser does not support HTML5!');
        }
    }
    else {
        if (EnableSound == 'True') { document.getElementById('error').play(); }
        toastr.error('Please upload a valid Excel file!');
    }
}

function BulkInsert(i) {
    $('.errorText').hide();
    $('#divErrorMsg').hide();
    if (isExcelUpload == false) {
        if (EnableSound == 'True') { document.getElementById('error').play(); } toastr.error('Invalid inputs, check and try again !!');
        $('#divExcel').show();
        $('#divExcel').text('Upload Excel first');
        return;
    }

    $("#divLoading").show(); $("#divProgressBar").show();

    myInterval = setInterval(fetchBulkInsertProgress, 10000);

    var det = {
        BatchNo: BatchNo,
        ItemImports: _excelJson
    }
    $.ajax({
        url: '/items/ImportItem',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {

            $("#divLoading").hide();
            $("#divProgressBar").hide();
            clearInterval(myInterval);

            if (data == "True") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }
            else if (data == "False") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }

            if (data.Status == 0) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error(data.Message);
                $("#excelfile").val(null);
            }
            else if (data.Status == 2) {
                if (EnableSound == 'True') { document.getElementById('error').play(); } toastr.error('Invalid inputs, check and try again !!');
                $('#divErrorMsg').show();
                //$('#divExcel').show();
                var errorMsg = '';
                data.Errors.forEach(function (res) {
                    errorMsg = errorMsg + res.Message + '</br>';
                });

                //$('#divExcel').html(errorMsg);
                $('#txtErrorMsg').html(errorMsg);
                $("#excelfile").val(null);
                _excelJson = [];
                isExcelUpload = false;
                //$("html, body").animate({ scrollTop: 0 }, "slow");
            }
            else {
                sessionStorage.setItem('showMsg', '1');
                sessionStorage.setItem('Msg', data.Message);
                if (i == 1) {
                    window.location.href = "/items/items";
                }
                else {
                    window.location.reload();
                }
            }
        },
        error: function (xhr) {
            $("#divLoading").hide();
            $("#divProgressBar").hide();
            clearInterval(myInterval);
        }
    });
}

function BulkInsert_OpeningStock(i) {
    $('.errorText').hide();
    $('#divErrorMsg').hide();
    if (isExcelUpload == false) {
        if (EnableSound == 'True') { document.getElementById('error').play(); } toastr.error('Invalid inputs, check and try again !!');
        $('#divExcel').show();
        $('#divExcel').text('Upload Excel first');
        return;
    }

    $("#divLoading").show(); $("#divProgressBar").show();

    myInterval = setInterval(fetchBulkInsertProgress, 10000);

    var det = {
        BatchNo: BatchNo,
        OpeningStockImports: _excelJson
    }
    $.ajax({
        url: '/items/ImportOpeningStock',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {

            $("#divLoading").hide();
            $("#divProgressBar").hide();
            clearInterval(myInterval);

            if (data == "True") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }
            else if (data == "False") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }

            if (data.Status == 0) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error(data.Message);
                $("#excelfile").val(null);
            }
            else if (data.Status == 2) {
                if (EnableSound == 'True') { document.getElementById('error').play(); } toastr.error('Invalid inputs, check and try again !!');
                $('#divErrorMsg').show();
                //$('#divExcel').show();
                var errorMsg = '';
                data.Errors.forEach(function (res) {
                    errorMsg = errorMsg + res.Message + '</br>';
                });

                //$('#divExcel').html(errorMsg);
                $('#txtErrorMsg').html(errorMsg);
                $("#excelfile").val(null);
                _excelJson = [];
                isExcelUpload = false;
                //$("html, body").animate({ scrollTop: 0 }, "slow");
            }
            else {
                sessionStorage.setItem('showMsg', '1');
                sessionStorage.setItem('Msg', data.Message);
                if (i == 1) {
                    window.location.href = "/items/itemImport";
                }
                else {
                    window.location.reload();
                }
            }
        },
        error: function (xhr) {
            $("#divLoading").hide();
            $("#divProgressBar").hide();
            clearInterval(myInterval);
        }
    });
}

function fetchBulkInsertProgress() {
    var det = {
        BatchNo: BatchNo
    };
    $.ajax({
        url: '/items/ItemCountByBatch',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {
            $('#divProgressBar .progress span').text(parseInt((data.Data.TotalCount / _excelJson.length) * 100) + '% Complete (success)');
            $('#divProgressBar .progress .progress-bar').css('width', parseInt((data.Data.TotalCount / _excelJson.length) * 100) + '%');
        },
        error: function (xhr) {

        }
    });
}

function copyTag(tag) {
    navigator.clipboard.writeText(tag);
    toastr.success("Copied the text: " + tag);
}

function closeErrorMsg() {
    $('#divErrorMsg').hide();
}

function FetchOtherSoftwareImport(PageIndex) {
    var DateFormat = Cookies.get('BusinessSetting').split('&')[0].split('=')[1];
    var det = {

    };
    _PageIndex = det.PageIndex;
    $("#divLoading").show();
    $.ajax({
        url: '/items/OtherSoftwareImportFetch',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {
            $("#tblOtherSoftwareImport").html(data);
            $("#divLoading").hide();
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
};

function DeleteOtherSoftwareImport(OtherSoftwareImportId) {
    var r = confirm("Are you sure you want to delete?");
    if (r == true) {
        var det = {
            OtherSoftwareImportId: OtherSoftwareImportId
        }
        $("#divLoading").show();
        $.ajax({
            url: '/items/OtherSoftwareImportDelete',
            datatype: "json",
            data: det,
            type: "post",
            success: function (data) {

                $("#divLoading").hide();
                if (data == "True") {
                    $('#subscriptionExpiryModal').modal('toggle');
                    $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                    $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                    return
                }
                else if (data == "False") {
                    $('#subscriptionExpiryModal').modal('toggle');
                    $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                    $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                    return
                }

                if (data.Status == 0) {
                    if (EnableSound == 'True') { document.getElementById('error').play(); }
                    toastr.error(data.Message);
                }
                else {
                    document.getElementById('success').play();
                    toastr.success(data.Message);
                    FetchOtherSoftwareImport();
                }
            },
            error: function (xhr) {
                $("#divLoading").hide();
            }
        });
    }
}
function getExcelBase64() {
    var file1 = $("#otherSoftwareExcelfile").prop("files")[0];

    var reader = new FileReader();
    reader.readAsDataURL(file1);
    reader.onload = function () {
        UploadPath = reader.result;
        fileExtension = '.' + file1.name.split('.').pop();
    };
    reader.onerror = function (error) {
        console.log(error);
        UploadPath = error;
    };
}
function InsertOtherSoftwareImport() {
    $('.errorText').hide();
    $('[style*="border: 2px"]').css('border', '');


    var det = {
        UploadPath: UploadPath,
        FileExtension: fileExtension,
        IsActive: true,
        IsDeleted: false,
    };
    $("#divLoading").show();
    $.ajax({
        url: '/items/OtherSoftwareImportInsert',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {

            $("#divLoading").hide();
            if (data == "True") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }
            else if (data == "False") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }

            if (data.Status == 0) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error(data.Message);
            }
            else if (data.Status == 2) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error('Invalid inputs, check and try again !!');
                data.Errors.forEach(function (res) {
                    $('#' + res.Id).show();
                    $('#' + res.Id).text(res.Message);


                    if ($('.' + res.Id + '_ctrl').children("select").length > 0) {
                        var element = $("." + res.Id + '_ctrl select');
                        if (element.hasClass("select2-hidden-accessible")) {
                            $('.' + res.Id + '_ctrl .select2-container .select2-selection').css('border', '2px solid #dc3545');
                        } else {
                            $('.' + res.Id + '_ctrl select').css('border', '2px solid #dc3545');
                        }
                    }
                    else {
                        $('.' + res.Id + '_ctrl').css('border', '2px solid #dc3545');
                    }
                });
            }
            else {
                $("#otherSoftwareExcelfile").val(null);
                UploadPath = "";
                fileExtension = "";
                if (EnableSound == 'True') { document.getElementById('success').play(); }
                toastr.success(data.Message);
                FetchOtherSoftwareImport();
            }
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
};

function FetchOtherSoftwareImport_OpeningStock(PageIndex) {
    var DateFormat = Cookies.get('BusinessSetting').split('&')[0].split('=')[1];
    var det = {

    };
    _PageIndex = det.PageIndex;
    $("#divLoading").show();
    $.ajax({
        url: '/items/OtherSoftwareImportFetch_OpeningStock',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {
            $("#tblOtherSoftwareImport").html(data);
            $("#divLoading").hide();
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
};

function DeleteOtherSoftwareImport_OpeningStock(OtherSoftwareImportId) {
    var r = confirm("Are you sure you want to delete?");
    if (r == true) {
        var det = {
            OtherSoftwareImportId: OtherSoftwareImportId
        }
        $("#divLoading").show();
        $.ajax({
            url: '/items/OtherSoftwareImportDelete_OpeningStock',
            datatype: "json",
            data: det,
            type: "post",
            success: function (data) {

                $("#divLoading").hide();
                if (data == "True") {
                    $('#subscriptionExpiryModal').modal('toggle');
                    $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                    $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                    return
                }
                else if (data == "False") {
                    $('#subscriptionExpiryModal').modal('toggle');
                    $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                    $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                    return
                }

                if (data.Status == 0) {
                    if (EnableSound == 'True') { document.getElementById('error').play(); }
                    toastr.error(data.Message);
                }
                else {
                    document.getElementById('success').play();
                    toastr.success(data.Message);
                    FetchOtherSoftwareImport_OpeningStock();
                }
            },
            error: function (xhr) {
                $("#divLoading").hide();
            }
        });
    }
}
function InsertOtherSoftwareImport_OpeningStock() {
    $('.errorText').hide();
    $('[style*="border: 2px"]').css('border', '');


    var det = {
        UploadPath: UploadPath,
        FileExtension: fileExtension,
        IsActive: true,
        IsDeleted: false,
    };
    $("#divLoading").show();
    $.ajax({
        url: '/items/OtherSoftwareImportInsert_OpeningStock',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {

            $("#divLoading").hide();
            if (data == "True") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }
            else if (data == "False") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }

            if (data.Status == 0) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error(data.Message);
            }
            else if (data.Status == 2) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error('Invalid inputs, check and try again !!');
                data.Errors.forEach(function (res) {
                    $('#' + res.Id).show();
                    $('#' + res.Id).text(res.Message);


                    if ($('.' + res.Id + '_ctrl').children("select").length > 0) {
                        var element = $("." + res.Id + '_ctrl select');
                        if (element.hasClass("select2-hidden-accessible")) {
                            $('.' + res.Id + '_ctrl .select2-container .select2-selection').css('border', '2px solid #dc3545');
                        } else {
                            $('.' + res.Id + '_ctrl select').css('border', '2px solid #dc3545');
                        }
                    }
                    else {
                        $('.' + res.Id + '_ctrl').css('border', '2px solid #dc3545');
                    }
                });
            }
            else {
                $("#otherSoftwareExcelfile").val(null);
                UploadPath = "";
                fileExtension = "";
                if (EnableSound == 'True') { document.getElementById('success').play(); }
                toastr.success(data.Message);
                FetchOtherSoftwareImport_OpeningStock();
            }
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
};

function openItemCodeModal() {
    $('#itemCodeModal').modal('toggle');
    if ($('#ddlItemType').val() == "Product") {
        $('#ddlItemCodeType_N').val('HSN');
        $('#lblCode').html('HSN Code <span class="danger">*</span>');
    }
    else {
        $('#ddlItemCodeType_N').val('SAC');
        $('#lblCode').html('SAC Code <span class="danger">*</span>');
    }
    $('#ddlItemCodeType_N').prop('disabled', true);
    initializeSelect2InScope('#itemCodeModal');
}

function toggleTaxPreference1() {
    $('.divTaxable_N').hide();
    $('.divNonTaxable_N').hide();

    if ($('#ddlTaxPreference_N option:selected').text() == 'Taxable') {
        $('.divTaxable_N').show();
        $('#ddlTaxExemption_N').val(0);
    }
    else if ($('#ddlTaxPreference_N option:selected').text() == 'Non-Taxable') {
        $('.divNonTaxable_N').show();
        $('#ddlIntraStateTax_N').val(0);
        $('#ddlInterStateTax_N').val(0);
    }

    initializeSelect2InScope('#itemCodeModal');
}

function insertItemCode(i) {
    $('.errorText').hide();
    $('[style*="border: 2px"]').css('border', '');


    var det = {
        ItemCodeType: $('#ddlItemCodeType_N').val(),
        Code: $('#txtCode_N').val(),
        Description: $('#txtDescription_N').val(),
        TaxPreferenceId: $('#ddlTaxPreference_N').val(),
        TaxPreference: $("#ddlTaxPreference_N option:selected").text(),
        TaxExemptionId: $('#ddlTaxExemption_N').val(),
        IntraStateTaxId: $('#ddlIntraStateTax_N').val().split('-')[0],
        InterStateTaxId: $('#ddlInterStateTax_N').val().split('-')[0],
        IsActive: true,
        IsDeleted: false,
    };
    $("#divLoading").show();
    $.ajax({
        url: '/othersettings/ItemCodeInsert',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {

            $("#divLoading").hide();
            if (data == "True") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }
            else if (data == "False") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }

            if (data.Status == 0) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error(data.Message);
            }
            else if (data.Status == 2) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error('Invalid inputs, check and try again !!');
                data.Errors.forEach(function (res) {
                    $('#' + res.Id + '_N').show();
                    $('#' + res.Id + '_N').text(res.Message);


                    if ($('.' + res.Id + '_N_ctrl').children("select").length > 0) {
                        var element = $("." + res.Id + '_N_ctrl select');
                        if (element.hasClass("select2-hidden-accessible")) {
                            $('.' + res.Id + '_N_ctrl .select2-container .select2-selection').css('border', '2px solid #dc3545');
                        } else {
                            $('.' + res.Id + '_N_ctrl select').css('border', '2px solid #dc3545');
                        }
                    }
                    else {
                        $('.' + res.Id + '_N_ctrl').css('border', '2px solid #dc3545');
                    }
                });
            }
            else {
                $('#ddlItemCode').append($('<option>', { value: data.Data.ItemCode.ItemCodeId, text: data.Data.ItemCode.Code }));
                $('#ddlItemCode').val(data.Data.ItemCode.ItemCodeId);

                $('#itemCodeModal').modal('toggle');
            }
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
};

function fetchItemCodeTax() {
    $('.errorText').hide();
    $('[style*="border: 2px"]').css('border', '');

    var det = {
        ItemCodeId: $('#ddlItemCode').val(),
    };
    $("#divLoading").show();
    $.ajax({
        url: '/othersettings/fetchItemCodeTax',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {

            $("#divLoading").hide();
            if (data == "True") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }
            else if (data == "False") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }

            if (data.Status == 0) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error(data.Message);
            }
            else if (data.Status == 2) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error('Invalid inputs, check and try again !!');
                data.Errors.forEach(function (res) {
                    $('#' + res.Id).show();
                    $('#' + res.Id).text(res.Message);


                    if ($('.' + res.Id + '_ctrl').children("select").length > 0) {
                        var element = $("." + res.Id + '_ctrl select');
                        if (element.hasClass("select2-hidden-accessible")) {
                            $('.' + res.Id + '_ctrl .select2-container .select2-selection').css('border', '2px solid #dc3545');
                        } else {
                            $('.' + res.Id + '_ctrl select').css('border', '2px solid #dc3545');
                        }
                    }
                    else {
                        $('.' + res.Id + '_ctrl').css('border', '2px solid #dc3545');
                    }
                });
            }
            else {
                $('#ddlTaxPreference').val(data.Data.ItemCode.TaxPreferenceId);
                $('#ddlTax').val(data.Data.ItemCode.IntraStateTaxId + '-' + data.Data.ItemCode.IntraStateTaxPercentage);
                $('#ddlInterStateTax').val(data.Data.ItemCode.InterStateTaxId + '-' + data.Data.ItemCode.InterStateTaxPercentage);
                $('#ddlTaxExemption').val(data.Data.ItemCode.TaxExemptionId);

                initializeSelect2InScope();
                toggleTaxPreference();
            }
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
}

function toggleTaxPreference() {
    $('.divTaxable').hide();
    $('.divNonTaxable').hide();

    if ($('#ddlTaxPreference option:selected').text() == 'Taxable') {
        $('.divTaxable').show();
        $('#ddlTaxExemption').val(0);
    }
    else if ($('#ddlTaxPreference option:selected').text() == 'Non-Taxable') {
        $('.divNonTaxable').show();
        $('#ddlIntraStateTax').val(0);
        $('#ddlInterStateTax').val(0);
    }

    if ($('#ddlTaxPreference option:selected').text() == 'Taxable') {
        $('#ddlTaxType').val('Inclusive');
        $('.divTaxType').show();
        checkTaxType();
    }
    else {
        $('#ddlTaxType').val('Exclusive');
        $('.divTaxType').hide();
        checkTaxType();
    }

    initializeSelect2InScope();
}

function insertTaxExemption() {
    $('.errorText').hide();
    $('[style*="border: 2px"]').css('border', '');


    var _type = 'Customer';
    if ($("#rdbItem").prop("checked")) {
        _type = "Item";
    }

    var det = {
        Reason: $('#txtReason_TaxExemption').val(),
        Description: $('#txtDescription_TaxExemption').val(),
        TaxExemptionType: _type,
        IsActive: true,
        IsDeleted: false,
    };
    $("#divLoading").show();
    $.ajax({
        url: '/taxsettings/TaxExemptionInsert',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {

            $("#divLoading").hide();
            if (data == "True") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }
            else if (data == "False") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }

            if (data.Status == 0) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error(data.Message);
            }
            else if (data.Status == 2) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error('Invalid inputs, check and try again !!');

                data.Errors.forEach(function (res) {
                    $('#' + res.Id + '_TaxExemption').show();
                    $('#' + res.Id + '_TaxExemption').text(res.Message);

                    var ctrl = $('.' + res.Id + '_TaxExemption_ctrl select').prop('tagName');
                    if ($('.' + res.Id + '_ctrl').children("select").length > 0) {
                        var element = $("." + res.Id + '_TaxExemption_ctrl select');
                        if (element.hasClass("select2-hidden-accessible")) {
                            $('.' + res.Id + '_TaxExemption_ctrl .select2-container .select2-selection').css('border', '2px solid #dc3545');
                        } else {
                            $('.' + res.Id + '_TaxExemption_ctrl select').css('border', '2px solid #dc3545');
                        }
                    }
                    else {
                        $('.' + res.Id + '_TaxExemption_ctrl').css('border', '2px solid #dc3545');
                    }
                });
            }
            else {
                $('#ddlTaxExemption').append($('<option>', { value: data.Data.TaxExemption.TaxExemptionId, text: data.Data.TaxExemption.Reason }));
                $('#ddlTaxExemption').val(data.Data.TaxExemption.TaxExemptionId);
                $('#taxExemptionModal').modal('toggle');
            }
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
}

function openSaltModal() {
    $('#saltModal').modal('toggle');
    $('textarea#txtIndication,#txtDosage,#txtSideEffects,#txtSpecialPrecautions,#txtDrugInteractions,#txtNotes').summernote({
        placeholder: '',
        tabsize: 2,
        height: 100,
        toolbar: [
            ['style', ['style']],
            ['font', ['bold', 'italic', 'underline', 'clear']],
            // ['font', ['bold', 'italic', 'underline', 'strikethrough', 'superscript', 'subscript', 'clear']],
            //['fontname', ['fontname']],
            // ['fontsize', ['fontsize']],
            ['color', ['color']],
            ['para', ['ul', 'ol', 'paragraph']],
            ['height', ['height']],
            ['table', ['table']],
            ['insert', ['link', 'picture', 'hr']],
            //['view', ['fullscreen', 'codeview']],
            ['help', ['help']]
        ],
    });
}

function insertSalt(i) {
    $('.errorText').hide();
    $('[style*="border: 2px"]').css('border', '');


    var det = {
        SaltName: $('#txtSaltName').val(),
        Indication: $('#txtIndication').val(),
        Dosage: $('#txtDosage').val(),
        SideEffects: $('#txtSideEffects').val(),
        SpecialPrecautions: $('#txtSpecialPrecautions').val(),
        DrugInteractions: $('#txtDrugInteractions').val(),
        Notes: $('#txtNotes').val(),
        TBItem: $('#ddlTBItem').val(),
        IsNarcotic: $('#chkIsNarcotic').is(':checked'),
        IsScheduleH: $('#chkIsScheduleH').is(':checked'),
        IsScheduleH1: $('#chkIsScheduleH1').is(':checked'),
        IsDiscontinued: $('#chkIsDiscontinued').is(':checked'),
        IsProhibited: $('#chkIsProhibited').is(':checked'),
        IsActive: true,
        IsDeleted: false,
    };
    $("#divLoading").show();
    $.ajax({
        url: '/itemsettings/SaltInsert',
        datatype: "json",
        data: det,
        type: "post",
        success: function (data) {

            $("#divLoading").hide();
            if (data == "True") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your free trial has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please buy plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }
            else if (data == "False") {
                $('#subscriptionExpiryModal').modal('toggle');
                $('#lblsubscriptionExpiryMsg1').html('<i class="icon fas fa-exclamation-triangle"></i> Your subscription plan has expired!!');
                $('#lblsubscriptionExpiryMsg2').html('Please renew plan to continue billing with ' + Cookies.get('data').split('&')[9].split('=')[1]);
                return
            }

            if (data.Status == 0) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error(data.Message);
            }
            else if (data.Status == 2) {
                if (EnableSound == 'True') { document.getElementById('error').play(); }
                toastr.error('Invalid inputs, check and try again !!');

                data.Errors.forEach(function (res) {
                    $('#' + res.Id).show();
                    $('#' + res.Id).text(res.Message);


                    if ($('.' + res.Id + '_ctrl').children("select").length > 0) {
                        var element = $("." + res.Id + '_ctrl select');
                        if (element.hasClass("select2-hidden-accessible")) {
                            $('.' + res.Id + '_ctrl .select2-container .select2-selection').css('border', '2px solid #dc3545');
                        } else {
                            $('.' + res.Id + '_ctrl select').css('border', '2px solid #dc3545');
                        }
                    }
                    else {
                        $('.' + res.Id + '_ctrl').css('border', '2px solid #dc3545');
                    }
                });
            }
            else {
                $('#ddlSalt').append($('<option>', { value: data.Data.Salt.SaltId, text: data.Data.Salt.SaltName }));
                $('#ddlSalt').val(data.Data.Salt.SaltId);
                $('#saltModal').modal('toggle');
            }
        },
        error: function (xhr) {
            $("#divLoading").hide();
        }
    });
};

// Initialize autocomplete for HSN/SAC Code
$('#txtCode_N').autocomplete({
    minLength: 2,
    source: function (request, response) {
        $.ajax({
            url: "/othersettings/ItemCodeAutocomplete",
            dataType: "json",
            type: "POST",
            data: {
                Search: request.term,
                ItemCodeType: $('#ddlItemCodeType_N').val()
            },
            success: function (data) {
                if (data.Status == 0) {
                    if (EnableSound == 'True') { document.getElementById('error').play(); }
                    toastr.error(data.Message);
                }
                else if (data.Status == 2) {
                    if (EnableSound == 'True') { document.getElementById('error').play(); }
                    toastr.error('Invalid inputs, check and try again !!');
                    data.Errors.forEach(function (res) {
                        $('#' + res.Id).show();
                        $('#' + res.Id).text(res.Message);
                    });
                }
                else {
                    response(data.Data.ItemsArray);
                }
            },
            error: function (xhr) {
                // Handle error silently
            }
        });
    },
    select: function (event, ui) {
        var selectedValue = ui.item.value;
        var parts = selectedValue.split(' ~ ');
        if (parts.length === 2) {
            $('#txtCode_N').val(parts[0]);
            $('#txtDescription_N').val(parts[1]);
        }
        return false;
    }
});

// Initialize autocomplete for Description
$('#txtDescription_N').autocomplete({
    minLength: 2,
    source: function (request, response) {
        $.ajax({
            url: "/othersettings/ItemCodeAutocomplete",
            dataType: "json",
            type: "POST",
            data: {
                Search: request.term,
                ItemCodeType: $('#ddlItemCodeType_N').val()
            },
            success: function (data) {
                if (data.Status == 0) {
                    if (EnableSound == 'True') { document.getElementById('error').play(); }
                    toastr.error(data.Message);
                }
                else if (data.Status == 2) {
                    if (EnableSound == 'True') { document.getElementById('error').play(); }
                    toastr.error('Invalid inputs, check and try again !!');
                    data.Errors.forEach(function (res) {
                        $('#' + res.Id).show();
                        $('#' + res.Id).text(res.Message);
                    });
                }
                else {
                    response(data.Data.ItemsArray);
                }
            },
            error: function (xhr) {
                // Handle error silently
            }
        });
    },
    select: function (event, ui) {
        var selectedValue = ui.item.value;
        var parts = selectedValue.split(' ~ ');
        if (parts.length === 2) {
            $('#txtCode_N').val(parts[0]);
            $('#txtDescription_N').val(parts[1]);
        }
        return false;
    }
});