
@{
    ViewBag.Title = Request.Cookies["data"].Value.Split('&')[8].Split('=')[1] + " | Whatsapp Settings";
    Layout = "~/Views/Shared/_CustomerLayout.cshtml";
}

<!-- Content Header (Page header) -->
<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>Whatsapp Settings</h1>
                <div class="float-left">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="/dashboard/index">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="/settings/index">Settings</a></li>
                        <li class="breadcrumb-item active">Whatsapp Settings</li>
                    </ol>
                </div>
            </div>
            <div class="col-md-6 col-12 d-flex align-items-center justify-content-start justify-content-md-end mt-1 mt-md-0">
                @if (ViewBag.MenuPermission.IsAdd)
                {
                    <a id="btnNew" href="/notificationsettings/whatsappsettingadd" class="btn btn-primary float-sm-right mr-2"><i class="fas fa-plus"></i> Add New</a>
                }
                <a id="btnBack" href="/settings/index" class="btn btn-warning float-sm-right mr-2"><i class="fas fa-arrow-left"></i> Back</a>
                @*<a href="javascript:void(0)" data-toggle="modal" data-target="#faqModal" class="btn btn-secondary float-sm-right mr-2">FAQs</a>*@
            </div>
        </div>
    </div><!-- /.container-fluid -->
</section>
<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <div class="row">

            <div class="col-12">
                @*<div class="callout callout-info @(Request.Cookies["SystemSetting"].Value.Split('&')[0].Split('=')[1] == "True" ? "":"hidden")">
                        <h5><i class="fas fa-info"></i> Note:</h5>
                        This page has been enhanced for printing. Click the print button at the bottom of the invoice to test.
                    </div>*@
                <!-- /.card -->
                <div class="card  card-primary card-outline">
                    <div class="card-header">
                        <h5>
                            <span class="success" id="divTotalCount">
                                Total : 0
                            </span>
                            |
                            <span class="primary" id="divActiveCount">
                                Active : 0
                            </span>
                            |
                            <span class="danger" id="divInactiveCount">In-Active : 0</span>
                        </h5>


                    </div>
                    <!-- /.card-header -->
                    <div class="card-body">
                        <div id="tblUserRole_wrapper" class="dataTables_wrapper dt-bootstrap4 no-footer">
                            <div class="dataTables_length noPrint" id="tblUserRole_length">
                                <label>
                                    Show
                                    <select name="tblUserRole_length" aria-controls="tblUserRole" class="custom-select custom-select-sm form-control form-control-sm"
                                            onchange="fetchList(1)" id="txtPageSize">
                                        @{
                                            if (ViewBag.PageSize == 10)
                                            {
                                                <option value="10" selected>10</option>
                                            }
                                            else
                                            {
                                                <option value="10">10</option>
                                            }
                                            if (ViewBag.PageSize == 25)
                                            {
                                                <option value="25" selected>25</option>
                                            }
                                            else
                                            {
                                                <option value="25">25</option>
                                            }
                                            if (ViewBag.PageSize == 50)
                                            {
                                                <option value="50" selected>50</option>
                                            }
                                            else
                                            {
                                                <option value="50">50</option>
                                            }
                                            if (ViewBag.PageSize == 100)
                                            {
                                                <option value="100" selected>100</option>
                                            }
                                            else
                                            {
                                                <option value="100">100</option>
                                            }
                                            if (ViewBag.PageSize == 500)
                                            {
                                                <option value="500" selected>500</option>
                                            }
                                            else
                                            {
                                                <option value="500">500</option>
                                            }
                                        }
                                    </select> entries
                                </label>
                            </div>
                            @if (ViewBag.MenuPermission.IsExport)
                            {
                               <div class="dt-buttons btn-group flex-wrap noPrint">
                                   <button class="btn btn-secondary buttons-csv buttons-html5" tabindex="0" aria-controls="tblUserRole" type="button" onclick="exportToCsv('@ViewBag.Title')"><span>CSV</span></button>
                                   <button class="btn btn-secondary buttons-excel buttons-html5" tabindex="0" aria-controls="tblUserRole" type="button" onclick="exportToExcel('@ViewBag.Title')"><span>Excel</span></button>
                                   <button class="btn btn-secondary buttons-pdf buttons-html5" tabindex="0" aria-controls="tblUserRole" type="button" onclick="exportToPdf('@ViewBag.Title')"><span>PDF</span></button>
                                   <button class="btn btn-secondary buttons-print" tabindex="0" aria-controls="tblUserRole" type="button" onclick="printDiv('@ViewBag.Title')"><span>Print</span></button>
                               </div>
                            }
                            <div id="tblUserRole_filter" class="dataTables_filter noPrint"><label>Search:<input type="text" class="form-control form-control-sm" placeholder="" aria-controls="tblUserRole" id="txtSearch" onkeyup="fetchList(1)"></label></div>
                            <div class="row mt-1">
                                <div class="col-sm-12 table-responsive">
                                    <table id="tblData" class="table table-bordered table-striped">
                                        @Html.Partial("PartialWhatsappSettings")
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- /.card-body -->
                </div>
            </div>
        </div>
        <!-- /.row -->
    </div><!-- /.container-fluid -->
</section>
<!-- /.content -->
<div class="modal fade" id="faqModal">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">FAQs</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="p-0 pl-2 pr-2">
                            <div class="card collapsed-card" data-card-widget="collapse" title="Collapse">
                                <div class="card-header" data-card-widget="collapse" title="Collapse">
                                    <h3 class="card-title">How do I add and update product categories?</h3>
                                    <div class="card-tools">
                                        <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body" style="display: none;">
                                    •	To add a new product category, click on the ‘Add New’ button at the top of the screen
                                    •	To update an existing product category, click on 'Edit' button beside the name of product category you want to change, make your changes and then click the ‘Save’ button at the bottom of the screen.
                                    •	To delete an existing product category, tick the box that is to the left of the product category you would like to delete and then click the ‘Delete’ button at the top of the list.
                                </div>
                            </div>
                            <div class="card collapsed-card" data-card-widget="collapse" title="Collapse">
                                <div class="card-header" data-card-widget="collapse" title="Collapse">
                                    <h3 class="card-title">How do I make a product category inactive?</h3>
                                    <div class="card-tools">
                                        <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body" style="display: none;">
                                    IMS allows you stop an entire product category from displaying in your catalogue, by marking it as inactive. This is sometimes better than deleting all those products since all the product information is retained but the products are not shown in the catalogue. To mark a product category as inactive, follow these steps:

                                    •	Click on the name of the product category that you want to make active.
                                    •	Change the status field from ‘Active’ to ‘Inactive’.
                                    •	Click the ‘Save’ button at the bottom of the page.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-default" data-dismiss="modal" style="margin-left:auto">Close</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- WhatsApp Connection Check Modal -->
<div class="modal fade" id="whatsappConnectionModal" tabindex="-1" role="dialog" aria-labelledby="whatsappConnectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="whatsappConnectionModalLabel">
                    <i class="fas fa-qrcode"></i> WhatsApp Web Connection Status
                </h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="connectionStatusContainer">
                    <div id="connectionStatusMessage" class="alert alert-info">
                        <i class="fas fa-spinner fa-spin"></i> Checking connection status...
                    </div>
                    <div id="qrCodeContainer" style="text-align: center; display: none;">
                        <p class="text-muted"><strong>Instructions:</strong> Scan this QR code with your WhatsApp mobile app to connect:</p>
                        <ol class="text-left" style="display: inline-block; text-align: left;">
                            <li>Open WhatsApp on your mobile phone</li>
                            <li>Go to Settings → Linked Devices</li>
                            <li>Tap "Link a Device"</li>
                            <li>Scan the QR code below</li>
                        </ol>
                        <div id="qrCodeImage" style="margin: 20px auto; max-width: 300px; padding: 20px;">
                            <!-- QR code will be displayed here -->
                        </div>
                        <div>
                            <button type="button" class="btn btn-primary" onclick="refreshQRCodeInModal()">
                                <i class="fas fa-sync-alt"></i> Refresh QR Code
                            </button>
                            <button type="button" class="btn btn-success ml-2" onclick="checkConnectionInModal()">
                                <i class="fas fa-check-circle"></i> Check Connection Status
                            </button>
                        </div>
                    </div>
                    <div id="connectionConnected" style="display: none;">
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> <strong>Connected!</strong> WhatsApp is ready to send messages automatically.
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <button type="button" class="btn btn-info" onclick="checkConnectionInModal()">
                                <i class="fas fa-sync-alt"></i> Check Connection Status
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<script src="~/Content/JQuery/Customer/Settings/NotificationSettings/WhatsappSettings.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
    // WhatsApp Node.js service URL
    var whatsappServiceUrl = '@(System.Configuration.ConfigurationManager.AppSettings["WhatsAppNodeServiceUrl"] ?? "http://localhost:3000")';
    if (whatsappServiceUrl.includes('/send-message')) {
        whatsappServiceUrl = whatsappServiceUrl.replace('/send-message', '');
    }
    
    // Get WebSocket URL (convert http/https to ws/wss)
    var wsUrl = whatsappServiceUrl.replace(/^https/, 'wss').replace(/^http:/, 'ws:');
    
    // Get CompanyId from cookies (for multi-tenant support)
    var companyId = '@(Request.Cookies["data"] != null && Request.Cookies["data"]["CompanyId"] != null ? Request.Cookies["data"]["CompanyId"] : "0")';
    
    // Modal-specific variables
    var currentWhatsappSettingsId = null;
    var modalSocket = null;
    var isModalSocketConnected = false;
    
    // Function to recheck WhatsApp connection
    function recheckWhatsAppConnection(whatsappSettingsId) {
        currentWhatsappSettingsId = whatsappSettingsId;
        
        // Reset modal state
        $('#connectionStatusMessage').show();
        $('#qrCodeContainer').hide();
        $('#connectionConnected').hide();
        $('#connectionStatusMessage').html('<i class="fas fa-spinner fa-spin"></i> Checking connection status...');
        $('#qrCodeImage').empty();
        
        // Show modal
        $('#whatsappConnectionModal').modal('show');
        
        // Initialize WebSocket connection for modal
        initModalWebSocket();
        
        // Check connection status
        checkConnectionInModal();
    }
    
    // Function to initialize WebSocket connection for modal
    function initModalWebSocket() {
        if (modalSocket) return;
        
        console.log('Initializing WebSocket connection for modal:', wsUrl);
        
        modalSocket = io(wsUrl, {
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            reconnectionAttempts: Infinity
        });
        
        modalSocket.on('connect', function() {
            console.log('Modal WebSocket connected');
            isModalSocketConnected = true;
            modalSocket.emit('subscribe', companyId);
        });
        
        modalSocket.on('connect_error', function(error) {
            console.error('Modal WebSocket connection error:', error);
            isModalSocketConnected = false;
        });
        
        modalSocket.on('disconnect', function(reason) {
            console.log('Modal WebSocket disconnected:', reason);
            isModalSocketConnected = false;
        });
        
        // QR Code received
        modalSocket.on('qr-code', function(data) {
            if (data.companyId === companyId) {
                console.log('QR code received in modal:', data);
                displayQRCodeInModal(data.qrCode);
            }
        });
        
        // Status update received
        modalSocket.on('status', function(data) {
            if (data.companyId === companyId) {
                console.log('Status update received in modal:', data);
                updateConnectionStatusInModal(data);
            }
        });
        
        // Disconnected event
        modalSocket.on('disconnected', function(data) {
            if (data.companyId === companyId) {
                console.log('Disconnected event received in modal:', data);
                $('#connectionStatusMessage').html('<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> <strong>WhatsApp Disconnected!</strong> Your WhatsApp session has been disconnected. Please scan the QR code again to reconnect.</div>');
                $('#connectionStatusMessage').show();
                $('#qrCodeContainer').show();
                $('#connectionConnected').hide();
            }
        });
    }
    
    // Function to check connection status in modal
    function checkConnectionInModal() {
        $('#connectionStatusMessage').html('<i class="fas fa-spinner fa-spin"></i> Checking connection status...');
        $('#connectionStatusMessage').show();
        
        $.ajax({
            url: whatsappServiceUrl + '/status/' + companyId,
            method: 'GET',
            timeout: 5000,
            success: function(response) {
                console.log('Status check response in modal:', response);
                updateConnectionStatusInModal(response);
            },
            error: function(xhr, status, error) {
                console.error('Error checking status:', error);
                $('#connectionStatusMessage').html('<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Cannot connect to WhatsApp service. Make sure the Node.js service is running on: ' + whatsappServiceUrl + '</div>');
                $('#connectionStatusMessage').show();
                $('#qrCodeContainer').hide();
                $('#connectionConnected').hide();
            }
        });
    }
    
    // Function to update connection status in modal
    function updateConnectionStatusInModal(response) {
        if (response.ready && !response.disconnected) {
            // Connected
            $('#connectionStatusMessage').hide();
            $('#qrCodeContainer').hide();
            $('#connectionConnected').show();
        } else if (response.disconnected) {
            // Disconnected
            $('#connectionStatusMessage').html('<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> <strong>WhatsApp Disconnected!</strong> Your WhatsApp session has been disconnected. Please scan the QR code again to reconnect.</div>');
            $('#connectionStatusMessage').show();
            $('#qrCodeContainer').show();
            $('#connectionConnected').hide();
        } else if (response.isInitializing) {
            // Initializing
            $('#connectionStatusMessage').html('<i class="fas fa-spinner fa-spin"></i> <strong>Initializing WhatsApp client...</strong> This may take a few seconds. Please wait...');
            $('#connectionStatusMessage').show();
            $('#qrCodeContainer').hide();
            $('#connectionConnected').hide();
        } else if (response.needsQR) {
            // Needs QR code
            $('#connectionStatusMessage').html('<i class="fas fa-spinner fa-spin"></i> Waiting for QR code...');
            $('#connectionStatusMessage').show();
            $('#qrCodeContainer').show();
            $('#connectionConnected').hide();
            
            // Request QR code
            requestQRCodeInModal();
        } else {
            // Waiting for QR
            $('#connectionStatusMessage').html('<i class="fas fa-spinner fa-spin"></i> ' + (response.message || 'Waiting for QR code...'));
            $('#connectionStatusMessage').show();
            $('#qrCodeContainer').show();
            $('#connectionConnected').hide();
            
            // Request QR code
            requestQRCodeInModal();
        }
    }
    
    // Function to request QR code in modal
    function requestQRCodeInModal() {
        $.ajax({
            url: whatsappServiceUrl + '/qr/' + companyId,
            method: 'GET',
            timeout: 10000,
            success: function(response) {
                if (response.qrCode) {
                    displayQRCodeInModal(response.qrCode);
                } else {
                    $('#connectionStatusMessage').html('<i class="fas fa-spinner fa-spin"></i> Waiting for QR code... Please wait a moment and try refreshing.');
                    $('#connectionStatusMessage').show();
                }
            },
            error: function(xhr, status, error) {
                console.error('Error requesting QR code:', error);
                $('#connectionStatusMessage').html('<i class="fas fa-spinner fa-spin"></i> Waiting for QR code... Please wait a moment and try refreshing.');
                $('#connectionStatusMessage').show();
            }
        });
    }
    
    // Function to display QR code in modal
    function displayQRCodeInModal(qrCodeData) {
        if (qrCodeData) {
            $('#qrCodeImage').html('<img src="' + qrCodeData + '" alt="QR Code" style="max-width: 100%; height: auto;" />');
            $('#qrCodeContainer').show();
            $('#connectionStatusMessage').html('<div class="alert alert-info"><i class="fas fa-qrcode"></i> <strong>QR Code Ready!</strong> Please scan the QR code below with your WhatsApp mobile app.</div>');
            $('#connectionStatusMessage').show();
        }
    }
    
    // Function to refresh QR code in modal
    function refreshQRCodeInModal() {
        $('#qrCodeImage').empty();
        $('#connectionStatusMessage').html('<i class="fas fa-spinner fa-spin"></i> Refreshing QR code...');
        $('#connectionStatusMessage').show();
        requestQRCodeInModal();
    }
    
    // Cleanup WebSocket when modal is closed
    $('#whatsappConnectionModal').on('hidden.bs.modal', function() {
        if (modalSocket) {
            modalSocket.emit('unsubscribe', companyId);
            modalSocket.disconnect();
            modalSocket = null;
            isModalSocketConnected = false;
        }
        currentWhatsappSettingsId = null;
    });
</script>