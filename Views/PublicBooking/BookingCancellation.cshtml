@{
    Layout = null;
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.PageTitle</title>
    <meta name="description" content="@ViewBag.MetaDescription">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Toastr CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }
        .cancellation-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .cancellation-header {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        .cancellation-header h1 {
            margin: 0;
            font-size: 2rem;
            font-weight: 600;
        }
        .cancellation-body {
            padding: 40px;
        }
        .booking-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .btn-cancel {
            background: #dc3545;
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 8px;
            font-weight: 600;
            width: 100%;
        }
        .btn-cancel:hover {
            background: #c82333;
        }
        .btn-cancel:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="cancellation-container">
        <div class="cancellation-header">
            <h1><i class="fas fa-times-circle"></i> Cancel Booking</h1>
            <p class="mb-0">Booking Number: @ViewBag.BookingNo</p>
        </div>
        
        <div class="cancellation-body">
            @if (ViewBag.Booking != null)
            {
                <div class="booking-info">
                    <p><strong>Date:</strong> @(((DateTime)ViewBag.Booking.BookingDate).ToString("dddd, MMMM dd, yyyy"))</p>
                    <p><strong>Time:</strong> @(((TimeSpan)ViewBag.Booking.BookingTime).ToString(@"hh\:mm"))</p>
                    <p><strong>Guests:</strong> @ViewBag.Booking.NoOfGuests</p>
                    @{
                        var tableList = ViewBag.Booking.TableNos;
                        int tableCount = 0;
                        if (tableList != null)
                        {
                            try 
                            { 
                                tableCount = ((System.Collections.ICollection)tableList).Count; 
                            } 
                            catch { }
                        }
                    }
                    <p><strong>Table@(tableCount > 1 ? "s" : ""):</strong> 
                        @{
                            var tables = ViewBag.Booking.TableNos;
                            if (tables != null && tableCount > 0)
                            {
                                var tableStrings = new System.Collections.Generic.List<string>();
                                try
                                {
                                    foreach (var table in (System.Collections.IEnumerable)tables)
                                    {
                                        if (table != null)
                                        {
                                            tableStrings.Add(table.ToString());
                                        }
                                    }
                                    if (tableStrings.Count > 0)
                                    {
                                        <text>@string.Join(", ", tableStrings)</text>
                                    }
                                }
                                catch
                                {
                                    if (ViewBag.Booking.TableNo != null)
                                    {
                                        <text>@ViewBag.Booking.TableNo</text>
                                    }
                                    else
                                    {
                                        <text>Not Assigned</text>
                                    }
                                }
                            }
                            else if (ViewBag.Booking.TableNo != null)
                            {
                                <text>@ViewBag.Booking.TableNo</text>
                            }
                            else
                            {
                                <text>Not Assigned</text>
                            }
                        }
                    </p>
                </div>

                if (ViewBag.Booking.Status == "Cancelled")
                {
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle"></i> This booking has already been cancelled.
                    </div>
                }
                else
                {
                    <form id="cancellationForm">
                        <input type="hidden" id="bookingNo" value="@ViewBag.BookingNo" />
                        <input type="hidden" id="token" value="@ViewBag.Token" />
                        
                        <div class="form-group mb-3">
                            <label for="cancellationReason">Reason for Cancellation (Optional)</label>
                            <textarea class="form-control" id="cancellationReason" rows="3" placeholder="Please let us know why you're cancelling..."></textarea>
                        </div>

                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> Are you sure you want to cancel this booking? This action cannot be undone.
                        </div>

                        <button type="submit" class="btn btn-cancel" id="cancelBtn">
                            <i class="fas fa-times"></i> Cancel Booking
                        </button>
                    </form>
                }
            }
            else
            {
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i> Booking not found or invalid token.
                </div>
            }
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Toastr JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    
    <script>
        $(document).ready(function() {
            $('#cancellationForm').on('submit', function(e) {
                e.preventDefault();
                
                if (!confirm('Are you sure you want to cancel this booking?')) {
                    return;
                }

                var bookingNo = $('#bookingNo').val();
                var token = $('#token').val();
                var reason = $('#cancellationReason').val();

                $('#cancelBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Cancelling...');

                $.ajax({
                    url: '/api/PublicTableBooking/CancelPublicBooking',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        BookingNo: bookingNo,
                        Token: token,
                        Reason: reason
                    }),
                    success: function(response) {
                        if (response.Status == 1) {
                            toastr.success('Booking cancelled successfully. You will receive a confirmation email.');
                            setTimeout(function() {
                                window.location.href = '/';
                            }, 2000);
                        } else {
                            toastr.error(response.Message || 'Failed to cancel booking');
                            $('#cancelBtn').prop('disabled', false).html('<i class="fas fa-times"></i> Cancel Booking');
                        }
                    },
                    error: function() {
                        toastr.error('An error occurred. Please try again.');
                        $('#cancelBtn').prop('disabled', false).html('<i class="fas fa-times"></i> Cancel Booking');
                    }
                });
            });
        });
    </script>
</body>
</html>

