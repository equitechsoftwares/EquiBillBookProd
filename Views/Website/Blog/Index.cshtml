@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Inner Banner -->
<section class="banner pt-3 pb-0" style="background: #6c3fb5;">
    <div class="container">
        <div class="row justify-content-between align-items-center">
            <div class="col-md-6 text-md-start text-center wow zoomInLeft">
                <h2 class="mb-3">Blog</h2>
                <h5 class="text-white">Track your business anytime, anywhere</h5>
            </div>
            <div class="col-md-3 wow zoomInRight">
                <img src="~/Content/web-assets/images/innerbanner.png" class="img-fluid" alt="">
            </div>
        </div>
    </div>
</section>
<!-- // -->
<!-- Blog Panel -->
<section>
    <div class="container">
        <!-- Category Filter Section -->
        @if (ViewBag.BlogCategories != null && ((System.Collections.IEnumerable)ViewBag.BlogCategories).Cast<object>().Any())
        {
            <div class="row mb-4">
                <div class="col-12">
                    <div class="category-filter-section">
                        <h5 class="mb-3">Filter by Category:</h5>
                        <div class="category-buttons">
                            <button type="button" class="btn btn-outline-primary category-filter-btn active" data-category="" onclick="filterBlogsByCategory('')">
                                All Categories
                            </button>
                            @foreach (dynamic category in ViewBag.BlogCategories)
                            {
                                <button type="button" class="btn btn-outline-primary category-filter-btn" data-category="@HttpUtility.HtmlAttributeEncode(category.CategoryName.ToString())" onclick="filterBlogsByCategory('@Html.Raw(HttpUtility.JavaScriptStringEncode(category.CategoryName.ToString()))')">
                                    @category.CategoryName
                                </button>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Blog List Container -->
        <div id="blogListContainer" data-company-id="@(ViewBag.CompanyId ?? 0)" data-page-size="9" data-total-count="@(ViewBag.BlogTotalCount ?? 0)">
            @if (ViewBag.Blogs != null && ((System.Collections.IEnumerable)ViewBag.Blogs).Cast<object>().Any())
            {
                <div class="row" id="blogRow">
                    @foreach (dynamic item in ViewBag.Blogs)
                    {
                        <div class="col-md-4 mb-4 blog-item" data-category="@(item.CategoryName != null ? HttpUtility.HtmlAttributeEncode(item.CategoryName.ToString()) : "")">
                            <div class="single-blog-card card border-0 shadow-sm h-100">
                                @if (!string.IsNullOrWhiteSpace(item.CategoryName?.ToString()))
                                {
                                    <span class="category position-absolute badge badge-pill badge-primary" style="top: 10px; right: 10px; z-index: 1;">@item.CategoryName</span>
                                }
                                @if (!string.IsNullOrWhiteSpace(item.Image?.ToString()))
                                {
                                    <img src="@item.Image" class="card-img-top position-relative" alt="@item.Title" style="height: 200px; object-fit: cover;" onerror="this.style.display='none'; this.onerror=null;">
                                }
                                <div class="card-body">
                                    <div class="post-meta mb-2">
                                        <ul class="list-inline meta-list">
                                            <li class="list-inline-item">
                                                <i class="far fa-calendar-alt mr-1"></i>
                                                @if (item.PublishedDate != null)
                                                {
                                                    @(((DateTime)item.PublishedDate).ToString("MMMM dd, yyyy"))
                                                }
                                                else if (item.AddedOn != null)
                                                {
                                                    @(((DateTime)item.AddedOn).ToString("MMMM dd, yyyy"))
                                                }
                                            </li>
                                        </ul>
                                    </div>
                                    <h5 class="card-title mb-3">
                                        <a href="/blog/@(item.UniqueSlug ?? item.BlogId)" class="text-dark">@item.Title</a>
                                    </h5>
                                    @if (!string.IsNullOrWhiteSpace(item.ShortDescription?.ToString()))
                                    {
                                        <p class="card-text text-muted">@(item.ShortDescription.Length > 150 ? item.ShortDescription.Substring(0, 150) + "..." : item.ShortDescription)</p>
                                    }
                                    <div class="text-right mt-3">
                                        <a href="/blog/@(item.UniqueSlug ?? item.BlogId)" class="btn btn-primary btn-sm read-more-btn">Read More <i class="fas fa-arrow-right"></i></a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <div id="noBlogsMessage" class="row" style="display: none;">
                    <div class="col-12 text-center py-5">
                        <h3 class="text-muted">No blog posts found in this category.</h3>
                        <p class="text-muted">Try selecting a different category.</p>
                    </div>
                </div>
                <div id="blogLoadMoreSentinel" class="col-12 text-center py-4"></div>
                <div id="blogLoadingIndicator" class="col-12 text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p class="text-muted mt-2">Loading more posts...</p>
                </div>
                <div id="blogNoMoreMessage" class="col-12 text-center py-3" style="display: none;">
                    <p class="text-muted small">You've reached the end of the blog</p>
                </div>
            }
            else
            {
                <div class="row">
                    <div class="col-12 text-center py-5">
                        <h3 class="text-muted">No blog posts available yet.</h3>
                        <p class="text-muted">Check back soon for updates!</p>
                    </div>
                </div>
            }
        </div>
    </div>
</section>
<!-- // -->

<style>
    .category-filter-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
    }

    .category-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .category-filter-btn {
        transition: all 0.3s ease;
        border-radius: 20px;
        padding: 8px 20px;
    }

    .category-filter-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .category-filter-btn.active {
        background-color: #6c3fb5 !important;
        border-color: #6c3fb5 !important;
        color: white !important;
    }

    .blog-item {
        transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .blog-item.hidden {
        display: none;
    }

    .blog-item.fade-in {
        animation: fadeIn 0.5s ease-in;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .read-more-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
</style>

<script>
    var blogState = {
        pageIndex: 1,
        totalCount: 0,
        pageSize: 9,
        companyId: 0,
        categoryFilter: '',
        isLoading: false,
        hasMore: true
    };

    $(document).ready(function() {
        var $container = $('#blogListContainer');
        blogState.totalCount = parseInt($container.data('total-count') || 0, 10);
        blogState.pageSize = parseInt($container.data('page-size') || 9, 10);
        blogState.companyId = parseInt($container.data('company-id') || 0, 10);
        blogState.hasMore = $('.blog-item').length < blogState.totalCount;

        // Intersection Observer for load more on scroll
        if (typeof IntersectionObserver !== 'undefined') {
            var sentinel = document.getElementById('blogLoadMoreSentinel');
            if (sentinel && $('.blog-item').length > 0) {
                var observer = new IntersectionObserver(function(entries) {
                    entries.forEach(function(entry) {
                        if (entry.isIntersecting && blogState.hasMore && !blogState.isLoading) {
                            loadMoreBlogs();
                        }
                    });
                }, { rootMargin: '200px', threshold: 0 });
                observer.observe(sentinel);
            }
        } else {
            // Fallback: scroll event for older browsers
            $(window).on('scroll', function() {
                var sentinel = $('#blogLoadMoreSentinel');
                if (sentinel.length && blogState.hasMore && !blogState.isLoading) {
                    var rect = sentinel[0].getBoundingClientRect();
                    if (rect.top < window.innerHeight + 200) {
                        loadMoreBlogs();
                    }
                }
            });
        }
    });

    function filterBlogsByCategory(categoryName) {
        blogState.categoryFilter = categoryName;
        blogState.pageIndex = 1;

        $('.category-filter-btn').removeClass('active');
        var targetButton = categoryName === ''
            ? $('.category-filter-btn[data-category=""]')
            : $('.category-filter-btn[data-category="' + categoryName.replace(/"/g, '&quot;') + '"]');
        targetButton.addClass('active');

        // Reload from API when filter changes (ensures correct data for infinite scroll)
        reloadBlogsWithFilter(categoryName);
    }

    function reloadBlogsWithFilter(categoryName) {
        if (blogState.isLoading) return;
        blogState.isLoading = true;
        blogState.pageIndex = 1;

        $('#blogLoadingIndicator').show();
        $('#blogNoMoreMessage').hide();

        loadBlogsFromApi(1, categoryName, function(blogs, totalCount) {
            blogState.totalCount = totalCount;
            blogState.hasMore = blogs.length < totalCount;

            $('#blogRow').empty();
            blogs.forEach(function(item) {
                $('#blogRow').append(renderBlogCard(item));
            });

            $('#blogLoadingIndicator').hide();
            blogState.isLoading = false;

            if (blogs.length === 0) {
                $('#noBlogsMessage').show();
                $('#blogRow').hide();
            } else {
                $('#noBlogsMessage').hide();
                $('#blogRow').show();
            }
        }, function() {
            $('#blogLoadingIndicator').hide();
            blogState.isLoading = false;
        });
    }

    function loadMoreBlogs() {
        if (blogState.isLoading || !blogState.hasMore) return;

        blogState.isLoading = true;
        $('#blogLoadingIndicator').show();
        $('#blogNoMoreMessage').hide();

        var nextPage = blogState.pageIndex + 1;
        loadBlogsFromApi(nextPage, blogState.categoryFilter, function(blogs, totalCount) {
            blogState.pageIndex = nextPage;
            blogState.totalCount = totalCount;
            blogState.hasMore = ($('.blog-item').length + blogs.length) < totalCount;

            blogs.forEach(function(item) {
                $('#blogRow').append(renderBlogCard(item));
            });

            $('#blogLoadingIndicator').hide();
            if (!blogState.hasMore) {
                $('#blogNoMoreMessage').show();
            }
            blogState.isLoading = false;
        }, function() {
            $('#blogLoadingIndicator').hide();
            blogState.isLoading = false;
        });
    }

    function loadBlogsFromApi(pageIndex, categoryFilter, onSuccess, onError) {
        $.ajax({
            url: '/api/Blog/WebBlogs',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                CompanyId: blogState.companyId,
                PageIndex: pageIndex,
                PageSize: blogState.pageSize,
                CategoryFilter: categoryFilter || ''
            }),
            success: function(response) {
                if (response && response.Status === 1 && response.Data) {
                    onSuccess(response.Data.Blogs || [], response.Data.TotalCount || 0);
                } else {
                    if (onError) onError();
                }
            },
            error: function() {
                if (onError) onError();
            }
        });
    }

    function formatDate(dateStr) {
        if (!dateStr) return '';
        var d = new Date(dateStr);
        if (isNaN(d.getTime())) return '';
        var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        return months[d.getMonth()] + ' ' + ('0' + d.getDate()).slice(-2) + ', ' + d.getFullYear();
    }

    function renderBlogCard(item) {
        var slug = item.UniqueSlug || item.BlogId;
        var categoryName = item.CategoryName || '';
        var shortDesc = item.ShortDescription || '';
        if (shortDesc.length > 150) shortDesc = shortDesc.substring(0, 150) + '...';

        var categoryBadge = categoryName ? '<span class="category position-absolute badge badge-pill badge-primary" style="top: 10px; right: 10px; z-index: 1;">' + $('<div>').text(categoryName).html() + '</span>' : '';
        var imgHtml = item.Image ? '<img src="' + $('<div>').text(item.Image).html() + '" class="card-img-top position-relative" alt="' + $('<div>').text(item.Title || '').html() + '" style="height: 200px; object-fit: cover;" onerror="this.style.display=\'none\'; this.onerror=null;">' : '';

        return '<div class="col-md-4 mb-4 blog-item fade-in" data-category="' + $('<div>').text(categoryName).html() + '">' +
            '<div class="single-blog-card card border-0 shadow-sm h-100">' +
            categoryBadge +
            imgHtml +
            '<div class="card-body">' +
            '<div class="post-meta mb-2"><ul class="list-inline meta-list"><li class="list-inline-item"><i class="far fa-calendar-alt mr-1"></i>' + formatDate(item.PublishedDate || item.AddedOn) + '</li></ul></div>' +
            '<h5 class="card-title mb-3"><a href="/blog/' + $('<div>').text(slug).html() + '" class="text-dark">' + $('<div>').text(item.Title || '').html() + '</a></h5>' +
            (shortDesc ? '<p class="card-text text-muted">' + $('<div>').text(shortDesc).html() + '</p>' : '') +
            '<div class="text-right mt-3"><a href="/blog/' + $('<div>').text(slug).html() + '" class="btn btn-primary btn-sm read-more-btn">Read More <i class="fas fa-arrow-right"></i></a></div>' +
            '</div></div></div>';
    }
</script>

